unit MMXE;

interface

uses Windows;

//
// v4.0.1
// Last modify: 2003.06.16.
//
//
// MMX or 3DNow  - movq, por, pand, psllq, paddw, punpcklbw...
// MMX 2         - pavgw, pminsw, pmaxsw...
// SSE or 3DNow  - montq, prefetchtna...
//
// MMX vagy 3DNow! mindenképpen szükséges!!! SSE nem árt ha van!
// Némelyik régebbi MMX-es Intel prociban nincsen SSE támogatás!!
// Tesztelve:
// -AMD Duron 700         MMX,MMX Enhanced,3DNow!
// -AMD Duron 800         MMX,MMX Enhanced,3Dnow!
// -AMD Athlon XP2100+    MMX,MMX Enhanced,3Dnow!,3DNow! Enhanced,SSE
// -Intel Celeron 400     MMX
// -Intel Celeron 800     MMX,SSE
// -Intel Pentium4 1700   MMX,SSE,SSE2
//
// -> Intel outside...
//
//=============================================================================================
// RUTINOK (rövid leirással):
//=============================================================================================
//
// Az elsõ lépés az MMX "fokozat" beállítása:
//                      - 0= sima MMX processzor (Intel Celeron, PII)
//                      - 1= sima MMX processzor + SSE (Intel Celeron, PII)
//                      - 2= enhanced MMX-et is támogató proci (AMD Duron,Athlon)
  procedure SetMMX(const M: integer);
// ***************************************************************************************
// - MMX memoria masolas 32byte-os
  procedure CopyMemoryMMX32(const Dest: Pointer;const Src: Pointer;const Size: DWord);
// ***************************************************************************************
// - MMX memória másolás tükrözéssel: - ugyanaz a cél és a forrás - 2byte/pixel
//                                    - különbözõ cél és forrás - 2byte/pixel
//                                    - különbözõ cél és forrás - 3byte/pixel
  procedure YMirrorMMX(const pBuffer: pointer; const IWidth,IHeight: integer);
  procedure YMirror_2MMX(const Dest,Src: pointer; const IWidth,IHeight: integer);
  procedure YMirrorRGB24_2MMX(const Dest,Src: pointer; const IWidth,IHeight: integer);
// ***************************************************************************************
// - RGB565->RGB555 kodkonverzio
  procedure CopyMemoryRGB565toRGB555MMX32(const Dest: Pointer;const Src: Pointer;const Size: DWord);
// ***************************************************************************************
// - RGB24->RGB555 kodkonverzio
// - RGB24->RGB555 kodkonverzio tükrözéses
  procedure CopyMemoryRGB24toRGB555MMX24(const Dest: Pointer;const Src: Pointer; const SrcW,SrcH: DWord);
  procedure CopyMemoryRGB24toRGB555MMX24_Ymirror(const Dest: Pointer;const Src: Pointer;const Width,Height: DWord);
  procedure CopyMemoryRGB24toRGB555MMX24Interlaced_Ymirror(const Dest: Pointer;const Src: Pointer;const Width,Height: DWord);
// - RGB32->RGB8 grayscale kodkonverzio
  procedure CopyMemoryRGB32toRGB8GrayScale(dest, src : pointer; pixels : integer);
// ***************************************************************************************
// - YUY2->RGB8 grayscale kodkonverzio
  procedure CopyMemoryYUY2toRGB8GrayScaleMMX32(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB8GrayScaleMMX32_Ymirror(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
// - csak az Y-okra másolja rá a 8 bites intenzítás értékeket
  procedure InsertMemoryGrayscaletoYUY2MMX32(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
// ***************************************************************************************
// - Strecth és Fit algoritmusok: (2byte/pixel)  RGB555,RGB565 (YUY2 nem)
//                      - 2 -> 1 kicsinyités
//                      - 3 -> 1 kicsinyités
//                      - 4 -> 1 kicsinyités
//                      - 3 -> 2 kicsinyités
//                      - 1 -> 2 nagyítás
//                      - 1 -> 4 nagyítás
//                      - 3 -> 4 nagyítás
  procedure Copy2_1_16MMX32(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy3_1_16MMX24(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy4_1_16MMX32(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy3_2_16MMX24(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy1_2_16MMX32(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy1_4_16MMX32(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy3_4_16MMX24(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
// ***************************************************************************************
// - Strecth és Fit algoritmusok: (1byte/pixel)  GrayScale, RGB8
//                      - 2 -> 1 kicsinyités
  procedure Copy2_1_8MMX32(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
// ***************************************************************************************
// - Strecth és Fit algoritmusok: (2byte/pixel)  csak YUY2
//                      - 2 -> 1 kicsinyités
//                      - 2 -> 1 kicsinyités csak X irányban!
  procedure Copy2_1_YUY16MMX32(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy2_1_YUY16MMX32OnlyHorizontal(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
// ***************************************************************************************
// - Deinterlace filter kódkonverzioval (is):  csak 768*576, mivel egyébként szükségtelen
//                      - RGB565 -> RGB555
//                      - YUY2   -> RGB555
//                      - YUY2   -> YUY2 ugyanaz a cél és forrás
//                      - YUY2   -> YUY2
//                      - YUY2   -> YUY2 tükrözéses másolással
  procedure CopyMemoryRGB565toRGB555_DeinterlaceOnly768x576MMX8(const Dest: Pointer;const Src: Pointer);
  procedure CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX16(const Dest: Pointer;const Src: Pointer);
  procedure YUY2DeinterlaceOnly768x576MMX16(const Src: Pointer);
  procedure YUY2DeinterlaceOnly768x576_2MMX16(const Dest,Src: Pointer);
  procedure YUY2DeinterlaceOnly768x576_2MMX16_Ymirror(const Dest,Src: Pointer);
// ***************************************************************************************
// - Átlagolásos memória másolás  (YUY2,RGB555)
// a célt és forrást atlagolja a cél memóriába
// a YUY2 verzió jó RGB8-ra vagy szürkeárnyalatra is!
  procedure CopyMemoryAverageYUY2MMX32(const Dest: Pointer;const Src: Pointer;const Size: DWord);
  procedure CopyMemoryAverageRGB555MMX16(const Dest: Pointer;const Src: Pointer;const Size: DWord);
// ***************************************************************************************
// - Sima és tükrözéses valamint interpolált kódkonverzió megjelenítéshez (YUY2 -> RGB555)
  procedure CopyMemoryYUY2toRGB555MMX16(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB555MMX16_Ymirror(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB555MMX16Interlaced(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
// - Kódkonverzió megjelenítéshez (YUY2 -> RGB32)
  procedure CopyMemoryYUY2toRGB32MMX16(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB32MMX16_Ymirror(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
// - Deinterlace filteres és tükrözéses kódkonverzió megj.-hez (YUY2 -> RGB555)
  procedure CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX16_Ymirror(const Dest: Pointer;const Src: Pointer);
// - Mozgás detektáló algoritmus fénymérési, átlagolási lehetoséggel,
//   maszkolással(bármilyen maszk alakzat, max. 8db). Zajküszöb megadható. (YUY2)
  procedure VmdYUY2MMX(const ref,new,mask: Pointer; const Size: DWord; const Noise: Dword;
                       const MeasureLight: boolean; const VR: Pointer);
// - Saját 7x7-es mátrix-os szürõ, beállítható osztótaggal. Negatív szorzók
//   is használhatóak. (grayscale,plane)
  procedure CustomMatrixFilter7x7MMXGrayScale(const Src: pointer; const SrcW,SrcH: DWord; const Filter: pointer; const Sum: Word);
// - 3x3-as medián szürõ. (grayscale,plane)
  procedure MedianFilter3x3MMXPlane(const Src: pointer; const SrcW,SrcH: DWord);
  procedure MedianFilter3x3MMXPlaneD(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord);
// - 5x5-ös medián szürõ (grayscale,plane)
// Csak MMX2-es verzió a sebesség miatt!!
  procedure MedianFilter5x5MMXPlane(const Src: pointer; const SrcW,SrcH: DWord);
// - Saját 3x3-as mátrix-os szürõ, beállítható osztótaggal. Negatív szorzók
//   is használhatóak. (grayscale,plane)
  procedure CustomMatrixFilter3x3MMXGrayScale(const Src: pointer; const SrcW,SrcH: DWord; const Filter: pointer; const Sum: Word);
  procedure CustomMatrixFilter3x3MMXGrayScaleD(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord; const Filter: pointer; const Sum: Word);
// - 3x3-as minimum szürõ. (grayscale,plane)
  procedure MinimumFilter3x3MMXPlane(const Src: pointer; const SrcW,SrcH: DWord);
// - 3x3-as maximum szürõ. (grayscale,plane)
  procedure MaximumFilter3x3MMXPlane(const Src: pointer; const SrcW,SrcH: DWord);
// - RGB32->R,G,B Az RGB32-t plane-ekre szedi szét, a plane-ek a memóriában egymást követik
  procedure RGB32toRGBPlanesMMX32(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord);
// - R,G,B->RGB32 A plane-eket rakja össze RGB32-vé, a plane-ek a memóriában egymást követik
  procedure RGBPlanestoRGB32MMX32(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord);
// - Byte-onként OR-ol össze két grayscale képet
  procedure ORPlanesMMX32(const Dest: pointer; const Src: pointer; const Size: DWord);
// - Byte-onként XOR-ol össze két grayscale képet
  procedure XORPlanesMMX32(const Dest: pointer; const Src: pointer; const Size: DWord);
// - Byte-onként AND-el össze két grayscale képet
  procedure ANDPlanesMMX32(const Dest: pointer; const Src: pointer; const Size: DWord);
// - Cut algoritmus 8bit/pixel megadható vágási küszöbbel
  procedure CutPlanesMMX32(const Src: pointer; const Size: DWord; const Level: byte);
// - Ablakos másolás oda és vissza 'DEPTH' bit/pixel
//   FONTOS: A terület 16*x-es négyzet egész számú többszöröse legyen
//           figyelembe véve a színmélységbe!!!
//   IMGXW: kép szélessége amibõl vágunk, vagy amibe visszaillesztünk
//   X,Y: kivágandó vagy kivágott ablak balfelsõ sarkának poziciója
//   XW,YW: kivágandó vagy kivágott ablak magassága szélessége
//   DEPTH: színmélység: 8,16,24,32 bit
  function GetModifiedWindowXWidth(const XW,YW: dword;
                                   const depth: dword): integer;
  procedure CopyFromWindowMMX16(const Dest: pointer; const Src: pointer; const IMGXW: dword; const X,Y: dword; const XW,YW: dword; const depth: dword);
  procedure CopyBackToWindowMMX16(const Dest: pointer; const Src: pointer; const IMGXW: dword; const X,Y: dword; const XW,YW: dword; const depth: dword);
  procedure ORBackToWindowMMX16(const Dest: pointer; const Src: pointer; const IMGXW: dword; const X,Y: dword; const XW,YW: dword; const depth: dword);
  procedure ORBackToWindowWithBlackFrameMMX16(const Dest: pointer; const Src: pointer; const IMGXW: dword; const X,Y: dword; const XW,YW: dword; const depth: dword);
// - Terület keresõ algoritmus
//   4 byte/pixel-ü képben keres: - 0 H S V formátum    H=0..255 !!
//                                - 0 R G B formátum
//                                - 0 0 0 G formátum
//  sx,sy,ex,ey-on belül keresi a SrcRect képet az Srcfull képen
  procedure SearchRectangleRGBMMX(const SrcFull,SrcRect: pointer;
                                 const SrcfullW,SrcfullH: word;
                                 const SrcRectW,SrcRectH: word;
                                 const sx,sy,ex,ey: word;
                                 var fx,fy: word;
                                 var error: dword);
  procedure SearchRectangleGrayScaleMMX(const SrcFull,SrcRect: pointer;
                                        const SrcfullW,SrcfullH: word;
                                        const SrcRectW,SrcRectH: word;
                                        const sx,sy,ex,ey: word;
                                        var fx,fy: word;
                                        var error: dword);
  procedure SearchRectangleHSVMMX(const SrcFull,SrcRect: pointer;
                                 const SrcfullW,SrcfullH: word;
                                 const SrcRectW,SrcRectH: word;
                                 const sx,sy,ex,ey: word;
                                 var fx,fy: word;
                                 var error: dword);
//=============================================================================================
// NEM TESZTELTEK!!! (ezek nem lettek még kipróbálva)
//=============================================================================================
// - RGB24 -> R,G,B RGB24-et plane-ekre szedi szét, a plane-ek a memóriában egymást követik
  procedure RGB24toRGBPlanesMMX(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord);
  procedure BGR32toYUY2MMX(const Dest: pointer; const Src: pointer; const srcW,SrcH: Dword);
  procedure RGB32toYUY2MMX(const Dest: pointer; const Src: pointer; const srcW,SrcH: Dword);
  procedure InterlaceRGB32MMX(const Dest: pointer; const Src: pointer; const SrcW,SrcH: Dword);
//=============================================================================================
// Fejlécek:
//=============================================================================================
  procedure CopyMemoryMMX032(const Dest: Pointer;const Src: Pointer;const Size: DWord);
  procedure CopyMemoryYUY2toRGB8GrayScaleMMX032(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB8GrayScaleMMX032_Ymirror(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure InsertMemoryGrayscaletoYUY2MMX032(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryRGB565toRGB555MMX032(const Dest: Pointer;const Src: Pointer;const Size: DWord);
  procedure CopyMemoryRGB24toRGB555MMX024(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryRGB24toRGB555MMX024_Ymirror(const Dest: Pointer;const Src: Pointer;const Width,Height: DWord);
  procedure CopyMemoryRGB24toRGB555MMX024Interlaced_Ymirror(const Dest: Pointer;const Src: Pointer;const Width,Height: DWord);
  procedure CopyMemoryRGB565toRGB555_DeinterlaceOnly768x576MMX08(const Dest: Pointer;const Src: Pointer);
  procedure Copy2_1_16MMX032(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy2_1_YUY16MMX032(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy2_1_YUY16MMX032OnlyHorizontal(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy2_1_8MMX032(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy3_1_16MMX024(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy4_1_16MMX032(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy3_2_16MMX024(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy1_2_16MMX032(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy1_4_16MMX032(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy3_4_16MMX024(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB555MMX016(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB555MMX016Interlaced(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB32MMX016(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB32MMX016_Ymirror(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX016(const Dest: Pointer;const Src: Pointer);
  procedure CopyMemoryYUY2toRGB555MMX016_Ymirror(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX016_Ymirror(const Dest: Pointer;const Src: Pointer);
  procedure YUY2DeinterlaceOnly768x576MMX016(const Src: Pointer);
  procedure YUY2DeinterlaceOnly768x576_2MMX016(const Dest,Src: Pointer);
  procedure YUY2DeinterlaceOnly768x576_2MMX016_Ymirror(const Dest,Src: Pointer);
  procedure YMirrorMMX0(const pbuffer: pointer; const IWidth,IHeight: integer);
  procedure YMirror_2MMX0(const Dest,Src: pointer; const IWidth,IHeight: integer);
  procedure YMirrorRGB24_2MMX0(const Dest,Src: pointer; const IWidth,IHeight: integer);
  procedure CopyMemoryAverageYUY2MMX032(const Dest: Pointer;const Src: Pointer;const Size: DWord);
  procedure CopyMemoryAverageRGB555MMX016(const Dest: Pointer;const Src: Pointer;const Size: DWord);
  procedure VmdYUY2MMX0(const ref,new,mask: Pointer; const Size: DWord; const Noise: Dword;
                        const MeasureLight: boolean; const VR: Pointer);
  procedure CustomMatrixFilter3x3MMX0GrayScale(const Src: pointer; const SrcW,SrcH: DWord; const Filter: pointer; const Sum: Word);
  procedure CustomMatrixFilter3x3MMX0GrayScaleD(const Dest: pointer;const Src: pointer; const SrcW,SrcH: DWord; const Filter: pointer; const Sum: Word);
  procedure CustomMatrixFilter7x7MMX0GrayScale(const Src: pointer; const SrcW,SrcH: DWord; const Filter: pointer; const Sum: Word);
  procedure MinimumFilter3x3MMX0Plane(const Src: pointer; const SrcW,SrcH: DWord);
  procedure MaximumFilter3x3MMX0Plane(const Src: pointer; const SrcW,SrcH: DWord);
  procedure MedianFilter3x3MMX0Plane(const Src: pointer; const SrcW,SrcH: DWord);
  procedure MedianFilter3x3MMX0PlaneD(const Dest:pointer; const Src: pointer; const SrcW,SrcH: DWord);
  procedure RGB32toRGBPlanesMMX032(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord);
  procedure RGBPlanestoRGB32MMX032(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord);
  procedure RGB24toRGBPlanesMMX0(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord);
  procedure ORPlanesMMX032(const Dest: pointer; const Src: pointer; const Size: DWord);
  procedure XORPlanesMMX032(const Dest: pointer; const Src: pointer; const Size: DWord);
  procedure ANDPlanesMMX032(const Dest: pointer; const Src: pointer; const Size: DWord);
  procedure CopyFromWindowMMX016(const Dest: pointer; const Src: pointer; const IMGXW: dword; const X,Y: dword; const XW,YW: dword; const depth: dword);
  procedure CopyBackToWindowMMX016(const Dest: pointer; const Src: pointer; const IMGXW: dword; const X,Y: dword; const XW,YW: dword; const depth: dword);
  procedure ORBackToWindowMMX016(const Dest: pointer; const Src: pointer; const IMGXW: dword; const X,Y: dword; const XW,YW: dword; const depth: dword);
  procedure ORBackToWindowWithBlackFrameMMX016(const Dest: pointer; const Src: pointer; const IMGXW: dword; const X,Y: dword; const XW,YW: dword; const depth: dword);
  procedure CutPlanesMMX032(const Src: pointer; const Size: DWord; const Level: byte);
  procedure SearchRectangleRGBMMX0(const SrcFull,SrcRect: pointer;
                                   const SrcfullW,SrcfullH: word;
                                   const SrcRectW,SrcRectH: word;
                                   const sx,sy,ex,ey: word;
                                   var fx,fy: word;
                                   var error: dword);
  procedure SearchRectangleGrayScaleMMX0(const SrcFull,SrcRect: pointer;
                                         const SrcfullW,SrcfullH: word;
                                         const SrcRectW,SrcRectH: word;
                                         const sx,sy,ex,ey: word;
                                         var fx,fy: word;
                                         var error: dword);
  procedure SearchRectangleHSVMMX0(const SrcFull,SrcRect: pointer;
                                   const SrcfullW,SrcfullH: word;
                                   const SrcRectW,SrcRectH: word;
                                   const sx,sy,ex,ey: word;
                                   var fx,fy: word;
                                   var error: dword);
  procedure BGR32toYUY2MMX0(const Dest: pointer; const Src: pointer; const srcW,SrcH: Dword);
  procedure RGB32toYUY2MMX0(const Dest: pointer; const Src: pointer; const srcW,SrcH: Dword);
  procedure InterlaceRGB32MMX0(const Dest: pointer; const Src: pointer; const SrcW,SrcH: Dword);
  //***
  procedure CopyMemoryMMX132(const Dest: Pointer;const Src: Pointer;const Size: DWord);
  procedure CopyMemoryYUY2toRGB8GrayScaleMMX132(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB8GrayScaleMMX132_Ymirror(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure InsertMemoryGrayscaletoYUY2MMX132(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryRGB565toRGB555MMX132(const Dest: Pointer;const Src: Pointer;const Size: DWord);
  procedure CopyMemoryRGB24toRGB555MMX124(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryRGB24toRGB555MMX124_Ymirror(const Dest: Pointer;const Src: Pointer;const Width,Height: DWord);
  procedure CopyMemoryRGB24toRGB555MMX124Interlaced_Ymirror(const Dest: Pointer;const Src: Pointer;const Width,Height: DWord);
  procedure CopyMemoryRGB565toRGB555_DeinterlaceOnly768x576MMX18(const Dest: Pointer;const Src: Pointer);
  procedure Copy2_1_16MMX132(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy2_1_YUY16MMX132(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy2_1_YUY16MMX132OnlyHorizontal(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy2_1_8MMX132(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy3_1_16MMX124(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy4_1_16MMX132(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy3_2_16MMX124(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy1_2_16MMX132(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy1_4_16MMX132(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure Copy3_4_16MMX124(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB555MMX116(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB555MMX116Interlaced(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB32MMX116(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB32MMX116_Ymirror(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX116(const Dest: Pointer;const Src: Pointer);
  procedure CopyMemoryYUY2toRGB555MMX116_Ymirror(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX116_Ymirror(const Dest: Pointer;const Src: Pointer);
  procedure YUY2DeinterlaceOnly768x576MMX116(const Src: Pointer);
  procedure YUY2DeinterlaceOnly768x576_2MMX116(const Dest,Src: Pointer);
  procedure YUY2DeinterlaceOnly768x576_2MMX116_Ymirror(const Dest,Src: Pointer);
  procedure YMirrorMMX1(const pbuffer: pointer; const IWidth,IHeight: integer);
  procedure YMirror_2MMX1(const Dest,Src: pointer; const IWidth,IHeight: integer);
  procedure YMirrorRGB24_2MMX1(const Dest,Src: pointer; const IWidth,IHeight: integer);
  procedure CopyMemoryAverageYUY2MMX132(const Dest: Pointer;const Src: Pointer;const Size: DWord);
  procedure CopyMemoryAverageRGB555MMX116(const Dest: Pointer;const Src: Pointer;const Size: DWord);
  procedure VmdYUY2MMX1(const ref,new,mask: Pointer; const Size: DWord; const Noise: Dword;
                        const MeasureLight: boolean; const VR: Pointer);
  procedure CustomMatrixFilter3x3MMX1GrayScale(const Src: pointer; const SrcW,SrcH: DWord; const Filter: pointer; const Sum: Word);
  procedure CustomMatrixFilter3x3MMX1GrayScaleD(const Dest: pointer;const Src: pointer; const SrcW,SrcH: DWord; const Filter: pointer; const Sum: Word);
  procedure CustomMatrixFilter7x7MMX1GrayScale(const Src: pointer; const SrcW,SrcH: DWord; const Filter: pointer; const Sum: Word);
  procedure MinimumFilter3x3MMX1Plane(const Src: pointer; const SrcW,SrcH: DWord);
  procedure MaximumFilter3x3MMX1Plane(const Src: pointer; const SrcW,SrcH: DWord);
  procedure MedianFilter3x3MMX1Plane(const Src: pointer; const SrcW,SrcH: DWord);
  procedure MedianFilter3x3MMX1PlaneD(const Dest:pointer; const Src: pointer; const SrcW,SrcH: DWord);
  procedure RGB32toRGBPlanesMMX132(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord);
  procedure RGBPlanestoRGB32MMX132(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord);
  procedure RGB24toRGBPlanesMMX1(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord);
  procedure ORPlanesMMX132(const Dest: pointer; const Src: pointer; const Size: DWord);
  procedure XORPlanesMMX132(const Dest: pointer; const Src: pointer; const Size: DWord);
  procedure ANDPlanesMMX132(const Dest: pointer; const Src: pointer; const Size: DWord);
  procedure CopyFromWindowMMX116(const Dest: pointer; const Src: pointer; const IMGXW: dword; const X,Y: dword; const XW,YW: dword; const depth: dword);
  procedure CopyBackToWindowMMX116(const Dest: pointer; const Src: pointer; const IMGXW: dword; const X,Y: dword; const XW,YW: dword; const depth: dword);
  procedure ORBackToWindowMMX116(const Dest: pointer; const Src: pointer; const IMGXW: dword; const X,Y: dword; const XW,YW: dword; const depth: dword);
  procedure ORBackToWindowWithBlackFrameMMX116(const Dest: pointer; const Src: pointer; const IMGXW: dword; const X,Y: dword; const XW,YW: dword; const depth: dword);
  procedure CutPlanesMMX132(const Src: pointer; const Size: DWord; const Level: byte);
  procedure SearchRectangleRGBMMX1(const SrcFull,SrcRect: pointer;
                                   const SrcfullW,SrcfullH: word;
                                   const SrcRectW,SrcRectH: word;
                                   const sx,sy,ex,ey: word;
                                   var fx,fy: word;
                                   var error: dword);
  procedure SearchRectangleGrayScaleMMX1(const SrcFull,SrcRect: pointer;
                                         const SrcfullW,SrcfullH: word;
                                         const SrcRectW,SrcRectH: word;
                                         const sx,sy,ex,ey: word;
                                         var fx,fy: word;
                                         var error: dword);
  procedure SearchRectangleHSVMMX1(const SrcFull,SrcRect: pointer;
                                   const SrcfullW,SrcfullH: word;
                                   const SrcRectW,SrcRectH: word;
                                   const sx,sy,ex,ey: word;
                                   var fx,fy: word;
                                   var error: dword);
  procedure BGR32toYUY2MMX1(const Dest: pointer; const Src: pointer; const srcW,SrcH: Dword);
  procedure RGB32toYUY2MMX1(const Dest: pointer; const Src: pointer; const srcW,SrcH: Dword);
  procedure InterlaceRGB32MMX1(const Dest: pointer; const Src: pointer; const SrcW,SrcH: Dword);
  //***
  procedure CopyMemoryRGB565toRGB555_DeinterlaceOnly768x576MMX28(const Dest: Pointer;const Src: Pointer);
  procedure CopyMemoryYUY2toRGB555MMX216(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB555MMX216Interlaced(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX216(const Dest: Pointer;const Src: Pointer);
  procedure CopyMemoryYUY2toRGB555MMX216_Ymirror(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
  procedure CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX216_Ymirror(const Dest: Pointer;const Src: Pointer);
  procedure CopyMemoryRGB24toRGB555MMX224Interlaced_Ymirror(const Dest: Pointer;const Src: Pointer;const Width,Height: DWord);
  procedure YUY2DeinterlaceOnly768x576MMX216(const Src: Pointer);
  procedure YUY2DeinterlaceOnly768x576_2MMX216(const Dest,Src: Pointer);
  procedure YUY2DeinterlaceOnly768x576_2MMX216_Ymirror(const Dest,Src: Pointer);
  procedure CopyMemoryAverageYUY2MMX232(const Dest: Pointer;const Src: Pointer;const Size: DWord);
  procedure CopyMemoryAverageRGB555MMX216(const Dest: Pointer;const Src: Pointer;const Size: DWord);
  procedure VmdYUY2MMX2(const ref,new,mask: Pointer; const Size: DWord; const Noise: Dword;
                        const MeasureLight: boolean; const VR: Pointer);
  procedure MinimumFilter3x3MMX2Plane(const Src: pointer; const SrcW,SrcH: DWord);
  procedure MaximumFilter3x3MMX2Plane(const Src: pointer; const SrcW,SrcH: DWord);
  procedure MedianFilter3x3MMX2Plane(const Src: pointer; const SrcW,SrcH: DWord);
  procedure MedianFilter3x3MMX2PlaneD(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord);
  procedure MedianFilter5x5MMX2Plane(const Src: pointer; const SrcW,SrcH: DWord);

implementation

var
  MMX: integer;

procedure SetMMX(const M: integer);
begin
  MMX:=M;
end;

//****************** Header procedures

procedure CopyMemoryMMX32(const Dest: Pointer;const Src: Pointer;const Size: DWord);
begin
  case MMX of
   0: CopyMemoryMMX032(Dest,Src,Size);
   1,2: CopyMemoryMMX132(Dest,Src,Size);
  end;
end;

procedure CopyMemoryRGB565toRGB555MMX32(const Dest: Pointer;const Src: Pointer;const Size: DWord);
begin
  case MMX of
   0: CopyMemoryRGB565toRGB555MMX032(Dest,Src,Size);
   1,2: CopyMemoryRGB565toRGB555MMX132(Dest,Src,Size);
  end;
end;

procedure CopyMemoryRGB24toRGB555MMX24(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: CopyMemoryRGB24toRGB555MMX024(Dest,Src,SrcW,SrcH);
   1,2: CopyMemoryRGB24toRGB555MMX124(Dest,Src,SrcW,SrcH);
  end;
end;

procedure CopyMemoryRGB24toRGB555MMX24_Ymirror(const Dest: Pointer;const Src: Pointer;const Width,Height: DWord);
begin
  case MMX of
   0: CopyMemoryRGB24toRGB555MMX024_Ymirror(Dest,Src,Width,Height);
   1,2: CopyMemoryRGB24toRGB555MMX124_Ymirror(Dest,Src,Width,Height);
  end;
end;

procedure CopyMemoryRGB24toRGB555MMX24Interlaced_Ymirror(const Dest: Pointer;const Src: Pointer;const Width,Height: DWord);
begin
  case MMX of
   0: CopyMemoryRGB24toRGB555MMX024Interlaced_Ymirror(Dest,Src,Width,Height);
   1: CopyMemoryRGB24toRGB555MMX124Interlaced_Ymirror(Dest,Src,Width,Height);
   2: CopyMemoryRGB24toRGB555MMX224Interlaced_Ymirror(Dest,Src,Width,Height);
  end;
end;

procedure CopyMemoryRGB565toRGB555_DeinterlaceOnly768x576MMX8(const Dest: Pointer;const Src: Pointer);
begin
  case MMX of
   0: CopyMemoryRGB565toRGB555_DeinterlaceOnly768x576MMX08(Dest,Src);
   1: CopyMemoryRGB565toRGB555_DeinterlaceOnly768x576MMX18(Dest,Src);
   2: CopyMemoryRGB565toRGB555_DeinterlaceOnly768x576MMX28(Dest,Src);
  end;
end;

procedure Copy2_1_16MMX32(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: Copy2_1_16MMX032(Dest,Src,SrcW,SrcH);
   1,2: Copy2_1_16MMX132(Dest,Src,SrcW,SrcH);
  end;
end;

procedure Copy2_1_YUY16MMX32(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: Copy2_1_YUY16MMX032(Dest,Src,SrcW,SrcH);
   1,2: Copy2_1_YUY16MMX132(Dest,Src,SrcW,SrcH);
  end;
end;

procedure Copy2_1_YUY16MMX32OnlyHorizontal(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: Copy2_1_YUY16MMX032OnlyHorizontal(Dest,Src,SrcW,SrcH);
   1,2: Copy2_1_YUY16MMX132OnlyHorizontal(Dest,Src,SrcW,SrcH);
  end;
end;

procedure Copy2_1_8MMX32(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: Copy2_1_8MMX032(Dest,Src,SrcW,SrcH);
   1,2: Copy2_1_8MMX132(Dest,Src,SrcW,SrcH);
  end;
end;

procedure Copy3_1_16MMX24(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: Copy3_1_16MMX024(Dest,Src,SrcW,SrcH);
   1,2: Copy3_1_16MMX124(Dest,Src,SrcW,SrcH);
  end;
end;

procedure Copy4_1_16MMX32(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: Copy4_1_16MMX032(Dest,Src,SrcW,SrcH);
   1,2: Copy4_1_16MMX132(Dest,Src,SrcW,SrcH);
  end;
end;

procedure Copy3_2_16MMX24(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: Copy3_2_16MMX024(Dest,Src,SrcW,SrcH);
   1,2: Copy3_2_16MMX124(Dest,Src,SrcW,SrcH);
  end;
end;

procedure Copy1_2_16MMX32(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: Copy1_2_16MMX032(Dest,Src,SrcW,SrcH);
   1,2: Copy1_2_16MMX132(Dest,Src,SrcW,SrcH);
  end;
end;

procedure Copy1_4_16MMX32(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: Copy1_4_16MMX032(Dest,Src,SrcW,SrcH);
   1,2: Copy1_4_16MMX132(Dest,Src,SrcW,SrcH);
  end;
end;

procedure Copy3_4_16MMX24(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: Copy3_4_16MMX024(Dest,Src,SrcW,SrcH);
   1,2: Copy3_4_16MMX124(Dest,Src,SrcW,SrcH);
  end;
end;

procedure CopyMemoryYUY2toRGB8GrayScaleMMX32(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: CopyMemoryYUY2toRGB8GrayScaleMMX032(Dest,Src,SrcW,SrcH);
   1,2: CopyMemoryYUY2toRGB8GrayScaleMMX132(Dest,Src,SrcW,SrcH);
  end;
end;

procedure CopyMemoryYUY2toRGB8GrayScaleMMX32_Ymirror(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: CopyMemoryYUY2toRGB8GrayScaleMMX032_Ymirror(Dest,Src,SrcW,SrcH);
   1,2: CopyMemoryYUY2toRGB8GrayScaleMMX132_Ymirror(Dest,Src,SrcW,SrcH);
  end;
end;

procedure InsertMemoryGrayscaletoYUY2MMX32(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: InsertMemoryGrayscaletoYUY2MMX032(Dest,Src,SrcW,SrcH);
   1,2: InsertMemoryGrayscaletoYUY2MMX132(Dest,Src,SrcW,SrcH);
  end;
end;

procedure CopyMemoryYUY2toRGB555MMX16(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: CopyMemoryYUY2toRGB555MMX016(Dest,Src,SrcW,SrcH);
   1: CopyMemoryYUY2toRGB555MMX116(Dest,Src,SrcW,SrcH);
   2: CopyMemoryYUY2toRGB555MMX216(Dest,Src,SrcW,SrcH);
  end;
end;

procedure CopyMemoryYUY2toRGB555MMX16Interlaced(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: CopyMemoryYUY2toRGB555MMX016Interlaced(Dest,Src,SrcW,SrcH);
   1: CopyMemoryYUY2toRGB555MMX116Interlaced(Dest,Src,SrcW,SrcH);
   2: CopyMemoryYUY2toRGB555MMX216Interlaced(Dest,Src,SrcW,SrcH);
  end;
end;

procedure CopyMemoryYUY2toRGB32MMX16(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: CopyMemoryYUY2toRGB32MMX016(Dest,Src,SrcW,SrcH);
   1,2: CopyMemoryYUY2toRGB32MMX116(Dest,Src,SrcW,SrcH);
  end;
end;

procedure CopyMemoryYUY2toRGB32MMX16_Ymirror(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: CopyMemoryYUY2toRGB32MMX016_Ymirror(Dest,Src,SrcW,SrcH);
   1,2: CopyMemoryYUY2toRGB32MMX116_Ymirror(Dest,Src,SrcW,SrcH);
  end;
end;

procedure CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX16(const Dest: Pointer;const Src: Pointer);
begin
  case MMX of
   0: CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX016(Dest,Src);
   1: CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX116(Dest,Src);
   2: CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX216(Dest,Src);
  end;
end;

procedure CopyMemoryYUY2toRGB555MMX16_Ymirror(const Dest: Pointer;const Src: Pointer;const SrcW,SrcH: DWord);
begin
  case MMX of
   0: CopyMemoryYUY2toRGB555MMX016_Ymirror(Dest,Src,SrcW,SrcH);
   1: CopyMemoryYUY2toRGB555MMX116_Ymirror(Dest,Src,SrcW,SrcH);
   2: CopyMemoryYUY2toRGB555MMX216_Ymirror(Dest,Src,SrcW,SrcH);
  end;
end;

procedure CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX16_Ymirror(const Dest: Pointer;const Src: Pointer);
begin
  case MMX of
   0: CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX016_Ymirror(Dest,Src);
   1: CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX116_Ymirror(Dest,Src);
   2: CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX216_Ymirror(Dest,Src);
  end;
end;

procedure YUY2DeinterlaceOnly768x576MMX16(const Src: Pointer);
begin
  case MMX of
   0: YUY2DeinterlaceOnly768x576MMX016(Src);
   1: YUY2DeinterlaceOnly768x576MMX116(Src);
   2: YUY2DeinterlaceOnly768x576MMX216(Src);
  end;
end;

procedure YUY2DeinterlaceOnly768x576_2MMX16(const Dest,Src: Pointer);
begin
  case MMX of
   0: YUY2DeinterlaceOnly768x576_2MMX016(Dest,Src);
   1: YUY2DeinterlaceOnly768x576_2MMX116(Dest,Src);
   2: YUY2DeinterlaceOnly768x576_2MMX216(Dest,Src);
  end;
end;

procedure YUY2DeinterlaceOnly768x576_2MMX16_Ymirror(const Dest,Src: Pointer);
begin
  case MMX of
   0: YUY2DeinterlaceOnly768x576_2MMX016_Ymirror(Dest,Src);
   1: YUY2DeinterlaceOnly768x576_2MMX116_Ymirror(Dest,Src);
   2: YUY2DeinterlaceOnly768x576_2MMX216_Ymirror(Dest,Src);
  end;
end;

procedure YMirrorMMX(const pBuffer: pointer; const IWidth,IHeight: integer);
begin
  case MMX of
   0: YMirrorMMX0(pBuffer,IWidth,IHeight);
   1,2: YMirrorMMX1(pBuffer,IWidth,IHeight);
  end;
end;

procedure YMirror_2MMX(const Dest,Src: pointer; const IWidth,IHeight: integer);
begin
  case MMX of
   0: YMirror_2MMX0(Dest,Src,IWidth,IHeight);
   1,2: YMirror_2MMX1(Dest,Src,IWidth,IHeight);
  end;
end;

procedure YMirrorRGB24_2MMX(const Dest,Src: pointer; const IWidth,IHeight: integer);
begin
  case MMX of
   0: YMirrorRGB24_2MMX0(Dest,Src,IWidth,IHeight);
   1,2: YMirrorRGB24_2MMX1(Dest,Src,IWidth,IHeight);
  end;
end;

procedure CopyMemoryAverageYUY2MMX32(const Dest: Pointer;const Src: Pointer;const Size: DWord);
begin
  case MMX of
   0: CopyMemoryAverageYUY2MMX032(Dest,Src,Size);
   1: CopyMemoryAverageYUY2MMX132(Dest,Src,Size);
   2: CopyMemoryAverageYUY2MMX232(Dest,Src,Size);
  end;
end;

procedure CopyMemoryAverageRGB555MMX16(const Dest: Pointer;const Src: Pointer;const Size: DWord);
begin
  case MMX of
   0: CopyMemoryAverageRGB555MMX016(Dest,Src,Size);
   1: CopyMemoryAverageRGB555MMX116(Dest,Src,Size);
   2: CopyMemoryAverageRGB555MMX216(Dest,Src,Size);
  end;
end;

procedure VmdYUY2MMX(const ref,new,mask: Pointer; const Size: DWord; const Noise: Dword;
                     const MeasureLight: boolean; const VR: Pointer);
begin
  case MMX of
   0: VmdYUY2MMX0(ref,new,mask,Size,Noise,MeasureLight,VR);
   1: VmdYUY2MMX1(ref,new,mask,Size,Noise,MeasureLight,VR);
   2: VmdYUY2MMX2(ref,new,mask,Size,Noise,MeasureLight,VR);
  end;
end;

procedure CustomMatrixFilter3x3MMXGrayScale(const Src: pointer; const SrcW,SrcH: DWord; const Filter: pointer; const Sum: Word);
begin
  case MMX of
   0: CustomMatrixFilter3x3MMX0GrayScale(Src,SrcW,SrcH,Filter,Sum);
   1,2: CustomMatrixFilter3x3MMX1GrayScale(Src,SrcW,SrcH,Filter,Sum);
  end;
end;

procedure CustomMatrixFilter3x3MMXGrayScaleD(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord; const Filter: pointer; const Sum: Word);
begin
  case MMX of
   0: CustomMatrixFilter3x3MMX0GrayScaleD(Dest,Src,SrcW,SrcH,Filter,Sum);
   1,2: CustomMatrixFilter3x3MMX1GrayScaleD(Dest,Src,SrcW,SrcH,Filter,Sum);
  end;
end;

procedure CustomMatrixFilter7x7MMXGrayScale(const Src: pointer; const SrcW,SrcH: DWord; const Filter: pointer; const Sum: Word);
begin
  case MMX of
   0: CustomMatrixFilter7x7MMX0GrayScale(Src,SrcW,SrcH,Filter,Sum);
   1,2: CustomMatrixFilter7x7MMX1GrayScale(Src,SrcW,SrcH,Filter,Sum);
  end;
end;

procedure MinimumFilter3x3MMXPlane(const Src: pointer; const SrcW,SrcH: DWord);
begin
  case MMX of
   0: MinimumFilter3x3MMX0Plane(Src,SrcW,SrcH);
   1: MinimumFilter3x3MMX1Plane(Src,SrcW,SrcH);
   2: MinimumFilter3x3MMX2Plane(Src,SrcW,SrcH);
  end;
end;

procedure MaximumFilter3x3MMXPlane(const Src: pointer; const SrcW,SrcH: DWord);
begin
  case MMX of
   0: MaximumFilter3x3MMX0Plane(Src,SrcW,SrcH);
   1: MaximumFilter3x3MMX1Plane(Src,SrcW,SrcH);
   2: MaximumFilter3x3MMX2Plane(Src,SrcW,SrcH);
  end;
end;

procedure MedianFilter3x3MMXPlane(const Src: pointer; const SrcW,SrcH: DWord);
begin
  case MMX of
   0: MedianFilter3x3MMX0Plane(Src,SrcW,SrcH);
   1: MedianFilter3x3MMX1Plane(Src,SrcW,SrcH);
   2: MedianFilter3x3MMX2Plane(Src,SrcW,SrcH);
  end;
end;

procedure MedianFilter3x3MMXPlaneD(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord);
begin
  case MMX of
   0: MedianFilter3x3MMX0PlaneD(Dest,Src,SrcW,SrcH);
   1: MedianFilter3x3MMX1PlaneD(Dest,Src,SrcW,SrcH);
   2: MedianFilter3x3MMX2PlaneD(Dest,Src,SrcW,SrcH);
  end;
end;

procedure MedianFilter5x5MMXPlane(const Src: pointer; const SrcW,SrcH: DWord);
begin
  case MMX of
   2: MedianFilter5x5MMX2Plane(Src,SrcW,SrcH);
  end;
end;

procedure RGB32toRGBPlanesMMX32(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord);
begin
  case MMX of
   0: RGB32toRGBPlanesMMX032(Dest,Src,SrcW,SrcH);
   1,2: RGB32toRGBPlanesMMX132(Dest,Src,SrcW,SrcH);
  end;
end;

procedure RGBPlanestoRGB32MMX32(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord);
begin
  case MMX of
   0: RGBPlanestoRGB32MMX032(Dest,Src,SrcW,SrcH);
   1,2: RGBPlanestoRGB32MMX132(Dest,Src,SrcW,SrcH);
  end;
end;

procedure RGB24toRGBPlanesMMX(const Dest: pointer; const Src: pointer; const SrcW,SrcH: DWord);
begin
  case MMX of
   0: RGB24toRGBPlanesMMX0(Dest,Src,SrcW,SrcH);
   1,2: RGB24toRGBPlanesMMX1(Dest,Src,SrcW,SrcH);
  end;
end;

procedure ORPlanesMMX32(const Dest: pointer; const Src: pointer; const Size: DWord);
begin
  case MMX of
   0: ORPlanesMMX032(Dest,Src,Size);
   1,2: ORPlanesMMX132(Dest,Src,Size);
  end;
end;

procedure XORPlanesMMX32(const Dest: pointer; const Src: pointer; const Size: DWord);
begin
  case MMX of
   0: XORPlanesMMX032(Dest,Src,Size);
   1,2: XORPlanesMMX132(Dest,Src,Size);
  end;
end;

procedure ANDPlanesMMX32(const Dest: pointer; const Src: pointer; const Size: DWord);
begin
  case MMX of
   0: ANDPlanesMMX032(Dest,Src,Size);
   1,2: ANDPlanesMMX132(Dest,Src,Size);
  end;
end;

procedure CutPlanesMMX32(const Src: pointer; const Size: DWord; const Level: byte);
begin
  case MMX of
   0: CutPlanesMMX032(Src,Size,Level);
   1,2: CutPlanesMMX132(Src,Size,Level);
  end;
end;

procedure CopyFromWindowMMX16(const Dest: pointer; const Src: pointer; const IMGXW: dword; const X,Y: dword; const XW,YW: dword; const depth: dword);
begin
  case MMX of
   0: CopyFromWindowMMX016(Dest,Src,IMGXW,X,Y,XW,YW,depth);
   1,2: CopyFromWindowMMX116(Dest,Src,IMGXW,X,Y,XW,YW,depth);
  end;
end;

procedure CopyBackToWindowMMX16(const Dest: pointer; const Src: pointer; const IMGXW: dword; const X,Y: dword; const XW,YW: dword; const depth: dword);
begin
  case MMX of
   0: CopyBackToWindowMMX016(Dest,Src,IMGXW,X,Y,XW,YW,depth);
   1,2: CopyBackToWindowMMX116(Dest,Src,IMGXW,X,Y,XW,YW,depth);
  end;
end;

procedure ORBackToWindowMMX16(const Dest: pointer; const Src: pointer; const IMGXW: dword; const X,Y: dword; const XW,YW: dword; const depth: dword);
begin
  case MMX of
   0: ORBackToWindowMMX016(Dest,Src,IMGXW,X,Y,XW,YW,depth);
   1,2: ORBackToWindowMMX116(Dest,Src,IMGXW,X,Y,XW,YW,depth);
  end;
end;

procedure ORBackToWindowWithBlackFrameMMX16(const Dest: pointer; const Src: pointer; const IMGXW: dword; const X,Y: dword; const XW,YW: dword; const depth: dword);
begin
  case MMX of
   0: ORBackToWindowWithBlackFrameMMX016(Dest,Src,IMGXW,X,Y,XW,YW,depth);
   1,2: ORBackToWindowWithBlackFrameMMX116(Dest,Src,IMGXW,X,Y,XW,YW,depth);
  end;
end;

procedure SearchRectangleRGBMMX(const SrcFull,SrcRect: pointer;
                                const SrcfullW,SrcfullH: word;
                                const SrcRectW,SrcRectH: word;
                                const sx,sy,ex,ey: word;
                                var fx,fy: word;
                                var error: dword);
begin
  case MMX of
   0: SearchRectangleRGBMMX0(SrcFull,SrcRect,
                             SrcfullW,SrcfullH,SrcRectW,SrcRectH,
                             sx,sy,ex,ey,
                             fx,fy,
                             error);
   1,2: SearchRectangleRGBMMX1(SrcFull,SrcRect,
                               SrcfullW,SrcfullH,SrcRectW,SrcRectH,
                               sx,sy,ex,ey,
                               fx,fy,
                               error);
  end;
end;

procedure SearchRectangleGrayScaleMMX(const SrcFull,SrcRect: pointer;
                                      const SrcfullW,SrcfullH: word;
                                      const SrcRectW,SrcRectH: word;
                                      const sx,sy,ex,ey: word;
                                      var fx,fy: word;
                                      var error: dword);
begin
  case MMX of
   0: SearchRectangleGrayScaleMMX0(SrcFull,SrcRect,
                                   SrcfullW,SrcfullH,SrcRectW,SrcRectH,
                                   sx,sy,ex,ey,
                                   fx,fy,
                                   error);
   1,2: SearchRectangleGrayScaleMMX1(SrcFull,SrcRect,
                                     SrcfullW,SrcfullH,SrcRectW,SrcRectH,
                                     sx,sy,ex,ey,
                                     fx,fy,
                                     error);
  end;
end;

procedure SearchRectangleHSVMMX(const SrcFull,SrcRect: pointer;
                                const SrcfullW,SrcfullH: word;
                                const SrcRectW,SrcRectH: word;
                                const sx,sy,ex,ey: word;
                                var fx,fy: word;
                                var error: dword);
begin
  case MMX of
   0: SearchRectangleHSVMMX0(SrcFull,SrcRect,
                             SrcfullW,SrcfullH,SrcRectW,SrcRectH,
                             sx,sy,ex,ey,
                             fx,fy,
                             error);
   1,2: SearchRectangleHSVMMX1(SrcFull,SrcRect,
                               SrcfullW,SrcfullH,SrcRectW,SrcRectH,
                               sx,sy,ex,ey,
                               fx,fy,
                               error);
  end;
end;

procedure BGR32toYUY2MMX(const Dest: pointer; const Src: pointer; const srcW,SrcH: Dword);
begin
  case MMX of
   0: BGR32toYUY2MMX0(Dest,Src,SrcW,SrcH);
   1,2: BGR32toYUY2MMX1(Dest,Src,SrcW,SrcH);
  end;
end;

procedure RGB32toYUY2MMX(const Dest: pointer; const Src: pointer; const srcW,SrcH: Dword);
begin
  case MMX of
   0: RGB32toYUY2MMX0(Dest,Src,SrcW,SrcH);
   1,2: RGB32toYUY2MMX1(Dest,Src,SrcW,SrcH);
  end;
end;

procedure InterlaceRGB32MMX(const Dest: pointer; const Src: pointer; const SrcW,SrcH: Dword);
begin
  case MMX of
   0: InterlaceRGB32MMX0(Dest,Src,SrcW,SrcH);
   1,2: InterlaceRGB32MMX1(Dest,Src,SrcW,SrcH);
  end;
end;

//******************* MMX0
procedure CopyMemoryMMX032(const Dest: Pointer;
                           const Src: Pointer;
                           const Size: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src
   mov ecx,Size
   shr ecx,5

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure CopyMemoryRGB565toRGB555MMX032(const Dest: Pointer;
                                         const Src: Pointer;
                                         const Size: DWord);
begin
  asm
   pushad
   pushfd

   mov edi,Dest
   mov esi,Src
   mov ecx,Size
   shr ecx,5

   mov eax,$FFC0FFC0
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$ED           /// pxor mm5,mm5
   db $0F,$6E,$E8           /// movd mm5,eax
   db $0F,$EB,$E8           /// por mm5,mm0

   mov ebx,$001F001F
   db $0F,$6E,$C3           /// movd mm0,ebx
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$F6           /// pxor mm6,mm6
   db $0F,$6E,$F3           /// movd mm6,ebx
   db $0F,$EB,$F0           /// por mm6,mm0

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$DB,$C5           /// pand mm0,mm5
   db $0F,$73,$D0,$01       /// psrlq mm0,1
   db $0F,$DB,$E6           /// pand mm4,mm6
   db $0F,$EB,$C4           /// por mm0,mm4

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$DB,$CD           /// pand mm1,mm5
   db $0F,$73,$D1,$01       /// psrlq mm1,1
   db $0F,$DB,$E6           /// pand mm4,mm6
   db $0F,$EB,$CC           /// por mm1,mm4

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$DB,$D5           /// pand mm2,mm5
   db $0F,$73,$D2,$01       /// psrlq mm2,1
   db $0F,$DB,$E6           /// pand mm4,mm6
   db $0F,$EB,$D4           /// por mm2,mm4

   db $0F,$6F,$E3           /// movq mm4,mm3
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$73,$D3,$01       /// psrlq mm3,1
   db $0F,$DB,$E6           /// pand mm4,mm6
   db $0F,$EB,$DC           /// por mm3,mm4

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle
   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure CopyMemoryRGB24toRGB555MMX024(const Dest: Pointer;
                                        const Src: Pointer;
                                        const SrcW,SrcH: DWord);
var
  CacheMemory: PByte;
  SizeDiv24: Dword;
begin
  GetMem(CacheMemory,4096);
  SizeDiv24:=SrcW*SrcH div 8;
  asm
   pushad
   pushfd

   mov ebx,Pointer(CacheMemory);

   mov edi,Dest
   mov esi,Src
   mov ecx,SizeDiv24

   mov eax,$000000F8
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$DB,$5B,$10       /// pand mm3,[ebx+16]
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$73,$D3,$09       /// psrlq mm3,8+1
   db $0F,$73,$D4,$06       /// psrlq mm4,8-2
   db $0F,$73,$D5,$03       /// psrlq mm5,3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$DB,$73,$18       /// pand mm6,[ebx+24]
   db $0F,$73,$D4,$11       /// psrlq mm4,2*8+1
   db $0F,$73,$D5,$0E       /// psrlq mm5,2*8-2
   db $0F,$73,$D6,$0B       /// psrlq mm6,8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$6B,$38       /// pand mm5,[ebx+56]
   db $0F,$DB,$73,$30       /// pand mm6,[ebx+48]
   db $0F,$73,$F4,$27       /// psllq mm4,5*8-1
   db $0F,$73,$D5,$16       /// psrlq mm5,3*8-2
   db $0F,$73,$D6,$13       /// psrlq mm6,2*8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6


   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]
   db $0F,$73,$F4,$1F       /// psllq mm4,4*8-1
   db $0F,$73,$F5,$22       /// psllq mm5,4*8+2
   db $0F,$73,$F6,$25       /// psllq mm6,5*8-3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   //*** Elso mmx reg. ok

   db $0F,$6F,$F9           /// movq mm7,mm1
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$DB,$7B,$30       /// pand mm7,[ebx+48]
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$73,$D7,$29       /// psrlq mm7,5*8+1
   db $0F,$73,$D4,$26       /// psrlq mm4,5*8-2
   db $0F,$73,$D5,$23       /// psrlq mm5,4*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DB,$73,$38       /// pand mm6,[ebx+56]
   db $0F,$73,$F4,$0F       /// psllq mm4,2*8-1
   db $0F,$73,$F5,$12       /// psllq mm5,2*8+2
   db $0F,$73,$D6,$2B       /// psrlq mm6,5*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$20       /// pand mm4,[ebx+32]
   db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$73,$F4,$07       /// psllq mm4,8-1
   db $0F,$73,$F5,$0A       /// psllq mm5,8+2
   db $0F,$73,$F6,$0D       /// psllq mm6,2*8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$38       /// pand mm4,[ebx+56]
   db $0F,$DB,$6B,$30       /// pand mm5,[ebx+48]
   db $0F,$DB,$73,$28       /// pand mm6,[ebx+40]
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$F5,$02       /// psllq mm5,2
   db $0F,$73,$F6,$05       /// psllq mm6,8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$E7,$1F           /// movntq [edi],mm3
   db $0F,$E7,$7F,$08       /// movntq [edi+8],mm7

   add esi,24
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryRGB24toRGB555MMX024_Ymirror(const Dest: Pointer;
                                                const Src: Pointer;
                                                const Width,
                                                      Height: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd

   mov ebx,Pointer(CacheMemory);

   mov eax,$000000F8
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov edi,Dest
   mov esi,Src

   mov eax,Width
   shl eax,1

   mov ecx,Height
   dec ecx
@DestAdd:
   add edi,eax
   loop @DestAdd

   mov edx,Height

@MMX_MainCycle:

   mov ecx,Width
   shr ecx,3

@MMX_CopyCycle1:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$DB,$5B,$10       /// pand mm3,[ebx+16]
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$73,$D3,$09       /// psrlq mm3,8+1
   db $0F,$73,$D4,$06       /// psrlq mm4,8-2
   db $0F,$73,$D5,$03       /// psrlq mm5,3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$DB,$73,$18       /// pand mm6,[ebx+24]
   db $0F,$73,$D4,$11       /// psrlq mm4,2*8+1
   db $0F,$73,$D5,$0E       /// psrlq mm5,2*8-2
   db $0F,$73,$D6,$0B       /// psrlq mm6,8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$6B,$38       /// pand mm5,[ebx+56]
   db $0F,$DB,$73,$30       /// pand mm6,[ebx+48]
   db $0F,$73,$F4,$27       /// psllq mm4,5*8-1
   db $0F,$73,$D5,$16       /// psrlq mm5,3*8-2
   db $0F,$73,$D6,$13       /// psrlq mm6,2*8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6


   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]
   db $0F,$73,$F4,$1F       /// psllq mm4,4*8-1
   db $0F,$73,$F5,$22       /// psllq mm5,4*8+2
   db $0F,$73,$F6,$25       /// psllq mm6,5*8-3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   //*** Elso mmx reg. ok

   db $0F,$6F,$F9           /// movq mm7,mm1
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$DB,$7B,$30       /// pand mm7,[ebx+48]
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$73,$D7,$29       /// psrlq mm7,5*8+1
   db $0F,$73,$D4,$26       /// psrlq mm4,5*8-2
   db $0F,$73,$D5,$23       /// psrlq mm5,4*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DB,$73,$38       /// pand mm6,[ebx+56]
   db $0F,$73,$F4,$0F       /// psllq mm4,2*8-1
   db $0F,$73,$F5,$12       /// psllq mm5,2*8+2
   db $0F,$73,$D6,$2B       /// psrlq mm6,5*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$20       /// pand mm4,[ebx+32]
   db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$73,$F4,$07       /// psllq mm4,8-1
   db $0F,$73,$F5,$0A       /// psllq mm5,8+2
   db $0F,$73,$F6,$0D       /// psllq mm6,2*8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$38       /// pand mm4,[ebx+56]
   db $0F,$DB,$6B,$30       /// pand mm5,[ebx+48]
   db $0F,$DB,$73,$28       /// pand mm6,[ebx+40]
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$F5,$02       /// psllq mm5,2
   db $0F,$73,$F6,$05       /// psllq mm6,8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$E7,$1F           /// movntq [edi],mm3
   db $0F,$E7,$7F,$08       /// movntq [edi+8],mm7

   add esi,24
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle1

   sub edi,eax
   sub edi,eax

   dec edx
   jnz @MMX_MainCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryRGB24toRGB555MMX024Interlaced_Ymirror(const Dest: Pointer;
                                                          const Src: Pointer;
                                                          const Width,
                                                                Height: DWord);
var
  CacheMemory: PByte;
  SrcWD,SrcWQ: dword;
begin
  GetMem(CacheMemory,4096);
  SrcWD:=2*Width;
  SrcWQ:=4*Width;
  asm
   pushad
   pushfd

   mov ebx,Pointer(CacheMemory);
   mov eax,$000000F8
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov edi,Dest
   mov esi,Src

   mov ecx,Height
   dec ecx
@DestAdd:
   add edi,SrcWQ
   loop @DestAdd

   mov ecx,Width
   shr ecx,3

@MMX_CopyFirstLine:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$DB,$5B,$10       /// pand mm3,[ebx+16]
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$73,$D3,$09       /// psrlq mm3,8+1
   db $0F,$73,$D4,$06       /// psrlq mm4,8-2
   db $0F,$73,$D5,$03       /// psrlq mm5,3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$DB,$73,$18       /// pand mm6,[ebx+24]
   db $0F,$73,$D4,$11       /// psrlq mm4,2*8+1
   db $0F,$73,$D5,$0E       /// psrlq mm5,2*8-2
   db $0F,$73,$D6,$0B       /// psrlq mm6,8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$6B,$38       /// pand mm5,[ebx+56]
   db $0F,$DB,$73,$30       /// pand mm6,[ebx+48]
   db $0F,$73,$F4,$27       /// psllq mm4,5*8-1
   db $0F,$73,$D5,$16       /// psrlq mm5,3*8-2
   db $0F,$73,$D6,$13       /// psrlq mm6,2*8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6


   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]
   db $0F,$73,$F4,$1F       /// psllq mm4,4*8-1
   db $0F,$73,$F5,$22       /// psllq mm5,4*8+2
   db $0F,$73,$F6,$25       /// psllq mm6,5*8-3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   //*** Elso mmx reg. ok

   db $0F,$6F,$F9           /// movq mm7,mm1
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$DB,$7B,$30       /// pand mm7,[ebx+48]
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$73,$D7,$29       /// psrlq mm7,5*8+1
   db $0F,$73,$D4,$26       /// psrlq mm4,5*8-2
   db $0F,$73,$D5,$23       /// psrlq mm5,4*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DB,$73,$38       /// pand mm6,[ebx+56]
   db $0F,$73,$F4,$0F       /// psllq mm4,2*8-1
   db $0F,$73,$F5,$12       /// psllq mm5,2*8+2
   db $0F,$73,$D6,$2B       /// psrlq mm6,5*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$20       /// pand mm4,[ebx+32]
   db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$73,$F4,$07       /// psllq mm4,8-1
   db $0F,$73,$F5,$0A       /// psllq mm5,8+2
   db $0F,$73,$F6,$0D       /// psllq mm6,2*8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$38       /// pand mm4,[ebx+56]
   db $0F,$DB,$6B,$30       /// pand mm5,[ebx+48]
   db $0F,$DB,$73,$28       /// pand mm6,[ebx+40]
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$F5,$02       /// psllq mm5,2
   db $0F,$73,$F6,$05       /// psllq mm6,8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   mov eax,$001F001F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$58       /// movq [ebx+88],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$60       /// movq [ebx+96],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$68       /// movq [ebx+104],mm0

   mov eax,$7C1F7C1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$70       /// movq [ebx+112],mm0

   db $0F,$7F,$1F           /// movq [edi],mm3
   db $0F,$7F,$7F,$08       /// movq [edi+8],mm7

   add esi,24
   add edi,16

   dec ecx
   jnz @MMX_CopyFirstLine

   sub edi,SrcWQ
   sub edi,SrcWD

   mov edx,Height
   dec edx

@MMX_MainCycle:

   mov ecx,Width
   shr ecx,3

@MMX_CopyCycle1:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$DB,$5B,$10       /// pand mm3,[ebx+16]
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$73,$D3,$09       /// psrlq mm3,8+1
   db $0F,$73,$D4,$06       /// psrlq mm4,8-2
   db $0F,$73,$D5,$03       /// psrlq mm5,3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$DB,$73,$18       /// pand mm6,[ebx+24]
   db $0F,$73,$D4,$11       /// psrlq mm4,2*8+1
   db $0F,$73,$D5,$0E       /// psrlq mm5,2*8-2
   db $0F,$73,$D6,$0B       /// psrlq mm6,8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$6B,$38       /// pand mm5,[ebx+56]
   db $0F,$DB,$73,$30       /// pand mm6,[ebx+48]
   db $0F,$73,$F4,$27       /// psllq mm4,5*8-1
   db $0F,$73,$D5,$16       /// psrlq mm5,3*8-2
   db $0F,$73,$D6,$13       /// psrlq mm6,2*8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6


   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]
   db $0F,$73,$F4,$1F       /// psllq mm4,4*8-1
   db $0F,$73,$F5,$22       /// psllq mm5,4*8+2
   db $0F,$73,$F6,$25       /// psllq mm6,5*8-3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   //*** Elso mmx reg. ok

   db $0F,$6F,$F9           /// movq mm7,mm1
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$DB,$7B,$30       /// pand mm7,[ebx+48]
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$73,$D7,$29       /// psrlq mm7,5*8+1
   db $0F,$73,$D4,$26       /// psrlq mm4,5*8-2
   db $0F,$73,$D5,$23       /// psrlq mm5,4*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DB,$73,$38       /// pand mm6,[ebx+56]
   db $0F,$73,$F4,$0F       /// psllq mm4,2*8-1
   db $0F,$73,$F5,$12       /// psllq mm5,2*8+2
   db $0F,$73,$D6,$2B       /// psrlq mm6,5*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$20       /// pand mm4,[ebx+32]
   db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$73,$F4,$07       /// psllq mm4,8-1
   db $0F,$73,$F5,$0A       /// psllq mm5,8+2
   db $0F,$73,$F6,$0D       /// psllq mm6,2*8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$38       /// pand mm4,[ebx+56]
   db $0F,$DB,$6B,$30       /// pand mm5,[ebx+48]
   db $0F,$DB,$73,$28       /// pand mm6,[ebx+40]
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$F5,$02       /// psllq mm5,2
   db $0F,$73,$F6,$05       /// psllq mm6,8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$7F,$1F           /// movq [edi],mm3
   db $0F,$7F,$7F,$08       /// movq [edi+8],mm7

   add edi,SrcWQ
   db $0F,$6F,$0F           /// movq mm1,[edi]
   db $0F,$6F,$57,$08       /// movq mm2,[edi+8]
   sub edi,SrcWD
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$C3           /// movq mm0,mm3
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$63,$60       /// pand mm4,[ebx+96]
   db $0F,$DB,$6B,$60       /// pand mm5,[ebx+96]
   db $0F,$DB,$43,$60       /// pand mm0,[ebx+96]
   db $0F,$DB,$73,$60       /// pand mm6,[ebx+96]
   db $0F,$FD,$E0           /// paddw mm4,mm0         // pavgw mm4,mm0
   db $0F,$71,$D4,$01       /// psrlw mm4,1           //
   db $0F,$DB,$63,$60       /// pand mm4,[ebx+96]     //
   db $0F,$FD,$EE           /// paddw mm5,mm6         // pavgw mm5,mm6
   db $0F,$71,$D5,$01       /// psrlw mm5,1           //
   db $0F,$DB,$6B,$60       /// pand mm5,[ebx+96]     //
   db $0F,$DB,$4B,$70       /// pand mm1,[ebx+112]
   db $0F,$DB,$53,$70       /// pand mm2,[ebx+112]
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$7B,$70       /// pand mm7,[ebx+112]
   db $0F,$FC,$CB           /// paddb mm1,mm3         // pavgb mm1,mm3
   db $0F,$71,$D1,$01       /// psrlw mm1,1           //
   db $0F,$DB,$4B,$70       /// pand mm1,[ebx+112]    //
   db $0F,$FC,$D7           /// paddb mm2,mm7         // pavgb mm2,mm7
   db $0F,$71,$D2,$01       /// psrlw mm2,1           //
   db $0F,$DB,$53,$70       /// pand mm2,[ebx+112]    //
   db $0F,$EB,$CC           /// por mm1,mm4
   db $0F,$EB,$D5           /// por mm2,mm5
   db $0F,$E7,$0F           /// movntq [edi],mm1
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2
   sub edi,SrcWD

   add esi,24
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle1

   sub edi,SrcWQ
   sub edi,SrcWD

   dec edx
   jnz @MMX_MainCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryRGB565toRGB555_DeinterlaceOnly768x576MMX08(const Dest: Pointer;
                                                               const Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd

   mov edi,Dest
   mov esi,Src
   mov eax,Pointer(CacheMemory)

   mov ebx,$FFC0FFC0
   db $0F,$6E,$C3           /// movd mm0,ebx
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$CB           /// movd mm1,ebx
   db $0F,$EB,$C8           /// por mm1,mm0
   db $0F,$7F,$08           /// movq [eax],mm1

   mov ebx,$001F001F
   db $0F,$6E,$C3           /// movd mm0,ebx
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$CB           /// movd mm1,ebx
   db $0F,$EB,$C8           /// por mm1,mm0
   db $0F,$7F,$48,$08       /// movq [eax+8],mm1
   db $0F,$73,$F1,$05       /// psllq mm1,5
   db $0F,$7F,$48,$10       /// movq [eax+16],mm1
   db $0F,$73,$F1,$05       /// psllq mm1,5
   db $0F,$7F,$48,$18       /// movq [eax+24],mm1

   mov ecx,768*2/32

@MMX_CopyFirstLine:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$DB,$00           /// pand mm0,[eax]
   db $0F,$73,$D0,$01       /// psrlq mm0,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$C4           /// por mm0,mm4

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$DB,$08           /// pand mm1,[eax]
   db $0F,$73,$D1,$01       /// psrlq mm1,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$CC           /// por mm1,mm4

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$DB,$10           /// pand mm2,[eax]
   db $0F,$73,$D2,$01       /// psrlq mm2,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$D4           /// por mm2,mm4

   db $0F,$6F,$E3           /// movq mm4,mm3
   db $0F,$DB,$18           /// pand mm3,[eax]
   db $0F,$73,$D3,$01       /// psrlq mm3,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$DC           /// por mm3,mm4

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyFirstLine

   mov edi,Dest
   mov esi,Src

   mov ecx,(576/2)-1
   mov edx,(768*2)/8

   db $0F,$6F,$07           /// movq mm0,[edi]

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$6F,$8E,$00,$06,$00,$00/// movq mm1,[esi+768*2]
   db $0F,$6F,$96,$00,$0C,$00,$00/// movq mm2,[esi+768*4]

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$DB,$08           /// pand mm1,[eax]
   db $0F,$73,$D1,$01       /// psrlq mm1,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$CC           /// por mm1,mm4

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$DB,$10           /// pand mm2,[eax]
   db $0F,$73,$D2,$01       /// psrlq mm2,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$D4           /// por mm2,mm4

   db $0F,$EF,$F6           /// pxor mm6,mm6
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$58,$08       /// pand mm3,[eax+8]
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$DB,$68,$08       /// pand mm5,[eax+8]
   db $0F,$73,$F4,$01       /// psllq mm4,1
   db $0F,$F9,$E3           /// psubw mm4,mm3
   db $0F,$F9,$E5           /// psubw mm4,mm5
   db $0F,$FD,$DD           /// paddw mm3,mm5    // PAVGW mm3,mm5
   db $0F,$71,$D3,$01       /// psrlw mm3,1      //
   db $0F,$73,$F3,$03       /// psllq mm3,3
   db $0F,$FD,$E3           /// paddw mm4,mm3
   db $0F,$73,$D4,$03       /// psrlq mm4,3
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$F4           /// por mm6,mm4

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$58,$10       /// pand mm3,[eax+16]
   db $0F,$DB,$60,$10       /// pand mm4,[eax+16]
   db $0F,$DB,$68,$10       /// pand mm5,[eax+16]
   db $0F,$73,$F4,$01       /// psllq mm4,1
   db $0F,$F9,$E3           /// psubw mm4,mm3
   db $0F,$F9,$E5           /// psubw mm4,mm5
   db $0F,$FD,$DD           /// paddw mm3,mm5    // PAVGW mm3,mm5
   db $0F,$71,$D3,$01       /// psrlw mm3,1      //
   db $0F,$73,$F3,$03       /// psllq mm3,3
   db $0F,$FD,$E3           /// paddw mm4,mm3
   db $0F,$73,$D4,$03       /// psrlq mm4,3
   db $0F,$DB,$60,$10       /// pand mm4,[eax+16]
   db $0F,$EB,$F4           /// por mm6,mm4

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$DB,$40,$18       /// pand mm0,[eax+24]
   db $0F,$DB,$48,$18       /// pand mm1,[eax+24]
   db $0F,$DB,$50,$18       /// pand mm2,[eax+24]
   db $0F,$73,$D0,$03       /// psrlq mm0,3
   db $0F,$73,$D2,$03       /// psrlq mm2,3
   db $0F,$73,$D1,$02       /// psrlq mm1,2
   db $0F,$F9,$C8           /// psubw mm1,mm0
   db $0F,$F9,$CA           /// psubw mm1,mm2
   db $0F,$FD,$C2           /// paddw mm0,mm2    // PAVGW mm0,mm2
   db $0F,$71,$D0,$01       /// psrlw mm0,1      //
   db $0F,$73,$F0,$03       /// psllq mm0,3
   db $0F,$FD,$C8           /// paddw mm1,mm0
   db $0F,$DB,$48,$18       /// pand mm1,[eax+24]
   db $0F,$EB,$F1           /// por mm6,mm1

   db $0F,$E7,$B7,$00,$06,$00,$00/// movntq [edi+768*2],mm6
   db $0F,$7F,$A7,$00,$0C,$00,$00/// movq [edi+768*4],mm4

   add esi,8
   add edi,8

   db $0F,$6F,$07           /// movq mm0,[edi]

   dec ebx
   jnz @MMX_CopyCycle

   add esi,768*2
   add edi,768*2

   dec ecx
   jnz @MMX_Line

   mov ecx,768*2/32

   add esi,768*2
   add edi,768*2

@MMX_CopyLastLine:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$DB,$00           /// pand mm0,[eax]
   db $0F,$73,$D0,$01       /// psrlq mm0,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$C4           /// por mm0,mm4

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$DB,$08           /// pand mm1,[eax]
   db $0F,$73,$D1,$01       /// psrlq mm1,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$CC           /// por mm1,mm4

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$DB,$10           /// pand mm2,[eax]
   db $0F,$73,$D2,$01       /// psrlq mm2,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$D4           /// por mm2,mm4

   db $0F,$6F,$E3           /// movq mm4,mm3
   db $0F,$DB,$18           /// pand mm3,[eax]
   db $0F,$73,$D3,$01       /// psrlq mm3,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$DC           /// por mm3,mm4

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyLastLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure Copy2_1_16MMX032(const Dest: Pointer;
                           const Src: Pointer;
                           const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   mov eax,$0000FFFF
   db $0F,$6E,$F8           /// movd mm7,eax
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$EB,$F8           /// por mm7,mm0

   mov edx,SrcW
   shr edx,4                // edx = SrcW*2/32

   mov ecx,SrcH             // ecx = SrcH/2
   shr ecx,1

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$DB,$C7           /// pand mm0,mm7
   db $0F,$DB,$CF           /// pand mm1,mm7
   db $0F,$DB,$D7           /// pand mm2,mm7
   db $0F,$DB,$DF           /// pand mm3,mm7

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$73,$D1,$10       /// psrlq mm1,16
   db $0F,$61,$C1           /// punpcklwd mm0,mm1
   db $0F,$73,$F5,$30       /// psllq mm5,48
   db $0F,$69,$EC           /// punpckhwd mm5,mm4
   db $0F,$EB,$C5           /// por mm0,mm5

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$73,$D3,$10       /// psrlq mm3,16
   db $0F,$61,$D3           /// punpcklwd mm2,mm3
   db $0F,$73,$F5,$30       /// psllq mm5,48
   db $0F,$69,$EC           /// punpckhwd mm5,mm4
   db $0F,$EB,$D5           /// por mm2,mm5

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2

   add esi,32
   add edi,16

   dec ebx
   jnz @MMX_CopyCycle

   add esi,SrcW
   add esi,SrcW

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy2_1_YUY16MMX032(const Dest: Pointer;
                              const Src: Pointer;
                              const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   db $0F,$EF,$FF           /// pxor mm7,mm7
   mov eax,$FFFFFFFF
   db $0F,$6E,$F8           /// movd mm7,eax

   mov edx,SrcW
   shr edx,4                // edx = SrcW*2/32

   mov ecx,SrcH             // ecx = SrcH/2
   shr ecx,1

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$DB,$C7           /// pand mm0,mm7
   db $0F,$DB,$CF           /// pand mm1,mm7
   db $0F,$DB,$D7           /// pand mm2,mm7
   db $0F,$DB,$DF           /// pand mm3,mm7

   db $0F,$73,$F1,$20       /// psllq mm1,32
   db $0F,$EB,$C1           /// por mm0,mm1

   db $0F,$73,$F3,$20       /// psllq mm3,32
   db $0F,$EB,$D3           /// por mm2,mm3

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2

   add esi,32
   add edi,16

   dec ebx
   jnz @MMX_CopyCycle

   add esi,SrcW
   add esi,SrcW

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy2_1_YUY16MMX032Onlyhorizontal(const Dest: Pointer;
                                            const Src: Pointer;
                                            const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   db $0F,$EF,$FF           /// pxor mm7,mm7
   mov eax,$FFFFFFFF
   db $0F,$6E,$F8           /// movd mm7,eax

   mov edx,SrcW
   shr edx,4                // edx = SrcW*2/32

   mov ecx,SrcH             // ecx = SrcH

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$DB,$C7           /// pand mm0,mm7
   db $0F,$DB,$CF           /// pand mm1,mm7
   db $0F,$DB,$D7           /// pand mm2,mm7
   db $0F,$DB,$DF           /// pand mm3,mm7

   db $0F,$73,$F1,$20       /// psllq mm1,32
   db $0F,$EB,$C1           /// por mm0,mm1

   db $0F,$73,$F3,$20       /// psllq mm3,32
   db $0F,$EB,$D3           /// por mm2,mm3

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2

   add esi,32
   add edi,16

   dec ebx
   jnz @MMX_CopyCycle

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy2_1_8MMX032(const Dest: Pointer;
                          const Src: Pointer;
                          const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   mov eax,$00FF00FF
   db $0F,$6E,$F0           /// movd mm6,eax
   db $0F,$73,$F6,$20       /// psllq mm6,32
   db $0F,$6E,$F8           /// movd mm7,eax
   db $0F,$EB,$FE           /// por mm7,mm6

   mov edx,SrcW
   shr edx,5                // edx = SrcW/32

   mov ecx,SrcH             // ecx = SrcH/2
   shr ecx,1

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$DB,$C7           /// pand mm0,mm7
   db $0F,$DB,$CF           /// pand mm1,mm7
   db $0F,$DB,$D7           /// pand mm2,mm7
   db $0F,$DB,$DF           /// pand mm3,mm7

   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$73,$D0,$20       /// psrlq mm0,32
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$73,$F1,$20       /// psllq mm1,32
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$73,$D2,$20       /// psrlq mm2,32
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$73,$F3,$20       /// psllq mm3,32

   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$EB,$D3           /// por mm2,mm3

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2

   add esi,32
   add edi,16

   dec ebx
   jnz @MMX_CopyCycle

   add esi,SrcW

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy3_1_16MMX024(const Dest: Pointer;
                           const Src: Pointer;
                           const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   mov eax,$FFFF0000
   db $0F,$6E,$F8           /// movd mm7,eax
   db $0F,$73,$F7,$20       /// psllq mm7,32

   mov eax,$0000FFFF
   db $0F,$6E,$F0           /// movd mm6,eax
   db $0F,$73,$F6,$20       /// psllq mm6,32

   db $0F,$EF,$ED           /// pxor mm5,mm5
   mov eax,$FFFF0000
   db $0F,$6E,$E8           /// movd mm5,eax

   db $0F,$EF,$E4           /// pxor mm4,mm4
   mov eax,$0000FFFF
   db $0F,$6E,$E0           /// movd mm4,eax

   xor edx,edx
   mov eax,SrcW
   mov cx,12
   div cx                   // edx = SrcW*2/24
   mov dx,ax
   and edx,$0000FFFF

   push edx
   xor edx,edx
   mov eax,SrcH             // ecx = SrcH/3
   mov cx,3
   div cx
   mov cx,ax
   and ecx,$0000FFFF
   pop edx

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$DB,$C4           /// pand mm0,mm4
   db $0F,$DB,$DF           /// pand mm3,mm7
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$EB,$C3           /// por mm0,mm3
   db $0F,$DB,$CE           /// pand mm1,mm6
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$DB,$D5           /// pand mm2,mm5
   db $0F,$73,$F2,$20       /// psllq mm2,32
   db $0F,$EB,$C2           /// por mm0,mm2

   db $0F,$E7,$07           /// movntq [edi],mm0

   add esi,24
   add edi,8

   dec ebx
   jnz @MMX_CopyCycle

   add esi,SrcW
   add esi,SrcW
   add esi,SrcW
   add esi,SrcW

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy4_1_16MMX032(const Dest: Pointer;
                           const Src: Pointer;
                           const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   db $0F,$EF,$FF           /// pxor mm7,mm7
   mov eax,$0000FFFF
   db $0F,$6E,$F8           /// movd mm7,eax

   mov edx,SrcW
   shr edx,4                // edx = SrcW*2/32

   mov ecx,SrcH             // ecx = SrcH/4
   shr ecx,2

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$DB,$C7           /// pand mm0,mm7
   db $0F,$DB,$CF           /// pand mm1,mm7
   db $0F,$DB,$D7           /// pand mm2,mm7
   db $0F,$DB,$DF           /// pand mm3,mm7

   db $0F,$73,$F1,$10       /// psllq mm1,16
   db $0F,$73,$F2,$20       /// psllq mm2,32
   db $0F,$73,$F3,$30       /// psllq mm3,48

   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$EB,$C3           /// por mm0,mm3

   db $0F,$E7,$07           /// movntq [edi],mm0

   add esi,32
   add edi,8

   dec ebx
   jnz @MMX_CopyCycle

   add esi,SrcW
   add esi,SrcW
   add esi,SrcW
   add esi,SrcW
   add esi,SrcW
   add esi,SrcW

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy3_2_16MMX024(const Dest: Pointer;
                           const Src: Pointer;
                           const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   mov eax,$FFFF0000
   db $0F,$6E,$F8           /// movd mm7,eax
   db $0F,$73,$F7,$20       /// psllq mm7,32

   db $0F,$EF,$F6           /// pxor mm6,mm6
   mov eax,$0000FFFF
   db $0F,$6E,$F0           /// movd mm6,eax

   db $0F,$EF,$ED           /// pxor mm5,mm5
   mov eax,$FFFFFFFF
   db $0F,$6E,$E8           /// movd mm5,eax

   mov eax,$FFFFFFFF
   db $0F,$6E,$E0           /// movd mm4,eax
   db $0F,$73,$F4,$20       /// psllq mm4,32

   xor edx,edx
   mov eax,SrcW
   mov cx,12
   div cx                   // edx = SrcW*2/24
   mov dx,ax
   and edx,$0000FFFF

   push edx
   xor edx,edx
   mov eax,SrcH             // ecx = SrcH/3
   mov cx,3
   div cx
   mov cx,ax
   and ecx,$0000FFFF
   pop edx

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle1:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$DB,$C5           /// pand mm0,mm5
   db $0F,$DB,$DF           /// pand mm3,mm7
   db $0F,$73,$D3,$10       /// psrlq mm3,16
   db $0F,$EB,$C3           /// por mm0,mm3
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$DB,$CE           /// pand mm1,mm6
   db $0F,$73,$F1,$30       /// psllq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1

   db $0F,$DB,$DC           /// pand mm3,mm4
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$73,$F2,$10       /// psllq mm2,16
   db $0F,$DB,$D4           /// pand mm2,mm4
   db $0F,$EB,$D3           /// por mm2,mm3

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2

   add esi,24
   add edi,16

   dec ebx
   jnz @MMX_CopyCycle1

   mov ebx,edx

@MMX_CopyCycle2:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$DB,$C5           /// pand mm0,mm5
   db $0F,$DB,$DF           /// pand mm3,mm7
   db $0F,$73,$D3,$10       /// psrlq mm3,16
   db $0F,$EB,$C3           /// por mm0,mm3
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$DB,$CE           /// pand mm1,mm6
   db $0F,$73,$F1,$30       /// psllq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1

   db $0F,$DB,$DC           /// pand mm3,mm4
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$73,$F2,$10       /// psllq mm2,16
   db $0F,$DB,$D4           /// pand mm2,mm4
   db $0F,$EB,$D3           /// por mm2,mm3

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2

   add esi,24
   add edi,16

   dec ebx
   jnz @MMX_CopyCycle2

   add esi,SrcW
   add esi,SrcW

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy1_2_16MMX032(const Dest: Pointer;
                           const Src: Pointer;
                           const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   mov edx,SrcW
   shr edx,4                // edx = SrcW*2/32

   mov ecx,SrcH             // ecx = SrcH

   mov eax,Srcw             // eax=SrcW*4
   shl eax,2

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$56,$08       /// movq mm2,[esi+8]
   db $0F,$6F,$66,$10       /// movq mm4,[esi+16]
   db $0F,$6F,$76,$18       /// movq mm6,[esi+24]

   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$69,$C8           /// punpckhwd mm1,mm0
   db $0F,$61,$C0           /// punpcklwd mm0,mm0

   db $0F,$6F,$DA           /// movq mm3,mm2
   db $0F,$69,$DA           /// punpckhwd mm3,mm2
   db $0F,$61,$D2           /// punpcklwd mm2,mm2

   db $0F,$6F,$EC           /// movq mm5,mm4
   db $0F,$69,$EC           /// punpckhwd mm5,mm4
   db $0F,$61,$E4           /// punpcklwd mm4,mm4

   db $0F,$6F,$FE           /// movq mm7,mm6
   db $0F,$69,$FE           /// punpckhwd mm7,mm6
   db $0F,$61,$F6           /// punpcklwd mm6,mm6

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3
   db $0F,$E7,$67,$20       /// movntq [edi+32],mm4
   db $0F,$E7,$6F,$28       /// movntq [edi+40],mm5
   db $0F,$E7,$77,$30       /// movntq [edi+48],mm6
   db $0F,$E7,$7F,$38       /// movntq [edi+56],mm7
   db $0F,$E7,$04,$07       /// movntq [edi+eax],mm0
   db $0F,$E7,$4C,$07,$08   /// movntq [edi+eax+8],mm1
   db $0F,$E7,$54,$07,$10   /// movntq [edi+eax+16],mm2
   db $0F,$E7,$5C,$07,$18   /// movntq [edi+eax+24],mm3
   db $0F,$E7,$64,$07,$20   /// movntq [edi+eax+32],mm4
   db $0F,$E7,$6C,$07,$28   /// movntq [edi+eax+40],mm5
   db $0F,$E7,$74,$07,$30   /// movntq [edi+eax+48],mm6
   db $0F,$E7,$7C,$07,$38   /// movntq [edi+eax+56],mm7

   add esi,32
   add edi,64

   dec ebx
   jnz @MMX_CopyCycle

   add edi,eax

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy1_4_16MMX032(const Dest: Pointer;
                           const Src: Pointer;
                           const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   mov edx,SrcW
   shr edx,3                // edx = SrcW*2/16

   mov ecx,SrcH             // ecx = SrcH

   mov eax,Srcw             // eax = SrcW*8
   shl eax,3

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$66,$08       /// movq mm4,[esi+8]

   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$69,$C0           /// punpckhwd mm0,mm0
   db $0F,$69,$C0           /// punpckhwd mm0,mm0
   db $0F,$73,$F1,$10       /// psllq mm1,16
   db $0F,$6F,$D1           /// movq mm2,mm1
   db $0F,$69,$C9           /// punpckhwd mm1,mm1
   db $0F,$69,$C9           /// punpckhwd mm1,mm1
   db $0F,$73,$F2,$10       /// psllq mm2,16
   db $0F,$6F,$DA           /// movq mm3,mm2
   db $0F,$69,$D2           /// punpckhwd mm2,mm2
   db $0F,$69,$D2           /// punpckhwd mm2,mm2
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$69,$DB           /// punpckhwd mm3,mm3
   db $0F,$69,$DB           /// punpckhwd mm3,mm3

   db $0F,$6F,$EC           /// movq mm5,mm4
   db $0F,$69,$E4           /// punpckhwd mm4,mm4
   db $0F,$69,$E4           /// punpckhwd mm4,mm4
   db $0F,$73,$F5,$10       /// psllq mm5,16
   db $0F,$6F,$F5           /// movq mm6,mm5
   db $0F,$69,$ED           /// punpckhwd mm5,mm5
   db $0F,$69,$ED           /// punpckhwd mm5,mm5
   db $0F,$73,$F6,$10       /// psllq mm6,16
   db $0F,$6F,$FE           /// movq mm7,mm6
   db $0F,$69,$F6           /// punpckhwd mm6,mm6
   db $0F,$69,$F6           /// punpckhwd mm6,mm6
   db $0F,$73,$F7,$10       /// psllq mm7,16
   db $0F,$69,$FF           /// punpckhwd mm7,mm7
   db $0F,$69,$FF           /// punpckhwd mm7,mm7

   push ecx
   mov ecx,4
@4Lines:
   db $0F,$E7,$1F           /// movntq [edi],mm3
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2
   db $0F,$E7,$4F,$10       /// movntq [edi+16],mm1
   db $0F,$E7,$47,$18       /// movntq [edi+24],mm0
   db $0F,$E7,$7F,$20       /// movntq [edi+32],mm7
   db $0F,$E7,$77,$28       /// movntq [edi+40],mm6
   db $0F,$E7,$6F,$30       /// movntq [edi+48],mm5
   db $0F,$E7,$67,$38       /// movntq [edi+56],mm4
   add edi,eax
   dec ecx
   jnz @4Lines
   pop ecx

   sub edi,eax
   sub edi,eax
   sub edi,eax
   sub edi,eax

   add esi,16
   add edi,64

   dec ebx
   jnz @MMX_CopyCycle

   add edi,eax
   add edi,eax
   add edi,eax

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy3_4_16MMX024(const Dest: Pointer;
                           const Src: Pointer;
                           const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   xor edx,edx
   mov eax,SrcW
   mov cx,12
   div cx                   // edx = SrcW*2/24
   mov dx,ax
   and edx,$0000FFFF

   push edx
   xor edx,edx
   mov eax,SrcH             // ecx = SrcH/3
   mov cx,3
   div cx
   mov cx,ax
   and ecx,$0000FFFF
   pop edx

   db $0F,$EF,$DB           /// pxor mm3,mm3
   mov eax,$0000FFFF
   db $0F,$6E,$D8           /// movd mm3,eax

   mov eax,$FFFFFFFF
   db $0F,$6E,$E0           /// movd mm4,eax
   db $0F,$73,$F4,$20       /// psllq mm4,32
   mov eax,$FFFF0000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$EB,$E0           /// por mm4,mm0


@MMX_Line:

   mov eax,2

@MMX_2Line:

   mov ebx,edx

@MMX_CopyCycle1:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$73,$F5,$10       /// psllq mm5,16
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$F3           /// pand mm6,mm3
   db $0F,$EB,$EE           /// por mm5,mm6

   db $0F,$73,$D0,$30       /// psrlq mm0,48
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$73,$F6,$10       /// psllq mm6,16
   db $0F,$EB,$F0           /// por mm6,mm0
   db $0F,$6F,$F9           /// movq mm7,mm1
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$F7           /// por mm6,mm7

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$73,$D0,$20       /// psrlq mm0,32
   db $0F,$DB,$C3           /// pand mm0,mm3
   db $0F,$73,$D1,$10       /// psrlq mm1,16
   db $0F,$DB,$CC           /// pand mm1,mm4
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$73,$F7,$30       /// psllq mm7,48
   db $0F,$EB,$F8           /// por mm7,mm0

   db $0F,$6F,$C2           /// movq mm0,mm2
   db $0F,$73,$D0,$10       /// psrlq mm0,16
   db $0F,$DB,$C3           /// pand mm0,mm3
   db $0F,$DB,$D4           /// pand mm2,mm4
   db $0F,$EB,$D0           /// por mm2,mm0

   db $0F,$E7,$2F           /// movntq [edi],mm5
   db $0F,$E7,$77,$08       /// movntq [edi+8],mm6
   db $0F,$E7,$7F,$10       /// movntq [edi+16],mm7
   db $0F,$E7,$57,$18       /// movntq [edi+24],mm2

   add esi,24
   add edi,32

   dec ebx
   jnz @MMX_CopyCycle1

   dec eax
   jnz @MMX_2Line


   push edx
   xor edx,edx
   mov eax,SrcW             // eax=SrcW*2*(4/3)
   shl ax,3
   mov bx,3
   div bx
   and eax,$0000FFFF
   pop edx

   mov ebx,edx

@MMX_CopyCycle2:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$73,$F5,$10       /// psllq mm5,16
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$F3           /// pand mm6,mm3
   db $0F,$EB,$EE           /// por mm5,mm6

   db $0F,$73,$D0,$30       /// psrlq mm0,48
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$73,$F6,$10       /// psllq mm6,16
   db $0F,$EB,$F0           /// por mm6,mm0
   db $0F,$6F,$F9           /// movq mm7,mm1
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$F7           /// por mm6,mm7

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$73,$D0,$20       /// psrlq mm0,32
   db $0F,$DB,$C3           /// pand mm0,mm3
   db $0F,$73,$D1,$10       /// psrlq mm1,16
   db $0F,$DB,$CC           /// pand mm1,mm4
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$73,$F7,$30       /// psllq mm7,48
   db $0F,$EB,$F8           /// por mm7,mm0

   db $0F,$6F,$C2           /// movq mm0,mm2
   db $0F,$73,$D0,$10       /// psrlq mm0,16
   db $0F,$DB,$C3           /// pand mm0,mm3
   db $0F,$DB,$D4           /// pand mm2,mm4
   db $0F,$EB,$D0           /// por mm2,mm0

   db $0F,$E7,$2F           /// movntq [edi],mm5
   db $0F,$E7,$77,$08       /// movntq [edi+8],mm6
   db $0F,$E7,$7F,$10       /// movntq [edi+16],mm7
   db $0F,$E7,$57,$18       /// movntq [edi+24],mm2
   db $0F,$E7,$2C,$07       /// movntq [edi+eax],mm5
   db $0F,$E7,$74,$07,$08   /// movntq [edi+eax+8],mm6
   db $0F,$E7,$7C,$07,$10   /// movntq [edi+eax+16],mm7
   db $0F,$E7,$54,$07,$18   /// movntq [edi+eax+24],mm2

   add esi,24
   add edi,32

   dec ebx
   jnz @MMX_CopyCycle2

   add edi,eax

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX016(const Dest: Pointer;
                                                              const Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov esi,Src
   mov edi,Dest

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$FF00FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov eax,$001F001F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$58       /// movq [ebx+88],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$60       /// movq [ebx+96],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$68       /// movq [ebx+104],mm0

   mov eax,$7C1F7C1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$70       /// movq [ebx+112],mm0

   mov eax,$F8F8F8F8
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$78       /// movq [ebx+120],mm0

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyFirstLine:
   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyFirstLine

   mov edx,574/2

@MMX_CopyLine:

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyCycle1:
   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle1

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyCycle2:
   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3
   db $0F,$6F,$FB           /// movq mm7,mm3

   db $0F,$6F,$8F,$00,$FA,$FF,$FF/// movq mm1,[edi-768*2]
   db $0F,$6F,$97,$00,$F4,$FF,$FF/// movq mm2,[edi-768*4]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$63,$70       /// pand mm4,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$6F,$F3           /// movq mm6,mm3
   db $0F,$FC,$F5           /// paddb mm6,mm5          //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]     //
   db $0F,$71,$D4,$01       /// psrlw mm4,1
   db $0F,$FC,$F4           /// paddb mm6,mm4          //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]     //
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]

   db $0F,$DB,$43,$60       /// pand mm0,[ebx+96]
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$DB,$53,$60       /// pand mm2,[ebx+96]
   db $0F,$73,$F1,$01       /// psllq mm1,1
   db $0F,$F9,$C8           /// psubw mm1,mm0
   db $0F,$F9,$CA           /// psubw mm1,mm2
   db $0F,$FD,$C2           /// paddw mm0,mm2          // PAVGW mm0,mm2
   db $0F,$71,$D0,$01       /// psrlw mm0,1
   db $0F,$73,$F0,$03       /// psllq mm0,3
   db $0F,$FD,$C8           /// paddw mm1,mm0
   db $0F,$73,$D1,$03       /// psrlq mm1,3
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$EB,$F1           /// por mm6,mm1

   db $0F,$E7,$B7,$00,$FA,$FF,$FF/// movntq [edi-768*2],mm6

   db $0F,$6F,$C7           /// movq mm0,mm7
   db $0F,$6F,$8F,$08,$FA,$FF,$FF/// movq mm1,[edi-768*2+8]
   db $0F,$6F,$97,$08,$F4,$FF,$FF/// movq mm2,[edi-768*4+8]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$63,$70       /// pand mm4,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$6F,$F3           /// movq mm6,mm3
   db $0F,$FC,$F5           /// paddb mm6,mm5          //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]     //
   db $0F,$71,$D4,$01       /// psrlw mm4,1
   db $0F,$FC,$F4           /// paddb mm6,mm4          //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]     //
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]

   db $0F,$DB,$43,$60       /// pand mm0,[ebx+96]
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$DB,$53,$60       /// pand mm2,[ebx+96]
   db $0F,$73,$F1,$01       /// psllq mm1,1
   db $0F,$F9,$C8           /// psubw mm1,mm0
   db $0F,$F9,$CA           /// psubw mm1,mm2
   db $0F,$FD,$C2           /// paddw mm0,mm2          // PAVGW mm0,mm2
   db $0F,$71,$D0,$01       /// psrlw mm0,1
   db $0F,$73,$F0,$03       /// psllq mm0,3
   db $0F,$FD,$C8           /// paddw mm1,mm0
   db $0F,$73,$D1,$03       /// psrlq mm1,3
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$EB,$F1           /// por mm6,mm1

   db $0F,$E7,$B7,$08,$FA,$FF,$FF/// movntq [edi-768*2+8],mm6

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle2

   dec edx
   jnz @MMX_CopyLine

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyLastLine:
   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyLastLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB8GrayScaleMMX032(const Dest: Pointer;
                                              const Src: Pointer;
                                              const SrcW: DWord;
                                              const SrcH: DWord);
var
  CacheMemory: PByte;
  PN: dword;
begin
  GetMem(CacheMemory,4096);
  PN:=SrcW*2 div 32*SrcH;
  asm
   pushad
   pushfd
   mov edi,Dest

   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov ecx,PN

@MMX_CopyCycle:
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$DB,$03           /// pand mm0,[ebx]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$DB,$0B           /// pand mm1,[ebx]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$73,$D0,$20       /// psrlq mm0,32
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$73,$F1,$20       /// psllq mm1,32
   db $0F,$EB,$C1           /// por mm0,mm1

   db $0F,$DB,$13           /// pand mm2,[ebx]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$DB,$1B           /// pand mm3,[ebx]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$73,$D2,$20       /// psrlq mm2,32
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$73,$F3,$20       /// psllq mm3,32
   db $0F,$EB,$D3           /// por mm2,mm3

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2

   add esi,32
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB8GrayScaleMMX032_Ymirror(const Dest: Pointer;
                                                      const Src: Pointer;
                                                      const SrcW: DWord;
                                                      const SrcH: DWord);
var
  CacheMemory: PByte;
  SrcWD32,
  Size,
  Line2: dword;
begin
  GetMem(CacheMemory,4096);
  Size:=(SrcH-1)*SrcW;
  SrcWD32:=SrcW*2 div 32;
  Line2:=2*SrcW;
  asm
   pushad
   pushfd
   mov edi,Dest
   add edi,Size

   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov edx,SrcH

@MMX_Line:

   mov ecx,SrcWD32

@MMX_CopyCycle:
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$DB,$03           /// pand mm0,[ebx]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$DB,$0B           /// pand mm1,[ebx]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$73,$D0,$20       /// psrlq mm0,32
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$73,$F1,$20       /// psllq mm1,32
   db $0F,$EB,$C1           /// por mm0,mm1

   db $0F,$DB,$13           /// pand mm2,[ebx]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$DB,$1B           /// pand mm3,[ebx]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$73,$D2,$20       /// psrlq mm2,32
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$73,$F3,$20       /// psllq mm3,32
   db $0F,$EB,$D3           /// por mm2,mm3

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2

   add esi,32
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   sub edi,Line2

   dec edx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure InsertMemoryGrayscaletoYUY2MMX032(const Dest: Pointer;
                                            const Src: Pointer;
                                            const SrcW,SrcH: DWord);
var
  PN: dword;
  CacheMemory: Pointer;
begin
  GetMem(CacheMemory,4096);
  PN:=SrcW*2 div 32*SrcH;
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$FF00FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   db $0F,$EF,$FF           /// pxor mm7,mm7

   mov ecx,PN

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$17           /// movq mm2,[edi]
   db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]
   db $0F,$6F,$67,$10       /// movq mm4,[edi+16]
   db $0F,$6F,$6F,$18       /// movq mm5,[edi+24]

   db $0F,$DB,$13           /// pand mm2,[ebx]  // C Y3 C Y2 C Y1 C Y0
   db $0F,$DB,$1B           /// pand mm3,[ebx]  // C Y7 C Y6 C Y5 C Y4
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$2B           /// pand mm5,[ebx]

   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$60,$C7           /// punpcklbw mm0,mm7
   db $0F,$EB,$D0           /// por mm2,mm0
   db $0F,$68,$F7           /// punpckhbw mm6,mm7
   db $0F,$EB,$DE           /// por mm3,mm6

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$60,$CF           /// punpcklbw mm1,mm7
   db $0F,$EB,$E1           /// por mm4,mm1
   db $0F,$68,$F7           /// punpckhbw mm6,mm7
   db $0F,$EB,$EE           /// por mm5,mm6

   db $0F,$E7,$17           /// movntq [edi],mm2
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3
   db $0F,$E7,$67,$10       /// movntq [edi+16],mm4
   db $0F,$E7,$6F,$18       /// movntq [edi+24],mm5

   add esi,16
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB555MMX016(const Dest: Pointer;
                                       const Src: Pointer;
                                       const SrcW: DWord;
                                       const SrcH: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov edi,Dest

   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$FF00FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov eax,$F8F8F8F8
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$78       /// movq [ebx+120],mm0

   mov edx,SrcH

@MMX_CopyLine:

   mov ecx,SrcW             // ecx=(SrcW*2)/16
   shr ecx,3

@MMX_CopyCycle:
   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   dec edx
   jnz @MMX_CopyLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB555MMX016Interlaced(const Dest: Pointer;
                                                 const Src: Pointer;
                                                 const SrcW: DWord;
                                                 const SrcH: DWord);
var
  CacheMemory: PByte;
  SrcWD,
  SrcWQ: dword;
begin
  GetMem(CacheMemory,4096);
  SrcWD:=2*SrcW;
  SrcWQ:=4*SrcW;
  asm
   pushad
   pushfd
   mov edi,Dest

   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$FF00FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov eax,$001F001F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$58       /// movq [ebx+88],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$60       /// movq [ebx+96],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$68       /// movq [ebx+104],mm0

   mov eax,$7C1F7C1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$70       /// movq [ebx+112],mm0

   mov eax,$F8F8F8F8
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$78       /// movq [ebx+120],mm0

   mov ecx,SrcW             // ecx=(SrcW*2)/16
   shr ecx,3

@MMX_CopyFirstLine:

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyFirstLine

   add edi,SrcWD

   mov edx,SrcH
   dec edx

@MMX_CopyLine:

   mov ecx,SrcW             // ecx=(SrcW*2)/16
   shr ecx,3

@MMX_CopyCycle:

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   sub edi,SrcWQ
   db $0F,$6F,$0F           /// movq mm1,[edi]
   db $0F,$6F,$57,$08       /// movq mm2,[edi+8]
   add edi,SrcWD
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$63,$60       /// pand mm4,[ebx+96]
   db $0F,$DB,$6B,$60       /// pand mm5,[ebx+96]
   db $0F,$DB,$73,$60       /// pand mm6,[ebx+96]
   db $0F,$DB,$7B,$60       /// pand mm7,[ebx+96]
   db $0F,$FD,$E6           /// paddw mm4,mm6         // pavgw mm4,mm6
   db $0F,$71,$D4,$01       /// psrlw mm4,1           //
   db $0F,$DB,$63,$60       /// pand mm4,[ebx+96]     //
   db $0F,$FD,$EF           /// paddw mm5,mm7         // pavgw mm5,mm7
   db $0F,$71,$D5,$01       /// psrlw mm5,1           //
   db $0F,$DB,$6B,$60       /// pand mm5,[ebx+96]     //
   db $0F,$DB,$4B,$70       /// pand mm1,[ebx+112]
   db $0F,$DB,$53,$70       /// pand mm2,[ebx+112]
   db $0F,$DB,$43,$70       /// pand mm0,[ebx+112]
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$FC,$C8           /// paddb mm1,mm0         // pavgb mm1,mm0
   db $0F,$71,$D1,$01       /// psrlw mm1,1           //
   db $0F,$DB,$4B,$70       /// pand mm1,[ebx+112]    //
   db $0F,$FC,$D3           /// paddb mm2,mm3         // pavgb mm2,mm3
   db $0F,$71,$D2,$01       /// psrlw mm2,1           //
   db $0F,$DB,$53,$70       /// pand mm2,[ebx+112]    //
   db $0F,$EB,$CC           /// por mm1,mm4
   db $0F,$EB,$D5           /// por mm2,mm5
   db $0F,$E7,$0F           /// movntq [edi],mm1
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2
   add edi,SrcWD

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   add edi,SrcWD

   dec edx
   jnz @MMX_CopyLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB32MMX016(const Dest: Pointer;
                                      const Src: Pointer;
                                      const SrcW: DWord;
                                      const SrcH: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd

   mov edi,Dest
   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$FF00FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov edx,SrcH

@MMX_CopyLine:

   mov ecx,SrcW             // ecx=(SrcW*2)/16
   shr ecx,3

@MMX_CopyCycle:

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   // mm1=R
   // mm2=G
   // mm0=B

   db $0F,$EF,$FF           /// pxor mm7,mm7

   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$1F           /// movntq [edi],mm3

   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$73,$D3,$10       /// psrlq mm3,16
   db $0F,$73,$D4,$10       /// psrlq mm4,16
   db $0F,$73,$D5,$10       /// psrlq mm5,16
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$73,$D5,$20       /// psrlq mm5,32
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$10       /// movntq [edi+16],mm3

   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$73,$D3,$30       /// psrlq mm3,48
   db $0F,$73,$D4,$30       /// psrlq mm4,48
   db $0F,$73,$D5,$30       /// psrlq mm5,48
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,16
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   dec edx
   jnz @MMX_CopyLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB32MMX016_Ymirror(const Dest: Pointer;
                                              const Src: Pointer;
                                              const SrcW: DWord;
                                              const SrcH: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd

   mov edi,Dest
   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$FF00FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov eax,SrcW
   shl eax,2

   mov ecx,SrcH
   dec ecx
@DestAdd:
   add edi,eax
   loop @DestAdd

   mov edx,SrcH

@MMX_CopyLine:

   mov ecx,SrcW             // ecx=(SrcW*2)/16
   shr ecx,3

@MMX_CopyCycle:

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   // mm1=R
   // mm2=G
   // mm0=B

   db $0F,$EF,$FF           /// pxor mm7,mm7

   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$1F           /// movntq [edi],mm3

   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$73,$D3,$10       /// psrlq mm3,16
   db $0F,$73,$D4,$10       /// psrlq mm4,16
   db $0F,$73,$D5,$10       /// psrlq mm5,16
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$73,$D5,$20       /// psrlq mm5,32
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$10       /// movntq [edi+16],mm3

   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$73,$D3,$30       /// psrlq mm3,48
   db $0F,$73,$D4,$30       /// psrlq mm4,48
   db $0F,$73,$D5,$30       /// psrlq mm5,48
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,16
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   sub edi,eax
   sub edi,eax

   dec edx
   jnz @MMX_CopyLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX016_Ymirror(const Dest: Pointer;
                                                                      const Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov esi,Src
   mov edi,Dest
   mov ecx,576-1
@CALC_edi:
   add edi,768*2
   loop @CALC_edi

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$FF00FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov eax,$001F001F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$58       /// movq [ebx+88],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$60       /// movq [ebx+96],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$68       /// movq [ebx+104],mm0

   mov eax,$7C1F7C1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$70       /// movq [ebx+112],mm0

   mov eax,$F8F8F8F8
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$78       /// movq [ebx+120],mm0

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyFirstLine:

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyFirstLine
   sub edi,768*4

   mov edx,574/2

@MMX_CopyLine:

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyCycle1:

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle1
   sub edi,768*4

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyCycle2:

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3
   db $0F,$6F,$FB           /// movq mm7,mm3

   db $0F,$6F,$8F,$00,$06,$00,$00/// movq mm1,[edi+768*2]
   db $0F,$6F,$97,$00,$0C,$00,$00/// movq mm2,[edi+768*4]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$63,$70       /// pand mm4,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$6F,$F3           /// movq mm6,mm3
   db $0F,$FC,$F5           /// paddb mm6,mm5          //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]     //
   db $0F,$71,$D4,$01       /// psrlw mm4,1
   db $0F,$FC,$F4           /// paddb mm6,mm4          //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]     //
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]

   db $0F,$DB,$43,$60       /// pand mm0,[ebx+96]
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$DB,$53,$60       /// pand mm2,[ebx+96]
   db $0F,$73,$F1,$01       /// psllq mm1,1
   db $0F,$F9,$C8           /// psubw mm1,mm0
   db $0F,$F9,$CA           /// psubw mm1,mm2
   db $0F,$FD,$C2           /// paddw mm0,mm2          // PAVGW mm0,mm2
   db $0F,$71,$D0,$01       /// psrlw mm0,1            //
   db $0F,$73,$F0,$03       /// psllq mm0,3
   db $0F,$FD,$C8           /// paddw mm1,mm0
   db $0F,$73,$D1,$03       /// psrlq mm1,3
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$EB,$F1           /// por mm6,mm1

   db $0F,$E7,$B7,$00,$06,$00,$00/// movntq [edi+768*2],mm6

   db $0F,$6F,$C7           /// movq mm0,mm7
   db $0F,$6F,$8F,$08,$06,$00,$00/// movq mm1,[edi+768*2+8]
   db $0F,$6F,$97,$08,$0C,$00,$00/// movq mm2,[edi+768*4+8]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$63,$70       /// pand mm4,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$6F,$F3           /// movq mm6,mm3
   db $0F,$FC,$F5           /// paddb mm6,mm5          //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]     //
   db $0F,$71,$D4,$01       /// psrlw mm4,1
   db $0F,$FC,$F4           /// paddb mm6,mm4          //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]     //
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]

   db $0F,$DB,$43,$60       /// pand mm0,[ebx+96]
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$DB,$53,$60       /// pand mm2,[ebx+96]
   db $0F,$73,$F1,$01       /// psllq mm1,1
   db $0F,$F9,$C8           /// psubw mm1,mm0
   db $0F,$F9,$CA           /// psubw mm1,mm2
   db $0F,$FD,$C2           /// paddw mm0,mm2          // PAVGW mm0,mm2
   db $0F,$71,$D0,$01       /// psrlw mm0,1            //
   db $0F,$73,$F0,$03       /// psllq mm0,3
   db $0F,$FD,$C8           /// paddw mm1,mm0
   db $0F,$73,$D1,$03       /// psrlq mm1,3
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$EB,$F1           /// por mm6,mm1

   db $0F,$E7,$B7,$08,$06,$00,$00/// movntq [edi+768*2+8],mm6

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle2
   sub edi,768*4

   dec edx
   jnz @MMX_CopyLine

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyLastLine:

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyLastLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB555MMX016_Ymirror(const Dest: Pointer;
                                               const Src: Pointer;
                                               const SrcW: DWord;
                                               const SrcH: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov edi,Dest

   mov ecx,SrcH
   dec ecx
@CALC_edi:
   add edi,SrcW
   add edi,SrcW
   loop @CALC_edi

   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$FF00FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov eax,$F8F8F8F8
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$78       /// movq [ebx+120],mm0

   mov edx,SrcH

@MMX_CopyLine:

   mov ecx,SrcW             // ecx=(SrcW*2)/16
   shr ecx,3

@MMX_CopyCycle:

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   sub edi,SrcW
   sub edi,SrcW
   sub edi,SrcW
   sub edi,SrcW

   dec edx
   jnz @MMX_CopyLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure YUY2DeinterlaceOnly768x576MMX016(const Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov esi,Src

   mov edx,(768*2)/16
   mov ecx,576/2-1

   mov ebx,Pointer(CacheMemory)

   mov eax,$1F1F1F1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$FEFEFEFE
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

@MMX_Line:

   mov eax,edx
@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]
   db $0F,$6F,$8E,$00,$06,$00,$00/// movq mm1,[esi+768*2]
   db $0F,$6F,$A6,$08,$06,$00,$00/// movq mm4,[esi+768*2+8]
   db $0F,$6F,$96,$00,$0C,$00,$00/// movq mm2,[esi+768*4]
   db $0F,$6F,$AE,$08,$0C,$00,$00/// movq mm5,[esi+768*4+8]

   db $0F,$6F,$F0           /// movq mm6,mm0

   db $0F,$6F,$FA           /// movq mm7,mm2           //
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$7B,$08       /// pand mm7,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm2
   db $0F,$71,$D7,$01       /// psrlw mm7,1            //
   db $0F,$FC,$F7           /// paddb mm6,mm7          //

   db $0F,$DB,$4B,$08       /// pand mm1,[ebx+8]       //  PAVGB mm1,0
   db $0F,$71,$D1,$01       /// psrlw mm1,1            //

   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$4B,$08       /// pand mm1,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm1
   db $0F,$71,$D1,$01       /// psrlw mm1,1            //
   db $0F,$FC,$F1           /// paddb mm6,mm1          //

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$03           /// pand mm0,[ebx]
   db $0F,$71,$D2,$03       /// psrlw mm2,3
   db $0F,$DB,$13           /// pand mm2,[ebx]
   db $0F,$DC,$F0           /// paddusb mm6,mm0
   db $0F,$DC,$F2           /// paddusb mm6,mm2

   db $0F,$E7,$B6,$00,$06,$00,$00/// movntq [esi+768*2],mm6

   db $0F,$6F,$F3           /// movq mm6,mm3

   db $0F,$6F,$FD           /// movq mm7,mm5           //
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$7B,$08       /// pand mm7,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$71,$D7,$01       /// psrlw mm7,1            //
   db $0F,$FC,$F7           /// paddb mm6,mm7          //

   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]       //  PAVGB mm4,0
   db $0F,$71,$D4,$01       /// psrlw mm4,1            //

   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm4
   db $0F,$71,$D4,$01       /// psrlw mm4,1            //
   db $0F,$FC,$F4           /// paddb mm6,mm4          //

   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$1B           /// pand mm3,[ebx]
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5

   db $0F,$E7,$B6,$08,$06,$00,$00/// movntq [esi+768*2+8],mm6

   add esi,16

   dec eax
   jnz @MMX_CopyCycle

   add esi,768*2

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;


procedure YUY2DeinterlaceOnly768x576_2MMX016(const Dest: Pointer;
                                             const Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov esi,Src
   mov edi,Dest

   mov edx,(768*2)/16
   mov ecx,576/2-1

   mov ebx,Pointer(CacheMemory)

   mov eax,$1F1F1F1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$FEFEFEFE
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,edx
   shr eax,1
@MMX_FirstLine:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32
   dec eax
   jnz @MMX_FirstLine

   mov esi,Src
   mov edi,Dest

@MMX_Line:

   mov eax,edx
@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]
   db $0F,$6F,$8E,$00,$06,$00,$00/// movq mm1,[esi+768*2]
   db $0F,$6F,$A6,$08,$06,$00,$00/// movq mm4,[esi+768*2+8]
   db $0F,$6F,$96,$00,$0C,$00,$00/// movq mm2,[esi+768*4]
   db $0F,$6F,$AE,$08,$0C,$00,$00/// movq mm5,[esi+768*4+8]

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3
   db $0F,$E7,$97,$00,$0C,$00,$00/// movntq [edi+768*4],mm2
   db $0F,$E7,$AF,$08,$0C,$00,$00/// movntq [edi+768*4+8],mm5

   db $0F,$6F,$F0           /// movq mm6,mm0

   db $0F,$6F,$FA           /// movq mm7,mm2           //
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$7B,$08       /// pand mm7,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm2
   db $0F,$71,$D7,$01       /// psrlw mm7,1            //
   db $0F,$FC,$F7           /// paddb mm6,mm7          //

   db $0F,$DB,$4B,$08       /// pand mm1,[ebx+8]       //  PAVGB mm1,0
   db $0F,$71,$D1,$01       /// psrlw mm1,1            //

   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$4B,$08       /// pand mm1,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm1
   db $0F,$71,$D1,$01       /// psrlw mm1,1            //
   db $0F,$FC,$F1           /// paddb mm6,mm1          //

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$03           /// pand mm0,[ebx]
   db $0F,$71,$D2,$03       /// psrlw mm2,3
   db $0F,$DB,$13           /// pand mm2,[ebx]
   db $0F,$DC,$F0           /// paddusb mm6,mm0
   db $0F,$DC,$F2           /// paddusb mm6,mm2

   db $0F,$E7,$B7,$00,$06,$00,$00/// movntq [edi+768*2],mm6

   db $0F,$6F,$F3           /// movq mm6,mm3

   db $0F,$6F,$FD           /// movq mm7,mm5           //
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$7B,$08       /// pand mm7,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$71,$D7,$01       /// psrlw mm7,1            //
   db $0F,$FC,$F7           /// paddb mm6,mm7          //

   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]       //  PAVGB mm4,0
   db $0F,$71,$D4,$01       /// psrlw mm4,1            //

   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm4
   db $0F,$71,$D4,$01       /// psrlw mm4,1            //
   db $0F,$FC,$F4           /// paddb mm6,mm4          //

   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$1B           /// pand mm3,[ebx]
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5

   db $0F,$E7,$B7,$08,$06,$00,$00/// movntq [edi+768*2+8],mm6

   add esi,16
   add edi,16

   dec eax
   jnz @MMX_CopyCycle

   add esi,768*2
   add edi,768*2

   dec ecx
   jnz @MMX_Line

   mov eax,edx
   shr eax,1
@MMX_LastLine:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32
   dec eax
   jnz @MMX_LastLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure YUY2DeinterlaceOnly768x576_2MMX016_Ymirror(const Dest: Pointer;
                                                     const Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov esi,Src
   mov edi,Dest
   mov ecx,576-1
@CALC_edi:
   add edi,768*2
   loop @CALC_edi

   mov edx,(768*2)/16

   mov ebx,Pointer(CacheMemory)

   mov eax,$1F1F1F1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$FEFEFEFE
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,edx
   shr eax,1
@MMX_FirstLine:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32
   dec eax
   jnz @MMX_FirstLine

   mov esi,Src
   mov edi,Dest
   mov ecx,576-1
@CALC_edi2:
   add edi,768*2
   loop @CALC_edi2
   mov ecx,576/2-1

@MMX_Line:

   mov eax,edx
@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]
   db $0F,$6F,$8E,$00,$06,$00,$00/// movq mm1,[esi+768*2]
   db $0F,$6F,$A6,$08,$06,$00,$00/// movq mm4,[esi+768*2+8]
   db $0F,$6F,$96,$00,$0C,$00,$00/// movq mm2,[esi+768*4]
   db $0F,$6F,$AE,$08,$0C,$00,$00/// movq mm5,[esi+768*4+8]

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3
   db $0F,$E7,$97,$00,$F4,$FF,$FF/// movntq [edi-768*4],mm2
   db $0F,$E7,$AF,$08,$F4,$FF,$FF/// movntq [edi-768*4+8],mm5

   db $0F,$6F,$F0           /// movq mm6,mm0

   db $0F,$6F,$FA           /// movq mm7,mm2           //
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$7B,$08       /// pand mm7,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm2
   db $0F,$71,$D7,$01       /// psrlw mm7,1            //
   db $0F,$FC,$F7           /// paddb mm6,mm7          //

   db $0F,$DB,$4B,$08       /// pand mm1,[ebx+8]       //  PAVGB mm1,0
   db $0F,$71,$D1,$01       /// psrlw mm1,1            //

   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$4B,$08       /// pand mm1,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm1
   db $0F,$71,$D1,$01       /// psrlw mm1,1            //
   db $0F,$FC,$F1           /// paddb mm6,mm1          //

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$03           /// pand mm0,[ebx]
   db $0F,$71,$D2,$03       /// psrlw mm2,3
   db $0F,$DB,$13           /// pand mm2,[ebx]
   db $0F,$DC,$F0           /// paddusb mm6,mm0
   db $0F,$DC,$F2           /// paddusb mm6,mm2

   db $0F,$E7,$B7,$00,$FA,$FF,$FF/// movntq [edi-768*2],mm6

   db $0F,$6F,$F3           /// movq mm6,mm3

   db $0F,$6F,$FD           /// movq mm7,mm5           //
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$7B,$08       /// pand mm7,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$71,$D7,$01       /// psrlw mm7,1            //
   db $0F,$FC,$F7           /// paddb mm6,mm7          //

   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]       //  PAVGB mm4,0
   db $0F,$71,$D4,$01       /// psrlw mm4,1            //

   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm4
   db $0F,$71,$D4,$01       /// psrlw mm4,1            //
   db $0F,$FC,$F4           /// paddb mm6,mm4          //

   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$1B           /// pand mm3,[ebx]
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5

   db $0F,$E7,$B7,$08,$FA,$FF,$FF/// movntq [edi-768*2+8],mm6

   add esi,16
   add edi,16

   dec eax
   jnz @MMX_CopyCycle

   add esi,768*2
   sub edi,768*2
   sub edi,768*2
   sub edi,768*2

   dec ecx
   jnz @MMX_Line

   mov eax,edx
   shr eax,1
@MMX_LastLine:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32
   dec eax
   jnz @MMX_LastLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure YMirrorMMX0(const pBuffer: pointer;
                      const IWidth: integer;
                      const IHeight: integer);
begin
  asm
   pushad
   pushfd

   mov esi,pBuffer

   mov edi,pBuffer
   mov ecx,IHeight
   dec ecx
   mov eax,IWidth
   shl eax,1
@CALC_edi:
   add edi,eax
   loop @CALC_edi

   mov eax,IWidth
   shl eax,2

   mov ebx,IHeight
   shr ebx,1
@MMX_CopyCycle:

   mov ecx,IWidth
   shr ecx,4

@MMX_CopyCycleLine:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$6F,$27           /// movq mm4,[edi]
   db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
   db $0F,$6F,$77,$10       /// movq mm6,[edi+16]
   db $0F,$6F,$7F,$18       /// movq mm7,[edi+24]

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3
   db $0F,$E7,$26           /// movntq [esi],mm4
   db $0F,$E7,$6E,$08       /// movntq [esi+8],mm5
   db $0F,$E7,$76,$10       /// movntq [esi+16],mm6
   db $0F,$E7,$7E,$18       /// movntq [esi+24],mm7

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycleLine

   sub edi,eax

   dec ebx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure YMirror_2MMX0(const Dest: pointer;
                        const Src: pointer;
                        const IWidth: integer;
                        const IHeight: integer);
begin
  asm
   pushad
   pushfd

   mov esi,Src

   mov edi,Dest
   mov ecx,IHeight
   dec ecx
   mov eax,IWidth
   shl eax,1
@CALC_edi:
   add edi,eax
   loop @CALC_edi

   mov eax,IWidth
   shl eax,2

   mov ebx,IHeight
@MMX_CopyCycle:

   mov ecx,IWidth
   shr ecx,4

@MMX_CopyCycleLine:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycleLine

   sub edi,eax

   dec ebx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure YMirrorRGB24_2MMX0(const Dest: pointer;
                             const Src: pointer;
                             const IWidth: integer;
                             const IHeight: integer);
begin
  asm
   pushad
   pushfd

   mov esi,Src

   mov edi,Dest
   mov ecx,IHeight
   dec ecx
   mov eax,IWidth
   shl eax,1
   add eax,IWidth     // *2+1=*3
@CALC_edi:
   add edi,eax
   loop @CALC_edi

   mov eax,IWidth
   shl eax,2
   add eax,IWidth
   add eax,IWidth     // *4+1+1=*6

   mov ebx,IHeight
@MMX_CopyCycle:

   mov ecx,IWidth
   shr ecx,4

@MMX_CopyCycleLine:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$6F,$66,$20       /// movq mm4,[esi+32]
   db $0F,$6F,$6E,$28       /// movq mm5,[esi+40]

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3
   db $0F,$E7,$67,$20       /// movntq [edi+32],mm4
   db $0F,$E7,$6F,$28       /// movntq [edi+40],mm5

   add esi,48
   add edi,48

   dec ecx
   jnz @MMX_CopyCycleLine

   sub edi,eax

   dec ebx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure CopyMemoryAverageYUY2MMX032(const Dest: Pointer;
                                      const Src: Pointer;
                                      const Size: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src
   mov ecx,Size
   shr ecx,5

   mov eax,$FEFEFEFE
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$6F,$27           /// movq mm4,[edi]
   db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
   db $0F,$6F,$77,$10       /// movq mm6,[edi+16]
   db $0F,$6F,$7F,$18       /// movq mm7,[edi+24]

   db $0F,$DB,$03           /// pand mm0,[ebx]
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$71,$D0,$01       /// psrlw mm0,1         // PAVGB mm0,mm4
   db $0F,$71,$D4,$01       /// psrlw mm4,1
   db $0F,$FC,$C4           /// paddb mm0,mm4

   db $0F,$DB,$0B           /// pand mm1,[ebx]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$71,$D1,$01       /// psrlw mm1,1         // PAVGB mm1,mm5
   db $0F,$71,$D5,$01       /// psrlw mm5,1
   db $0F,$FC,$CD           /// paddb mm1,mm5

   db $0F,$DB,$13           /// pand mm2,[ebx]
   db $0F,$DB,$33           /// pand mm6,[ebx]
   db $0F,$71,$D2,$01       /// psrlw mm2,1         // PAVGB mm2,mm6
   db $0F,$71,$D6,$01       /// psrlw mm6,1
   db $0F,$FC,$D6           /// paddb mm2,mm6

   db $0F,$DB,$1B           /// pand mm3,[ebx]
   db $0F,$DB,$3B           /// pand mm7,[ebx]
   db $0F,$71,$D3,$01       /// psrlw mm3,1         // PAVGB mm3,mm7
   db $0F,$71,$D7,$01       /// psrlw mm7,1
   db $0F,$FC,$DF           /// paddb mm3,mm7

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryAverageRGB555MMX016(const Dest: Pointer;
                                        const Src: Pointer;
                                        const Size: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src
   mov ecx,Size
   shr ecx,4

   mov ebx,Pointer(CacheMemory)

   mov eax,$001F001F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$17           /// movq mm2,[edi]
   db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$FD,$E5           /// paddw mm4,mm5       // PAVGW mm4,mm5
   db $0F,$71,$D4,$01       /// psrlw mm4,1         //
   db $0F,$6F,$F4           /// movq mm6,mm4
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$6B,$08       /// pand mm5,[ebx+8]
   db $0F,$FD,$E5           /// paddw mm4,mm5       // PAVGW mm4,mm5
   db $0F,$71,$D4,$01       /// psrlw mm4,1         //
   db $0F,$EB,$F4           /// por mm6,mm4
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$63,$10       /// pand mm4,[ebx+16]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$FD,$E5           /// paddw mm4,mm5       // PAVGW mm4,mm5
   db $0F,$71,$D4,$01       /// psrlw mm4,1         //
   db $0F,$EB,$F4           /// por mm6,mm4

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$FD,$E5           /// paddw mm4,mm5       // PAVGW mm4,mm5
   db $0F,$71,$D4,$01       /// psrlw mm4,1         //
   db $0F,$6F,$FC           /// movq mm7,mm4
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$6B,$08       /// pand mm5,[ebx+8]
   db $0F,$FD,$E5           /// paddw mm4,mm5       // PAVGW mm4,mm5
   db $0F,$71,$D4,$01       /// psrlw mm4,1         //
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$63,$10       /// pand mm4,[ebx+16]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$FD,$E5           /// paddw mm4,mm5       // PAVGW mm4,mm5
   db $0F,$71,$D4,$01       /// psrlw mm4,1         //
   db $0F,$EB,$FC           /// por mm7,mm4

   db $0F,$E7,$37           /// movntq [edi],mm6
   db $0F,$E7,$7F,$08       /// movntq [edi+8],mm7

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure VmdYUY2MMX0(const ref,new,mask: Pointer;
                      const Size: DWord;
                      const Noise: DWord;
                      const MeasureLight: boolean;
                      const VR: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  if mask=nil then
    begin
        asm
         pushad
         pushfd

         mov edi,ref
         mov esi,new
         mov ecx,Size
         shr ecx,4

         mov ebx,Pointer(CacheMemory)

         mov eax,$00FF00FF
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$03           /// movq [ebx],mm0

         mov eax,Noise
         mov edx,Noise
         and eax,$000000FF
         and edx,$000000FF
         shl edx,16
         or eax,edx
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

         mov eax,$00010001
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

         mov eax,$00000000
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         mov eax,$000000FF
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

         db $0F,$EF,$C0           /// pxor mm0,mm0
         db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

         db $0F,$7F,$43,$60       /// movq [ebx+96],mm0     // level

         mov eax,$FEFEFEFE
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$68       /// movq [ebx+104],mm0

         db $0F,$EF,$C0           /// pxor mm0,mm0
         db $0F,$7F,$43,$70       /// movq [ebx+112],mm0

       @MMX_CopyCycle:

         db $0F,$6F,$06           /// movq mm0,[esi]
         db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
         db $0F,$6F,$17           /// movq mm2,[edi]
         db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]

       @MeasureLight:
         cmp MeasureLight,0
         je @MeasureEnd
         db $0F,$6F,$73,$60       /// movq mm6,[ebx+96]
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$10       /// psrlq mm4,16
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$20       /// psrlq mm4,32
         db $0F,$73,$D5,$20       /// psrlq mm5,32
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$30       /// psrlq mm4,48
         db $0F,$73,$D5,$30       /// psrlq mm5,48
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$7F,$73,$60       /// movq [ebx+96],mm6

       @MeasureEnd:
         db $0F,$DB,$03           /// pand mm0,[ebx]  // 0 Y0 0 Y1 0 Y2 0 Y3
         db $0F,$DB,$0B           /// pand mm1,[ebx]  // 0 Y4 0 Y5 0 Y6 0 Y7
         db $0F,$DB,$13           /// pand mm2,[ebx]
         db $0F,$DB,$1B           /// pand mm3,[ebx]

         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$F9,$E2           /// psubw mm4,mm2
         db $0F,$F9,$EB           /// psubw mm5,mm3
         db $0F,$65,$D0           /// pcmpgtw mm2,mm0
         db $0F,$65,$D9           /// pcmpgtw mm3,mm1
         db $0F,$EF,$E2           /// pxor mm4,mm2
         db $0F,$EF,$EB           /// pxor mm5,mm3
         db $0F,$DB,$53,$10       /// pand mm2,[ebx+16] // korrekcio ha negaltunk
         db $0F,$DB,$5B,$10       /// pand mm3,[ebx+16]
         db $0F,$FD,$E2           /// paddw mm4,mm2     // 0 diff0 0 diff1 0 diff2 0 diff3
         db $0F,$FD,$EB           /// paddw mm5,mm3     // 0 diff4 0 diff5 0 diff6 0 diff7

         db $0F,$D9,$63,$08       /// psubusw mm4,[ebx+8] // mm4=0 if Noise>=mm4
         db $0F,$D9,$6B,$08       /// psubusw mm5,[ebx+8]

         db $0F,$65,$63,$70       /// pcmpgtw mm4,[ebx+112]    //
         db $0F,$65,$6B,$70       /// pcmpgtw mm5,[ebx+112]    //  PMIN mm5,[ebx+16]
         db $0F,$DB,$63,$10       /// pand mm4,[ebx+16]        //
         db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]        //

         db $0F,$DD,$E5           /// paddusw mm4,mm5
         db $0F,$6F,$73,$20       /// movq mm6,[ebx+32]

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$7F,$73,$20       /// movq [ebx+32],mm6

         add esi,16
         add edi,16

         dec ecx
         jnz @MMX_CopyCycle

         db $0F,$6F,$43,$20       /// movq mm0,[ebx+32]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov edi,VR
         mov [edi],eax

         mov eax,$FFFFFFFF
         mov [edi+4],eax
         mov [edi+8],eax
         mov [edi+12],eax
         mov [edi+16],eax
         mov [edi+20],eax
         mov [edi+24],eax
         mov [edi+28],eax

         db $0F,$6F,$43,$60       /// movq mm0,[ebx+96]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+32],eax

         db $0F,$77               /// emms
         popfd
         popad
        end;
    end
   else // mask<>nil
    begin
        asm
         pushad
         pushfd

         mov edi,ref
         mov esi,new
         mov edx,mask
         mov ecx,Size
         shr ecx,4

         mov ebx,Pointer(CacheMemory)

         mov eax,$00FF00FF
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$03           /// movq [ebx],mm0

         push edx
         mov eax,Noise
         mov edx,Noise
         and eax,$000000FF
         and edx,$000000FF
         shl edx,16
         or eax,edx
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
         pop edx

         mov eax,$00010001
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

         mov eax,$00000000
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         mov eax,$000000FF
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

         db $0F,$EF,$C0           /// pxor mm0,mm0
         db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
         db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
         db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
         db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
         db $0F,$7F,$43,$40       /// movq [ebx+64],mm0
         db $0F,$7F,$43,$48       /// movq [ebx+72],mm0
         db $0F,$7F,$43,$50       /// movq [ebx+80],mm0
         db $0F,$7F,$43,$58       /// movq [ebx+88],mm0

         db $0F,$7F,$43,$60       /// movq [ebx+96],mm0     // level

         mov eax,$FEFEFEFE
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$68       /// movq [ebx+104],mm0

         db $0F,$EF,$C0           /// pxor mm0,mm0
         db $0F,$7F,$43,$70       /// movq [ebx+112],mm0

       @MMX_CopyCycle:

         db $0F,$6F,$06           /// movq mm0,[esi]
         db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
         db $0F,$6F,$17           /// movq mm2,[edi]
         db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]

       @MeasureLight:
         cmp MeasureLight,0
         je @MeasureEnd
         db $0F,$6F,$73,$60       /// movq mm6,[ebx+96]
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$10       /// psrlq mm4,16
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$20       /// psrlq mm4,32
         db $0F,$73,$D5,$20       /// psrlq mm5,32
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$30       /// psrlq mm4,48
         db $0F,$73,$D5,$30       /// psrlq mm5,48
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$7F,$73,$60       /// movq [ebx+96],mm6

       @MeasureEnd:
         db $0F,$6F,$32           /// movq mm6,[edx]
         db $0F,$7E,$F0           /// movd eax,mm6
         cmp eax,$00
         jne @Check
         db $0F,$73,$D6,$20       /// psrlq mm6,32
         db $0F,$7E,$F0           /// movd eax,mm6
         cmp eax,$00
         jne @Check
         db $0F,$6F,$72,$08       /// movq mm6,[edx+8]
         db $0F,$7E,$F0           /// movd eax,mm6
         cmp eax,$00
         jne @Check
         db $0F,$73,$D6,$20       /// psrlq mm6,32
         db $0F,$7E,$F0           /// movd eax,mm6
         cmp eax,$00
         je @CheckEnd

       @Check:
         db $0F,$DB,$03           /// pand mm0,[ebx]  // 0 Y0 0 Y1 0 Y2 0 Y3
         db $0F,$DB,$0B           /// pand mm1,[ebx]  // 0 Y4 0 Y5 0 Y6 0 Y7
         db $0F,$DB,$13           /// pand mm2,[ebx]
         db $0F,$DB,$1B           /// pand mm3,[ebx]

         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$F9,$E2           /// psubw mm4,mm2
         db $0F,$F9,$EB           /// psubw mm5,mm3
         db $0F,$65,$D0           /// pcmpgtw mm2,mm0
         db $0F,$65,$D9           /// pcmpgtw mm3,mm1
         db $0F,$EF,$E2           /// pxor mm4,mm2
         db $0F,$EF,$EB           /// pxor mm5,mm3
         db $0F,$DB,$53,$10       /// pand mm2,[ebx+16] // korrekcio ha negaltunk
         db $0F,$DB,$5B,$10       /// pand mm3,[ebx+16]
         db $0F,$FD,$E2           /// paddw mm4,mm2     // 0 diff0 0 diff1 0 diff2 0 diff3
         db $0F,$FD,$EB           /// paddw mm5,mm3     // 0 diff4 0 diff5 0 diff6 0 diff7

         db $0F,$D9,$63,$08       /// psubusw mm4,[ebx+8] // mm4=0 if Noise>=mm4
         db $0F,$D9,$6B,$08       /// psubusw mm5,[ebx+8]

         db $0F,$65,$63,$70       /// pcmpgtw mm4,[ebx+112]    //
         db $0F,$65,$6B,$70       /// pcmpgtw mm5,[ebx+112]    //  PMIN mm5,[ebx+16]
         db $0F,$DB,$63,$10       /// pand mm4,[ebx+16]        //
         db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]        //

         db $0F,$6F,$C4           /// movq mm0,mm4
         db $0F,$6F,$CD           /// movq mm1,mm5

         db $0F,$6F,$12           /// movq mm2,[edx]
         db $0F,$6F,$5A,$08       /// movq mm3,[edx+8]

         db $0F,$6F,$7B,$18       /// movq mm7,[ebx+24]

         push ecx
         mov ecx,8
         mov eax,32

       @Mask_NS:

         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1

         db $0F,$DB,$E2           /// pand mm4,mm2
         db $0F,$DB,$EB           /// pand mm5,mm3

         db $0F,$71,$D2,$01       /// psrlw mm2,1
         db $0F,$71,$D3,$01       /// psrlw mm3,1

         db $0F,$DD,$E5           /// paddusw mm4,mm5
         db $0F,$6F,$34,$03       /// movq mm6,[ebx+eax]

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$DB,$EF           /// pand mm5,mm7
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$EF           /// pand mm5,mm7
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$EF           /// pand mm5,mm7
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$EF           /// pand mm5,mm7
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$7F,$34,$03       /// movq [ebx+eax],mm6

         add eax,8
         dec ecx
         jnz @Mask_NS

         pop ecx

       @CheckEnd:
         add esi,16
         add edi,16
         add edx,16

         dec ecx
         jnz @MMX_CopyCycle

         mov edi,VR

         db $0F,$6F,$43,$20       /// movq mm0,[ebx+32]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi],eax
         db $0F,$6F,$43,$28       /// movq mm0,[ebx+40]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+4],eax
         db $0F,$6F,$43,$30       /// movq mm0,[ebx+48]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+8],eax
         db $0F,$6F,$43,$38       /// movq mm0,[ebx+56]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+12],eax
         db $0F,$6F,$43,$40       /// movq mm0,[ebx+64]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+16],eax
         db $0F,$6F,$43,$48       /// movq mm0,[ebx+72]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+20],eax
         db $0F,$6F,$43,$50       /// movq mm0,[ebx+80]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+24],eax
         db $0F,$6F,$43,$58       /// movq mm0,[ebx+88]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+28],eax

         db $0F,$6F,$43,$60       /// movq mm0,[ebx+96]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+32],eax

         db $0F,$77               /// emms
         popfd
         popad
        end;
    end;
  FreeMem(CacheMemory);
end;

procedure CustomMatrixFilter3x3MMX0GrayScale(const Src: pointer;
                                             const SrcW,SrcH: DWord;
                                             const Filter: pointer;
                                             const Sum: Word);
var
  TempImage: PByte;
  opnum,
  Disp_R,
  Disp,
  SrcW_M,
  SrcW_D,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(TempImage,SrcW*SrcH*2);
  opnum:=SrcW*SrcH div (4*8);
  SrcW_M:=(SrcW-2) div 6;
  SrcW_D:=2*SrcW;
  SrcW_R:=4*SrcW-12;
  SrcH_M:=SrcH-2;
  Disp:=SrcW+1;
  Disp_R:=6-(SrcW-(SrcW_M*6)-2);  // maradék byte-ok okozta kiesés kiszámolása
  SrcW_R2:=4*SrcW-16;
  asm
   pushad
   pushfd

   mov ebx,Filter
   sub ebx,256

   //*** Konstansok
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$7F,$83,$00,$0D,$00,$00/// movq [ebx+256+3072],mm0

   //*** Mátrix filter eltolása 1 pixellel X irányba 5-ször egymás után
   mov eax,$FFFF0000
   db $0F,$6E,$D0           /// movd mm2,eax
   db $0F,$73,$F2,$20       /// psllq mm2,32
   mov eax,$00000000
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$D1           /// por mm2,mm1

   mov ecx,5
   //***
@ShiftMatrixFilter:
   db $0F,$6F,$83,$00,$01,$00,$00/// movq mm0,[ebx+256]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$83,$30,$01,$00,$00/// movq [ebx+256+48],mm0
   db $0F,$6F,$83,$08,$01,$00,$00/// movq mm0,[ebx+256+8]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$38,$01,$00,$00/// movq [ebx+256+56],mm0
   //***
   db $0F,$6F,$83,$10,$01,$00,$00/// movq mm0,[ebx+256+16]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$83,$40,$01,$00,$00/// movq [ebx+256+64],mm0
   db $0F,$6F,$83,$18,$01,$00,$00/// movq mm0,[ebx+256+24]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$48,$01,$00,$00/// movq [ebx+256+72],mm0
   //***
   db $0F,$6F,$83,$20,$01,$00,$00/// movq mm0,[ebx+256+32]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$83,$50,$01,$00,$00/// movq [ebx+256+80],mm0
   db $0F,$6F,$83,$28,$01,$00,$00/// movq mm0,[ebx+256+40]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$58,$01,$00,$00/// movq [ebx+256+88],mm0
   //***
   add ebx,48
   dec ecx
   jnz @ShiftMatrixFilter

   mov ebx,Filter
   sub ebx,256

   mov esi,Src
   mov edi,Pointer(TempImage)

   //*** byte->word konverzió
   mov ecx,opnum
@CL:
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$6F,$56,$08       /// movq mm2,[esi+8]
   db $0F,$6F,$DA           /// movq mm3,mm2
   db $0F,$6F,$66,$10       /// movq mm4,[esi+16]
   db $0F,$6F,$EC           /// movq mm5,mm4
   db $0F,$6F,$76,$18       /// movq mm6,[esi+24]
   db $0F,$6F,$FE           /// movq mm7,mm6
   db $0F,$68,$83,$00,$0D,$00,$00/// punpckhbw mm0,[ebx+256+3072]
   db $0F,$60,$8B,$00,$0D,$00,$00/// punpcklbw mm1,[ebx+256+3072]
   db $0F,$68,$93,$00,$0D,$00,$00/// punpckhbw mm2,[ebx+256+3072]
   db $0F,$60,$9B,$00,$0D,$00,$00/// punpcklbw mm3,[ebx+256+3072]
   db $0F,$68,$A3,$00,$0D,$00,$00/// punpckhbw mm4,[ebx+256+3072]
   db $0F,$60,$AB,$00,$0D,$00,$00/// punpcklbw mm5,[ebx+256+3072]
   db $0F,$68,$B3,$00,$0D,$00,$00/// punpckhbw mm6,[ebx+256+3072]
   db $0F,$60,$BB,$00,$0D,$00,$00/// punpcklbw mm7,[ebx+256+3072]
   db $0F,$E7,$0F           /// movntq [edi],mm1
   db $0F,$E7,$47,$08       /// movntq [edi+8],mm0
   db $0F,$E7,$5F,$10       /// movntq [edi+16],mm3
   db $0F,$E7,$57,$18       /// movntq [edi+24],mm2
   db $0F,$E7,$6F,$20       /// movntq [edi+32],mm5
   db $0F,$E7,$67,$28       /// movntq [edi+40],mm4
   db $0F,$E7,$7F,$30       /// movntq [edi+48],mm7
   db $0F,$E7,$77,$38       /// movntq [edi+56],mm6

   add esi,32
   add edi,64

   dec ecx
   jnz @CL

   mov edi,Src
   add edi,Disp
   mov esi,Pointer(TempImage)

   mov ecx,SrcH_M

@FL33_1:

   push ecx
   mov ecx,SrcW_M

@FL33_2:

   // 1. sor
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$F8           /// movq mm7,mm0
   db $0F,$F5,$BB,$00,$01,$00,$00/// pmaddwd mm7,[ebx+256]
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$F5,$B3,$30,$01,$00,$00/// pmaddwd mm6,[ebx+256+48]
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$F5,$AB,$60,$01,$00,$00/// pmaddwd mm5,[ebx+256+2*48]
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$F5,$A3,$90,$01,$00,$00/// pmaddwd mm4,[ebx+256+3*48]
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$F5,$9B,$C0,$01,$00,$00/// pmaddwd mm3,[ebx+256+4*48]
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$F5,$93,$F0,$01,$00,$00/// pmaddwd mm2,[ebx+256+5*48]
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$08,$01,$00,$00/// pmaddwd mm1,[ebx+256+8]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$38,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+8]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$68,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+8]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$98,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+8]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$C8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+8]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$F8,$01,$00,$00/// pmaddwd mm1,[ebx+256+5*48+8]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   // 2. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$10,$01,$00,$00/// pmaddwd mm1,[ebx+256+16]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$40,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+16]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$70,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+16]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$A0,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+16]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$D0,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+16]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$00,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+16]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$18,$01,$00,$00/// pmaddwd mm1,[ebx+256+24]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$48,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+24]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$78,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+24]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$A8,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+24]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$D8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+24]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$08,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+24]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   // 3. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$20,$01,$00,$00/// pmaddwd mm1,[ebx+256+32]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$50,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+32]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$80,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+32]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$B0,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+32]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$E0,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+32]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$10,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+32]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$28,$01,$00,$00/// pmaddwd mm1,[ebx+256+40]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$58,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+40]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$88,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+40]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$B8,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+40]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$E8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+40]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$18,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+40]
   db $0F,$FE,$D1           /// paddd mm2,mm1

   // Összegzés
   db $0F,$7E,$F8           /// movd eax,mm7
   db $0F,$73,$D7,$20       /// psrlq mm7,32
   db $0F,$7E,$FA           /// movd edx,mm7
   add eax,edx
   cmp eax,$00
   jg @NN7
   mov eax,$00
@NN7:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K7
   mov al,$FF
@K7:
   mov byte ptr [edi],al

   db $0F,$7E,$F0           /// movd eax,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$7E,$F2           /// movd edx,mm6
   add eax,edx
   cmp eax,$00
   jg @NN6
   mov eax,$00
@NN6:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K6
   mov al,$FF
@K6:
   mov byte ptr [edi+1],al

   db $0F,$7E,$E8           /// movd eax,mm5
   db $0F,$73,$D5,$20       /// psrlq mm5,32
   db $0F,$7E,$EA           /// movd edx,mm5
   add eax,edx
   cmp eax,$00
   jg @NN5
   mov eax,$00
@NN5:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K5
   mov al,$FF
@K5:
   mov byte ptr [edi+2],al

   db $0F,$7E,$E0           /// movd eax,mm4
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$7E,$E2           /// movd edx,mm4
   add eax,edx
   cmp eax,$00
   jg @NN4
   mov eax,$00
@NN4:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K4
   mov al,$FF
@K4:
   mov byte ptr [edi+3],al

   db $0F,$7E,$D8           /// movd eax,mm3
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$7E,$DA           /// movd edx,mm3
   add eax,edx
   cmp eax,$00
   jg @NN3
   mov eax,$00
@NN3:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K3
   mov al,$FF
@K3:
   mov byte ptr [edi+4],al

   db $0F,$7E,$D0           /// movd eax,mm2
   db $0F,$73,$D2,$20       /// psrlq mm2,32
   db $0F,$7E,$D2           /// movd edx,mm2
   add eax,edx
   cmp eax,$00
   jg @NN2
   mov eax,$00
@NN2:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K2
   mov al,$FF
@K2:
   mov byte ptr [edi+5],al

   sub esi,SrcW_R
   add edi,6

   dec ecx
   jnz @FL33_2

   sub esi,Disp_R
   sub esi,Disp_R
   sub edi,Disp_R

   // 1. sor
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$F8           /// movq mm7,mm0
   db $0F,$F5,$BB,$00,$01,$00,$00/// pmaddwd mm7,[ebx+256]
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$F5,$B3,$30,$01,$00,$00/// pmaddwd mm6,[ebx+256+48]
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$F5,$AB,$60,$01,$00,$00/// pmaddwd mm5,[ebx+256+2*48]
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$F5,$A3,$90,$01,$00,$00/// pmaddwd mm4,[ebx+256+3*48]
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$F5,$9B,$C0,$01,$00,$00/// pmaddwd mm3,[ebx+256+4*48]
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$F5,$93,$F0,$01,$00,$00/// pmaddwd mm2,[ebx+256+5*48]
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$08,$01,$00,$00/// pmaddwd mm1,[ebx+256+8]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$38,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+8]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$68,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+8]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$98,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+8]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$C8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+8]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$F8,$01,$00,$00/// pmaddwd mm1,[ebx+256+5*48+8]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   // 2. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$10,$01,$00,$00/// pmaddwd mm1,[ebx+256+16]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$40,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+16]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$70,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+16]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$A0,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+16]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$D0,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+16]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$00,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+16]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$18,$01,$00,$00/// pmaddwd mm1,[ebx+256+24]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$48,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+24]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$78,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+24]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$A8,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+24]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$D8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+24]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$08,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+24]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   // 3. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$20,$01,$00,$00/// pmaddwd mm1,[ebx+256+32]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$50,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+32]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$80,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+32]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$B0,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+32]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$E0,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+32]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$10,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+32]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$28,$01,$00,$00/// pmaddwd mm1,[ebx+256+40]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$58,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+40]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$88,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+40]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$B8,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+40]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$E8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+40]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$18,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+40]
   db $0F,$FE,$D1           /// paddd mm2,mm1

   // Összegzés
   db $0F,$7E,$F8           /// movd eax,mm7
   db $0F,$73,$D7,$20       /// psrlq mm7,32
   db $0F,$7E,$FA           /// movd edx,mm7
   add eax,edx
   cmp eax,$00
   jg @NN72
   mov eax,$00
@NN72:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K72
   mov al,$FF
@K72:
   mov byte ptr [edi],al

   db $0F,$7E,$F0           /// movd eax,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$7E,$F2           /// movd edx,mm6
   add eax,edx
   cmp eax,$00
   jg @NN62
   mov eax,$00
@NN62:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K62
   mov al,$FF
@K62:
   mov byte ptr [edi+1],al

   db $0F,$7E,$E8           /// movd eax,mm5
   db $0F,$73,$D5,$20       /// psrlq mm5,32
   db $0F,$7E,$EA           /// movd edx,mm5
   add eax,edx
   cmp eax,$00
   jg @NN52
   mov eax,$00
@NN52:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K52
   mov al,$FF
@K52:
   mov byte ptr [edi+2],al

   db $0F,$7E,$E0           /// movd eax,mm4
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$7E,$E2           /// movd edx,mm4
   add eax,edx
   cmp eax,$00
   jg @NN42
   mov eax,$00
@NN42:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K42
   mov al,$FF
@K42:
   mov byte ptr [edi+3],al

   db $0F,$7E,$D8           /// movd eax,mm3
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$7E,$DA           /// movd edx,mm3
   add eax,edx
   cmp eax,$00
   jg @NN32
   mov eax,$00
@NN32:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K32
   mov al,$FF
@K32:
   mov byte ptr [edi+4],al

   db $0F,$7E,$D0           /// movd eax,mm2
   db $0F,$73,$D2,$20       /// psrlq mm2,32
   db $0F,$7E,$D2           /// movd edx,mm2
   add eax,edx
   cmp eax,$00
   jg @NN22
   mov eax,$00
@NN22:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K22
   mov al,$FF
@K22:
   mov byte ptr [edi+5],al

   sub esi,SrcW_R2
   add edi,8

   pop ecx
   dec ecx
   jnz @FL33_1

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(TempImage);
end;

procedure CustomMatrixFilter3x3MMX0GrayScaleD(const Dest: pointer;
                                              const Src: pointer;
                                              const SrcW,SrcH: DWord;
                                              const Filter: pointer;
                                              const Sum: Word);
var
  TempImage: PByte;
  opnum,
  Disp_R,
  Disp,
  SrcW_M,
  SrcW_D,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(TempImage,SrcW*SrcH*2);
  opnum:=SrcW*SrcH div (4*8);
  SrcW_M:=(SrcW-2) div 6;
  SrcW_D:=2*SrcW;
  SrcW_R:=4*SrcW-12;
  SrcH_M:=SrcH-2;
  Disp:=SrcW+1;
  Disp_R:=6-(SrcW-(SrcW_M*6)-2);  // maradék byte-ok okozta kiesés kiszámolása
  SrcW_R2:=4*SrcW-16;
  asm
   pushad
   pushfd

   mov ebx,Filter
   sub ebx,256

   //*** Konstansok
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$7F,$83,$00,$0D,$00,$00/// movq [ebx+256+3072],mm0

   //*** Mátrix filter eltolása 1 pixellel X irányba 5-ször egymás után
   mov eax,$FFFF0000
   db $0F,$6E,$D0           /// movd mm2,eax
   db $0F,$73,$F2,$20       /// psllq mm2,32
   mov eax,$00000000
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$D1           /// por mm2,mm1

   mov ecx,5
   //***
@ShiftMatrixFilter:
   db $0F,$6F,$83,$00,$01,$00,$00/// movq mm0,[ebx+256]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$83,$30,$01,$00,$00/// movq [ebx+256+48],mm0
   db $0F,$6F,$83,$08,$01,$00,$00/// movq mm0,[ebx+256+8]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$38,$01,$00,$00/// movq [ebx+256+56],mm0
   //***
   db $0F,$6F,$83,$10,$01,$00,$00/// movq mm0,[ebx+256+16]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$83,$40,$01,$00,$00/// movq [ebx+256+64],mm0
   db $0F,$6F,$83,$18,$01,$00,$00/// movq mm0,[ebx+256+24]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$48,$01,$00,$00/// movq [ebx+256+72],mm0
   //***
   db $0F,$6F,$83,$20,$01,$00,$00/// movq mm0,[ebx+256+32]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$83,$50,$01,$00,$00/// movq [ebx+256+80],mm0
   db $0F,$6F,$83,$28,$01,$00,$00/// movq mm0,[ebx+256+40]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$58,$01,$00,$00/// movq [ebx+256+88],mm0
   //***
   add ebx,48
   dec ecx
   jnz @ShiftMatrixFilter

   mov ebx,Filter
   sub ebx,256

   mov esi,Src
   mov edi,Pointer(TempImage)

   //*** byte->word konverzió
   mov ecx,opnum
@CL:
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$6F,$56,$08       /// movq mm2,[esi+8]
   db $0F,$6F,$DA           /// movq mm3,mm2
   db $0F,$6F,$66,$10       /// movq mm4,[esi+16]
   db $0F,$6F,$EC           /// movq mm5,mm4
   db $0F,$6F,$76,$18       /// movq mm6,[esi+24]
   db $0F,$6F,$FE           /// movq mm7,mm6
   db $0F,$68,$83,$00,$0D,$00,$00/// punpckhbw mm0,[ebx+256+3072]
   db $0F,$60,$8B,$00,$0D,$00,$00/// punpcklbw mm1,[ebx+256+3072]
   db $0F,$68,$93,$00,$0D,$00,$00/// punpckhbw mm2,[ebx+256+3072]
   db $0F,$60,$9B,$00,$0D,$00,$00/// punpcklbw mm3,[ebx+256+3072]
   db $0F,$68,$A3,$00,$0D,$00,$00/// punpckhbw mm4,[ebx+256+3072]
   db $0F,$60,$AB,$00,$0D,$00,$00/// punpcklbw mm5,[ebx+256+3072]
   db $0F,$68,$B3,$00,$0D,$00,$00/// punpckhbw mm6,[ebx+256+3072]
   db $0F,$60,$BB,$00,$0D,$00,$00/// punpcklbw mm7,[ebx+256+3072]
   db $0F,$E7,$0F           /// movntq [edi],mm1
   db $0F,$E7,$47,$08       /// movntq [edi+8],mm0
   db $0F,$E7,$5F,$10       /// movntq [edi+16],mm3
   db $0F,$E7,$57,$18       /// movntq [edi+24],mm2
   db $0F,$E7,$6F,$20       /// movntq [edi+32],mm5
   db $0F,$E7,$67,$28       /// movntq [edi+40],mm4
   db $0F,$E7,$7F,$30       /// movntq [edi+48],mm7
   db $0F,$E7,$77,$38       /// movntq [edi+56],mm6

   add esi,32
   add edi,64

   dec ecx
   jnz @CL

   mov edi,Dest
   add edi,Disp
   mov esi,Pointer(TempImage)

   mov ecx,SrcH_M

@FL33_1:

   push ecx
   mov ecx,SrcW_M

@FL33_2:

   // 1. sor
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$F8           /// movq mm7,mm0
   db $0F,$F5,$BB,$00,$01,$00,$00/// pmaddwd mm7,[ebx+256]
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$F5,$B3,$30,$01,$00,$00/// pmaddwd mm6,[ebx+256+48]
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$F5,$AB,$60,$01,$00,$00/// pmaddwd mm5,[ebx+256+2*48]
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$F5,$A3,$90,$01,$00,$00/// pmaddwd mm4,[ebx+256+3*48]
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$F5,$9B,$C0,$01,$00,$00/// pmaddwd mm3,[ebx+256+4*48]
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$F5,$93,$F0,$01,$00,$00/// pmaddwd mm2,[ebx+256+5*48]
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$08,$01,$00,$00/// pmaddwd mm1,[ebx+256+8]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$38,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+8]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$68,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+8]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$98,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+8]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$C8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+8]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$F8,$01,$00,$00/// pmaddwd mm1,[ebx+256+5*48+8]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   // 2. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$10,$01,$00,$00/// pmaddwd mm1,[ebx+256+16]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$40,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+16]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$70,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+16]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$A0,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+16]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$D0,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+16]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$00,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+16]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$18,$01,$00,$00/// pmaddwd mm1,[ebx+256+24]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$48,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+24]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$78,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+24]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$A8,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+24]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$D8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+24]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$08,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+24]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   // 3. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$20,$01,$00,$00/// pmaddwd mm1,[ebx+256+32]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$50,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+32]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$80,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+32]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$B0,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+32]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$E0,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+32]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$10,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+32]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$28,$01,$00,$00/// pmaddwd mm1,[ebx+256+40]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$58,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+40]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$88,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+40]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$B8,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+40]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$E8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+40]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$18,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+40]
   db $0F,$FE,$D1           /// paddd mm2,mm1

   // Összegzés
   db $0F,$7E,$F8           /// movd eax,mm7
   db $0F,$73,$D7,$20       /// psrlq mm7,32
   db $0F,$7E,$FA           /// movd edx,mm7
   add eax,edx
   cmp eax,$00
   jg @NN7
   mov eax,$00
@NN7:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K7
   mov al,$FF
@K7:
   mov byte ptr [edi],al

   db $0F,$7E,$F0           /// movd eax,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$7E,$F2           /// movd edx,mm6
   add eax,edx
   cmp eax,$00
   jg @NN6
   mov eax,$00
@NN6:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K6
   mov al,$FF
@K6:
   mov byte ptr [edi+1],al

   db $0F,$7E,$E8           /// movd eax,mm5
   db $0F,$73,$D5,$20       /// psrlq mm5,32
   db $0F,$7E,$EA           /// movd edx,mm5
   add eax,edx
   cmp eax,$00
   jg @NN5
   mov eax,$00
@NN5:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K5
   mov al,$FF
@K5:
   mov byte ptr [edi+2],al

   db $0F,$7E,$E0           /// movd eax,mm4
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$7E,$E2           /// movd edx,mm4
   add eax,edx
   cmp eax,$00
   jg @NN4
   mov eax,$00
@NN4:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K4
   mov al,$FF
@K4:
   mov byte ptr [edi+3],al

   db $0F,$7E,$D8           /// movd eax,mm3
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$7E,$DA           /// movd edx,mm3
   add eax,edx
   cmp eax,$00
   jg @NN3
   mov eax,$00
@NN3:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K3
   mov al,$FF
@K3:
   mov byte ptr [edi+4],al

   db $0F,$7E,$D0           /// movd eax,mm2
   db $0F,$73,$D2,$20       /// psrlq mm2,32
   db $0F,$7E,$D2           /// movd edx,mm2
   add eax,edx
   cmp eax,$00
   jg @NN2
   mov eax,$00
@NN2:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K2
   mov al,$FF
@K2:
   mov byte ptr [edi+5],al

   sub esi,SrcW_R
   add edi,6

   dec ecx
   jnz @FL33_2

   sub esi,Disp_R
   sub esi,Disp_R
   sub edi,Disp_R

   // 1. sor
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$F8           /// movq mm7,mm0
   db $0F,$F5,$BB,$00,$01,$00,$00/// pmaddwd mm7,[ebx+256]
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$F5,$B3,$30,$01,$00,$00/// pmaddwd mm6,[ebx+256+48]
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$F5,$AB,$60,$01,$00,$00/// pmaddwd mm5,[ebx+256+2*48]
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$F5,$A3,$90,$01,$00,$00/// pmaddwd mm4,[ebx+256+3*48]
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$F5,$9B,$C0,$01,$00,$00/// pmaddwd mm3,[ebx+256+4*48]
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$F5,$93,$F0,$01,$00,$00/// pmaddwd mm2,[ebx+256+5*48]
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$08,$01,$00,$00/// pmaddwd mm1,[ebx+256+8]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$38,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+8]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$68,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+8]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$98,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+8]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$C8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+8]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$F8,$01,$00,$00/// pmaddwd mm1,[ebx+256+5*48+8]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   // 2. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$10,$01,$00,$00/// pmaddwd mm1,[ebx+256+16]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$40,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+16]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$70,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+16]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$A0,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+16]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$D0,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+16]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$00,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+16]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$18,$01,$00,$00/// pmaddwd mm1,[ebx+256+24]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$48,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+24]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$78,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+24]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$A8,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+24]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$D8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+24]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$08,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+24]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   // 3. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$20,$01,$00,$00/// pmaddwd mm1,[ebx+256+32]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$50,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+32]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$80,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+32]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$B0,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+32]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$E0,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+32]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$10,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+32]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$28,$01,$00,$00/// pmaddwd mm1,[ebx+256+40]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$58,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+40]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$88,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+40]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$B8,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+40]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$E8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+40]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$18,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+40]
   db $0F,$FE,$D1           /// paddd mm2,mm1

   // Összegzés
   db $0F,$7E,$F8           /// movd eax,mm7
   db $0F,$73,$D7,$20       /// psrlq mm7,32
   db $0F,$7E,$FA           /// movd edx,mm7
   add eax,edx
   cmp eax,$00
   jg @NN72
   mov eax,$00
@NN72:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K72
   mov al,$FF
@K72:
   mov byte ptr [edi],al

   db $0F,$7E,$F0           /// movd eax,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$7E,$F2           /// movd edx,mm6
   add eax,edx
   cmp eax,$00
   jg @NN62
   mov eax,$00
@NN62:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K62
   mov al,$FF
@K62:
   mov byte ptr [edi+1],al

   db $0F,$7E,$E8           /// movd eax,mm5
   db $0F,$73,$D5,$20       /// psrlq mm5,32
   db $0F,$7E,$EA           /// movd edx,mm5
   add eax,edx
   cmp eax,$00
   jg @NN52
   mov eax,$00
@NN52:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K52
   mov al,$FF
@K52:
   mov byte ptr [edi+2],al

   db $0F,$7E,$E0           /// movd eax,mm4
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$7E,$E2           /// movd edx,mm4
   add eax,edx
   cmp eax,$00
   jg @NN42
   mov eax,$00
@NN42:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K42
   mov al,$FF
@K42:
   mov byte ptr [edi+3],al

   db $0F,$7E,$D8           /// movd eax,mm3
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$7E,$DA           /// movd edx,mm3
   add eax,edx
   cmp eax,$00
   jg @NN32
   mov eax,$00
@NN32:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K32
   mov al,$FF
@K32:
   mov byte ptr [edi+4],al

   db $0F,$7E,$D0           /// movd eax,mm2
   db $0F,$73,$D2,$20       /// psrlq mm2,32
   db $0F,$7E,$D2           /// movd edx,mm2
   add eax,edx
   cmp eax,$00
   jg @NN22
   mov eax,$00
@NN22:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K22
   mov al,$FF
@K22:
   mov byte ptr [edi+5],al

   sub esi,SrcW_R2
   add edi,8

   pop ecx
   dec ecx
   jnz @FL33_1

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(TempImage);
end;

procedure CustomMatrixFilter7x7MMX0GrayScale(const Src: pointer;
                                             const SrcW,SrcH: DWord;
                                             const Filter: pointer;
                                             const Sum: Word);
var
  TempImage: PByte;
  opnum,
  Disp,
  SrcW_M,
  SrcW_D,
  SrcW_R,
  SrcH_M: dword;
begin
  GetMem(TempImage,SrcW*SrcH*2);
  opnum:=SrcW*SrcH div (4*8);
  SrcW_M:=(SrcW-6) div 2;
  SrcW_D:=2*SrcW;
  SrcW_R:=12*SrcW-4;
  SrcH_M:=SrcH-6;
  Disp:=3*SrcW+3;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Pointer(TempImage)

   mov ebx,Filter

   //*** Konstansok
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$7F,$83,$00,$0C,$00,$00/// movq [ebx+3072],mm0

   //*** Mátrix filter eltolása 1 pixellel X irányba
   mov eax,$FFFF0000
   db $0F,$6E,$D0           /// movd mm2,eax
   db $0F,$73,$F2,$20       /// psllq mm2,32
   mov eax,$00000000
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$D1           /// por mm2,mm1
   //***
   db $0F,$6F,$03           /// movq mm0,[ebx]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$43,$70       /// movq [ebx+112],mm0
   db $0F,$6F,$43,$08       /// movq mm0,[ebx+8]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$78       /// movq [ebx+120],mm0
   //***
   db $0F,$6F,$43,$10       /// movq mm0,[ebx+16]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$43,$80       /// movq [ebx+128],mm0
   db $0F,$6F,$43,$18       /// movq mm0,[ebx+24]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$88       /// movq [ebx+136],mm0
   //***
   db $0F,$6F,$43,$20       /// movq mm0,[ebx+32]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$43,$90       /// movq [ebx+144],mm0
   db $0F,$6F,$43,$28       /// movq mm0,[ebx+40]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$98       /// movq [ebx+152],mm0
   //***
   db $0F,$6F,$43,$30       /// movq mm0,[ebx+48]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$43,$A0       /// movq [ebx+160],mm0
   db $0F,$6F,$43,$38       /// movq mm0,[ebx+56]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$A8       /// movq [ebx+168],mm0
   //***
   db $0F,$6F,$43,$40       /// movq mm0,[ebx+64]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$43,$B0       /// movq [ebx+176],mm0
   db $0F,$6F,$43,$48       /// movq mm0,[ebx+72]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$B8       /// movq [ebx+184],mm0
   //***
   db $0F,$6F,$43,$50       /// movq mm0,[ebx+80]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$43,$C0       /// movq [ebx+192],mm0
   db $0F,$6F,$43,$58       /// movq mm0,[ebx+88]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$C8       /// movq [ebx+200],mm0
   //***
   db $0F,$6F,$43,$60       /// movq mm0,[ebx+96]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$43,$D0       /// movq [ebx+208],mm0
   db $0F,$6F,$43,$68       /// movq mm0,[ebx+104]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$D8       /// movq [ebx+216],mm0
   //***

   //*** byte->word konverzió
   mov ecx,opnum
@CL:
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$6F,$56,$08       /// movq mm2,[esi+8]
   db $0F,$6F,$DA           /// movq mm3,mm2
   db $0F,$6F,$66,$10       /// movq mm4,[esi+16]
   db $0F,$6F,$EC           /// movq mm5,mm4
   db $0F,$6F,$76,$18       /// movq mm6,[esi+24]
   db $0F,$6F,$FE           /// movq mm7,mm6
   db $0F,$68,$83,$00,$0C,$00,$00/// punpckhbw mm0,[ebx+3072]
   db $0F,$60,$8B,$00,$0C,$00,$00/// punpcklbw mm1,[ebx+3072]
   db $0F,$68,$93,$00,$0C,$00,$00/// punpckhbw mm2,[ebx+3072]
   db $0F,$60,$9B,$00,$0C,$00,$00/// punpcklbw mm3,[ebx+3072]
   db $0F,$68,$A3,$00,$0C,$00,$00/// punpckhbw mm4,[ebx+3072]
   db $0F,$60,$AB,$00,$0C,$00,$00/// punpcklbw mm5,[ebx+3072]
   db $0F,$68,$B3,$00,$0C,$00,$00/// punpckhbw mm6,[ebx+3072]
   db $0F,$60,$BB,$00,$0C,$00,$00/// punpcklbw mm7,[ebx+3072]
   db $0F,$E7,$0F           /// movntq [edi],mm1
   db $0F,$E7,$47,$08       /// movntq [edi+8],mm0
   db $0F,$E7,$5F,$10       /// movntq [edi+16],mm3
   db $0F,$E7,$57,$18       /// movntq [edi+24],mm2
   db $0F,$E7,$6F,$20       /// movntq [edi+32],mm5
   db $0F,$E7,$67,$28       /// movntq [edi+40],mm4
   db $0F,$E7,$7F,$30       /// movntq [edi+48],mm7
   db $0F,$E7,$77,$38       /// movntq [edi+56],mm6

   add esi,32
   add edi,64

   dec ecx
   jnz @CL

   mov edi,Src
   add edi,Disp
   mov esi,Pointer(TempImage)

   mov ecx,SrcH_M

@FL77_1:

   push ecx
   mov ecx,SrcW_M

@FL77_2:

   // 1. sor
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$03           /// pmaddwd mm0,[ebx]
   db $0F,$F5,$4B,$70       /// pmaddwd mm1,[ebx+112]
   db $0F,$6F,$F8           /// movq mm7,mm0
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$08       /// pmaddwd mm0,[ebx+8]
   db $0F,$F5,$4B,$78       /// pmaddwd mm1,[ebx+120]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   // 2. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$10       /// pmaddwd mm0,[ebx+16]
   db $0F,$F5,$4B,$80       /// pmaddwd mm1,[ebx+128]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$18       /// pmaddwd mm0,[ebx+24]
   db $0F,$F5,$4B,$88       /// pmaddwd mm1,[ebx+136]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$7E,$F0           /// movd eax,mm6
   // 3. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$20       /// pmaddwd mm0,[ebx+32]
   db $0F,$F5,$4B,$90       /// pmaddwd mm1,[ebx+144]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$28       /// pmaddwd mm0,[ebx+40]
   db $0F,$F5,$4B,$98       /// pmaddwd mm1,[ebx+152]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   // 4. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$30       /// pmaddwd mm0,[ebx+48]
   db $0F,$F5,$4B,$A0       /// pmaddwd mm1,[ebx+160]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$38       /// pmaddwd mm0,[ebx+56]
   db $0F,$F5,$4B,$A8       /// pmaddwd mm1,[ebx+168]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   // 5. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$40       /// pmaddwd mm0,[ebx+64]
   db $0F,$F5,$4B,$B0       /// pmaddwd mm1,[ebx+176]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$48       /// pmaddwd mm0,[ebx+72]
   db $0F,$F5,$4B,$B8       /// pmaddwd mm1,[ebx+184]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   // 6. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$50       /// pmaddwd mm0,[ebx+80]
   db $0F,$F5,$4B,$C0       /// pmaddwd mm1,[ebx+192]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$58       /// pmaddwd mm0,[ebx+88]
   db $0F,$F5,$4B,$C8       /// pmaddwd mm1,[ebx+200]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   // 7. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$60       /// pmaddwd mm0,[ebx+96]
   db $0F,$F5,$4B,$D0       /// pmaddwd mm1,[ebx+208]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$68       /// pmaddwd mm0,[ebx+104]
   db $0F,$F5,$4B,$D8       /// pmaddwd mm1,[ebx+216]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1

   // Összegzés
   db $0F,$7E,$F8           /// movd eax,mm7
   db $0F,$73,$D7,$20       /// psrlq mm7,32
   db $0F,$7E,$FA           /// movd edx,mm7
   add eax,edx
   cmp eax,$00
   jg @NN7
   mov eax,$00
@NN7:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp eax,$FF
   jb @K7
   mov al,$FF
@K7:
   mov byte ptr [edi],al

   db $0F,$7E,$F0           /// movd eax,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$7E,$F2           /// movd edx,mm6
   add eax,edx
   cmp eax,$00
   jg @NN6
   mov eax,$00
@NN6:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp eax,$FF
   jb @K6
   mov al,$FF
@K6:
   mov byte ptr [edi+1],al

   sub esi,SrcW_R
   add edi,2

   dec ecx
   jnz @FL77_2

   add esi,12
   add edi,6

   pop ecx
   dec ecx
   jnz @FL77_1

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(TempImage);
end;


procedure MedianFilter3x3MMX0Plane(const Src: pointer;
                                   const SrcW,SrcH: DWord);
var
  CacheMemory,
  TempImage: PByte;
  Size,
  Disp,
  DispR,
  SrcW_M,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(TempImage,SrcW*SrcH);
  GetMem(CacheMemory,4096);
  SrcW_M:=(SrcW-2) div 8;   // X irányú ciklus
  SrcW_R:=2*SrcW-8;          // esi eltolásának a helyreállítása 8 növeléssel együtt
  SrcW_R2:=2*SrcW-10;        // u.a. de a maradék byte-ok kiszámolásánál
  SrcH_M:=SrcH-2;           // Y irányú ciklus
  Disp:=SrcW+1;             // Elsõ pixel eltolása
  DispR:=8-(SrcW-(SrcW_M*8)-2);  // maradék byte-ok okozta kiesés kiszámolása
  Size:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Pointer(TempImage)
   add edi,Disp
   mov ebx,Pointer(CacheMemory);

   //Konstansok
   db $0F,$76,$C0           /// pcmpeqd mm0,mm0
   db $0F,$7F,$83,$00,$04,$00,$00/// movq [ebx+1024],mm0

   mov eax,$7F7F7F7F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$08,$04,$00,$00/// movq [ebx+1032],mm0

   mov ecx,SrcH_M

@MF33_1:

   push ecx
   mov ecx,SrcW_M

@MF33_2:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov edx,4

   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3


@MF33R:

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$33           /// pcmpeqb mm6,[ebx]
   db $0F,$6F,$03           /// movq mm0,[ebx]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$03           /// movq [ebx],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$08       /// pcmpeqb mm6,[ebx+8]
   db $0F,$6F,$43,$08       /// movq mm0,[ebx+8]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$10       /// pcmpeqb mm6,[ebx+16]
   db $0F,$6F,$43,$10       /// movq mm0,[ebx+16]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$18       /// pcmpeqb mm6,[ebx+24]
   db $0F,$6F,$43,$18       /// movq mm0,[ebx+24]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$20       /// pcmpeqb mm6,[ebx+32]
   db $0F,$6F,$43,$20       /// movq mm0,[ebx+32]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$28       /// pcmpeqb mm6,[ebx+40]
   db $0F,$6F,$43,$28       /// movq mm0,[ebx+40]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$30       /// pcmpeqb mm6,[ebx+48]
   db $0F,$6F,$43,$30       /// movq mm0,[ebx+48]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$38       /// pcmpeqb mm6,[ebx+56]
   db $0F,$6F,$43,$38       /// movq mm0,[ebx+56]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$40       /// pcmpeqb mm6,[ebx+64]
   db $0F,$6F,$43,$40       /// movq mm0,[ebx+64]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3

   dec edx
   jnz @MF33R

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R
   add edi,8

   dec ecx
   jnz @MF33_2

   sub esi,DispR
   sub edi,DispR

   //**** Maradék byte-ok kiszámolása (nem egész 8-ra jön ki -2 miatt)

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov edx,4

   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3

@MF33R2:

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$33           /// pcmpeqb mm6,[ebx]
   db $0F,$6F,$03           /// movq mm0,[ebx]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$03           /// movq [ebx],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$08       /// pcmpeqb mm6,[ebx+8]
   db $0F,$6F,$43,$08       /// movq mm0,[ebx+8]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$10       /// pcmpeqb mm6,[ebx+16]
   db $0F,$6F,$43,$10       /// movq mm0,[ebx+16]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$18       /// pcmpeqb mm6,[ebx+24]
   db $0F,$6F,$43,$18       /// movq mm0,[ebx+24]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$20       /// pcmpeqb mm6,[ebx+32]
   db $0F,$6F,$43,$20       /// movq mm0,[ebx+32]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$28       /// pcmpeqb mm6,[ebx+40]
   db $0F,$6F,$43,$28       /// movq mm0,[ebx+40]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$30       /// pcmpeqb mm6,[ebx+48]
   db $0F,$6F,$43,$30       /// movq mm0,[ebx+48]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$38       /// pcmpeqb mm6,[ebx+56]
   db $0F,$6F,$43,$38       /// movq mm0,[ebx+56]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$40       /// pcmpeqb mm6,[ebx+64]
   db $0F,$6F,$43,$40       /// movq mm0,[ebx+64]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3


   dec edx
   jnz @MF33R2

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R2
   add edi,10

   pop ecx
   dec ecx
   jnz @MF33_1

   //*** Másolás vissza
   mov edi,Src
   mov esi,Pointer(TempImage)
   mov ecx,Size
   shr ecx,5

   @MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
  FreeMem(TempImage);
end;

procedure MedianFilter3x3MMX0PlaneD(const Dest: pointer;
                                    const Src: pointer;
                                    const SrcW,SrcH: DWord);
var
  CacheMemory: PByte;
  Size,         
  Disp,
  DispR,
  SrcW_M,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(CacheMemory,4096);
  SrcW_M:=(SrcW-2) div 8;   // X irányú ciklus
  SrcW_R:=2*SrcW-8;          // esi eltolásának a helyreállítása 8 növeléssel együtt
  SrcW_R2:=2*SrcW-10;        // u.a. de a maradék byte-ok kiszámolásánál
  SrcH_M:=SrcH-2;           // Y irányú ciklus
  Disp:=SrcW+1;             // Elsõ pixel eltolása
  DispR:=8-(SrcW-(SrcW_M*8)-2);  // maradék byte-ok okozta kiesés kiszámolása
  Size:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Dest
   add edi,Disp
   mov ebx,Pointer(CacheMemory);

   //Konstansok
   db $0F,$76,$C0           /// pcmpeqd mm0,mm0
   db $0F,$7F,$83,$00,$04,$00,$00/// movq [ebx+1024],mm0

   mov eax,$7F7F7F7F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$08,$04,$00,$00/// movq [ebx+1032],mm0

   mov ecx,SrcH_M

@MF33_1:

   push ecx
   mov ecx,SrcW_M

@MF33_2:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov edx,4

   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3


@MF33R:

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$33           /// pcmpeqb mm6,[ebx]
   db $0F,$6F,$03           /// movq mm0,[ebx]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$03           /// movq [ebx],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$08       /// pcmpeqb mm6,[ebx+8]
   db $0F,$6F,$43,$08       /// movq mm0,[ebx+8]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$10       /// pcmpeqb mm6,[ebx+16]
   db $0F,$6F,$43,$10       /// movq mm0,[ebx+16]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$18       /// pcmpeqb mm6,[ebx+24]
   db $0F,$6F,$43,$18       /// movq mm0,[ebx+24]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$20       /// pcmpeqb mm6,[ebx+32]
   db $0F,$6F,$43,$20       /// movq mm0,[ebx+32]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$28       /// pcmpeqb mm6,[ebx+40]
   db $0F,$6F,$43,$28       /// movq mm0,[ebx+40]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$30       /// pcmpeqb mm6,[ebx+48]
   db $0F,$6F,$43,$30       /// movq mm0,[ebx+48]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$38       /// pcmpeqb mm6,[ebx+56]
   db $0F,$6F,$43,$38       /// movq mm0,[ebx+56]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$40       /// pcmpeqb mm6,[ebx+64]
   db $0F,$6F,$43,$40       /// movq mm0,[ebx+64]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3

   dec edx
   jnz @MF33R

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R
   add edi,8

   dec ecx
   jnz @MF33_2

   sub esi,DispR
   sub edi,DispR

   //**** Maradék byte-ok kiszámolása (nem egész 8-ra jön ki -2 miatt)

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov edx,4

   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3

@MF33R2:

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$33           /// pcmpeqb mm6,[ebx]
   db $0F,$6F,$03           /// movq mm0,[ebx]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$03           /// movq [ebx],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$08       /// pcmpeqb mm6,[ebx+8]
   db $0F,$6F,$43,$08       /// movq mm0,[ebx+8]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$10       /// pcmpeqb mm6,[ebx+16]
   db $0F,$6F,$43,$10       /// movq mm0,[ebx+16]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$18       /// pcmpeqb mm6,[ebx+24]
   db $0F,$6F,$43,$18       /// movq mm0,[ebx+24]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$20       /// pcmpeqb mm6,[ebx+32]
   db $0F,$6F,$43,$20       /// movq mm0,[ebx+32]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$28       /// pcmpeqb mm6,[ebx+40]
   db $0F,$6F,$43,$28       /// movq mm0,[ebx+40]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$30       /// pcmpeqb mm6,[ebx+48]
   db $0F,$6F,$43,$30       /// movq mm0,[ebx+48]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$38       /// pcmpeqb mm6,[ebx+56]
   db $0F,$6F,$43,$38       /// movq mm0,[ebx+56]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$40       /// pcmpeqb mm6,[ebx+64]
   db $0F,$6F,$43,$40       /// movq mm0,[ebx+64]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3


   dec edx
   jnz @MF33R2

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R2
   add edi,10

   pop ecx
   dec ecx
   jnz @MF33_1

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure MinimumFilter3x3MMX0Plane(const Src: pointer;
                                    const SrcW,SrcH: DWord);
var
  CacheMemory,
  TempImage: PByte;
  Size,
  Disp,
  DispR,
  SrcW_M,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(TempImage,SrcW*SrcH);
  GetMem(CacheMemory,4096);
  SrcW_M:=(SrcW-2) div 8;   // X irányú ciklus
  SrcW_R:=2*SrcW-8;          // esi eltolásának a helyreállítása 8 növeléssel együtt
  SrcW_R2:=2*SrcW-10;        // u.a. de a maradék byte-ok kiszámolásánál
  SrcH_M:=SrcH-2;           // Y irányú ciklus
  Disp:=SrcW+1;             // Elsõ pixel eltolása
  DispR:=8-(SrcW-(SrcW_M*8)-2);  // maradék byte-ok okozta kiesés kiszámolása
  Size:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Pointer(TempImage)
   add edi,Disp
   mov ebx,Pointer(CacheMemory);

   //Konstansok
   db $0F,$76,$C0           /// pcmpeqd mm0,mm0
   db $0F,$7F,$83,$00,$04,$00,$00/// movq [ebx+1024],mm0

   mov eax,$7F7F7F7F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$08,$04,$00,$00/// movq [ebx+1032],mm0

   mov ecx,SrcH_M

@MF33_1:

   push ecx
   mov ecx,SrcW_M

@MF33_2:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0


   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R
   add edi,8

   dec ecx
   jnz @MF33_2

   sub esi,DispR
   sub edi,DispR

   //**** Maradék byte-ok kiszámolása (nem egész 8-ra jön ki -2 miatt)

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0


   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R2
   add edi,10

   pop ecx
   dec ecx
   jnz @MF33_1

   //*** Másolás vissza
   mov edi,Src
   mov esi,Pointer(TempImage)
   mov ecx,Size
   shr ecx,5

   @MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
  FreeMem(TempImage);
end;

procedure MaximumFilter3x3MMX0Plane(const Src: pointer;
                                    const SrcW,SrcH: DWord);
var
  CacheMemory,
  TempImage: PByte;
  Size,
  Disp,
  DispR,
  SrcW_M,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(TempImage,SrcW*SrcH);
  GetMem(CacheMemory,4096);
  SrcW_M:=(SrcW-2) div 8;   // X irányú ciklus
  SrcW_R:=2*SrcW-8;          // esi eltolásának a helyreállítása 8 növeléssel együtt
  SrcW_R2:=2*SrcW-10;        // u.a. de a maradék byte-ok kiszámolásánál
  SrcH_M:=SrcH-2;           // Y irányú ciklus
  Disp:=SrcW+1;             // Elsõ pixel eltolása
  DispR:=8-(SrcW-(SrcW_M*8)-2);  // maradék byte-ok okozta kiesés kiszámolása
  Size:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Pointer(TempImage)
   add edi,Disp
   mov ebx,Pointer(CacheMemory);

   //Konstansok
   db $0F,$76,$C0           /// pcmpeqd mm0,mm0
   db $0F,$7F,$83,$00,$04,$00,$00/// movq [ebx+1024],mm0

   mov eax,$7F7F7F7F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$08,$04,$00,$00/// movq [ebx+1032],mm0

   mov ecx,SrcH_M

@MF33_1:

   push ecx
   mov ecx,SrcW_M

@MF33_2:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0


   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R
   add edi,8

   dec ecx
   jnz @MF33_2

   sub esi,DispR
   sub edi,DispR

   //**** Maradék byte-ok kiszámolása (nem egész 8-ra jön ki -2 miatt)

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0


   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R2
   add edi,10

   pop ecx
   dec ecx
   jnz @MF33_1

   //*** Másolás vissza
   mov edi,Src
   mov esi,Pointer(TempImage)
   mov ecx,Size
   shr ecx,5

   @MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
  FreeMem(TempImage);
end;

procedure RGB32toRGBPlanesMMX032(const Dest: pointer;
                                 const Src: pointer;
                                 const SrcW,SrcH: DWord);
var
  Size: Dword;
  Disp: DWord;
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  Size:=SrcW*SrcH div 8;   // (*4/32)
  Disp:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Dest
   mov ebx,Pointer(CacheMemory);

   mov eax,$00FF0000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$000000FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov edx,Disp
   mov eax,edx
   shl eax,1

   mov ecx,Size
@PLCONV:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DB,$33           /// pand mm6,[ebx]
   db $0F,$DB,$3B           /// pand mm7,[ebx]
   db $0F,$73,$D4,$10       /// psrlq mm4,16
   db $0F,$73,$D5,$10       /// psrlq mm5,16
   db $0F,$73,$D6,$10       /// psrlq mm6,16
   db $0F,$73,$D7,$10       /// psrlq mm7,16
   db $0F,$6B,$E5           /// packssdw mm4,mm5
   db $0F,$6B,$F7           /// packssdw mm6,mm7
   db $0F,$67,$E6           /// packuswb mm4,mm6
   db $0F,$E7,$27           /// movntq [edi],mm4       // R7R6R5R4R3R2R1R0

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$6B,$08       /// pand mm5,[ebx+8]
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]
   db $0F,$DB,$7B,$08       /// pand mm7,[ebx+8]
   db $0F,$73,$D4,$08       /// psrlq mm4,8
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$73,$D6,$08       /// psrlq mm6,8
   db $0F,$73,$D7,$08       /// psrlq mm7,8
   db $0F,$6B,$E5           /// packssdw mm4,mm5
   db $0F,$6B,$F7           /// packssdw mm6,mm7
   db $0F,$67,$E6           /// packuswb mm4,mm6
   db $0F,$E7,$24,$17       /// movntq [edi+edx],mm4   // G7G6G5G4G3G2G1G0

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$63,$10       /// pand mm4,[ebx+16]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]
   db $0F,$6B,$E5           /// packssdw mm4,mm5
   db $0F,$6B,$F7           /// packssdw mm6,mm7
   db $0F,$67,$E6           /// packuswb mm4,mm6
   db $0F,$E7,$24,$07       /// movntq [edi+eax],mm4   // B7B6B5B4B3B2B1B0

   add esi,32
   add edi,8

   dec ecx
   jnz @PLCONV

   db $0F,$77               /// emms

   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure RGBPlanestoRGB32MMX032(const Dest: pointer;
                                 const Src: pointer;
                                 const SrcW,SrcH: DWord);
var
  Size: Dword;
  Disp: DWord;
begin
  Size:=SrcW*SrcH div 8;   // (*4/32)
  Disp:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Dest

   mov edx,Disp
   mov eax,edx
   shl eax,1

   db $0F,$EF,$FF           /// pxor mm7,mm7

   mov ecx,Size
@PLCONV:

   db $0F,$6F,$06           /// movq mm0,[esi]       // R7R6R5R4R3R2R1R0
   db $0F,$6F,$0C,$16       /// movq mm1,[esi+edx]   // G7G6G5G4G3G2G1G0
   db $0F,$6F,$14,$06       /// movq mm2,[esi+eax]   // B7B6B5B4B3B2B1B0

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$1F           /// movntq [edi],mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$73,$D3,$10       /// psrlq mm3,16
   db $0F,$73,$D4,$10       /// psrlq mm4,16
   db $0F,$73,$D5,$10       /// psrlq mm5,16
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$73,$D5,$20       /// psrlq mm5,32
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$10       /// movntq [edi+16],mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$73,$D3,$30       /// psrlq mm3,48
   db $0F,$73,$D4,$30       /// psrlq mm4,48
   db $0F,$73,$D5,$30       /// psrlq mm5,48
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,8
   add edi,32

   dec ecx
   jnz @PLCONV

   db $0F,$77               /// emms

   popfd
   popad
  end;
end;


procedure RGB24toRGBPlanesMMX0(const Dest: Pointer;
                               const Src: Pointer;
                               const SrcW,SrcH: DWord);
var
  CacheMemory: PByte;
  Disp,
  SizeDiv24: Dword;
begin
  GetMem(CacheMemory,4096);
  SizeDiv24:=SrcW*SrcH div 8;
  Disp:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov ebx,Pointer(CacheMemory);

   mov edi,Dest
   mov esi,Src
   mov ecx,SizeDiv24

   mov eax,$000000FF
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov edx,Disp
   mov eax,Disp
   shl eax,1

@MMX_CopyCycle:

   db $0F,$EF,$ED           /// pxor mm5,mm5    // R planes
   db $0F,$EF,$F6           /// pxor mm6,mm6    // G planes
   db $0F,$EF,$FF           /// pxor mm7,mm7    // B planes

   db $0F,$6F,$06           /// movq mm0,[esi]

   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$DB,$4B,$10       /// pand mm1,[ebx+16]   // R
   db $0F,$DB,$53,$08       /// pand mm2,[ebx+8]    // G
   db $0F,$DB,$1B           /// pand mm3,[ebx]      // B
   db $0F,$73,$D1,$10       /// psrlq mm1,2*8
   db $0F,$73,$D2,$08       /// psrlq mm2,1*8
//   psrlq mm3,0
   db $0F,$EB,$E9           /// por mm5,mm1
   db $0F,$EB,$F2           /// por mm6,mm2
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$DB,$4B,$28       /// pand mm1,[ebx+40]   // R
   db $0F,$DB,$53,$20       /// pand mm2,[ebx+32]   // G
   db $0F,$DB,$5B,$18       /// pand mm3,[ebx+24]   // B
   db $0F,$73,$D1,$20       /// psrlq mm1,4*8
   db $0F,$73,$D2,$18       /// psrlq mm2,3*8
   db $0F,$73,$D3,$10       /// psrlq mm3,2*8
   db $0F,$EB,$E9           /// por mm5,mm1
   db $0F,$EB,$F2           /// por mm6,mm2
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$6F,$66,$08       /// movq mm4,[esi+8]

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$DB,$0B           /// pand mm1,[ebx]      // R
   db $0F,$DB,$53,$38       /// pand mm2,[ebx+56]   // G
   db $0F,$DB,$5B,$30       /// pand mm3,[ebx+48]   // B
   db $0F,$73,$F1,$10       /// psllq mm1,2*8
   db $0F,$73,$D2,$28       /// psrlq mm2,5*8
   db $0F,$73,$D3,$20       /// psrlq mm3,4*8
   db $0F,$EB,$E9           /// por mm5,mm1
   db $0F,$EB,$F2           /// por mm6,mm2
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$6F,$D4           /// movq mm2,mm4
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$DB,$4B,$18       /// pand mm1,[ebx+24]   // R
   db $0F,$DB,$53,$10       /// pand mm2,[ebx+16]   // G
   db $0F,$DB,$5B,$08       /// pand mm3,[ebx+8]    // B
//   psllq mm1,0
   db $0F,$73,$F2,$08       /// psllq mm2,8
   db $0F,$73,$F3,$10       /// psllq mm3,2*8
   db $0F,$EB,$E9           /// por mm5,mm1
   db $0F,$EB,$F2           /// por mm6,mm2
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$6F,$D4           /// movq mm2,mm4
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$DB,$4B,$30       /// pand mm1,[ebx+48]   // R
   db $0F,$DB,$53,$28       /// pand mm2,[ebx+40]   // G
   db $0F,$DB,$5B,$20       /// pand mm3,[ebx+32]   // B
   db $0F,$73,$D1,$10       /// psrlq mm1,2*8
   db $0F,$73,$D2,$08       /// psrlq mm2,8
//   psrlq mm3,0
   db $0F,$EB,$E9           /// por mm5,mm1
   db $0F,$EB,$F2           /// por mm6,mm2
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$6F,$46,$10       /// movq mm0,[esi+16]

   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$DB,$4B,$08       /// pand mm1,[ebx+8]    // R
   db $0F,$DB,$13           /// pand mm2,[ebx]      // G
   db $0F,$DB,$5B,$38       /// pand mm3,[ebx+56]   // B
   db $0F,$73,$F1,$20       /// psllq mm1,4*8
   db $0F,$73,$F2,$28       /// psllq mm2,5*8
   db $0F,$73,$D3,$10       /// psrlq mm3,2*8
   db $0F,$EB,$E9           /// por mm5,mm1
   db $0F,$EB,$F2           /// por mm6,mm2
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$DB,$4B,$20       /// pand mm1,[ebx+32]   // R
   db $0F,$DB,$53,$18       /// pand mm2,[ebx+24]   // G
   db $0F,$DB,$5B,$10       /// pand mm3,[ebx+16]   // B
   db $0F,$73,$F1,$18       /// psllq mm1,3*8
   db $0F,$73,$F2,$20       /// psllq mm2,4*8
   db $0F,$73,$F3,$28       /// psllq mm3,5*8
   db $0F,$EB,$E9           /// por mm5,mm1
   db $0F,$EB,$F2           /// por mm6,mm2
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$DB,$4B,$38       /// pand mm1,[ebx+56]   // R
   db $0F,$DB,$53,$30       /// pand mm2,[ebx+48]   // G
   db $0F,$DB,$5B,$28       /// pand mm3,[ebx+40]   // B
//   psllq mm1,0
   db $0F,$73,$F2,$08       /// psllq mm2,8
   db $0F,$73,$F3,$10       /// psllq mm3,2*8
   db $0F,$EB,$E9           /// por mm5,mm1
   db $0F,$EB,$F2           /// por mm6,mm2
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$E7,$2F           /// movntq [edi],mm5
   db $0F,$E7,$34,$17       /// movntq [edi+edx],mm6
   db $0F,$E7,$3C,$07       /// movntq [edi+eax],mm7

   add esi,24
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure ORPlanesMMX032(const Dest: pointer; const Src: pointer; const Size: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src
   mov ecx,Size
   shr ecx,5

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$6F,$27           /// movq mm4,[edi]
   db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
   db $0F,$6F,$77,$10       /// movq mm6,[edi+16]
   db $0F,$6F,$7F,$18       /// movq mm7,[edi+24]

   db $0F,$EB,$C4           /// por mm0,mm4
   db $0F,$EB,$CD           /// por mm1,mm5
   db $0F,$EB,$D6           /// por mm2,mm6
   db $0F,$EB,$DF           /// por mm3,mm7

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure XORPlanesMMX032(const Dest: pointer; const Src: pointer; const Size: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src
   mov ecx,Size
   shr ecx,5

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$6F,$27           /// movq mm4,[edi]
   db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
   db $0F,$6F,$77,$10       /// movq mm6,[edi+16]
   db $0F,$6F,$7F,$18       /// movq mm7,[edi+24]

   db $0F,$EF,$C4           /// pxor mm0,mm4
   db $0F,$EF,$CD           /// pxor mm1,mm5
   db $0F,$EF,$D6           /// pxor mm2,mm6
   db $0F,$EF,$DF           /// pxor mm3,mm7

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure ANDPlanesMMX032(const Dest: pointer; const Src: pointer; const Size: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src
   mov ecx,Size
   shr ecx,5

@MMX_CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$6F,$27           /// movq mm4,[edi]
   db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
   db $0F,$6F,$77,$10       /// movq mm6,[edi+16]
   db $0F,$6F,$7F,$18       /// movq mm7,[edi+24]

   db $0F,$DB,$C4           /// pand mm0,mm4
   db $0F,$DB,$CD           /// pand mm1,mm5
   db $0F,$DB,$D6           /// pand mm2,mm6
   db $0F,$DB,$DF           /// pand mm3,mm7

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure CopyFromWindowMMX016(const Dest: pointer;
                               const Src: pointer;
                               const IMGXW: dword;
                               const X,Y: dword;
                               const XW,YW: dword;
                               const depth: dword);
var
  Disp: dword;
  Disp2: dword;
  XWDIV: dword;
begin
  Disp:=Y*IMGXW*(depth div 8)+X*(depth div 8);
  XWDIV:=GetModifiedWindowXWidth(XW,YW,depth)*(depth div 8) div 16;
  Disp2:=IMGXW*(depth div 8)-(XWDIV*16);
  asm
   pushad
   pushfd

   mov esi,Src
   add esi,Disp
   mov edi,Dest

   mov edx,YW
@LINE:
   mov ecx,XWDIV
@PIXELS:
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1

   add edi,16
   add esi,16

   dec ecx
   jnz @PIXELS

   add esi,Disp2

   dec edx
   jnz @LINE

   db $0F,$77               /// emms
   popfd
   popad
  end
end;

procedure CopyBackToWindowMMX016(const Dest: pointer;
                                 const Src: pointer;
                                 const IMGXW: dword;
                                 const X,Y: dword;
                                 const XW,YW: dword;
                                 const depth: dword);
var
  Disp: dword;
  Disp2: dword;
  XWDIV: dword;
begin
  Disp:=Y*IMGXW*(depth div 8)+X*(depth div 8);
  XWDIV:=GetModifiedWindowXWidth(XW,YW,depth)*(depth div 8) div 16;
  Disp2:=IMGXW*(depth div 8)-(XWDIV*16);
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Dest
   add edi,Disp

   mov edx,YW
@LINE:
   mov ecx,XWDIV
@PIXELS:
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1

   add esi,16
   add edi,16

   dec ecx
   jnz @PIXELS

   add edi,Disp2

   dec edx
   jnz @LINE

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure ORBackToWindowMMX016(const Dest: pointer;
                               const Src: pointer;
                               const IMGXW: dword;
                               const X,Y: dword;
                               const XW,YW: dword;
                               const depth: dword);
var
  Disp: dword;
  Disp2: dword;
  XWDIV: dword;
begin
  Disp:=Y*IMGXW*(depth div 8)+X*(depth div 8);
  XWDIV:=GetModifiedWindowXWidth(XW,YW,depth)*(depth div 8) div 16;
  Disp2:=IMGXW*(depth div 8)-(XWDIV*16);
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Dest
   add edi,Disp

   mov edx,YW
@LINE:
   mov ecx,XWDIV
@PIXELS:
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$17           /// movq mm2,[edi]
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]
   db $0F,$EB,$CB           /// por mm1,mm3
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1

   add esi,16
   add edi,16

   dec ecx
   jnz @PIXELS

   add edi,Disp2

   dec edx
   jnz @LINE

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure ORBackToWindowWithBlackFrameMMX016(const Dest: pointer;
                                             const Src: pointer;
                                             const IMGXW: dword;
                                             const X,Y: dword;
                                             const XW,YW: dword;
                                             const depth: dword);
var
  Disp: dword;
  Disp2: dword;
  XWDIV: dword;
begin
  Disp:=Y*IMGXW*(depth div 8)+X*(depth div 8);
  XWDIV:=GetModifiedWindowXWidth(XW,YW,depth)*(depth div 8) div 16;
  Disp2:=IMGXW*(depth div 8)-(XWDIV*16);
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Dest
   add edi,Disp

   db $0F,$EF,$C0           /// pxor mm0,mm0
   mov ecx,XWDIV
@BLACKPIXELS1:
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$47,$08       /// movntq [edi+8],mm0
   add esi,16
   add edi,16
   dec ecx
   jnz @BLACKPIXELS1
   add edi,Disp2

   mov eax,$00FFFFFF
   db $0F,$6E,$F8           /// movd mm7,eax
   db $0F,$73,$F7,$20       /// psllq mm7,32
   mov eax,$FFFFFFFF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$EB,$F8           /// por mm7,mm0
   //*
   mov eax,$FFFFFFFF
   db $0F,$6E,$F0           /// movd mm6,eax
   db $0F,$73,$F6,$20       /// psllq mm6,32
   mov eax,$FFFFFF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$EB,$F0           /// por mm6,mm0

   mov edx,YW
   sub edx,2
@LINE:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$DB,$C6           /// pand mm0,mm6
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$17           /// movq mm2,[edi]
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]
   db $0F,$EB,$CB           /// por mm1,mm3
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   add esi,16
   add edi,16

   mov ecx,XWDIV
   sub ecx,2
   jc @NOPIXE
   jz @NOPIX
@PIXELS:
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$17           /// movq mm2,[edi]
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]
   db $0F,$EB,$CB           /// por mm1,mm3
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1

   add esi,16
   add edi,16

   dec ecx
   jnz @PIXELS
   jmp @NOPIX

@NOPIXE:
   sub esi,16
   sub edi,16

@NOPIX:
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$DB,$CF           /// pand mm1,mm7
   db $0F,$6F,$17           /// movq mm2,[edi]
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]
   db $0F,$EB,$CB           /// por mm1,mm3
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   add esi,16
   add edi,16

   add edi,Disp2

   dec edx
   jnz @LINE

   db $0F,$EF,$C0           /// pxor mm0,mm0
   mov ecx,XWDIV
@BLACKPIXELS2:
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$47,$08       /// movntq [edi+8],mm0
   add esi,16
   add edi,16
   dec ecx
   jnz @BLACKPIXELS2

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure CutPlanesMMX032(const Src: pointer; const Size: DWord; const Level: byte);
begin
  asm
   pushad
   pushfd

   mov esi,Src

   mov al,Level
   shr al,1
   shl eax,8
   mov al,Level
   shr al,1
   shl eax,8
   mov al,Level
   shr al,1
   shl eax,8
   mov al,Level
   shr al,1
   db $0F,$6E,$F8           /// movd mm7,eax
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$EB,$F8           /// por mm7,mm0

   mov eax,$7F7F7F7F
   db $0F,$6E,$F0           /// movd mm6,eax
   db $0F,$73,$F6,$20       /// psllq mm6,32
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$EB,$F0           /// por mm6,mm0

   mov ecx,Size
   shr ecx,5
@CopyCycle:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$73,$D0,$01       /// psrlq mm0,1
   db $0F,$DB,$C6           /// pand mm0,mm6
   db $0F,$64,$C7           /// pcmpgtb mm0,mm7
   db $0F,$73,$D1,$01       /// psrlq mm1,1
   db $0F,$DB,$CE           /// pand mm1,mm6
   db $0F,$64,$CF           /// pcmpgtb mm1,mm7
   db $0F,$73,$D2,$01       /// psrlq mm2,1
   db $0F,$DB,$D6           /// pand mm2,mm6
   db $0F,$64,$D7           /// pcmpgtb mm2,mm7
   db $0F,$73,$D3,$01       /// psrlq mm3,1
   db $0F,$DB,$DE           /// pand mm3,mm6
   db $0F,$64,$DF           /// pcmpgtb mm3,mm7

   db $0F,$E7,$06           /// movntq [esi],mm0
   db $0F,$E7,$4E,$08       /// movntq [esi+8],mm1
   db $0F,$E7,$56,$10       /// movntq [esi+16],mm2
   db $0F,$E7,$5E,$18       /// movntq [esi+24],mm3

   add esi,32

   dec ecx
   jnz @CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure SearchRectangleRGBMMX0(const SrcFull,SrcRect: pointer;
                                 const SrcfullW,SrcfullH: word;
                                 const SrcRectW,SrcRectH: word;
                                 const sx,sy,ex,ey: word;
                                 var fx,fy: word;
                                 var error: dword);
var
  x,y: word;
  Disp: dword;
  Disp2: dword;
  XWDIV: dword;
  perror: dword;
begin
  XWDIV:=GetModifiedWindowXWidth(SrcRectW,SrcRectH,32)*4 div 16;
  Disp2:=SrcfullW*4-(XWDIV*16);
  error:=$FFFFFFFF;
  for y:=sy to ey do
   for x:=sx to ex do
    begin
     Disp:=y*SrcfullW*4+x*4;
     asm
      pushad
      pushfd

      mov esi,SrcFull
      add esi,Disp
      mov edi,SrcRect

      db $0F,$EF,$D2           /// pxor mm2,mm2
      db $0F,$EF,$FF           /// pxor mm7,mm7

      mov dx,SrcRectH
@LINE:
      mov ecx,XWDIV
@PIXELS:
      db $0F,$6F,$06           /// movq mm0,[esi]
      db $0F,$6F,$66,$08       /// movq mm4,[esi+8]
      db $0F,$6F,$0F           /// movq mm1,[edi]
      db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
      db $0F,$6F,$F1           /// movq mm6,mm1
      db $0F,$64,$F0           /// pcmpgtb mm6,mm0
      db $0F,$F8,$C1           /// psubb mm0,mm1
      db $0F,$EF,$C6           /// pxor mm0,mm6
      db $0F,$6F,$D8           /// movq mm3,mm0
      db $0F,$68,$C2           /// punpckhbw mm0,mm2
      db $0F,$F5,$C0           /// pmaddwd mm0,mm0
      db $0F,$FE,$F8           /// paddd mm7,mm0
      db $0F,$60,$DA           /// punpcklbw mm3,mm2
      db $0F,$F5,$DB           /// pmaddwd mm3,mm3
      db $0F,$FE,$FB           /// paddd mm7,mm3

      db $0F,$6F,$F5           /// movq mm6,mm5
      db $0F,$64,$F4           /// pcmpgtb mm6,mm4
      db $0F,$F8,$E5           /// psubb mm4,mm5
      db $0F,$EF,$E6           /// pxor mm4,mm6
      db $0F,$6F,$DC           /// movq mm3,mm4
      db $0F,$68,$E2           /// punpckhbw mm4,mm2
      db $0F,$F5,$E4           /// pmaddwd mm4,mm4
      db $0F,$FE,$FC           /// paddd mm7,mm4
      db $0F,$60,$DA           /// punpcklbw mm3,mm2
      db $0F,$F5,$DB           /// pmaddwd mm3,mm3
      db $0F,$FE,$FB           /// paddd mm7,mm3

      add edi,16
      add esi,16

      dec ecx
      jnz @PIXELS

      add esi,Disp2

      dec dx
      jnz @LINE

      db $0F,$7E,$F8           /// movd eax,mm7
      db $0F,$73,$D7,$20       /// psrlq mm7,32
      db $0F,$7E,$FB           /// movd ebx,mm7
      add eax,ebx

      mov perror,eax

      db $0F,$77               /// emms
      popfd
      popad
     end;
     if perror<error then
      begin
       error:=perror;
       fx:=x;
       fy:=y;
      end;
    end;
end;

procedure SearchRectangleGrayScaleMMX0(const SrcFull,SrcRect: pointer;
                                       const SrcfullW,SrcfullH: word;
                                       const SrcRectW,SrcRectH: word;
                                       const sx,sy,ex,ey: word;
                                       var fx,fy: word;
                                       var error: dword);
var
  x,y: word;
  Disp: dword;
  Disp2: dword;
  XWDIV: dword;
  perror: dword;
begin
  XWDIV:=GetModifiedWindowXWidth(SrcRectW,SrcRectH,8) div 16;
  Disp2:=SrcfullW-(XWDIV*16);
  error:=$FFFFFFFF;
  for y:=sy to ey do
   for x:=sx to ex do
    begin
     Disp:=y*SrcfullW+x;
     asm
      pushad
      pushfd

      mov esi,SrcFull
      add esi,Disp
      mov edi,SrcRect

      db $0F,$EF,$D2           /// pxor mm2,mm2
      db $0F,$EF,$FF           /// pxor mm7,mm7

      mov dx,SrcRectH
@LINE:
      mov ecx,XWDIV
@PIXELS:
      db $0F,$6F,$06           /// movq mm0,[esi]
      db $0F,$6F,$66,$08       /// movq mm4,[esi+8]
      db $0F,$6F,$0F           /// movq mm1,[edi]
      db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
      db $0F,$6F,$F1           /// movq mm6,mm1
      db $0F,$64,$F0           /// pcmpgtb mm6,mm0
      db $0F,$F8,$C1           /// psubb mm0,mm1
      db $0F,$EF,$C6           /// pxor mm0,mm6
      db $0F,$6F,$D8           /// movq mm3,mm0
      db $0F,$68,$C2           /// punpckhbw mm0,mm2
      db $0F,$F5,$C0           /// pmaddwd mm0,mm0
      db $0F,$FE,$F8           /// paddd mm7,mm0
      db $0F,$60,$DA           /// punpcklbw mm3,mm2
      db $0F,$F5,$DB           /// pmaddwd mm3,mm3
      db $0F,$FE,$FB           /// paddd mm7,mm3

      db $0F,$6F,$F5           /// movq mm6,mm5
      db $0F,$64,$F4           /// pcmpgtb mm6,mm4
      db $0F,$F8,$E5           /// psubb mm4,mm5
      db $0F,$EF,$E6           /// pxor mm4,mm6
      db $0F,$6F,$DC           /// movq mm3,mm4
      db $0F,$68,$E2           /// punpckhbw mm4,mm2
      db $0F,$F5,$E4           /// pmaddwd mm4,mm4
      db $0F,$FE,$FC           /// paddd mm7,mm4
      db $0F,$60,$DA           /// punpcklbw mm3,mm2
      db $0F,$F5,$DB           /// pmaddwd mm3,mm3
      db $0F,$FE,$FB           /// paddd mm7,mm3

      add edi,16
      add esi,16

      dec ecx
      jnz @PIXELS

      add esi,Disp2

      dec dx
      jnz @LINE

      db $0F,$7E,$F8           /// movd eax,mm7
      db $0F,$73,$D7,$20       /// psrlq mm7,32
      db $0F,$7E,$FB           /// movd ebx,mm7
      add eax,ebx

      mov perror,eax

      db $0F,$77               /// emms
      popfd
      popad
     end;
     if perror<error then
      begin
       error:=perror;
       fx:=x;
       fy:=y;
      end;
    end;
end;

procedure SearchRectangleHSVMMX0(const SrcFull,SrcRect: pointer;
                                 const SrcfullW,SrcfullH: word;
                                 const SrcRectW,SrcRectH: word;
                                 const sx,sy,ex,ey: word;
                                 var fx,fy: word;
                                 var error: dword);
var
  x,y: word;
  Disp: dword;
  Disp2: dword;
  XWDIV: dword;
  perror: dword;
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad

   mov ebx,Pointer(CacheMemory)

   mov eax,$FF7FFFFF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C8           /// por mm1,mm0
   db $0F,$7F,$0B           /// movq [ebx],mm1

   mov eax,$007F0000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C8           /// por mm1,mm0
   db $0F,$7F,$4B,$08       /// movq [ebx+8],mm1

   db $0F,$77               /// emms
   popad
  end;
  XWDIV:=GetModifiedWindowXWidth(SrcRectW,SrcRectH,32)*4 div 16;
  Disp2:=SrcfullW*4-(XWDIV*16);
  error:=$FFFFFFFF;
  for y:=sy to ey do
   for x:=sx to ex do
    begin
     Disp:=y*SrcfullW*4+x*4;
     asm
      pushad
      pushfd

      mov esi,SrcFull
      add esi,Disp
      mov edi,SrcRect

      mov ebx,Pointer(CacheMemory)

      db $0F,$EF,$D2           /// pxor mm2,mm2
      db $0F,$EF,$FF           /// pxor mm7,mm7

      mov dx,SrcRectH
@LINE:
      mov ecx,XWDIV
@PIXELS:
      db $0F,$6F,$06           /// movq mm0,[esi]
      db $0F,$6F,$66,$08       /// movq mm4,[esi+8]
      db $0F,$6F,$0F           /// movq mm1,[edi]
      db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
      db $0F,$6F,$F1           /// movq mm6,mm1
      db $0F,$64,$F0           /// pcmpgtb mm6,mm0
      db $0F,$F8,$C1           /// psubb mm0,mm1
      db $0F,$EF,$C6           /// pxor mm0,mm6
      db $0F,$DB,$03           /// pand mm0,[ebx]       // 127 felett
      db $0F,$EF,$43,$08       /// pxor mm0,[ebx+8]     //
      db $0F,$6F,$D8           /// movq mm3,mm0
      db $0F,$68,$C2           /// punpckhbw mm0,mm2
      db $0F,$F5,$C0           /// pmaddwd mm0,mm0
      db $0F,$FE,$F8           /// paddd mm7,mm0
      db $0F,$60,$DA           /// punpcklbw mm3,mm2
      db $0F,$F5,$DB           /// pmaddwd mm3,mm3
      db $0F,$FE,$FB           /// paddd mm7,mm3

      db $0F,$6F,$F5           /// movq mm6,mm5
      db $0F,$64,$F4           /// pcmpgtb mm6,mm4
      db $0F,$F8,$E5           /// psubb mm4,mm5
      db $0F,$EF,$E6           /// pxor mm4,mm6
      db $0F,$DB,$23           /// pand mm4,[ebx]       // 127 felett
      db $0F,$EF,$63,$08       /// pxor mm4,[ebx+8]     //
      db $0F,$6F,$DC           /// movq mm3,mm4
      db $0F,$68,$E2           /// punpckhbw mm4,mm2
      db $0F,$F5,$E4           /// pmaddwd mm4,mm4
      db $0F,$FE,$FC           /// paddd mm7,mm4
      db $0F,$60,$DA           /// punpcklbw mm3,mm2
      db $0F,$F5,$DB           /// pmaddwd mm3,mm3
      db $0F,$FE,$FB           /// paddd mm7,mm3

      add edi,16
      add esi,16

      dec ecx
      jnz @PIXELS

      add esi,Disp2

      dec dx
      jnz @LINE

      db $0F,$7E,$F8           /// movd eax,mm7
      db $0F,$73,$D7,$20       /// psrlq mm7,32
      db $0F,$7E,$FB           /// movd ebx,mm7
      add eax,ebx

      mov perror,eax

      db $0F,$77               /// emms
      popfd
      popad
     end;
     if perror<error then
      begin
       error:=perror;
       fx:=x;
       fy:=y;
      end;
    end;
  FreeMem(CacheMemory);
end;

procedure BGR32toYUY2MMX0(const Dest: pointer; const Src: pointer; const SrcW,SrcH: Dword);
var
  PixelCount: dword;
begin
  PixelCount:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov eax,$00002646
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   mov eax,$4B230E98
   db $0F,$6E,$F8           /// movd mm7,eax
   db $0F,$EB,$C7           /// por mm0,mm7

   db $0F,$EF,$FF           /// pxor mm7,mm7

   mov edi,Dest
   mov esi,Src

   mov ecx,PixelCount
   shr ecx,1

@CONVERT:
   db $0F,$6F,$1E           /// movq mm3,[esi]
   db $0F,$6F,$E3           /// movq mm4,mm3

   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$F5,$E0           /// pmaddwd mm4,mm0
   db $0F,$7E,$E0           /// movd eax,mm4
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$7E,$E3           /// movd ebx,mm4
   add eax,ebx
   shr eax,15
   mov [edi],al

   db $0F,$7E,$DA           /// movd edx,mm3

   and dx,$00FF
   sub ax,dx
   mov bx,$FF82       // -126
   mul bx
   add ah,$7F
   mov [edi+3],ah

   mov al,[edi]
   shr edx,16
   and dx,$00FF
   xor ah,ah
   sub ax,dx
   mov bx,$FF3B       // -197
   mul bx
   add ah,$7F
   mov [edi+1],ah

   db $0F,$6F,$E3           /// movq mm4,mm3
   db $0F,$68,$E7           /// punpckhbw mm4,mm7
   db $0F,$F5,$E0           /// pmaddwd mm4,mm0
   db $0F,$7E,$E0           /// movd eax,mm4
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$7E,$E3           /// movd ebx,mm4
   add eax,ebx
   shr eax,15
   mov [edi+2],al

   add esi,8
   add edi,4

   dec ecx
   jnz @CONVERT

   popfd
   popad
   db $0F,$77               /// emms
  end;
end;

procedure RGB32toYUY2MMX0(const Dest: pointer; const Src: pointer; const SrcW,SrcH: Dword);
var
  PixelCount: dword;
begin
  PixelCount:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov eax,$00002646
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   mov eax,$4B230E98
   db $0F,$6E,$F8           /// movd mm7,eax
   db $0F,$EB,$C7           /// por mm0,mm7

   db $0F,$EF,$FF           /// pxor mm7,mm7

   mov edi,Dest
   mov esi,Src

   mov ecx,PixelCount
   shr ecx,1

@CONVERT:
   db $0F,$6F,$1E           /// movq mm3,[esi]
   db $0F,$6F,$E3           /// movq mm4,mm3

   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$F5,$E0           /// pmaddwd mm4,mm0
   db $0F,$7E,$E0           /// movd eax,mm4
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$7E,$E3           /// movd ebx,mm4
   add eax,ebx
   shr eax,15
   mov [edi],al

   db $0F,$7E,$DA           /// movd edx,mm3

   and dx,$00FF
   sub ax,dx
   mov bx,$FF82       // -126
   mul bx
   add ah,$7F
   mov [edi+1],ah

   mov al,[edi]
   shr edx,16
   and dx,$00FF
   xor ah,ah
   sub ax,dx
   mov bx,$FF3B       // -197
   mul bx
   add ah,$7F
   mov [edi+3],ah

   db $0F,$6F,$E3           /// movq mm4,mm3
   db $0F,$68,$E7           /// punpckhbw mm4,mm7
   db $0F,$F5,$E0           /// pmaddwd mm4,mm0
   db $0F,$7E,$E0           /// movd eax,mm4
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$7E,$E3           /// movd ebx,mm4
   add eax,ebx
   shr eax,15
   mov [edi+2],al

   add esi,8
   add edi,4

   dec ecx
   jnz @CONVERT

   popfd
   popad
   db $0F,$77               /// emms
  end;
end;

procedure InterlaceRGB32MMX0(const Dest: pointer; const Src: pointer; const SrcW,SrcH: Dword);
begin
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Dest

   mov eax,SrcW
   shl eax,2

   mov edx,eax
   sub edx,32

   mov ebx,SrcH

@MMX_CopyCycle:

   mov ecx,SrcW
   shr ecx,3

@MMX_CopyCycleLine:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add edi,eax

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3


   add esi,32
   sub edi,edx      // -eax+32 = -(eax-32)

   dec ecx
   jnz @MMX_CopyCycleLine

   add edi,eax

   dec ebx
   jnz @MMX_CopyCycle

   popfd
   popad
   db $0F,$77               /// emms
  end;
end;

//******************* MMX1
procedure CopyMemoryMMX132(const Dest: Pointer;
                           const Src: Pointer;
                           const Size: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src
   mov ecx,Size
   shr ecx,5

@MMX_CopyCycle:

   prefetchnta [esi+64]
   prefetchnta [esi+96]

   movq mm0,[esi]
   movq mm1,[esi+8]
   movq mm2,[esi+16]
   movq mm3,[esi+24]
   movntq [edi],mm0
   movntq [edi+8],mm1
   movntq [edi+16],mm2
   movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   mov ecx,[Size]
   and ecx,31
   jz  @MMX_Exit

   rep movsb

@MMX_Exit:
   emms
   popfd
   popad
  end;
end;

procedure CopyMemoryRGB565toRGB555MMX132(const Dest: Pointer;
                                         const Src: Pointer;
                                         const Size: DWord);
begin
  asm
   pushad
   pushfd

   mov edi,Dest
   mov esi,Src
   mov ecx,Size
   shr ecx,5

   mov eax,$FFC0FFC0
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$ED           /// pxor mm5,mm5
   db $0F,$6E,$E8           /// movd mm5,eax
   db $0F,$EB,$E8           /// por mm5,mm0

   mov ebx,$001F001F
   db $0F,$6E,$C3           /// movd mm0,ebx
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$F6           /// pxor mm6,mm6
   db $0F,$6E,$F3           /// movd mm6,ebx
   db $0F,$EB,$F0           /// por mm6,mm0

@MMX_CopyCycle:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$DB,$C5           /// pand mm0,mm5
   db $0F,$73,$D0,$01       /// psrlq mm0,1
   db $0F,$DB,$E6           /// pand mm4,mm6
   db $0F,$EB,$C4           /// por mm0,mm4

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$DB,$CD           /// pand mm1,mm5
   db $0F,$73,$D1,$01       /// psrlq mm1,1
   db $0F,$DB,$E6           /// pand mm4,mm6
   db $0F,$EB,$CC           /// por mm1,mm4

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$DB,$D5           /// pand mm2,mm5
   db $0F,$73,$D2,$01       /// psrlq mm2,1
   db $0F,$DB,$E6           /// pand mm4,mm6
   db $0F,$EB,$D4           /// por mm2,mm4

   db $0F,$6F,$E3           /// movq mm4,mm3
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$73,$D3,$01       /// psrlq mm3,1
   db $0F,$DB,$E6           /// pand mm4,mm6
   db $0F,$EB,$DC           /// por mm3,mm4

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle
   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure CopyMemoryRGB24toRGB555MMX124(const Dest: Pointer;
                                        const Src: Pointer;
                                        const SrcW,SrcH: DWord);
var
  CacheMemory: PByte;
  SizeDiv24: Dword;
begin
  GetMem(CacheMemory,4096);
  SizeDiv24:=SrcW*SrcH div 8;
  asm
   pushad
   pushfd

   mov ebx,Pointer(CacheMemory);

   mov edi,Dest
   mov esi,Src
   mov ecx,SizeDiv24

   mov eax,$000000F8
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

@MMX_CopyCycle:

   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$46,$48       /// prefetchtna [esi+72]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$DB,$5B,$10       /// pand mm3,[ebx+16]
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$73,$D3,$09       /// psrlq mm3,8+1
   db $0F,$73,$D4,$06       /// psrlq mm4,8-2
   db $0F,$73,$D5,$03       /// psrlq mm5,3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$DB,$73,$18       /// pand mm6,[ebx+24]
   db $0F,$73,$D4,$11       /// psrlq mm4,2*8+1
   db $0F,$73,$D5,$0E       /// psrlq mm5,2*8-2
   db $0F,$73,$D6,$0B       /// psrlq mm6,8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$6B,$38       /// pand mm5,[ebx+56]
   db $0F,$DB,$73,$30       /// pand mm6,[ebx+48]
   db $0F,$73,$F4,$27       /// psllq mm4,5*8-1
   db $0F,$73,$D5,$16       /// psrlq mm5,3*8-2
   db $0F,$73,$D6,$13       /// psrlq mm6,2*8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6


   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]
   db $0F,$73,$F4,$1F       /// psllq mm4,4*8-1
   db $0F,$73,$F5,$22       /// psllq mm5,4*8+2
   db $0F,$73,$F6,$25       /// psllq mm6,5*8-3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   //*** Elso mmx reg. ok

   db $0F,$6F,$F9           /// movq mm7,mm1
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$DB,$7B,$30       /// pand mm7,[ebx+48]
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$73,$D7,$29       /// psrlq mm7,5*8+1
   db $0F,$73,$D4,$26       /// psrlq mm4,5*8-2
   db $0F,$73,$D5,$23       /// psrlq mm5,4*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DB,$73,$38       /// pand mm6,[ebx+56]
   db $0F,$73,$F4,$0F       /// psllq mm4,2*8-1
   db $0F,$73,$F5,$12       /// psllq mm5,2*8+2
   db $0F,$73,$D6,$2B       /// psrlq mm6,5*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$20       /// pand mm4,[ebx+32]
   db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$73,$F4,$07       /// psllq mm4,8-1
   db $0F,$73,$F5,$0A       /// psllq mm5,8+2
   db $0F,$73,$F6,$0D       /// psllq mm6,2*8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$38       /// pand mm4,[ebx+56]
   db $0F,$DB,$6B,$30       /// pand mm5,[ebx+48]
   db $0F,$DB,$73,$28       /// pand mm6,[ebx+40]
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$F5,$02       /// psllq mm5,2
   db $0F,$73,$F6,$05       /// psllq mm6,8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$E7,$1F           /// movntq [edi],mm3
   db $0F,$E7,$7F,$08       /// movntq [edi+8],mm7

   add esi,24
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryRGB24toRGB555MMX124_Ymirror(const Dest: Pointer;
                                                const Src: Pointer;
                                                const Width,
                                                      Height: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd

   mov ebx,Pointer(CacheMemory);

   mov eax,$000000F8
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov edi,Dest
   mov esi,Src

   mov eax,Width
   shl eax,1

   mov ecx,Height
   dec ecx
@DestAdd:
   add edi,eax
   loop @DestAdd

   mov edx,Height

@MMX_MainCycle:

   mov ecx,Width
   shr ecx,3

@MMX_CopyCycle1:

   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$46,$48       /// prefetchtna [esi+72]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$DB,$5B,$10       /// pand mm3,[ebx+16]
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$73,$D3,$09       /// psrlq mm3,8+1
   db $0F,$73,$D4,$06       /// psrlq mm4,8-2
   db $0F,$73,$D5,$03       /// psrlq mm5,3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$DB,$73,$18       /// pand mm6,[ebx+24]
   db $0F,$73,$D4,$11       /// psrlq mm4,2*8+1
   db $0F,$73,$D5,$0E       /// psrlq mm5,2*8-2
   db $0F,$73,$D6,$0B       /// psrlq mm6,8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$6B,$38       /// pand mm5,[ebx+56]
   db $0F,$DB,$73,$30       /// pand mm6,[ebx+48]
   db $0F,$73,$F4,$27       /// psllq mm4,5*8-1
   db $0F,$73,$D5,$16       /// psrlq mm5,3*8-2
   db $0F,$73,$D6,$13       /// psrlq mm6,2*8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6


   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]
   db $0F,$73,$F4,$1F       /// psllq mm4,4*8-1
   db $0F,$73,$F5,$22       /// psllq mm5,4*8+2
   db $0F,$73,$F6,$25       /// psllq mm6,5*8-3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   //*** Elso mmx reg. ok

   db $0F,$6F,$F9           /// movq mm7,mm1
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$DB,$7B,$30       /// pand mm7,[ebx+48]
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$73,$D7,$29       /// psrlq mm7,5*8+1
   db $0F,$73,$D4,$26       /// psrlq mm4,5*8-2
   db $0F,$73,$D5,$23       /// psrlq mm5,4*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DB,$73,$38       /// pand mm6,[ebx+56]
   db $0F,$73,$F4,$0F       /// psllq mm4,2*8-1
   db $0F,$73,$F5,$12       /// psllq mm5,2*8+2
   db $0F,$73,$D6,$2B       /// psrlq mm6,5*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$20       /// pand mm4,[ebx+32]
   db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$73,$F4,$07       /// psllq mm4,8-1
   db $0F,$73,$F5,$0A       /// psllq mm5,8+2
   db $0F,$73,$F6,$0D       /// psllq mm6,2*8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$38       /// pand mm4,[ebx+56]
   db $0F,$DB,$6B,$30       /// pand mm5,[ebx+48]
   db $0F,$DB,$73,$28       /// pand mm6,[ebx+40]
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$F5,$02       /// psllq mm5,2
   db $0F,$73,$F6,$05       /// psllq mm6,8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$E7,$1F           /// movntq [edi],mm3
   db $0F,$E7,$7F,$08       /// movntq [edi+8],mm7

   add esi,24
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle1

   sub edi,eax
   sub edi,eax

   dec edx
   jnz @MMX_MainCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryRGB24toRGB555MMX124Interlaced_Ymirror(const Dest: Pointer;
                                                          const Src: Pointer;
                                                          const Width,
                                                                Height: DWord);
var
  CacheMemory: PByte;
  SrcWD,SrcWQ: dword;
begin
  GetMem(CacheMemory,4096);
  SrcWD:=2*Width;
  SrcWQ:=4*Width;
  asm
   pushad
   pushfd

   mov ebx,Pointer(CacheMemory);
   mov eax,$000000F8
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov edi,Dest
   mov esi,Src

   mov ecx,Height
   dec ecx
@DestAdd:
   add edi,SrcWQ
   loop @DestAdd

   mov ecx,Width
   shr ecx,3

@MMX_CopyFirstLine:

   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$46,$48       /// prefetchtna [esi+72]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$DB,$5B,$10       /// pand mm3,[ebx+16]
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$73,$D3,$09       /// psrlq mm3,8+1
   db $0F,$73,$D4,$06       /// psrlq mm4,8-2
   db $0F,$73,$D5,$03       /// psrlq mm5,3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$DB,$73,$18       /// pand mm6,[ebx+24]
   db $0F,$73,$D4,$11       /// psrlq mm4,2*8+1
   db $0F,$73,$D5,$0E       /// psrlq mm5,2*8-2
   db $0F,$73,$D6,$0B       /// psrlq mm6,8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$6B,$38       /// pand mm5,[ebx+56]
   db $0F,$DB,$73,$30       /// pand mm6,[ebx+48]
   db $0F,$73,$F4,$27       /// psllq mm4,5*8-1
   db $0F,$73,$D5,$16       /// psrlq mm5,3*8-2
   db $0F,$73,$D6,$13       /// psrlq mm6,2*8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6


   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]
   db $0F,$73,$F4,$1F       /// psllq mm4,4*8-1
   db $0F,$73,$F5,$22       /// psllq mm5,4*8+2
   db $0F,$73,$F6,$25       /// psllq mm6,5*8-3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   //*** Elso mmx reg. ok

   db $0F,$6F,$F9           /// movq mm7,mm1
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$DB,$7B,$30       /// pand mm7,[ebx+48]
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$73,$D7,$29       /// psrlq mm7,5*8+1
   db $0F,$73,$D4,$26       /// psrlq mm4,5*8-2
   db $0F,$73,$D5,$23       /// psrlq mm5,4*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DB,$73,$38       /// pand mm6,[ebx+56]
   db $0F,$73,$F4,$0F       /// psllq mm4,2*8-1
   db $0F,$73,$F5,$12       /// psllq mm5,2*8+2
   db $0F,$73,$D6,$2B       /// psrlq mm6,5*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$20       /// pand mm4,[ebx+32]
   db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$73,$F4,$07       /// psllq mm4,8-1
   db $0F,$73,$F5,$0A       /// psllq mm5,8+2
   db $0F,$73,$F6,$0D       /// psllq mm6,2*8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$38       /// pand mm4,[ebx+56]
   db $0F,$DB,$6B,$30       /// pand mm5,[ebx+48]
   db $0F,$DB,$73,$28       /// pand mm6,[ebx+40]
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$F5,$02       /// psllq mm5,2
   db $0F,$73,$F6,$05       /// psllq mm6,8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   mov eax,$001F001F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$58       /// movq [ebx+88],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$60       /// movq [ebx+96],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$68       /// movq [ebx+104],mm0

   mov eax,$7C1F7C1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$70       /// movq [ebx+112],mm0

   db $0F,$7F,$1F           /// movq [edi],mm3
   db $0F,$7F,$7F,$08       /// movq [edi+8],mm7

   add esi,24
   add edi,16

   dec ecx
   jnz @MMX_CopyFirstLine

   sub edi,SrcWQ
   sub edi,SrcWD

   mov edx,Height
   dec edx

@MMX_MainCycle:

   mov ecx,Width
   shr ecx,3

@MMX_CopyCycle1:

   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$46,$48       /// prefetchtna [esi+72]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$DB,$5B,$10       /// pand mm3,[ebx+16]
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$73,$D3,$09       /// psrlq mm3,8+1
   db $0F,$73,$D4,$06       /// psrlq mm4,8-2
   db $0F,$73,$D5,$03       /// psrlq mm5,3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$DB,$73,$18       /// pand mm6,[ebx+24]
   db $0F,$73,$D4,$11       /// psrlq mm4,2*8+1
   db $0F,$73,$D5,$0E       /// psrlq mm5,2*8-2
   db $0F,$73,$D6,$0B       /// psrlq mm6,8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$6B,$38       /// pand mm5,[ebx+56]
   db $0F,$DB,$73,$30       /// pand mm6,[ebx+48]
   db $0F,$73,$F4,$27       /// psllq mm4,5*8-1
   db $0F,$73,$D5,$16       /// psrlq mm5,3*8-2
   db $0F,$73,$D6,$13       /// psrlq mm6,2*8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6


   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]
   db $0F,$73,$F4,$1F       /// psllq mm4,4*8-1
   db $0F,$73,$F5,$22       /// psllq mm5,4*8+2
   db $0F,$73,$F6,$25       /// psllq mm6,5*8-3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   //*** Elso mmx reg. ok

   db $0F,$6F,$F9           /// movq mm7,mm1
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$DB,$7B,$30       /// pand mm7,[ebx+48]
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$73,$D7,$29       /// psrlq mm7,5*8+1
   db $0F,$73,$D4,$26       /// psrlq mm4,5*8-2
   db $0F,$73,$D5,$23       /// psrlq mm5,4*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DB,$73,$38       /// pand mm6,[ebx+56]
   db $0F,$73,$F4,$0F       /// psllq mm4,2*8-1
   db $0F,$73,$F5,$12       /// psllq mm5,2*8+2
   db $0F,$73,$D6,$2B       /// psrlq mm6,5*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$20       /// pand mm4,[ebx+32]
   db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$73,$F4,$07       /// psllq mm4,8-1
   db $0F,$73,$F5,$0A       /// psllq mm5,8+2
   db $0F,$73,$F6,$0D       /// psllq mm6,2*8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$38       /// pand mm4,[ebx+56]
   db $0F,$DB,$6B,$30       /// pand mm5,[ebx+48]
   db $0F,$DB,$73,$28       /// pand mm6,[ebx+40]
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$F5,$02       /// psllq mm5,2
   db $0F,$73,$F6,$05       /// psllq mm6,8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$7F,$1F           /// movq [edi],mm3
   db $0F,$7F,$7F,$08       /// movq [edi+8],mm7

   add edi,SrcWQ
   db $0F,$6F,$0F           /// movq mm1,[edi]
   db $0F,$6F,$57,$08       /// movq mm2,[edi+8]
   sub edi,SrcWD
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$C3           /// movq mm0,mm3
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$63,$60       /// pand mm4,[ebx+96]
   db $0F,$DB,$6B,$60       /// pand mm5,[ebx+96]
   db $0F,$DB,$43,$60       /// pand mm0,[ebx+96]
   db $0F,$DB,$73,$60       /// pand mm6,[ebx+96]
   db $0F,$FD,$E0           /// paddw mm4,mm0         // pavgw mm4,mm0
   db $0F,$71,$D4,$01       /// psrlw mm4,1           //
   db $0F,$DB,$63,$60       /// pand mm4,[ebx+96]     //
   db $0F,$FD,$EE           /// paddw mm5,mm6         // pavgw mm5,mm6
   db $0F,$71,$D5,$01       /// psrlw mm5,1           //
   db $0F,$DB,$6B,$60       /// pand mm5,[ebx+96]     //
   db $0F,$DB,$4B,$70       /// pand mm1,[ebx+112]
   db $0F,$DB,$53,$70       /// pand mm2,[ebx+112]
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$7B,$70       /// pand mm7,[ebx+112]
   db $0F,$FC,$CB           /// paddb mm1,mm3         // pavgb mm1,mm3
   db $0F,$71,$D1,$01       /// psrlw mm1,1           //
   db $0F,$DB,$4B,$70       /// pand mm1,[ebx+112]    //
   db $0F,$FC,$D7           /// paddb mm2,mm7         // pavgb mm2,mm7
   db $0F,$71,$D2,$01       /// psrlw mm2,1           //
   db $0F,$DB,$53,$70       /// pand mm2,[ebx+112]    //
   db $0F,$EB,$CC           /// por mm1,mm4
   db $0F,$EB,$D5           /// por mm2,mm5
   db $0F,$E7,$0F           /// movntq [edi],mm1
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2
   sub edi,SrcWD

   add esi,24
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle1

   sub edi,SrcWQ
   sub edi,SrcWD

   dec edx
   jnz @MMX_MainCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryRGB565toRGB555_DeinterlaceOnly768x576MMX18(const Dest: Pointer;
                                                               const Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd

   mov edi,Dest
   mov esi,Src
   mov eax,Pointer(CacheMemory)

   mov ebx,$FFC0FFC0
   db $0F,$6E,$C3           /// movd mm0,ebx
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$CB           /// movd mm1,ebx
   db $0F,$EB,$C8           /// por mm1,mm0
   db $0F,$7F,$08           /// movq [eax],mm1

   mov ebx,$001F001F
   db $0F,$6E,$C3           /// movd mm0,ebx
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$CB           /// movd mm1,ebx
   db $0F,$EB,$C8           /// por mm1,mm0
   db $0F,$7F,$48,$08       /// movq [eax+8],mm1
   db $0F,$73,$F1,$05       /// psllq mm1,5
   db $0F,$7F,$48,$10       /// movq [eax+16],mm1
   db $0F,$73,$F1,$05       /// psllq mm1,5
   db $0F,$7F,$48,$18       /// movq [eax+24],mm1

   mov ecx,768*2/32

@MMX_CopyFirstLine:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$DB,$00           /// pand mm0,[eax]
   db $0F,$73,$D0,$01       /// psrlq mm0,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$C4           /// por mm0,mm4

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$DB,$08           /// pand mm1,[eax]
   db $0F,$73,$D1,$01       /// psrlq mm1,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$CC           /// por mm1,mm4

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$DB,$10           /// pand mm2,[eax]
   db $0F,$73,$D2,$01       /// psrlq mm2,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$D4           /// por mm2,mm4

   db $0F,$6F,$E3           /// movq mm4,mm3
   db $0F,$DB,$18           /// pand mm3,[eax]
   db $0F,$73,$D3,$01       /// psrlq mm3,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$DC           /// por mm3,mm4

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyFirstLine

   mov edi,Dest
   mov esi,Src

   mov ecx,(576/2)-1
   mov edx,(768*2)/8

   db $0F,$6F,$07           /// movq mm0,[edi]

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$18,$47,$18       /// prefetchtna [edi+24]
   db $0F,$18,$86,$18,$06,$00,$00/// prefetchtna [esi+768*2+24]
   db $0F,$18,$86,$18,$0C,$00,$00/// prefetchtna [esi+768*4+24]
   db $0F,$18,$47,$20       /// prefetchtna [edi+32]
   db $0F,$18,$86,$20,$06,$00,$00/// prefetchtna [esi+768*2+32]
   db $0F,$18,$86,$20,$0C,$00,$00/// prefetchtna [esi+768*4+32]

   db $0F,$6F,$8E,$00,$06,$00,$00/// movq mm1,[esi+768*2]
   db $0F,$6F,$96,$00,$0C,$00,$00/// movq mm2,[esi+768*4]

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$DB,$08           /// pand mm1,[eax]
   db $0F,$73,$D1,$01       /// psrlq mm1,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$CC           /// por mm1,mm4

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$DB,$10           /// pand mm2,[eax]
   db $0F,$73,$D2,$01       /// psrlq mm2,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$D4           /// por mm2,mm4

   db $0F,$EF,$F6           /// pxor mm6,mm6
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$58,$08       /// pand mm3,[eax+8]
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$DB,$68,$08       /// pand mm5,[eax+8]
   db $0F,$73,$F4,$01       /// psllq mm4,1
   db $0F,$F9,$E3           /// psubw mm4,mm3
   db $0F,$F9,$E5           /// psubw mm4,mm5
   db $0F,$FD,$DD           /// paddw mm3,mm5    // PAVGW mm3,mm5
   db $0F,$71,$D3,$01       /// psrlw mm3,1      //
   db $0F,$73,$F3,$03       /// psllq mm3,3
   db $0F,$FD,$E3           /// paddw mm4,mm3
   db $0F,$73,$D4,$03       /// psrlq mm4,3
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$F4           /// por mm6,mm4

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$58,$10       /// pand mm3,[eax+16]
   db $0F,$DB,$60,$10       /// pand mm4,[eax+16]
   db $0F,$DB,$68,$10       /// pand mm5,[eax+16]
   db $0F,$73,$F4,$01       /// psllq mm4,1
   db $0F,$F9,$E3           /// psubw mm4,mm3
   db $0F,$F9,$E5           /// psubw mm4,mm5
   db $0F,$FD,$DD           /// paddw mm3,mm5    // PAVGW mm3,mm5
   db $0F,$71,$D3,$01       /// psrlw mm3,1      //
   db $0F,$73,$F3,$03       /// psllq mm3,3
   db $0F,$FD,$E3           /// paddw mm4,mm3
   db $0F,$73,$D4,$03       /// psrlq mm4,3
   db $0F,$DB,$60,$10       /// pand mm4,[eax+16]
   db $0F,$EB,$F4           /// por mm6,mm4

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$DB,$40,$18       /// pand mm0,[eax+24]
   db $0F,$DB,$48,$18       /// pand mm1,[eax+24]
   db $0F,$DB,$50,$18       /// pand mm2,[eax+24]
   db $0F,$73,$D0,$03       /// psrlq mm0,3
   db $0F,$73,$D2,$03       /// psrlq mm2,3
   db $0F,$73,$D1,$02       /// psrlq mm1,2
   db $0F,$F9,$C8           /// psubw mm1,mm0
   db $0F,$F9,$CA           /// psubw mm1,mm2
   db $0F,$FD,$C2           /// paddw mm0,mm2    // PAVGW mm0,mm2
   db $0F,$71,$D0,$01       /// psrlw mm0,1      //
   db $0F,$73,$F0,$03       /// psllq mm0,3
   db $0F,$FD,$C8           /// paddw mm1,mm0
   db $0F,$DB,$48,$18       /// pand mm1,[eax+24]
   db $0F,$EB,$F1           /// por mm6,mm1

   db $0F,$E7,$B7,$00,$06,$00,$00/// movntq [edi+768*2],mm6
   db $0F,$7F,$A7,$00,$0C,$00,$00/// movq [edi+768*4],mm4

   add esi,8
   add edi,8

   db $0F,$6F,$07           /// movq mm0,[edi]

   dec ebx
   jnz @MMX_CopyCycle

   add esi,768*2
   add edi,768*2

   dec ecx
   jnz @MMX_Line

   mov ecx,768*2/32

   add esi,768*2
   add edi,768*2

@MMX_CopyLastLine:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$DB,$00           /// pand mm0,[eax]
   db $0F,$73,$D0,$01       /// psrlq mm0,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$C4           /// por mm0,mm4

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$DB,$08           /// pand mm1,[eax]
   db $0F,$73,$D1,$01       /// psrlq mm1,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$CC           /// por mm1,mm4

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$DB,$10           /// pand mm2,[eax]
   db $0F,$73,$D2,$01       /// psrlq mm2,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$D4           /// por mm2,mm4

   db $0F,$6F,$E3           /// movq mm4,mm3
   db $0F,$DB,$18           /// pand mm3,[eax]
   db $0F,$73,$D3,$01       /// psrlq mm3,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$DC           /// por mm3,mm4

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyLastLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure Copy2_1_16MMX132(const Dest: Pointer;
                           const Src: Pointer;
                           const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   mov eax,$0000FFFF
   db $0F,$6E,$F8           /// movd mm7,eax
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$EB,$F8           /// por mm7,mm0

   mov edx,SrcW
   shr edx,4                // edx = SrcW*2/32

   mov ecx,SrcH             // ecx = SrcH/2
   shr ecx,1

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$18,$46,$20       /// prefetchtna [esi+$20]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$DB,$C7           /// pand mm0,mm7
   db $0F,$DB,$CF           /// pand mm1,mm7
   db $0F,$DB,$D7           /// pand mm2,mm7
   db $0F,$DB,$DF           /// pand mm3,mm7

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$73,$D1,$10       /// psrlq mm1,16
   db $0F,$61,$C1           /// punpcklwd mm0,mm1
   db $0F,$73,$F5,$30       /// psllq mm5,48
   db $0F,$69,$EC           /// punpckhwd mm5,mm4
   db $0F,$EB,$C5           /// por mm0,mm5

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$73,$D3,$10       /// psrlq mm3,16
   db $0F,$61,$D3           /// punpcklwd mm2,mm3
   db $0F,$73,$F5,$30       /// psllq mm5,48
   db $0F,$69,$EC           /// punpckhwd mm5,mm4
   db $0F,$EB,$D5           /// por mm2,mm5

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2

   add esi,32
   add edi,16

   dec ebx
   jnz @MMX_CopyCycle

   add esi,SrcW
   add esi,SrcW

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy2_1_YUY16MMX132(const Dest: Pointer;
                              const Src: Pointer;
                              const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   db $0F,$EF,$FF           /// pxor mm7,mm7
   mov eax,$FFFFFFFF
   db $0F,$6E,$F8           /// movd mm7,eax

   mov edx,SrcW
   shr edx,4                // edx = SrcW*2/32

   mov ecx,SrcH             // ecx = SrcH/2
   shr ecx,1

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$18,$46,$20       /// prefetchtna [esi+$20]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$DB,$C7           /// pand mm0,mm7
   db $0F,$DB,$CF           /// pand mm1,mm7
   db $0F,$DB,$D7           /// pand mm2,mm7
   db $0F,$DB,$DF           /// pand mm3,mm7

   db $0F,$73,$F1,$20       /// psllq mm1,32
   db $0F,$EB,$C1           /// por mm0,mm1

   db $0F,$73,$F3,$20       /// psllq mm3,32
   db $0F,$EB,$D3           /// por mm2,mm3

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2

   add esi,32
   add edi,16

   dec ebx
   jnz @MMX_CopyCycle

   add esi,SrcW
   add esi,SrcW

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy2_1_YUY16MMX132Onlyhorizontal(const Dest: Pointer;
                                            const Src: Pointer;
                                            const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   db $0F,$EF,$FF           /// pxor mm7,mm7
   mov eax,$FFFFFFFF
   db $0F,$6E,$F8           /// movd mm7,eax

   mov edx,SrcW
   shr edx,4                // edx = SrcW*2/32

   mov ecx,SrcH             // ecx = SrcH

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$18,$46,$20       /// prefetchtna [esi+$20]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$DB,$C7           /// pand mm0,mm7
   db $0F,$DB,$CF           /// pand mm1,mm7
   db $0F,$DB,$D7           /// pand mm2,mm7
   db $0F,$DB,$DF           /// pand mm3,mm7

   db $0F,$73,$F1,$20       /// psllq mm1,32
   db $0F,$EB,$C1           /// por mm0,mm1

   db $0F,$73,$F3,$20       /// psllq mm3,32
   db $0F,$EB,$D3           /// por mm2,mm3

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2

   add esi,32
   add edi,16

   dec ebx
   jnz @MMX_CopyCycle

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy2_1_8MMX132(const Dest: Pointer;
                          const Src: Pointer;
                          const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   mov eax,$00FF00FF
   db $0F,$6E,$F0           /// movd mm6,eax
   db $0F,$73,$F6,$20       /// psllq mm6,32
   db $0F,$6E,$F8           /// movd mm7,eax
   db $0F,$EB,$FE           /// por mm7,mm6

   mov edx,SrcW
   shr edx,5                // edx = SrcW/32

   mov ecx,SrcH             // ecx = SrcH/2
   shr ecx,1

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$18,$46,$20       /// prefetchtna [esi+$20]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$DB,$C7           /// pand mm0,mm7
   db $0F,$DB,$CF           /// pand mm1,mm7
   db $0F,$DB,$D7           /// pand mm2,mm7
   db $0F,$DB,$DF           /// pand mm3,mm7

   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$73,$D0,$20       /// psrlq mm0,32
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$73,$F1,$20       /// psllq mm1,32
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$73,$D2,$20       /// psrlq mm2,32
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$73,$F3,$20       /// psllq mm3,32

   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$EB,$D3           /// por mm2,mm3

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2

   add esi,32
   add edi,16

   dec ebx
   jnz @MMX_CopyCycle

   add esi,SrcW

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy3_1_16MMX124(const Dest: Pointer;
                           const Src: Pointer;
                           const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   mov eax,$FFFF0000
   db $0F,$6E,$F8           /// movd mm7,eax
   db $0F,$73,$F7,$20       /// psllq mm7,32

   mov eax,$0000FFFF
   db $0F,$6E,$F0           /// movd mm6,eax
   db $0F,$73,$F6,$20       /// psllq mm6,32

   db $0F,$EF,$ED           /// pxor mm5,mm5
   mov eax,$FFFF0000
   db $0F,$6E,$E8           /// movd mm5,eax

   db $0F,$EF,$E4           /// pxor mm4,mm4
   mov eax,$0000FFFF
   db $0F,$6E,$E0           /// movd mm4,eax

   xor edx,edx
   mov eax,SrcW
   mov cx,12
   div cx                   // edx = SrcW*2/24
   mov dx,ax
   and edx,$0000FFFF

   push edx
   xor edx,edx
   mov eax,SrcH             // ecx = SrcH/3
   mov cx,3
   div cx
   mov cx,ax
   and ecx,$0000FFFF
   pop edx

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$18,$46,$18       /// prefetchtna [esi+$18]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$DB,$C4           /// pand mm0,mm4
   db $0F,$DB,$DF           /// pand mm3,mm7
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$EB,$C3           /// por mm0,mm3
   db $0F,$DB,$CE           /// pand mm1,mm6
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$DB,$D5           /// pand mm2,mm5
   db $0F,$73,$F2,$20       /// psllq mm2,32
   db $0F,$EB,$C2           /// por mm0,mm2

   db $0F,$E7,$07           /// movntq [edi],mm0

   add esi,24
   add edi,8

   dec ebx
   jnz @MMX_CopyCycle

   add esi,SrcW
   add esi,SrcW
   add esi,SrcW
   add esi,SrcW

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy4_1_16MMX132(const Dest: Pointer;
                           const Src: Pointer;
                           const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   db $0F,$EF,$FF           /// pxor mm7,mm7
   mov eax,$0000FFFF
   db $0F,$6E,$F8           /// movd mm7,eax

   mov edx,SrcW
   shr edx,4                // edx = SrcW*2/32

   mov ecx,SrcH             // ecx = SrcH/4
   shr ecx,2

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$18,$46,$20       /// prefetchtna [esi+$20]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$DB,$C7           /// pand mm0,mm7
   db $0F,$DB,$CF           /// pand mm1,mm7
   db $0F,$DB,$D7           /// pand mm2,mm7
   db $0F,$DB,$DF           /// pand mm3,mm7

   db $0F,$73,$F1,$10       /// psllq mm1,16
   db $0F,$73,$F2,$20       /// psllq mm2,32
   db $0F,$73,$F3,$30       /// psllq mm3,48

   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$EB,$C3           /// por mm0,mm3

   db $0F,$E7,$07           /// movntq [edi],mm0

   add esi,32
   add edi,8

   dec ebx
   jnz @MMX_CopyCycle

   add esi,SrcW
   add esi,SrcW
   add esi,SrcW
   add esi,SrcW
   add esi,SrcW
   add esi,SrcW

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy3_2_16MMX124(const Dest: Pointer;
                           const Src: Pointer;
                           const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   mov eax,$FFFF0000
   db $0F,$6E,$F8           /// movd mm7,eax
   db $0F,$73,$F7,$20       /// psllq mm7,32

   db $0F,$EF,$F6           /// pxor mm6,mm6
   mov eax,$0000FFFF
   db $0F,$6E,$F0           /// movd mm6,eax

   db $0F,$EF,$ED           /// pxor mm5,mm5
   mov eax,$FFFFFFFF
   db $0F,$6E,$E8           /// movd mm5,eax

   mov eax,$FFFFFFFF
   db $0F,$6E,$E0           /// movd mm4,eax
   db $0F,$73,$F4,$20       /// psllq mm4,32

   xor edx,edx
   mov eax,SrcW
   mov cx,12
   div cx                   // edx = SrcW*2/24
   mov dx,ax
   and edx,$0000FFFF

   push edx
   xor edx,edx
   mov eax,SrcH             // ecx = SrcH/3
   mov cx,3
   div cx
   mov cx,ax
   and ecx,$0000FFFF
   pop edx

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle1:

   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$46,$48       /// prefetchtna [esi+72]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$DB,$C5           /// pand mm0,mm5
   db $0F,$DB,$DF           /// pand mm3,mm7
   db $0F,$73,$D3,$10       /// psrlq mm3,16
   db $0F,$EB,$C3           /// por mm0,mm3
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$DB,$CE           /// pand mm1,mm6
   db $0F,$73,$F1,$30       /// psllq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1

   db $0F,$DB,$DC           /// pand mm3,mm4
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$73,$F2,$10       /// psllq mm2,16
   db $0F,$DB,$D4           /// pand mm2,mm4
   db $0F,$EB,$D3           /// por mm2,mm3

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2

   add esi,24
   add edi,16

   dec ebx
   jnz @MMX_CopyCycle1

   mov ebx,edx

@MMX_CopyCycle2:

   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$46,$48       /// prefetchtna [esi+72]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$DB,$C5           /// pand mm0,mm5
   db $0F,$DB,$DF           /// pand mm3,mm7
   db $0F,$73,$D3,$10       /// psrlq mm3,16
   db $0F,$EB,$C3           /// por mm0,mm3
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$DB,$CE           /// pand mm1,mm6
   db $0F,$73,$F1,$30       /// psllq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1

   db $0F,$DB,$DC           /// pand mm3,mm4
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$73,$F2,$10       /// psllq mm2,16
   db $0F,$DB,$D4           /// pand mm2,mm4
   db $0F,$EB,$D3           /// por mm2,mm3

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2

   add esi,24
   add edi,16

   dec ebx
   jnz @MMX_CopyCycle2

   add esi,SrcW
   add esi,SrcW

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy1_2_16MMX132(const Dest: Pointer;
                           const Src: Pointer;
                           const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   mov edx,SrcW
   shr edx,4                // edx = SrcW*2/32

   mov ecx,SrcH             // ecx = SrcH

   mov eax,Srcw             // eax=SrcW*4
   shl eax,2

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$56,$08       /// movq mm2,[esi+8]
   db $0F,$6F,$66,$10       /// movq mm4,[esi+16]
   db $0F,$6F,$76,$18       /// movq mm6,[esi+24]

   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$69,$C8           /// punpckhwd mm1,mm0
   db $0F,$61,$C0           /// punpcklwd mm0,mm0

   db $0F,$6F,$DA           /// movq mm3,mm2
   db $0F,$69,$DA           /// punpckhwd mm3,mm2
   db $0F,$61,$D2           /// punpcklwd mm2,mm2

   db $0F,$6F,$EC           /// movq mm5,mm4
   db $0F,$69,$EC           /// punpckhwd mm5,mm4
   db $0F,$61,$E4           /// punpcklwd mm4,mm4

   db $0F,$6F,$FE           /// movq mm7,mm6
   db $0F,$69,$FE           /// punpckhwd mm7,mm6
   db $0F,$61,$F6           /// punpcklwd mm6,mm6

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3
   db $0F,$E7,$67,$20       /// movntq [edi+32],mm4
   db $0F,$E7,$6F,$28       /// movntq [edi+40],mm5
   db $0F,$E7,$77,$30       /// movntq [edi+48],mm6
   db $0F,$E7,$7F,$38       /// movntq [edi+56],mm7
   db $0F,$E7,$04,$07       /// movntq [edi+eax],mm0
   db $0F,$E7,$4C,$07,$08   /// movntq [edi+eax+8],mm1
   db $0F,$E7,$54,$07,$10   /// movntq [edi+eax+16],mm2
   db $0F,$E7,$5C,$07,$18   /// movntq [edi+eax+24],mm3
   db $0F,$E7,$64,$07,$20   /// movntq [edi+eax+32],mm4
   db $0F,$E7,$6C,$07,$28   /// movntq [edi+eax+40],mm5
   db $0F,$E7,$74,$07,$30   /// movntq [edi+eax+48],mm6
   db $0F,$E7,$7C,$07,$38   /// movntq [edi+eax+56],mm7

   add esi,32
   add edi,64

   dec ebx
   jnz @MMX_CopyCycle

   add edi,eax

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy1_4_16MMX132(const Dest: Pointer;
                           const Src: Pointer;
                           const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   mov edx,SrcW
   shr edx,3                // edx = SrcW*2/16

   mov ecx,SrcH             // ecx = SrcH

   mov eax,Srcw             // eax = SrcW*8
   shl eax,3

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$66,$08       /// movq mm4,[esi+8]

   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$69,$C0           /// punpckhwd mm0,mm0
   db $0F,$69,$C0           /// punpckhwd mm0,mm0
   db $0F,$73,$F1,$10       /// psllq mm1,16
   db $0F,$6F,$D1           /// movq mm2,mm1
   db $0F,$69,$C9           /// punpckhwd mm1,mm1
   db $0F,$69,$C9           /// punpckhwd mm1,mm1
   db $0F,$73,$F2,$10       /// psllq mm2,16
   db $0F,$6F,$DA           /// movq mm3,mm2
   db $0F,$69,$D2           /// punpckhwd mm2,mm2
   db $0F,$69,$D2           /// punpckhwd mm2,mm2
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$69,$DB           /// punpckhwd mm3,mm3
   db $0F,$69,$DB           /// punpckhwd mm3,mm3

   db $0F,$6F,$EC           /// movq mm5,mm4
   db $0F,$69,$E4           /// punpckhwd mm4,mm4
   db $0F,$69,$E4           /// punpckhwd mm4,mm4
   db $0F,$73,$F5,$10       /// psllq mm5,16
   db $0F,$6F,$F5           /// movq mm6,mm5
   db $0F,$69,$ED           /// punpckhwd mm5,mm5
   db $0F,$69,$ED           /// punpckhwd mm5,mm5
   db $0F,$73,$F6,$10       /// psllq mm6,16
   db $0F,$6F,$FE           /// movq mm7,mm6
   db $0F,$69,$F6           /// punpckhwd mm6,mm6
   db $0F,$69,$F6           /// punpckhwd mm6,mm6
   db $0F,$73,$F7,$10       /// psllq mm7,16
   db $0F,$69,$FF           /// punpckhwd mm7,mm7
   db $0F,$69,$FF           /// punpckhwd mm7,mm7

   push ecx
   mov ecx,4
@4Lines:
   db $0F,$E7,$1F           /// movntq [edi],mm3
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2
   db $0F,$E7,$4F,$10       /// movntq [edi+16],mm1
   db $0F,$E7,$47,$18       /// movntq [edi+24],mm0
   db $0F,$E7,$7F,$20       /// movntq [edi+32],mm7
   db $0F,$E7,$77,$28       /// movntq [edi+40],mm6
   db $0F,$E7,$6F,$30       /// movntq [edi+48],mm5
   db $0F,$E7,$67,$38       /// movntq [edi+56],mm4
   add edi,eax
   dec ecx
   jnz @4Lines
   pop ecx

   sub edi,eax
   sub edi,eax
   sub edi,eax
   sub edi,eax

   add esi,16
   add edi,64

   dec ebx
   jnz @MMX_CopyCycle

   add edi,eax
   add edi,eax
   add edi,eax

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure Copy3_4_16MMX124(const Dest: Pointer;
                           const Src: Pointer;
                           const SrcW,SrcH: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   xor edx,edx
   mov eax,SrcW
   mov cx,12
   div cx                   // edx = SrcW*2/24
   mov dx,ax
   and edx,$0000FFFF

   push edx
   xor edx,edx
   mov eax,SrcH             // ecx = SrcH/3
   mov cx,3
   div cx
   mov cx,ax
   and ecx,$0000FFFF
   pop edx

   db $0F,$EF,$DB           /// pxor mm3,mm3
   mov eax,$0000FFFF
   db $0F,$6E,$D8           /// movd mm3,eax

   mov eax,$FFFFFFFF
   db $0F,$6E,$E0           /// movd mm4,eax
   db $0F,$73,$F4,$20       /// psllq mm4,32
   mov eax,$FFFF0000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$EB,$E0           /// por mm4,mm0


@MMX_Line:

   mov eax,2

@MMX_2Line:

   mov ebx,edx

@MMX_CopyCycle1:

   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$46,$48       /// prefetchtna [esi+72]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$73,$F5,$10       /// psllq mm5,16
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$F3           /// pand mm6,mm3
   db $0F,$EB,$EE           /// por mm5,mm6

   db $0F,$73,$D0,$30       /// psrlq mm0,48
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$73,$F6,$10       /// psllq mm6,16
   db $0F,$EB,$F0           /// por mm6,mm0
   db $0F,$6F,$F9           /// movq mm7,mm1
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$F7           /// por mm6,mm7

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$73,$D0,$20       /// psrlq mm0,32
   db $0F,$DB,$C3           /// pand mm0,mm3
   db $0F,$73,$D1,$10       /// psrlq mm1,16
   db $0F,$DB,$CC           /// pand mm1,mm4
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$73,$F7,$30       /// psllq mm7,48
   db $0F,$EB,$F8           /// por mm7,mm0

   db $0F,$6F,$C2           /// movq mm0,mm2
   db $0F,$73,$D0,$10       /// psrlq mm0,16
   db $0F,$DB,$C3           /// pand mm0,mm3
   db $0F,$DB,$D4           /// pand mm2,mm4
   db $0F,$EB,$D0           /// por mm2,mm0

   db $0F,$E7,$2F           /// movntq [edi],mm5
   db $0F,$E7,$77,$08       /// movntq [edi+8],mm6
   db $0F,$E7,$7F,$10       /// movntq [edi+16],mm7
   db $0F,$E7,$57,$18       /// movntq [edi+24],mm2

   add esi,24
   add edi,32

   dec ebx
   jnz @MMX_CopyCycle1

   dec eax
   jnz @MMX_2Line


   push edx
   xor edx,edx
   mov eax,SrcW             // eax=SrcW*2*(4/3)
   shl ax,3
   mov bx,3
   div bx
   and eax,$0000FFFF
   pop edx

   mov ebx,edx

@MMX_CopyCycle2:

   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$46,$48       /// prefetchtna [esi+72]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$73,$F5,$10       /// psllq mm5,16
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$F3           /// pand mm6,mm3
   db $0F,$EB,$EE           /// por mm5,mm6

   db $0F,$73,$D0,$30       /// psrlq mm0,48
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$73,$F6,$10       /// psllq mm6,16
   db $0F,$EB,$F0           /// por mm6,mm0
   db $0F,$6F,$F9           /// movq mm7,mm1
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$F7           /// por mm6,mm7

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$73,$D0,$20       /// psrlq mm0,32
   db $0F,$DB,$C3           /// pand mm0,mm3
   db $0F,$73,$D1,$10       /// psrlq mm1,16
   db $0F,$DB,$CC           /// pand mm1,mm4
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$73,$F7,$30       /// psllq mm7,48
   db $0F,$EB,$F8           /// por mm7,mm0

   db $0F,$6F,$C2           /// movq mm0,mm2
   db $0F,$73,$D0,$10       /// psrlq mm0,16
   db $0F,$DB,$C3           /// pand mm0,mm3
   db $0F,$DB,$D4           /// pand mm2,mm4
   db $0F,$EB,$D0           /// por mm2,mm0

   db $0F,$E7,$2F           /// movntq [edi],mm5
   db $0F,$E7,$77,$08       /// movntq [edi+8],mm6
   db $0F,$E7,$7F,$10       /// movntq [edi+16],mm7
   db $0F,$E7,$57,$18       /// movntq [edi+24],mm2
   db $0F,$E7,$2C,$07       /// movntq [edi+eax],mm5
   db $0F,$E7,$74,$07,$08   /// movntq [edi+eax+8],mm6
   db $0F,$E7,$7C,$07,$10   /// movntq [edi+eax+16],mm7
   db $0F,$E7,$54,$07,$18   /// movntq [edi+eax+24],mm2

   add esi,24
   add edi,32

   dec ebx
   jnz @MMX_CopyCycle2

   add edi,eax

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX116(const Dest: Pointer;
                                                              const Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov esi,Src
   mov edi,Dest

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$FF00FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov eax,$001F001F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$58       /// movq [ebx+88],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$60       /// movq [ebx+96],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$68       /// movq [ebx+104],mm0

   mov eax,$7C1F7C1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$70       /// movq [ebx+112],mm0

   mov eax,$F8F8F8F8
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$78       /// movq [ebx+120],mm0

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyFirstLine:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyFirstLine

   mov edx,574/2

@MMX_CopyLine:

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyCycle1:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle1

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyCycle2:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$18,$87,$10,$FA,$FF,$FF/// prefetchtna [edi-768*2+16]
   db $0F,$18,$87,$10,$F4,$FF,$FF/// prefetchtna [edi-768*4+16]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3
   db $0F,$6F,$FB           /// movq mm7,mm3

   db $0F,$6F,$8F,$00,$FA,$FF,$FF/// movq mm1,[edi-768*2]
   db $0F,$6F,$97,$00,$F4,$FF,$FF/// movq mm2,[edi-768*4]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$63,$70       /// pand mm4,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$6F,$F3           /// movq mm6,mm3
   db $0F,$FC,$F5           /// paddb mm6,mm5          //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]     //
   db $0F,$71,$D4,$01       /// psrlw mm4,1
   db $0F,$FC,$F4           /// paddb mm6,mm4          //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]     //
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]

   db $0F,$DB,$43,$60       /// pand mm0,[ebx+96]
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$DB,$53,$60       /// pand mm2,[ebx+96]
   db $0F,$73,$F1,$01       /// psllq mm1,1
   db $0F,$F9,$C8           /// psubw mm1,mm0
   db $0F,$F9,$CA           /// psubw mm1,mm2
   db $0F,$FD,$C2           /// paddw mm0,mm2          // PAVGW mm0,mm2
   db $0F,$71,$D0,$01       /// psrlw mm0,1
   db $0F,$73,$F0,$03       /// psllq mm0,3
   db $0F,$FD,$C8           /// paddw mm1,mm0
   db $0F,$73,$D1,$03       /// psrlq mm1,3
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$EB,$F1           /// por mm6,mm1

   db $0F,$E7,$B7,$00,$FA,$FF,$FF/// movntq [edi-768*2],mm6

   db $0F,$6F,$C7           /// movq mm0,mm7
   db $0F,$6F,$8F,$08,$FA,$FF,$FF/// movq mm1,[edi-768*2+8]
   db $0F,$6F,$97,$08,$F4,$FF,$FF/// movq mm2,[edi-768*4+8]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$63,$70       /// pand mm4,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$6F,$F3           /// movq mm6,mm3
   db $0F,$FC,$F5           /// paddb mm6,mm5          //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]     //
   db $0F,$71,$D4,$01       /// psrlw mm4,1
   db $0F,$FC,$F4           /// paddb mm6,mm4          //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]     //
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]

   db $0F,$DB,$43,$60       /// pand mm0,[ebx+96]
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$DB,$53,$60       /// pand mm2,[ebx+96]
   db $0F,$73,$F1,$01       /// psllq mm1,1
   db $0F,$F9,$C8           /// psubw mm1,mm0
   db $0F,$F9,$CA           /// psubw mm1,mm2
   db $0F,$FD,$C2           /// paddw mm0,mm2          // PAVGW mm0,mm2
   db $0F,$71,$D0,$01       /// psrlw mm0,1
   db $0F,$73,$F0,$03       /// psllq mm0,3
   db $0F,$FD,$C8           /// paddw mm1,mm0
   db $0F,$73,$D1,$03       /// psrlq mm1,3
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$EB,$F1           /// por mm6,mm1

   db $0F,$E7,$B7,$08,$FA,$FF,$FF/// movntq [edi-768*2+8],mm6

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle2

   dec edx
   jnz @MMX_CopyLine

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyLastLine:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$18,$87,$10,$FA,$FF,$FF/// prefetchtna [edi-768*2+16]
   db $0F,$18,$87,$10,$F4,$FF,$FF/// prefetchtna [edi-768*4+16]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyLastLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB8GrayScaleMMX132(const Dest: Pointer;
                                              const Src: Pointer;
                                              const SrcW: DWord;
                                              const SrcH: DWord);
var
  CacheMemory: PByte;
  PN: dword;
begin
  GetMem(CacheMemory,4096);
  PN:=SrcW*2 div 32*SrcH;
  asm
   pushad
   pushfd
   mov edi,Dest

   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov ecx,PN

@MMX_CopyCycle:
   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$DB,$03           /// pand mm0,[ebx]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$DB,$0B           /// pand mm1,[ebx]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$73,$D0,$20       /// psrlq mm0,32
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$73,$F1,$20       /// psllq mm1,32
   db $0F,$EB,$C1           /// por mm0,mm1

   db $0F,$DB,$13           /// pand mm2,[ebx]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$DB,$1B           /// pand mm3,[ebx]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$73,$D2,$20       /// psrlq mm2,32
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$73,$F3,$20       /// psllq mm3,32
   db $0F,$EB,$D3           /// por mm2,mm3

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2

   add esi,32
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB8GrayScaleMMX132_Ymirror(const Dest: Pointer;
                                                      const Src: Pointer;
                                                      const SrcW: DWord;
                                                      const SrcH: DWord);
var
  CacheMemory: PByte;
  SrcWD32,
  Size,
  Line2: dword;
begin
  GetMem(CacheMemory,4096);
  Size:=(SrcH-1)*SrcW;
  SrcWD32:=SrcW*2 div 32;
  Line2:=2*SrcW;
  asm
   pushad
   pushfd
   mov edi,Dest
   add edi,Size

   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov edx,SrcH

@MMX_Line:

   mov ecx,SrcWD32

@MMX_CopyCycle:
   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$DB,$03           /// pand mm0,[ebx]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$DB,$0B           /// pand mm1,[ebx]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$73,$D0,$20       /// psrlq mm0,32
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$73,$F1,$20       /// psllq mm1,32
   db $0F,$EB,$C1           /// por mm0,mm1

   db $0F,$DB,$13           /// pand mm2,[ebx]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$DB,$1B           /// pand mm3,[ebx]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$73,$D2,$20       /// psrlq mm2,32
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$73,$F3,$20       /// psllq mm3,32
   db $0F,$EB,$D3           /// por mm2,mm3

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2

   add esi,32
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   sub edi,Line2

   dec edx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure InsertMemoryGrayscaletoYUY2MMX132(const Dest: Pointer;
                                            const Src: Pointer;
                                            const SrcW,SrcH: DWord);
var
  PN: dword;
  CacheMemory: Pointer;
begin
  GetMem(CacheMemory,4096);
  PN:=SrcW*2 div 32*SrcH;
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$FF00FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   db $0F,$EF,$FF           /// pxor mm7,mm7

   mov ecx,PN

@MMX_CopyCycle:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$47,$40       /// prefetchtna [edi+64]
   db $0F,$18,$47,$60       /// prefetchtna [edi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$17           /// movq mm2,[edi]
   db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]
   db $0F,$6F,$67,$10       /// movq mm4,[edi+16]
   db $0F,$6F,$6F,$18       /// movq mm5,[edi+24]

   db $0F,$DB,$13           /// pand mm2,[ebx]  // C Y3 C Y2 C Y1 C Y0
   db $0F,$DB,$1B           /// pand mm3,[ebx]  // C Y7 C Y6 C Y5 C Y4
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$2B           /// pand mm5,[ebx]

   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$60,$C7           /// punpcklbw mm0,mm7
   db $0F,$EB,$D0           /// por mm2,mm0
   db $0F,$68,$F7           /// punpckhbw mm6,mm7
   db $0F,$EB,$DE           /// por mm3,mm6

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$60,$CF           /// punpcklbw mm1,mm7
   db $0F,$EB,$E1           /// por mm4,mm1
   db $0F,$68,$F7           /// punpckhbw mm6,mm7
   db $0F,$EB,$EE           /// por mm5,mm6

   db $0F,$E7,$17           /// movntq [edi],mm2
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3
   db $0F,$E7,$67,$10       /// movntq [edi+16],mm4
   db $0F,$E7,$6F,$18       /// movntq [edi+24],mm5

   add esi,16
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB555MMX116(const Dest: Pointer;
                                       const Src: Pointer;
                                       const SrcW: DWord;
                                       const SrcH: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov edi,Dest

   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$FF00FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov eax,$F8F8F8F8
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$78       /// movq [ebx+120],mm0

   mov edx,SrcH

@MMX_CopyLine:

   mov ecx,SrcW             // ecx=(SrcW*2)/16
   shr ecx,3

@MMX_CopyCycle:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   dec edx
   jnz @MMX_CopyLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB555MMX116Interlaced(const Dest: Pointer;
                                                 const Src: Pointer;
                                                 const SrcW: DWord;
                                                 const SrcH: DWord);
var
  CacheMemory: PByte;
  SrcWD,
  SrcWQ: dword;
begin
  GetMem(CacheMemory,4096);
  SrcWD:=2*SrcW;
  SrcWQ:=4*SrcW;
  asm
   pushad
   pushfd
   mov edi,Dest

   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$FF00FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov eax,$001F001F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$58       /// movq [ebx+88],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$60       /// movq [ebx+96],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$68       /// movq [ebx+104],mm0

   mov eax,$7C1F7C1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$70       /// movq [ebx+112],mm0

   mov eax,$F8F8F8F8
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$78       /// movq [ebx+120],mm0

   mov ecx,SrcW             // ecx=(SrcW*2)/16
   shr ecx,3

@MMX_CopyFirstLine:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyFirstLine

   add edi,SrcWD

   mov edx,SrcH
   dec edx

@MMX_CopyLine:

   mov ecx,SrcW             // ecx=(SrcW*2)/16
   shr ecx,3

@MMX_CopyCycle:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   sub edi,SrcWQ
   db $0F,$6F,$0F           /// movq mm1,[edi]
   db $0F,$6F,$57,$08       /// movq mm2,[edi+8]
   add edi,SrcWD
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$63,$60       /// pand mm4,[ebx+96]
   db $0F,$DB,$6B,$60       /// pand mm5,[ebx+96]
   db $0F,$DB,$73,$60       /// pand mm6,[ebx+96]
   db $0F,$DB,$7B,$60       /// pand mm7,[ebx+96]
   db $0F,$FD,$E6           /// paddw mm4,mm6         // pavgw mm4,mm6
   db $0F,$71,$D4,$01       /// psrlw mm4,1           //
   db $0F,$DB,$63,$60       /// pand mm4,[ebx+96]     //
   db $0F,$FD,$EF           /// paddw mm5,mm7         // pavgw mm5,mm7
   db $0F,$71,$D5,$01       /// psrlw mm5,1           //
   db $0F,$DB,$6B,$60       /// pand mm5,[ebx+96]     //
   db $0F,$DB,$4B,$70       /// pand mm1,[ebx+112]
   db $0F,$DB,$53,$70       /// pand mm2,[ebx+112]
   db $0F,$DB,$43,$70       /// pand mm0,[ebx+112]
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$FC,$C8           /// paddb mm1,mm0         // pavgb mm1,mm0
   db $0F,$71,$D1,$01       /// psrlw mm1,1           //
   db $0F,$DB,$4B,$70       /// pand mm1,[ebx+112]    //
   db $0F,$FC,$D3           /// paddb mm2,mm3         // pavgb mm2,mm3
   db $0F,$71,$D2,$01       /// psrlw mm2,1           //
   db $0F,$DB,$53,$70       /// pand mm2,[ebx+112]    //
   db $0F,$EB,$CC           /// por mm1,mm4
   db $0F,$EB,$D5           /// por mm2,mm5
   db $0F,$E7,$0F           /// movntq [edi],mm1
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2
   add edi,SrcWD

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   add edi,SrcWD

   dec edx
   jnz @MMX_CopyLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB32MMX116(const Dest: Pointer;
                                      const Src: Pointer;
                                      const SrcW: DWord;
                                      const SrcH: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd

   mov edi,Dest
   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$FF00FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov edx,SrcH

@MMX_CopyLine:

   mov ecx,SrcW             // ecx=(SrcW*2)/16
   shr ecx,3

@MMX_CopyCycle:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   // mm1=R
   // mm2=G
   // mm0=B

   db $0F,$EF,$FF           /// pxor mm7,mm7

   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$1F           /// movntq [edi],mm3

   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$73,$D3,$10       /// psrlq mm3,16
   db $0F,$73,$D4,$10       /// psrlq mm4,16
   db $0F,$73,$D5,$10       /// psrlq mm5,16
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$73,$D5,$20       /// psrlq mm5,32
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$10       /// movntq [edi+16],mm3

   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$73,$D3,$30       /// psrlq mm3,48
   db $0F,$73,$D4,$30       /// psrlq mm4,48
   db $0F,$73,$D5,$30       /// psrlq mm5,48
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,16
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   dec edx
   jnz @MMX_CopyLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB32MMX116_Ymirror(const Dest: Pointer;
                                              const Src: Pointer;
                                              const SrcW: DWord;
                                              const SrcH: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd

   mov edi,Dest
   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$FF00FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov eax,SrcW
   shl eax,2

   mov ecx,SrcH
   dec ecx
@DestAdd:
   add edi,eax
   loop @DestAdd

   mov edx,SrcH

@MMX_CopyLine:

   mov ecx,SrcW             // ecx=(SrcW*2)/16
   shr ecx,3

@MMX_CopyCycle:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   // mm1=R
   // mm2=G
   // mm0=B

   db $0F,$EF,$FF           /// pxor mm7,mm7

   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$1F           /// movntq [edi],mm3

   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$73,$D3,$10       /// psrlq mm3,16
   db $0F,$73,$D4,$10       /// psrlq mm4,16
   db $0F,$73,$D5,$10       /// psrlq mm5,16
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$73,$D5,$20       /// psrlq mm5,32
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$10       /// movntq [edi+16],mm3

   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$73,$D3,$30       /// psrlq mm3,48
   db $0F,$73,$D4,$30       /// psrlq mm4,48
   db $0F,$73,$D5,$30       /// psrlq mm5,48
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,16
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   sub edi,eax
   sub edi,eax

   dec edx
   jnz @MMX_CopyLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX116_Ymirror(const Dest: Pointer;
                                                                      const Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov esi,Src
   mov edi,Dest
   mov ecx,576-1
@CALC_edi:
   add edi,768*2
   loop @CALC_edi

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$FF00FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov eax,$001F001F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$58       /// movq [ebx+88],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$60       /// movq [ebx+96],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$68       /// movq [ebx+104],mm0

   mov eax,$7C1F7C1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$70       /// movq [ebx+112],mm0

   mov eax,$F8F8F8F8
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$78       /// movq [ebx+120],mm0

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyFirstLine:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyFirstLine
   sub edi,768*4

   mov edx,574/2

@MMX_CopyLine:

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyCycle1:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle1
   sub edi,768*4

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyCycle2:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$18,$87,$10,$06,$00,$00/// prefetchtna [edi+768*2+16]
   db $0F,$18,$87,$10,$0C,$00,$00/// prefetchtna [edi+768*4+16]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3
   db $0F,$6F,$FB           /// movq mm7,mm3

   db $0F,$6F,$8F,$00,$06,$00,$00/// movq mm1,[edi+768*2]
   db $0F,$6F,$97,$00,$0C,$00,$00/// movq mm2,[edi+768*4]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$63,$70       /// pand mm4,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$6F,$F3           /// movq mm6,mm3
   db $0F,$FC,$F5           /// paddb mm6,mm5          //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]     //
   db $0F,$71,$D4,$01       /// psrlw mm4,1
   db $0F,$FC,$F4           /// paddb mm6,mm4          //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]     //
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]

   db $0F,$DB,$43,$60       /// pand mm0,[ebx+96]
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$DB,$53,$60       /// pand mm2,[ebx+96]
   db $0F,$73,$F1,$01       /// psllq mm1,1
   db $0F,$F9,$C8           /// psubw mm1,mm0
   db $0F,$F9,$CA           /// psubw mm1,mm2
   db $0F,$FD,$C2           /// paddw mm0,mm2          // PAVGW mm0,mm2
   db $0F,$71,$D0,$01       /// psrlw mm0,1            //
   db $0F,$73,$F0,$03       /// psllq mm0,3
   db $0F,$FD,$C8           /// paddw mm1,mm0
   db $0F,$73,$D1,$03       /// psrlq mm1,3
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$EB,$F1           /// por mm6,mm1

   db $0F,$E7,$B7,$00,$06,$00,$00/// movntq [edi+768*2],mm6

   db $0F,$6F,$C7           /// movq mm0,mm7
   db $0F,$6F,$8F,$08,$06,$00,$00/// movq mm1,[edi+768*2+8]
   db $0F,$6F,$97,$08,$0C,$00,$00/// movq mm2,[edi+768*4+8]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$63,$70       /// pand mm4,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$6F,$F3           /// movq mm6,mm3
   db $0F,$FC,$F5           /// paddb mm6,mm5          //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]     //
   db $0F,$71,$D4,$01       /// psrlw mm4,1
   db $0F,$FC,$F4           /// paddb mm6,mm4          //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]     //
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]

   db $0F,$DB,$43,$60       /// pand mm0,[ebx+96]
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$DB,$53,$60       /// pand mm2,[ebx+96]
   db $0F,$73,$F1,$01       /// psllq mm1,1
   db $0F,$F9,$C8           /// psubw mm1,mm0
   db $0F,$F9,$CA           /// psubw mm1,mm2
   db $0F,$FD,$C2           /// paddw mm0,mm2          // PAVGW mm0,mm2
   db $0F,$71,$D0,$01       /// psrlw mm0,1            //
   db $0F,$73,$F0,$03       /// psllq mm0,3
   db $0F,$FD,$C8           /// paddw mm1,mm0
   db $0F,$73,$D1,$03       /// psrlq mm1,3
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$EB,$F1           /// por mm6,mm1

   db $0F,$E7,$B7,$08,$06,$00,$00/// movntq [edi+768*2+8],mm6

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle2
   sub edi,768*4

   dec edx
   jnz @MMX_CopyLine

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyLastLine:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$18,$87,$10,$06,$00,$00/// prefetchtna [edi+768*2+16]
   db $0F,$18,$87,$10,$0C,$00,$00/// prefetchtna [edi+768*4+16]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyLastLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB555MMX116_Ymirror(const Dest: Pointer;
                                               const Src: Pointer;
                                               const SrcW: DWord;
                                               const SrcH: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov edi,Dest

   mov ecx,SrcH
   dec ecx
@CALC_edi:
   add edi,SrcW
   add edi,SrcW
   loop @CALC_edi

   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$FF00FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov eax,$F8F8F8F8
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$78       /// movq [ebx+120],mm0

   mov edx,SrcH

@MMX_CopyLine:

   mov ecx,SrcW             // ecx=(SrcW*2)/16
   shr ecx,3

@MMX_CopyCycle:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4
   db $0F,$67,$F6           /// packuswb mm6,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$67,$FF           /// packuswb mm7,mm7
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$40       /// pand mm7,[ebx+64]
   db $0F,$71,$D7,$08       /// psrlw mm7,8

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$ED,$C6           /// paddsw mm0,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$67,$C0           /// packuswb mm0,mm0
   db $0F,$67,$C9           /// packuswb mm1,mm1
   db $0F,$67,$D2           /// packuswb mm2,mm2
   db $0F,$67,$DB           /// packuswb mm3,mm3
   db $0F,$67,$E4           /// packuswb mm4,mm4
   db $0F,$67,$ED           /// packuswb mm5,mm5
   db $0F,$60,$C3           /// punpcklbw mm0,mm3
   db $0F,$60,$CC           /// punpcklbw mm1,mm4
   db $0F,$60,$D5           /// punpcklbw mm2,mm5

   db $0F,$DB,$43,$78       /// pand mm0,[ebx+120]  //B
   db $0F,$DB,$53,$78       /// pand mm2,[ebx+120]  //G
   db $0F,$DB,$4B,$78       /// pand mm1,[ebx+120]  //R

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$71,$D1,$01       /// psrlw mm1,1
   db $0F,$EF,$E4           /// pxor mm4,mm4
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$FA           /// movq mm7,mm2
   db $0F,$60,$D4           /// punpcklbw mm2,mm4
   db $0F,$60,$C1           /// punpcklbw mm0,mm1
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$68,$FC           /// punpckhbw mm7,mm4
   db $0F,$68,$D9           /// punpckhbw mm3,mm1
   db $0F,$71,$F7,$02       /// psllw mm7,2
   db $0F,$EB,$DF           /// por mm3,mm7
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   sub edi,SrcW
   sub edi,SrcW
   sub edi,SrcW
   sub edi,SrcW

   dec edx
   jnz @MMX_CopyLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure YUY2DeinterlaceOnly768x576MMX116(const Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov esi,Src

   mov edx,(768*2)/16
   mov ecx,576/2-1

   mov ebx,Pointer(CacheMemory)

   mov eax,$1F1F1F1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$FEFEFEFE
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

@MMX_Line:

   mov eax,edx
@MMX_CopyCycle:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$86,$20,$06,$00,$00/// prefetchtna [esi+768*2+32]
   db $0F,$18,$86,$30,$06,$00,$00/// prefetchtna [esi+768*2+48]
   db $0F,$18,$86,$20,$0C,$00,$00/// prefetchtna [esi+768*4+32]
   db $0F,$18,$86,$30,$0C,$00,$00/// prefetchtna [esi+768*4+48]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]
   db $0F,$6F,$8E,$00,$06,$00,$00/// movq mm1,[esi+768*2]
   db $0F,$6F,$A6,$08,$06,$00,$00/// movq mm4,[esi+768*2+8]
   db $0F,$6F,$96,$00,$0C,$00,$00/// movq mm2,[esi+768*4]
   db $0F,$6F,$AE,$08,$0C,$00,$00/// movq mm5,[esi+768*4+8]

   db $0F,$6F,$F0           /// movq mm6,mm0

   db $0F,$6F,$FA           /// movq mm7,mm2           //
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$7B,$08       /// pand mm7,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm2
   db $0F,$71,$D7,$01       /// psrlw mm7,1            //
   db $0F,$FC,$F7           /// paddb mm6,mm7          //

   db $0F,$DB,$4B,$08       /// pand mm1,[ebx+8]       //  PAVGB mm1,0
   db $0F,$71,$D1,$01       /// psrlw mm1,1            //

   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$4B,$08       /// pand mm1,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm1
   db $0F,$71,$D1,$01       /// psrlw mm1,1            //
   db $0F,$FC,$F1           /// paddb mm6,mm1          //

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$03           /// pand mm0,[ebx]
   db $0F,$71,$D2,$03       /// psrlw mm2,3
   db $0F,$DB,$13           /// pand mm2,[ebx]
   db $0F,$DC,$F0           /// paddusb mm6,mm0
   db $0F,$DC,$F2           /// paddusb mm6,mm2

   db $0F,$E7,$B6,$00,$06,$00,$00/// movntq [esi+768*2],mm6

   db $0F,$6F,$F3           /// movq mm6,mm3

   db $0F,$6F,$FD           /// movq mm7,mm5           //
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$7B,$08       /// pand mm7,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$71,$D7,$01       /// psrlw mm7,1            //
   db $0F,$FC,$F7           /// paddb mm6,mm7          //

   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]       //  PAVGB mm4,0
   db $0F,$71,$D4,$01       /// psrlw mm4,1            //

   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm4
   db $0F,$71,$D4,$01       /// psrlw mm4,1            //
   db $0F,$FC,$F4           /// paddb mm6,mm4          //

   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$1B           /// pand mm3,[ebx]
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5

   db $0F,$E7,$B6,$08,$06,$00,$00/// movntq [esi+768*2+8],mm6

   add esi,16

   dec eax
   jnz @MMX_CopyCycle

   add esi,768*2

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;


procedure YUY2DeinterlaceOnly768x576_2MMX116(const Dest: Pointer;
                                             const Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov esi,Src
   mov edi,Dest

   mov edx,(768*2)/16
   mov ecx,576/2-1

   mov ebx,Pointer(CacheMemory)

   mov eax,$1F1F1F1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$FEFEFEFE
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,edx
   shr eax,1
@MMX_FirstLine:
   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32
   dec eax
   jnz @MMX_FirstLine

   mov esi,Src
   mov edi,Dest

@MMX_Line:

   mov eax,edx
@MMX_CopyCycle:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$86,$20,$06,$00,$00/// prefetchtna [esi+768*2+32]
   db $0F,$18,$86,$30,$06,$00,$00/// prefetchtna [esi+768*2+48]
   db $0F,$18,$86,$20,$0C,$00,$00/// prefetchtna [esi+768*4+32]
   db $0F,$18,$86,$30,$0C,$00,$00/// prefetchtna [esi+768*4+48]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]
   db $0F,$6F,$8E,$00,$06,$00,$00/// movq mm1,[esi+768*2]
   db $0F,$6F,$A6,$08,$06,$00,$00/// movq mm4,[esi+768*2+8]
   db $0F,$6F,$96,$00,$0C,$00,$00/// movq mm2,[esi+768*4]
   db $0F,$6F,$AE,$08,$0C,$00,$00/// movq mm5,[esi+768*4+8]

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3
   db $0F,$E7,$97,$00,$0C,$00,$00/// movntq [edi+768*4],mm2
   db $0F,$E7,$AF,$08,$0C,$00,$00/// movntq [edi+768*4+8],mm5

   db $0F,$6F,$F0           /// movq mm6,mm0

   db $0F,$6F,$FA           /// movq mm7,mm2           //
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$7B,$08       /// pand mm7,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm2
   db $0F,$71,$D7,$01       /// psrlw mm7,1            //
   db $0F,$FC,$F7           /// paddb mm6,mm7          //

   db $0F,$DB,$4B,$08       /// pand mm1,[ebx+8]       //  PAVGB mm1,0
   db $0F,$71,$D1,$01       /// psrlw mm1,1            //

   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$4B,$08       /// pand mm1,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm1
   db $0F,$71,$D1,$01       /// psrlw mm1,1            //
   db $0F,$FC,$F1           /// paddb mm6,mm1          //

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$03           /// pand mm0,[ebx]
   db $0F,$71,$D2,$03       /// psrlw mm2,3
   db $0F,$DB,$13           /// pand mm2,[ebx]
   db $0F,$DC,$F0           /// paddusb mm6,mm0
   db $0F,$DC,$F2           /// paddusb mm6,mm2

   db $0F,$E7,$B7,$00,$06,$00,$00/// movntq [edi+768*2],mm6

   db $0F,$6F,$F3           /// movq mm6,mm3

   db $0F,$6F,$FD           /// movq mm7,mm5           //
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$7B,$08       /// pand mm7,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$71,$D7,$01       /// psrlw mm7,1            //
   db $0F,$FC,$F7           /// paddb mm6,mm7          //

   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]       //  PAVGB mm4,0
   db $0F,$71,$D4,$01       /// psrlw mm4,1            //

   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm4
   db $0F,$71,$D4,$01       /// psrlw mm4,1            //
   db $0F,$FC,$F4           /// paddb mm6,mm4          //

   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$1B           /// pand mm3,[ebx]
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5

   db $0F,$E7,$B7,$08,$06,$00,$00/// movntq [edi+768*2+8],mm6

   add esi,16
   add edi,16

   dec eax
   jnz @MMX_CopyCycle

   add esi,768*2
   add edi,768*2

   dec ecx
   jnz @MMX_Line

   mov eax,edx
   shr eax,1
@MMX_LastLine:
   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32
   dec eax
   jnz @MMX_LastLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure YUY2DeinterlaceOnly768x576_2MMX116_Ymirror(const Dest: Pointer;
                                                     const Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov esi,Src
   mov edi,Dest
   mov ecx,576-1
@CALC_edi:
   add edi,768*2
   loop @CALC_edi

   mov edx,(768*2)/16

   mov ebx,Pointer(CacheMemory)

   mov eax,$1F1F1F1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$FEFEFEFE
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,edx
   shr eax,1
@MMX_FirstLine:
   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32
   dec eax
   jnz @MMX_FirstLine

   mov esi,Src
   mov edi,Dest
   mov ecx,576-1
@CALC_edi2:
   add edi,768*2
   loop @CALC_edi2
   mov ecx,576/2-1

@MMX_Line:

   mov eax,edx
@MMX_CopyCycle:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$86,$20,$06,$00,$00/// prefetchtna [esi+768*2+32]
   db $0F,$18,$86,$30,$06,$00,$00/// prefetchtna [esi+768*2+48]
   db $0F,$18,$86,$20,$0C,$00,$00/// prefetchtna [esi+768*4+32]
   db $0F,$18,$86,$30,$0C,$00,$00/// prefetchtna [esi+768*4+48]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]
   db $0F,$6F,$8E,$00,$06,$00,$00/// movq mm1,[esi+768*2]
   db $0F,$6F,$A6,$08,$06,$00,$00/// movq mm4,[esi+768*2+8]
   db $0F,$6F,$96,$00,$0C,$00,$00/// movq mm2,[esi+768*4]
   db $0F,$6F,$AE,$08,$0C,$00,$00/// movq mm5,[esi+768*4+8]

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3
   db $0F,$E7,$97,$00,$F4,$FF,$FF/// movntq [edi-768*4],mm2
   db $0F,$E7,$AF,$08,$F4,$FF,$FF/// movntq [edi-768*4+8],mm5

   db $0F,$6F,$F0           /// movq mm6,mm0

   db $0F,$6F,$FA           /// movq mm7,mm2           //
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$7B,$08       /// pand mm7,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm2
   db $0F,$71,$D7,$01       /// psrlw mm7,1            //
   db $0F,$FC,$F7           /// paddb mm6,mm7          //

   db $0F,$DB,$4B,$08       /// pand mm1,[ebx+8]       //  PAVGB mm1,0
   db $0F,$71,$D1,$01       /// psrlw mm1,1            //

   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$4B,$08       /// pand mm1,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm1
   db $0F,$71,$D1,$01       /// psrlw mm1,1            //
   db $0F,$FC,$F1           /// paddb mm6,mm1          //

   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$03           /// pand mm0,[ebx]
   db $0F,$71,$D2,$03       /// psrlw mm2,3
   db $0F,$DB,$13           /// pand mm2,[ebx]
   db $0F,$DC,$F0           /// paddusb mm6,mm0
   db $0F,$DC,$F2           /// paddusb mm6,mm2

   db $0F,$E7,$B7,$00,$FA,$FF,$FF/// movntq [edi-768*2],mm6

   db $0F,$6F,$F3           /// movq mm6,mm3

   db $0F,$6F,$FD           /// movq mm7,mm5           //
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$7B,$08       /// pand mm7,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm5
   db $0F,$71,$D7,$01       /// psrlw mm7,1            //
   db $0F,$FC,$F7           /// paddb mm6,mm7          //

   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]       //  PAVGB mm4,0
   db $0F,$71,$D4,$01       /// psrlw mm4,1            //

   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]       //
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]       //
   db $0F,$71,$D6,$01       /// psrlw mm6,1            //  PAVGB mm6,mm4
   db $0F,$71,$D4,$01       /// psrlw mm4,1            //
   db $0F,$FC,$F4           /// paddb mm6,mm4          //

   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$1B           /// pand mm3,[ebx]
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5

   db $0F,$E7,$B7,$08,$FA,$FF,$FF/// movntq [edi-768*2+8],mm6

   add esi,16
   add edi,16

   dec eax
   jnz @MMX_CopyCycle

   add esi,768*2
   sub edi,768*2
   sub edi,768*2
   sub edi,768*2

   dec ecx
   jnz @MMX_Line

   mov eax,edx
   shr eax,1
@MMX_LastLine:
   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32
   dec eax
   jnz @MMX_LastLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure YMirrorMMX1(const pBuffer: pointer;
                      const IWidth: integer;
                      const IHeight: integer);
begin
  asm
   pushad
   pushfd

   mov esi,pBuffer

   mov edi,pBuffer
   mov ecx,IHeight
   dec ecx
   mov eax,IWidth
   shl eax,1
@CALC_edi:
   add edi,eax
   loop @CALC_edi

   mov eax,IWidth
   shl eax,2

   mov ebx,IHeight
   shr ebx,1
@MMX_CopyCycle:

   mov ecx,IWidth
   shr ecx,4

@MMX_CopyCycleLine:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]
   db $0F,$18,$47,$40       /// prefetchtna [edi+64]
   db $0F,$18,$47,$60       /// prefetchtna [edi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$6F,$27           /// movq mm4,[edi]
   db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
   db $0F,$6F,$77,$10       /// movq mm6,[edi+16]
   db $0F,$6F,$7F,$18       /// movq mm7,[edi+24]

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3
   db $0F,$E7,$26           /// movntq [esi],mm4
   db $0F,$E7,$6E,$08       /// movntq [esi+8],mm5
   db $0F,$E7,$76,$10       /// movntq [esi+16],mm6
   db $0F,$E7,$7E,$18       /// movntq [esi+24],mm7

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycleLine

   sub edi,eax

   dec ebx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure YMirror_2MMX1(const Dest: pointer;
                        const Src: pointer;
                        const IWidth: integer;
                        const IHeight: integer);
begin
  asm
   pushad
   pushfd

   mov esi,Src

   mov edi,Dest
   mov ecx,IHeight
   dec ecx
   mov eax,IWidth
   shl eax,1
@CALC_edi:
   add edi,eax
   loop @CALC_edi

   mov eax,IWidth
   shl eax,2

   mov ebx,IHeight
@MMX_CopyCycle:

   mov ecx,IWidth
   shr ecx,4

@MMX_CopyCycleLine:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycleLine

   sub edi,eax

   dec ebx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure YMirrorRGB24_2MMX1(const Dest: pointer;
                             const Src: pointer;
                             const IWidth: integer;
                             const IHeight: integer);
begin
  asm
   pushad
   pushfd

   mov esi,Src

   mov edi,Dest
   mov ecx,IHeight
   dec ecx
   mov eax,IWidth
   shl eax,1
   add eax,IWidth     // *2+1=*3
@CALC_edi:
   add edi,eax
   loop @CALC_edi

   mov eax,IWidth
   shl eax,2
   add eax,IWidth
   add eax,IWidth     // *4+1+1=*6

   mov ebx,IHeight
@MMX_CopyCycle:

   mov ecx,IWidth
   shr ecx,4

@MMX_CopyCycleLine:

   db $0F,$18,$46,$96       /// prefetchtna [esi+$96]
   db $0F,$18,$86,$44,$01,$00,$00/// prefetchtna [esi+$144]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$6F,$66,$20       /// movq mm4,[esi+32]
   db $0F,$6F,$6E,$28       /// movq mm5,[esi+40]

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3
   db $0F,$E7,$67,$20       /// movntq [edi+32],mm4
   db $0F,$E7,$6F,$28       /// movntq [edi+40],mm5

   add esi,48
   add edi,48

   dec ecx
   jnz @MMX_CopyCycleLine

   sub edi,eax

   dec ebx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure CopyMemoryAverageYUY2MMX132(const Dest: Pointer;
                                      const Src: Pointer;
                                      const Size: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src
   mov ecx,Size
   shr ecx,5

   mov eax,$FEFEFEFE
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

@MMX_CopyCycle:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]
   db $0F,$18,$47,$40       /// prefetchtna [edi+64]
   db $0F,$18,$47,$60       /// prefetchtna [edi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$6F,$27           /// movq mm4,[edi]
   db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
   db $0F,$6F,$77,$10       /// movq mm6,[edi+16]
   db $0F,$6F,$7F,$18       /// movq mm7,[edi+24]

   db $0F,$DB,$03           /// pand mm0,[ebx]
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$71,$D0,$01       /// psrlw mm0,1         // PAVGB mm0,mm4
   db $0F,$71,$D4,$01       /// psrlw mm4,1
   db $0F,$FC,$C4           /// paddb mm0,mm4

   db $0F,$DB,$0B           /// pand mm1,[ebx]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$71,$D1,$01       /// psrlw mm1,1         // PAVGB mm1,mm5
   db $0F,$71,$D5,$01       /// psrlw mm5,1
   db $0F,$FC,$CD           /// paddb mm1,mm5

   db $0F,$DB,$13           /// pand mm2,[ebx]
   db $0F,$DB,$33           /// pand mm6,[ebx]
   db $0F,$71,$D2,$01       /// psrlw mm2,1         // PAVGB mm2,mm6
   db $0F,$71,$D6,$01       /// psrlw mm6,1
   db $0F,$FC,$D6           /// paddb mm2,mm6

   db $0F,$DB,$1B           /// pand mm3,[ebx]
   db $0F,$DB,$3B           /// pand mm7,[ebx]
   db $0F,$71,$D3,$01       /// psrlw mm3,1         // PAVGB mm3,mm7
   db $0F,$71,$D7,$01       /// psrlw mm7,1
   db $0F,$FC,$DF           /// paddb mm3,mm7

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryAverageRGB555MMX116(const Dest: Pointer;
                                        const Src: Pointer;
                                        const Size: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src
   mov ecx,Size
   shr ecx,4

   mov ebx,Pointer(CacheMemory)

   mov eax,$001F001F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

@MMX_CopyCycle:

   db $0F,$18,$46,$32       /// prefetchtna [esi+$32]
   db $0F,$18,$46,$48       /// prefetchtna [esi+$48]
   db $0F,$18,$47,$32       /// prefetchtna [edi+$32]
   db $0F,$18,$47,$48       /// prefetchtna [edi+$48]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$17           /// movq mm2,[edi]
   db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$FD,$E5           /// paddw mm4,mm5       // PAVGW mm4,mm5
   db $0F,$71,$D4,$01       /// psrlw mm4,1         //
   db $0F,$6F,$F4           /// movq mm6,mm4
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$6B,$08       /// pand mm5,[ebx+8]
   db $0F,$FD,$E5           /// paddw mm4,mm5       // PAVGW mm4,mm5
   db $0F,$71,$D4,$01       /// psrlw mm4,1         //
   db $0F,$EB,$F4           /// por mm6,mm4
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$63,$10       /// pand mm4,[ebx+16]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$FD,$E5           /// paddw mm4,mm5       // PAVGW mm4,mm5
   db $0F,$71,$D4,$01       /// psrlw mm4,1         //
   db $0F,$EB,$F4           /// por mm6,mm4

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$FD,$E5           /// paddw mm4,mm5       // PAVGW mm4,mm5
   db $0F,$71,$D4,$01       /// psrlw mm4,1         //
   db $0F,$6F,$FC           /// movq mm7,mm4
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$6B,$08       /// pand mm5,[ebx+8]
   db $0F,$FD,$E5           /// paddw mm4,mm5       // PAVGW mm4,mm5
   db $0F,$71,$D4,$01       /// psrlw mm4,1         //
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$63,$10       /// pand mm4,[ebx+16]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$FD,$E5           /// paddw mm4,mm5       // PAVGW mm4,mm5
   db $0F,$71,$D4,$01       /// psrlw mm4,1         //
   db $0F,$EB,$FC           /// por mm7,mm4

   db $0F,$E7,$37           /// movntq [edi],mm6
   db $0F,$E7,$7F,$08       /// movntq [edi+8],mm7

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure VmdYUY2MMX1(const ref,new,mask: Pointer;
                      const Size: DWord;
                      const Noise: DWord;
                      const MeasureLight: boolean;
                      const VR: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  if mask=nil then
    begin
        asm
         pushad
         pushfd

         mov edi,ref
         mov esi,new
         mov ecx,Size
         shr ecx,4

         mov ebx,Pointer(CacheMemory)

         mov eax,$00FF00FF
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$03           /// movq [ebx],mm0

         mov eax,Noise
         mov edx,Noise
         and eax,$000000FF
         and edx,$000000FF
         shl edx,16
         or eax,edx
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

         mov eax,$00010001
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

         mov eax,$00000000
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         mov eax,$000000FF
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

         db $0F,$EF,$C0           /// pxor mm0,mm0
         db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

         db $0F,$7F,$43,$60       /// movq [ebx+96],mm0     // level

         mov eax,$FEFEFEFE
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$68       /// movq [ebx+104],mm0

         db $0F,$EF,$C0           /// pxor mm0,mm0
         db $0F,$7F,$43,$70       /// movq [ebx+112],mm0

       @MMX_CopyCycle:

         db $0F,$18,$46,$32       /// prefetchtna [esi+$32]
         db $0F,$18,$46,$48       /// prefetchtna [esi+$48]
         db $0F,$18,$47,$32       /// prefetchtna [edi+$32]
         db $0F,$18,$47,$48       /// prefetchtna [edi+$48]

         db $0F,$6F,$06           /// movq mm0,[esi]
         db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
         db $0F,$6F,$17           /// movq mm2,[edi]
         db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]

       @MeasureLight:
         cmp MeasureLight,0
         je @MeasureEnd
         db $0F,$6F,$73,$60       /// movq mm6,[ebx+96]
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$10       /// psrlq mm4,16
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$20       /// psrlq mm4,32
         db $0F,$73,$D5,$20       /// psrlq mm5,32
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$30       /// psrlq mm4,48
         db $0F,$73,$D5,$30       /// psrlq mm5,48
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$7F,$73,$60       /// movq [ebx+96],mm6

       @MeasureEnd:
         db $0F,$DB,$03           /// pand mm0,[ebx]  // 0 Y0 0 Y1 0 Y2 0 Y3
         db $0F,$DB,$0B           /// pand mm1,[ebx]  // 0 Y4 0 Y5 0 Y6 0 Y7
         db $0F,$DB,$13           /// pand mm2,[ebx]
         db $0F,$DB,$1B           /// pand mm3,[ebx]

         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$F9,$E2           /// psubw mm4,mm2
         db $0F,$F9,$EB           /// psubw mm5,mm3
         db $0F,$65,$D0           /// pcmpgtw mm2,mm0
         db $0F,$65,$D9           /// pcmpgtw mm3,mm1
         db $0F,$EF,$E2           /// pxor mm4,mm2
         db $0F,$EF,$EB           /// pxor mm5,mm3
         db $0F,$DB,$53,$10       /// pand mm2,[ebx+16] // korrekcio ha negaltunk
         db $0F,$DB,$5B,$10       /// pand mm3,[ebx+16]
         db $0F,$FD,$E2           /// paddw mm4,mm2     // 0 diff0 0 diff1 0 diff2 0 diff3
         db $0F,$FD,$EB           /// paddw mm5,mm3     // 0 diff4 0 diff5 0 diff6 0 diff7

         db $0F,$D9,$63,$08       /// psubusw mm4,[ebx+8] // mm4=0 if Noise>=mm4
         db $0F,$D9,$6B,$08       /// psubusw mm5,[ebx+8]

         db $0F,$65,$63,$70       /// pcmpgtw mm4,[ebx+112]    //
         db $0F,$65,$6B,$70       /// pcmpgtw mm5,[ebx+112]    //  PMIN mm5,[ebx+16]
         db $0F,$DB,$63,$10       /// pand mm4,[ebx+16]        //
         db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]        //

         db $0F,$DD,$E5           /// paddusw mm4,mm5
         db $0F,$6F,$73,$20       /// movq mm6,[ebx+32]

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$7F,$73,$20       /// movq [ebx+32],mm6

         add esi,16
         add edi,16

         dec ecx
         jnz @MMX_CopyCycle

         db $0F,$6F,$43,$20       /// movq mm0,[ebx+32]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov edi,VR
         mov [edi],eax

         mov eax,$FFFFFFFF
         mov [edi+4],eax
         mov [edi+8],eax
         mov [edi+12],eax
         mov [edi+16],eax
         mov [edi+20],eax
         mov [edi+24],eax
         mov [edi+28],eax

         db $0F,$6F,$43,$60       /// movq mm0,[ebx+96]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+32],eax

         db $0F,$77               /// emms
         popfd
         popad
        end;
    end
   else // mask<>nil
    begin
        asm
         pushad
         pushfd

         mov edi,ref
         mov esi,new
         mov edx,mask
         mov ecx,Size
         shr ecx,4

         mov ebx,Pointer(CacheMemory)

         mov eax,$00FF00FF
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$03           /// movq [ebx],mm0

         push edx
         mov eax,Noise
         mov edx,Noise
         and eax,$000000FF
         and edx,$000000FF
         shl edx,16
         or eax,edx
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
         pop edx

         mov eax,$00010001
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

         mov eax,$00000000
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         mov eax,$000000FF
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

         db $0F,$EF,$C0           /// pxor mm0,mm0
         db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
         db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
         db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
         db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
         db $0F,$7F,$43,$40       /// movq [ebx+64],mm0
         db $0F,$7F,$43,$48       /// movq [ebx+72],mm0
         db $0F,$7F,$43,$50       /// movq [ebx+80],mm0
         db $0F,$7F,$43,$58       /// movq [ebx+88],mm0

         db $0F,$7F,$43,$60       /// movq [ebx+96],mm0     // level

         mov eax,$FEFEFEFE
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$68       /// movq [ebx+104],mm0

         db $0F,$EF,$C0           /// pxor mm0,mm0
         db $0F,$7F,$43,$70       /// movq [ebx+112],mm0

       @MMX_CopyCycle:

         db $0F,$18,$46,$32       /// prefetchtna [esi+$32]
         db $0F,$18,$46,$48       /// prefetchtna [esi+$48]
         db $0F,$18,$47,$32       /// prefetchtna [edi+$32]
         db $0F,$18,$47,$48       /// prefetchtna [edi+$48]
         db $0F,$18,$42,$32       /// prefetchtna [edx+$32]
         db $0F,$18,$42,$48       /// prefetchtna [edx+$48]

         db $0F,$6F,$06           /// movq mm0,[esi]
         db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
         db $0F,$6F,$17           /// movq mm2,[edi]
         db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]

       @MeasureLight:
         cmp MeasureLight,0
         je @MeasureEnd
         db $0F,$6F,$73,$60       /// movq mm6,[ebx+96]
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$10       /// psrlq mm4,16
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$20       /// psrlq mm4,32
         db $0F,$73,$D5,$20       /// psrlq mm5,32
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$30       /// psrlq mm4,48
         db $0F,$73,$D5,$30       /// psrlq mm5,48
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$7F,$73,$60       /// movq [ebx+96],mm6

       @MeasureEnd:
         db $0F,$6F,$32           /// movq mm6,[edx]
         db $0F,$7E,$F0           /// movd eax,mm6
         cmp eax,$00
         jne @Check
         db $0F,$73,$D6,$20       /// psrlq mm6,32
         db $0F,$7E,$F0           /// movd eax,mm6
         cmp eax,$00
         jne @Check
         db $0F,$6F,$72,$08       /// movq mm6,[edx+8]
         db $0F,$7E,$F0           /// movd eax,mm6
         cmp eax,$00
         jne @Check
         db $0F,$73,$D6,$20       /// psrlq mm6,32
         db $0F,$7E,$F0           /// movd eax,mm6
         cmp eax,$00
         je @CheckEnd

       @Check:
         db $0F,$DB,$03           /// pand mm0,[ebx]  // 0 Y0 0 Y1 0 Y2 0 Y3
         db $0F,$DB,$0B           /// pand mm1,[ebx]  // 0 Y4 0 Y5 0 Y6 0 Y7
         db $0F,$DB,$13           /// pand mm2,[ebx]
         db $0F,$DB,$1B           /// pand mm3,[ebx]

         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$F9,$E2           /// psubw mm4,mm2
         db $0F,$F9,$EB           /// psubw mm5,mm3
         db $0F,$65,$D0           /// pcmpgtw mm2,mm0
         db $0F,$65,$D9           /// pcmpgtw mm3,mm1
         db $0F,$EF,$E2           /// pxor mm4,mm2
         db $0F,$EF,$EB           /// pxor mm5,mm3
         db $0F,$DB,$53,$10       /// pand mm2,[ebx+16] // korrekcio ha negaltunk
         db $0F,$DB,$5B,$10       /// pand mm3,[ebx+16]
         db $0F,$FD,$E2           /// paddw mm4,mm2     // 0 diff0 0 diff1 0 diff2 0 diff3
         db $0F,$FD,$EB           /// paddw mm5,mm3     // 0 diff4 0 diff5 0 diff6 0 diff7

         db $0F,$D9,$63,$08       /// psubusw mm4,[ebx+8] // mm4=0 if Noise>=mm4
         db $0F,$D9,$6B,$08       /// psubusw mm5,[ebx+8]

         db $0F,$65,$63,$70       /// pcmpgtw mm4,[ebx+112]    //
         db $0F,$65,$6B,$70       /// pcmpgtw mm5,[ebx+112]    //  PMIN mm5,[ebx+16]
         db $0F,$DB,$63,$10       /// pand mm4,[ebx+16]        //
         db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]        //

         db $0F,$6F,$C4           /// movq mm0,mm4
         db $0F,$6F,$CD           /// movq mm1,mm5

         db $0F,$6F,$12           /// movq mm2,[edx]
         db $0F,$6F,$5A,$08       /// movq mm3,[edx+8]

         db $0F,$6F,$7B,$18       /// movq mm7,[ebx+24]

         push ecx
         mov ecx,8
         mov eax,32

       @Mask_NS:

         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1

         db $0F,$DB,$E2           /// pand mm4,mm2
         db $0F,$DB,$EB           /// pand mm5,mm3

         db $0F,$71,$D2,$01       /// psrlw mm2,1
         db $0F,$71,$D3,$01       /// psrlw mm3,1

         db $0F,$DD,$E5           /// paddusw mm4,mm5
         db $0F,$6F,$34,$03       /// movq mm6,[ebx+eax]

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$DB,$EF           /// pand mm5,mm7
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$EF           /// pand mm5,mm7
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$EF           /// pand mm5,mm7
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$EF           /// pand mm5,mm7
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$7F,$34,$03       /// movq [ebx+eax],mm6

         add eax,8
         dec ecx
         jnz @Mask_NS

         pop ecx

       @CheckEnd:
         add esi,16
         add edi,16
         add edx,16

         dec ecx
         jnz @MMX_CopyCycle

         mov edi,VR

         db $0F,$6F,$43,$20       /// movq mm0,[ebx+32]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi],eax
         db $0F,$6F,$43,$28       /// movq mm0,[ebx+40]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+4],eax
         db $0F,$6F,$43,$30       /// movq mm0,[ebx+48]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+8],eax
         db $0F,$6F,$43,$38       /// movq mm0,[ebx+56]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+12],eax
         db $0F,$6F,$43,$40       /// movq mm0,[ebx+64]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+16],eax
         db $0F,$6F,$43,$48       /// movq mm0,[ebx+72]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+20],eax
         db $0F,$6F,$43,$50       /// movq mm0,[ebx+80]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+24],eax
         db $0F,$6F,$43,$58       /// movq mm0,[ebx+88]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+28],eax

         db $0F,$6F,$43,$60       /// movq mm0,[ebx+96]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+32],eax

         db $0F,$77               /// emms
         popfd
         popad
        end;
    end;
  FreeMem(CacheMemory);
end;

procedure CustomMatrixFilter3x3MMX1GrayScale(const Src: pointer;
                                             const SrcW,SrcH: DWord;
                                             const Filter: pointer;
                                             const Sum: Word);
var
  TempImage: PByte;
  opnum,
  Disp_R,
  Disp,
  SrcW_M,
  SrcW_D,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(TempImage,SrcW*SrcH*2);
  opnum:=SrcW*SrcH div (4*8);
  SrcW_M:=(SrcW-2) div 6;
  SrcW_D:=2*SrcW;
  SrcW_R:=4*SrcW-12;
  SrcH_M:=SrcH-2;
  Disp:=SrcW+1;
  Disp_R:=6-(SrcW-(SrcW_M*6)-2);  // maradék byte-ok okozta kiesés kiszámolása
  SrcW_R2:=4*SrcW-16;
  asm
   pushad
   pushfd

   mov ebx,Filter
   sub ebx,256

   //*** Konstansok
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$7F,$83,$00,$0D,$00,$00/// movq [ebx+256+3072],mm0

   //*** Mátrix filter eltolása 1 pixellel X irányba 5-ször egymás után
   mov eax,$FFFF0000
   db $0F,$6E,$D0           /// movd mm2,eax
   db $0F,$73,$F2,$20       /// psllq mm2,32
   mov eax,$00000000
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$D1           /// por mm2,mm1

   mov ecx,5
   //***
@ShiftMatrixFilter:
   db $0F,$6F,$83,$00,$01,$00,$00/// movq mm0,[ebx+256]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$83,$30,$01,$00,$00/// movq [ebx+256+48],mm0
   db $0F,$6F,$83,$08,$01,$00,$00/// movq mm0,[ebx+256+8]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$38,$01,$00,$00/// movq [ebx+256+56],mm0
   //***
   db $0F,$6F,$83,$10,$01,$00,$00/// movq mm0,[ebx+256+16]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$83,$40,$01,$00,$00/// movq [ebx+256+64],mm0
   db $0F,$6F,$83,$18,$01,$00,$00/// movq mm0,[ebx+256+24]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$48,$01,$00,$00/// movq [ebx+256+72],mm0
   //***
   db $0F,$6F,$83,$20,$01,$00,$00/// movq mm0,[ebx+256+32]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$83,$50,$01,$00,$00/// movq [ebx+256+80],mm0
   db $0F,$6F,$83,$28,$01,$00,$00/// movq mm0,[ebx+256+40]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$58,$01,$00,$00/// movq [ebx+256+88],mm0
   //***
   add ebx,48
   dec ecx
   jnz @ShiftMatrixFilter

   mov ebx,Filter
   sub ebx,256

   mov esi,Src
   mov edi,Pointer(TempImage)

   //*** byte->word konverzió
   mov ecx,opnum
@CL:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$6F,$56,$08       /// movq mm2,[esi+8]
   db $0F,$6F,$DA           /// movq mm3,mm2
   db $0F,$6F,$66,$10       /// movq mm4,[esi+16]
   db $0F,$6F,$EC           /// movq mm5,mm4
   db $0F,$6F,$76,$18       /// movq mm6,[esi+24]
   db $0F,$6F,$FE           /// movq mm7,mm6
   db $0F,$68,$83,$00,$0D,$00,$00/// punpckhbw mm0,[ebx+256+3072]
   db $0F,$60,$8B,$00,$0D,$00,$00/// punpcklbw mm1,[ebx+256+3072]
   db $0F,$68,$93,$00,$0D,$00,$00/// punpckhbw mm2,[ebx+256+3072]
   db $0F,$60,$9B,$00,$0D,$00,$00/// punpcklbw mm3,[ebx+256+3072]
   db $0F,$68,$A3,$00,$0D,$00,$00/// punpckhbw mm4,[ebx+256+3072]
   db $0F,$60,$AB,$00,$0D,$00,$00/// punpcklbw mm5,[ebx+256+3072]
   db $0F,$68,$B3,$00,$0D,$00,$00/// punpckhbw mm6,[ebx+256+3072]
   db $0F,$60,$BB,$00,$0D,$00,$00/// punpcklbw mm7,[ebx+256+3072]
   db $0F,$E7,$0F           /// movntq [edi],mm1
   db $0F,$E7,$47,$08       /// movntq [edi+8],mm0
   db $0F,$E7,$5F,$10       /// movntq [edi+16],mm3
   db $0F,$E7,$57,$18       /// movntq [edi+24],mm2
   db $0F,$E7,$6F,$20       /// movntq [edi+32],mm5
   db $0F,$E7,$67,$28       /// movntq [edi+40],mm4
   db $0F,$E7,$7F,$30       /// movntq [edi+48],mm7
   db $0F,$E7,$77,$38       /// movntq [edi+56],mm6

   add esi,32
   add edi,64

   dec ecx
   jnz @CL

   mov edi,Src
   add edi,Disp
   mov esi,Pointer(TempImage)

   mov ecx,SrcH_M

@FL33_1:

   push ecx
   mov ecx,SrcW_M

@FL33_2:

   // 1. sor
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$F8           /// movq mm7,mm0
   db $0F,$F5,$BB,$00,$01,$00,$00/// pmaddwd mm7,[ebx+256]
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$F5,$B3,$30,$01,$00,$00/// pmaddwd mm6,[ebx+256+48]
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$F5,$AB,$60,$01,$00,$00/// pmaddwd mm5,[ebx+256+2*48]
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$F5,$A3,$90,$01,$00,$00/// pmaddwd mm4,[ebx+256+3*48]
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$F5,$9B,$C0,$01,$00,$00/// pmaddwd mm3,[ebx+256+4*48]
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$F5,$93,$F0,$01,$00,$00/// pmaddwd mm2,[ebx+256+5*48]
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$08,$01,$00,$00/// pmaddwd mm1,[ebx+256+8]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$38,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+8]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$68,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+8]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$98,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+8]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$C8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+8]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$F8,$01,$00,$00/// pmaddwd mm1,[ebx+256+5*48+8]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   // 2. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$10,$01,$00,$00/// pmaddwd mm1,[ebx+256+16]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$40,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+16]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$70,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+16]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$A0,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+16]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$D0,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+16]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$00,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+16]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$18,$01,$00,$00/// pmaddwd mm1,[ebx+256+24]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$48,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+24]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$78,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+24]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$A8,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+24]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$D8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+24]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$08,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+24]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   // 3. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$20,$01,$00,$00/// pmaddwd mm1,[ebx+256+32]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$50,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+32]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$80,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+32]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$B0,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+32]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$E0,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+32]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$10,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+32]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$28,$01,$00,$00/// pmaddwd mm1,[ebx+256+40]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$58,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+40]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$88,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+40]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$B8,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+40]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$E8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+40]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$18,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+40]
   db $0F,$FE,$D1           /// paddd mm2,mm1

   // Összegzés
   db $0F,$7E,$F8           /// movd eax,mm7
   db $0F,$73,$D7,$20       /// psrlq mm7,32
   db $0F,$7E,$FA           /// movd edx,mm7
   add eax,edx
   cmp eax,$00
   jg @NN7
   mov eax,$00
@NN7:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K7
   mov al,$FF
@K7:
   mov byte ptr [edi],al

   db $0F,$7E,$F0           /// movd eax,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$7E,$F2           /// movd edx,mm6
   add eax,edx
   cmp eax,$00
   jg @NN6
   mov eax,$00
@NN6:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K6
   mov al,$FF
@K6:
   mov byte ptr [edi+1],al

   db $0F,$7E,$E8           /// movd eax,mm5
   db $0F,$73,$D5,$20       /// psrlq mm5,32
   db $0F,$7E,$EA           /// movd edx,mm5
   add eax,edx
   cmp eax,$00
   jg @NN5
   mov eax,$00
@NN5:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K5
   mov al,$FF
@K5:
   mov byte ptr [edi+2],al

   db $0F,$7E,$E0           /// movd eax,mm4
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$7E,$E2           /// movd edx,mm4
   add eax,edx
   cmp eax,$00
   jg @NN4
   mov eax,$00
@NN4:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K4
   mov al,$FF
@K4:
   mov byte ptr [edi+3],al

   db $0F,$7E,$D8           /// movd eax,mm3
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$7E,$DA           /// movd edx,mm3
   add eax,edx
   cmp eax,$00
   jg @NN3
   mov eax,$00
@NN3:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K3
   mov al,$FF
@K3:
   mov byte ptr [edi+4],al

   db $0F,$7E,$D0           /// movd eax,mm2
   db $0F,$73,$D2,$20       /// psrlq mm2,32
   db $0F,$7E,$D2           /// movd edx,mm2
   add eax,edx
   cmp eax,$00
   jg @NN2
   mov eax,$00
@NN2:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K2
   mov al,$FF
@K2:
   mov byte ptr [edi+5],al

   sub esi,SrcW_R
   add edi,6

   dec ecx
   jnz @FL33_2

   sub esi,Disp_R
   sub esi,Disp_R
   sub edi,Disp_R

   // 1. sor
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$F8           /// movq mm7,mm0
   db $0F,$F5,$BB,$00,$01,$00,$00/// pmaddwd mm7,[ebx+256]
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$F5,$B3,$30,$01,$00,$00/// pmaddwd mm6,[ebx+256+48]
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$F5,$AB,$60,$01,$00,$00/// pmaddwd mm5,[ebx+256+2*48]
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$F5,$A3,$90,$01,$00,$00/// pmaddwd mm4,[ebx+256+3*48]
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$F5,$9B,$C0,$01,$00,$00/// pmaddwd mm3,[ebx+256+4*48]
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$F5,$93,$F0,$01,$00,$00/// pmaddwd mm2,[ebx+256+5*48]
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$08,$01,$00,$00/// pmaddwd mm1,[ebx+256+8]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$38,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+8]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$68,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+8]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$98,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+8]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$C8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+8]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$F8,$01,$00,$00/// pmaddwd mm1,[ebx+256+5*48+8]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   // 2. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$10,$01,$00,$00/// pmaddwd mm1,[ebx+256+16]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$40,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+16]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$70,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+16]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$A0,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+16]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$D0,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+16]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$00,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+16]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$18,$01,$00,$00/// pmaddwd mm1,[ebx+256+24]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$48,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+24]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$78,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+24]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$A8,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+24]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$D8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+24]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$08,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+24]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   // 3. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$20,$01,$00,$00/// pmaddwd mm1,[ebx+256+32]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$50,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+32]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$80,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+32]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$B0,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+32]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$E0,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+32]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$10,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+32]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$28,$01,$00,$00/// pmaddwd mm1,[ebx+256+40]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$58,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+40]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$88,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+40]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$B8,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+40]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$E8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+40]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$18,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+40]
   db $0F,$FE,$D1           /// paddd mm2,mm1

   // Összegzés
   db $0F,$7E,$F8           /// movd eax,mm7
   db $0F,$73,$D7,$20       /// psrlq mm7,32
   db $0F,$7E,$FA           /// movd edx,mm7
   add eax,edx
   cmp eax,$00
   jg @NN72
   mov eax,$00
@NN72:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K72
   mov al,$FF
@K72:
   mov byte ptr [edi],al

   db $0F,$7E,$F0           /// movd eax,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$7E,$F2           /// movd edx,mm6
   add eax,edx
   cmp eax,$00
   jg @NN62
   mov eax,$00
@NN62:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K62
   mov al,$FF
@K62:
   mov byte ptr [edi+1],al

   db $0F,$7E,$E8           /// movd eax,mm5
   db $0F,$73,$D5,$20       /// psrlq mm5,32
   db $0F,$7E,$EA           /// movd edx,mm5
   add eax,edx
   cmp eax,$00
   jg @NN52
   mov eax,$00
@NN52:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K52
   mov al,$FF
@K52:
   mov byte ptr [edi+2],al

   db $0F,$7E,$E0           /// movd eax,mm4
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$7E,$E2           /// movd edx,mm4
   add eax,edx
   cmp eax,$00
   jg @NN42
   mov eax,$00
@NN42:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K42
   mov al,$FF
@K42:
   mov byte ptr [edi+3],al

   db $0F,$7E,$D8           /// movd eax,mm3
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$7E,$DA           /// movd edx,mm3
   add eax,edx
   cmp eax,$00
   jg @NN32
   mov eax,$00
@NN32:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K32
   mov al,$FF
@K32:
   mov byte ptr [edi+4],al

   db $0F,$7E,$D0           /// movd eax,mm2
   db $0F,$73,$D2,$20       /// psrlq mm2,32
   db $0F,$7E,$D2           /// movd edx,mm2
   add eax,edx
   cmp eax,$00
   jg @NN22
   mov eax,$00
@NN22:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K22
   mov al,$FF
@K22:
   mov byte ptr [edi+5],al

   sub esi,SrcW_R2
   add edi,8

   pop ecx
   dec ecx
   jnz @FL33_1

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(TempImage);
end;

procedure CustomMatrixFilter3x3MMX1GrayScaleD(const Dest: pointer;
                                              const Src: pointer;
                                              const SrcW,SrcH: DWord;
                                              const Filter: pointer;
                                              const Sum: Word);
var
  TempImage: PByte;
  opnum,
  Disp_R,
  Disp,
  SrcW_M,
  SrcW_D,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(TempImage,SrcW*SrcH*2);
  opnum:=SrcW*SrcH div (4*8);
  SrcW_M:=(SrcW-2) div 6;
  SrcW_D:=2*SrcW;
  SrcW_R:=4*SrcW-12;
  SrcH_M:=SrcH-2;
  Disp:=SrcW+1;
  Disp_R:=6-(SrcW-(SrcW_M*6)-2);  // maradék byte-ok okozta kiesés kiszámolása
  SrcW_R2:=4*SrcW-16;
  asm
   pushad
   pushfd

   mov ebx,Filter
   sub ebx,256

   //*** Konstansok
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$7F,$83,$00,$0D,$00,$00/// movq [ebx+256+3072],mm0

   //*** Mátrix filter eltolása 1 pixellel X irányba 5-ször egymás után
   mov eax,$FFFF0000
   db $0F,$6E,$D0           /// movd mm2,eax
   db $0F,$73,$F2,$20       /// psllq mm2,32
   mov eax,$00000000
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$D1           /// por mm2,mm1

   mov ecx,5
   //***
@ShiftMatrixFilter:
   db $0F,$6F,$83,$00,$01,$00,$00/// movq mm0,[ebx+256]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$83,$30,$01,$00,$00/// movq [ebx+256+48],mm0
   db $0F,$6F,$83,$08,$01,$00,$00/// movq mm0,[ebx+256+8]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$38,$01,$00,$00/// movq [ebx+256+56],mm0
   //***
   db $0F,$6F,$83,$10,$01,$00,$00/// movq mm0,[ebx+256+16]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$83,$40,$01,$00,$00/// movq [ebx+256+64],mm0
   db $0F,$6F,$83,$18,$01,$00,$00/// movq mm0,[ebx+256+24]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$48,$01,$00,$00/// movq [ebx+256+72],mm0
   //***
   db $0F,$6F,$83,$20,$01,$00,$00/// movq mm0,[ebx+256+32]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$83,$50,$01,$00,$00/// movq [ebx+256+80],mm0
   db $0F,$6F,$83,$28,$01,$00,$00/// movq mm0,[ebx+256+40]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$58,$01,$00,$00/// movq [ebx+256+88],mm0
   //***
   add ebx,48
   dec ecx
   jnz @ShiftMatrixFilter

   mov ebx,Filter
   sub ebx,256

   mov esi,Src
   mov edi,Pointer(TempImage)

   //*** byte->word konverzió
   mov ecx,opnum
@CL:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$6F,$56,$08       /// movq mm2,[esi+8]
   db $0F,$6F,$DA           /// movq mm3,mm2
   db $0F,$6F,$66,$10       /// movq mm4,[esi+16]
   db $0F,$6F,$EC           /// movq mm5,mm4
   db $0F,$6F,$76,$18       /// movq mm6,[esi+24]
   db $0F,$6F,$FE           /// movq mm7,mm6
   db $0F,$68,$83,$00,$0D,$00,$00/// punpckhbw mm0,[ebx+256+3072]
   db $0F,$60,$8B,$00,$0D,$00,$00/// punpcklbw mm1,[ebx+256+3072]
   db $0F,$68,$93,$00,$0D,$00,$00/// punpckhbw mm2,[ebx+256+3072]
   db $0F,$60,$9B,$00,$0D,$00,$00/// punpcklbw mm3,[ebx+256+3072]
   db $0F,$68,$A3,$00,$0D,$00,$00/// punpckhbw mm4,[ebx+256+3072]
   db $0F,$60,$AB,$00,$0D,$00,$00/// punpcklbw mm5,[ebx+256+3072]
   db $0F,$68,$B3,$00,$0D,$00,$00/// punpckhbw mm6,[ebx+256+3072]
   db $0F,$60,$BB,$00,$0D,$00,$00/// punpcklbw mm7,[ebx+256+3072]
   db $0F,$E7,$0F           /// movntq [edi],mm1
   db $0F,$E7,$47,$08       /// movntq [edi+8],mm0
   db $0F,$E7,$5F,$10       /// movntq [edi+16],mm3
   db $0F,$E7,$57,$18       /// movntq [edi+24],mm2
   db $0F,$E7,$6F,$20       /// movntq [edi+32],mm5
   db $0F,$E7,$67,$28       /// movntq [edi+40],mm4
   db $0F,$E7,$7F,$30       /// movntq [edi+48],mm7
   db $0F,$E7,$77,$38       /// movntq [edi+56],mm6

   add esi,32
   add edi,64

   dec ecx
   jnz @CL

   mov edi,Dest
   add edi,Disp
   mov esi,Pointer(TempImage)

   mov ecx,SrcH_M

@FL33_1:

   push ecx
   mov ecx,SrcW_M

@FL33_2:

   // 1. sor
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$F8           /// movq mm7,mm0
   db $0F,$F5,$BB,$00,$01,$00,$00/// pmaddwd mm7,[ebx+256]
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$F5,$B3,$30,$01,$00,$00/// pmaddwd mm6,[ebx+256+48]
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$F5,$AB,$60,$01,$00,$00/// pmaddwd mm5,[ebx+256+2*48]
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$F5,$A3,$90,$01,$00,$00/// pmaddwd mm4,[ebx+256+3*48]
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$F5,$9B,$C0,$01,$00,$00/// pmaddwd mm3,[ebx+256+4*48]
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$F5,$93,$F0,$01,$00,$00/// pmaddwd mm2,[ebx+256+5*48]
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$08,$01,$00,$00/// pmaddwd mm1,[ebx+256+8]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$38,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+8]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$68,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+8]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$98,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+8]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$C8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+8]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$F8,$01,$00,$00/// pmaddwd mm1,[ebx+256+5*48+8]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   // 2. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$10,$01,$00,$00/// pmaddwd mm1,[ebx+256+16]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$40,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+16]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$70,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+16]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$A0,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+16]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$D0,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+16]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$00,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+16]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$18,$01,$00,$00/// pmaddwd mm1,[ebx+256+24]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$48,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+24]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$78,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+24]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$A8,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+24]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$D8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+24]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$08,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+24]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   // 3. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$20,$01,$00,$00/// pmaddwd mm1,[ebx+256+32]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$50,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+32]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$80,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+32]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$B0,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+32]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$E0,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+32]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$10,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+32]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$28,$01,$00,$00/// pmaddwd mm1,[ebx+256+40]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$58,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+40]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$88,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+40]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$B8,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+40]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$E8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+40]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$18,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+40]
   db $0F,$FE,$D1           /// paddd mm2,mm1

   // Összegzés
   db $0F,$7E,$F8           /// movd eax,mm7
   db $0F,$73,$D7,$20       /// psrlq mm7,32
   db $0F,$7E,$FA           /// movd edx,mm7
   add eax,edx
   cmp eax,$00
   jg @NN7
   mov eax,$00
@NN7:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K7
   mov al,$FF
@K7:
   mov byte ptr [edi],al

   db $0F,$7E,$F0           /// movd eax,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$7E,$F2           /// movd edx,mm6
   add eax,edx
   cmp eax,$00
   jg @NN6
   mov eax,$00
@NN6:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K6
   mov al,$FF
@K6:
   mov byte ptr [edi+1],al

   db $0F,$7E,$E8           /// movd eax,mm5
   db $0F,$73,$D5,$20       /// psrlq mm5,32
   db $0F,$7E,$EA           /// movd edx,mm5
   add eax,edx
   cmp eax,$00
   jg @NN5
   mov eax,$00
@NN5:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K5
   mov al,$FF
@K5:
   mov byte ptr [edi+2],al

   db $0F,$7E,$E0           /// movd eax,mm4
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$7E,$E2           /// movd edx,mm4
   add eax,edx
   cmp eax,$00
   jg @NN4
   mov eax,$00
@NN4:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K4
   mov al,$FF
@K4:
   mov byte ptr [edi+3],al

   db $0F,$7E,$D8           /// movd eax,mm3
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$7E,$DA           /// movd edx,mm3
   add eax,edx
   cmp eax,$00
   jg @NN3
   mov eax,$00
@NN3:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K3
   mov al,$FF
@K3:
   mov byte ptr [edi+4],al

   db $0F,$7E,$D0           /// movd eax,mm2
   db $0F,$73,$D2,$20       /// psrlq mm2,32
   db $0F,$7E,$D2           /// movd edx,mm2
   add eax,edx
   cmp eax,$00
   jg @NN2
   mov eax,$00
@NN2:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K2
   mov al,$FF
@K2:
   mov byte ptr [edi+5],al

   sub esi,SrcW_R
   add edi,6

   dec ecx
   jnz @FL33_2

   sub esi,Disp_R
   sub esi,Disp_R
   sub edi,Disp_R

   // 1. sor
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$F8           /// movq mm7,mm0
   db $0F,$F5,$BB,$00,$01,$00,$00/// pmaddwd mm7,[ebx+256]
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$F5,$B3,$30,$01,$00,$00/// pmaddwd mm6,[ebx+256+48]
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$F5,$AB,$60,$01,$00,$00/// pmaddwd mm5,[ebx+256+2*48]
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$F5,$A3,$90,$01,$00,$00/// pmaddwd mm4,[ebx+256+3*48]
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$F5,$9B,$C0,$01,$00,$00/// pmaddwd mm3,[ebx+256+4*48]
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$F5,$93,$F0,$01,$00,$00/// pmaddwd mm2,[ebx+256+5*48]
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$08,$01,$00,$00/// pmaddwd mm1,[ebx+256+8]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$38,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+8]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$68,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+8]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$98,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+8]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$C8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+8]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$F8,$01,$00,$00/// pmaddwd mm1,[ebx+256+5*48+8]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   // 2. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$10,$01,$00,$00/// pmaddwd mm1,[ebx+256+16]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$40,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+16]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$70,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+16]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$A0,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+16]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$D0,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+16]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$00,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+16]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$18,$01,$00,$00/// pmaddwd mm1,[ebx+256+24]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$48,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+24]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$78,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+24]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$A8,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+24]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$D8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+24]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$08,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+24]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   // 3. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$20,$01,$00,$00/// pmaddwd mm1,[ebx+256+32]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$50,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+32]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$80,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+32]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$B0,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+32]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$E0,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+32]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$10,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+32]
   db $0F,$FE,$D1           /// paddd mm2,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$28,$01,$00,$00/// pmaddwd mm1,[ebx+256+40]
   db $0F,$FE,$F9           /// paddd mm7,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$58,$01,$00,$00/// pmaddwd mm1,[ebx+256+48+40]
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$88,$01,$00,$00/// pmaddwd mm1,[ebx+256+2*48+40]
   db $0F,$FE,$E9           /// paddd mm5,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$B8,$01,$00,$00/// pmaddwd mm1,[ebx+256+3*48+40]
   db $0F,$FE,$E1           /// paddd mm4,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$E8,$01,$00,$00/// pmaddwd mm1,[ebx+256+4*48+40]
   db $0F,$FE,$D9           /// paddd mm3,mm1
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$8B,$18,$02,$00,$00/// pmaddwd mm1,[ebx+256+5*48+40]
   db $0F,$FE,$D1           /// paddd mm2,mm1

   // Összegzés
   db $0F,$7E,$F8           /// movd eax,mm7
   db $0F,$73,$D7,$20       /// psrlq mm7,32
   db $0F,$7E,$FA           /// movd edx,mm7
   add eax,edx
   cmp eax,$00
   jg @NN72
   mov eax,$00
@NN72:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K72
   mov al,$FF
@K72:
   mov byte ptr [edi],al

   db $0F,$7E,$F0           /// movd eax,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$7E,$F2           /// movd edx,mm6
   add eax,edx
   cmp eax,$00
   jg @NN62
   mov eax,$00
@NN62:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K62
   mov al,$FF
@K62:
   mov byte ptr [edi+1],al

   db $0F,$7E,$E8           /// movd eax,mm5
   db $0F,$73,$D5,$20       /// psrlq mm5,32
   db $0F,$7E,$EA           /// movd edx,mm5
   add eax,edx
   cmp eax,$00
   jg @NN52
   mov eax,$00
@NN52:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K52
   mov al,$FF
@K52:
   mov byte ptr [edi+2],al

   db $0F,$7E,$E0           /// movd eax,mm4
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$7E,$E2           /// movd edx,mm4
   add eax,edx
   cmp eax,$00
   jg @NN42
   mov eax,$00
@NN42:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K42
   mov al,$FF
@K42:
   mov byte ptr [edi+3],al

   db $0F,$7E,$D8           /// movd eax,mm3
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$7E,$DA           /// movd edx,mm3
   add eax,edx
   cmp eax,$00
   jg @NN32
   mov eax,$00
@NN32:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K32
   mov al,$FF
@K32:
   mov byte ptr [edi+4],al

   db $0F,$7E,$D0           /// movd eax,mm2
   db $0F,$73,$D2,$20       /// psrlq mm2,32
   db $0F,$7E,$D2           /// movd edx,mm2
   add eax,edx
   cmp eax,$00
   jg @NN22
   mov eax,$00
@NN22:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp ax,$FF
   jb @K22
   mov al,$FF
@K22:
   mov byte ptr [edi+5],al

   sub esi,SrcW_R2
   add edi,8

   pop ecx
   dec ecx
   jnz @FL33_1

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(TempImage);
end;

procedure CustomMatrixFilter7x7MMX1GrayScale(const Src: pointer;
                                             const SrcW,SrcH: DWord;
                                             const Filter: pointer;
                                             const Sum: Word);
var
  TempImage: PByte;
  opnum,
  Disp,
  SrcW_M,
  SrcW_D,
  SrcW_R,
  SrcH_M: dword;
begin
  GetMem(TempImage,SrcW*SrcH*2);
  opnum:=SrcW*SrcH div (4*8);
  SrcW_M:=(SrcW-6) div 2;
  SrcW_D:=2*SrcW;
  SrcW_R:=12*SrcW-4;
  SrcH_M:=SrcH-6;
  Disp:=3*SrcW+3;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Pointer(TempImage)

   mov ebx,Filter

   //*** Konstansok
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$7F,$83,$00,$0C,$00,$00/// movq [ebx+3072],mm0

   //*** Mátrix filter eltolása 1 pixellel X irányba
   mov eax,$FFFF0000
   db $0F,$6E,$D0           /// movd mm2,eax
   db $0F,$73,$F2,$20       /// psllq mm2,32
   mov eax,$00000000
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$D1           /// por mm2,mm1
   //***
   db $0F,$6F,$03           /// movq mm0,[ebx]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$43,$70       /// movq [ebx+112],mm0
   db $0F,$6F,$43,$08       /// movq mm0,[ebx+8]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$78       /// movq [ebx+120],mm0
   //***
   db $0F,$6F,$43,$10       /// movq mm0,[ebx+16]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$43,$80       /// movq [ebx+128],mm0
   db $0F,$6F,$43,$18       /// movq mm0,[ebx+24]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$88       /// movq [ebx+136],mm0
   //***
   db $0F,$6F,$43,$20       /// movq mm0,[ebx+32]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$43,$90       /// movq [ebx+144],mm0
   db $0F,$6F,$43,$28       /// movq mm0,[ebx+40]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$98       /// movq [ebx+152],mm0
   //***
   db $0F,$6F,$43,$30       /// movq mm0,[ebx+48]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$43,$A0       /// movq [ebx+160],mm0
   db $0F,$6F,$43,$38       /// movq mm0,[ebx+56]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$A8       /// movq [ebx+168],mm0
   //***
   db $0F,$6F,$43,$40       /// movq mm0,[ebx+64]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$43,$B0       /// movq [ebx+176],mm0
   db $0F,$6F,$43,$48       /// movq mm0,[ebx+72]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$B8       /// movq [ebx+184],mm0
   //***
   db $0F,$6F,$43,$50       /// movq mm0,[ebx+80]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$43,$C0       /// movq [ebx+192],mm0
   db $0F,$6F,$43,$58       /// movq mm0,[ebx+88]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$C8       /// movq [ebx+200],mm0
   //***
   db $0F,$6F,$43,$60       /// movq mm0,[ebx+96]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$7F,$43,$D0       /// movq [ebx+208],mm0
   db $0F,$6F,$43,$68       /// movq mm0,[ebx+104]
   db $0F,$73,$F0,$10       /// psllq mm0,16
   db $0F,$DB,$CA           /// pand mm1,mm2
   db $0F,$73,$D1,$30       /// psrlq mm1,48
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$D8       /// movq [ebx+216],mm0
   //***

   //*** byte->word konverzió
   mov ecx,opnum
@CL:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$6F,$56,$08       /// movq mm2,[esi+8]
   db $0F,$6F,$DA           /// movq mm3,mm2
   db $0F,$6F,$66,$10       /// movq mm4,[esi+16]
   db $0F,$6F,$EC           /// movq mm5,mm4
   db $0F,$6F,$76,$18       /// movq mm6,[esi+24]
   db $0F,$6F,$FE           /// movq mm7,mm6
   db $0F,$68,$83,$00,$0C,$00,$00/// punpckhbw mm0,[ebx+3072]
   db $0F,$60,$8B,$00,$0C,$00,$00/// punpcklbw mm1,[ebx+3072]
   db $0F,$68,$93,$00,$0C,$00,$00/// punpckhbw mm2,[ebx+3072]
   db $0F,$60,$9B,$00,$0C,$00,$00/// punpcklbw mm3,[ebx+3072]
   db $0F,$68,$A3,$00,$0C,$00,$00/// punpckhbw mm4,[ebx+3072]
   db $0F,$60,$AB,$00,$0C,$00,$00/// punpcklbw mm5,[ebx+3072]
   db $0F,$68,$B3,$00,$0C,$00,$00/// punpckhbw mm6,[ebx+3072]
   db $0F,$60,$BB,$00,$0C,$00,$00/// punpcklbw mm7,[ebx+3072]
   db $0F,$E7,$0F           /// movntq [edi],mm1
   db $0F,$E7,$47,$08       /// movntq [edi+8],mm0
   db $0F,$E7,$5F,$10       /// movntq [edi+16],mm3
   db $0F,$E7,$57,$18       /// movntq [edi+24],mm2
   db $0F,$E7,$6F,$20       /// movntq [edi+32],mm5
   db $0F,$E7,$67,$28       /// movntq [edi+40],mm4
   db $0F,$E7,$7F,$30       /// movntq [edi+48],mm7
   db $0F,$E7,$77,$38       /// movntq [edi+56],mm6

   add esi,32
   add edi,64

   dec ecx
   jnz @CL

   mov edi,Src
   add edi,Disp
   mov esi,Pointer(TempImage)

   mov ecx,SrcH_M

@FL77_1:

   push ecx
   mov ecx,SrcW_M

@FL77_2:

   // 1. sor
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$03           /// pmaddwd mm0,[ebx]
   db $0F,$F5,$4B,$70       /// pmaddwd mm1,[ebx+112]
   db $0F,$6F,$F8           /// movq mm7,mm0
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$08       /// pmaddwd mm0,[ebx+8]
   db $0F,$F5,$4B,$78       /// pmaddwd mm1,[ebx+120]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   // 2. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$10       /// pmaddwd mm0,[ebx+16]
   db $0F,$F5,$4B,$80       /// pmaddwd mm1,[ebx+128]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$18       /// pmaddwd mm0,[ebx+24]
   db $0F,$F5,$4B,$88       /// pmaddwd mm1,[ebx+136]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$7E,$F0           /// movd eax,mm6
   // 3. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$20       /// pmaddwd mm0,[ebx+32]
   db $0F,$F5,$4B,$90       /// pmaddwd mm1,[ebx+144]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$28       /// pmaddwd mm0,[ebx+40]
   db $0F,$F5,$4B,$98       /// pmaddwd mm1,[ebx+152]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   // 4. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$30       /// pmaddwd mm0,[ebx+48]
   db $0F,$F5,$4B,$A0       /// pmaddwd mm1,[ebx+160]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$38       /// pmaddwd mm0,[ebx+56]
   db $0F,$F5,$4B,$A8       /// pmaddwd mm1,[ebx+168]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   // 5. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$40       /// pmaddwd mm0,[ebx+64]
   db $0F,$F5,$4B,$B0       /// pmaddwd mm1,[ebx+176]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$48       /// pmaddwd mm0,[ebx+72]
   db $0F,$F5,$4B,$B8       /// pmaddwd mm1,[ebx+184]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   // 6. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$50       /// pmaddwd mm0,[ebx+80]
   db $0F,$F5,$4B,$C0       /// pmaddwd mm1,[ebx+192]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$58       /// pmaddwd mm0,[ebx+88]
   db $0F,$F5,$4B,$C8       /// pmaddwd mm1,[ebx+200]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   // 7. sor
   add esi,SrcW_D
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$60       /// pmaddwd mm0,[ebx+96]
   db $0F,$F5,$4B,$D0       /// pmaddwd mm1,[ebx+208]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1
   db $0F,$6F,$46,$08       /// movq mm0,[esi+8]
   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$F5,$43,$68       /// pmaddwd mm0,[ebx+104]
   db $0F,$F5,$4B,$D8       /// pmaddwd mm1,[ebx+216]
   db $0F,$FE,$F8           /// paddd mm7,mm0
   db $0F,$FE,$F1           /// paddd mm6,mm1

   // Összegzés
   db $0F,$7E,$F8           /// movd eax,mm7
   db $0F,$73,$D7,$20       /// psrlq mm7,32
   db $0F,$7E,$FA           /// movd edx,mm7
   add eax,edx
   cmp eax,$00
   jg @NN7
   mov eax,$00
@NN7:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp eax,$FF
   jb @K7
   mov al,$FF
@K7:
   mov byte ptr [edi],al

   db $0F,$7E,$F0           /// movd eax,mm6
   db $0F,$73,$D6,$20       /// psrlq mm6,32
   db $0F,$7E,$F2           /// movd edx,mm6
   add eax,edx
   cmp eax,$00
   jg @NN6
   mov eax,$00
@NN6:
   ror eax,16
   mov dx,ax
   rol eax,16
   div word ptr Sum
   cmp eax,$FF
   jb @K6
   mov al,$FF
@K6:
   mov byte ptr [edi+1],al

   sub esi,SrcW_R
   add edi,2

   dec ecx
   jnz @FL77_2

   add esi,12
   add edi,6

   pop ecx
   dec ecx
   jnz @FL77_1

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(TempImage);
end;


procedure MedianFilter3x3MMX1Plane(const Src: pointer;
                                   const SrcW,SrcH: DWord);
var
  CacheMemory,
  TempImage: PByte;
  Size,
  Disp,
  DispR,
  SrcW_M,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(TempImage,SrcW*SrcH);
  GetMem(CacheMemory,4096);
  SrcW_M:=(SrcW-2) div 8;   // X irányú ciklus
  SrcW_R:=2*SrcW-8;          // esi eltolásának a helyreállítása 8 növeléssel együtt
  SrcW_R2:=2*SrcW-10;        // u.a. de a maradék byte-ok kiszámolásánál
  SrcH_M:=SrcH-2;           // Y irányú ciklus
  Disp:=SrcW+1;             // Elsõ pixel eltolása
  DispR:=8-(SrcW-(SrcW_M*8)-2);  // maradék byte-ok okozta kiesés kiszámolása
  Size:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Pointer(TempImage)
   add edi,Disp
   mov ebx,Pointer(CacheMemory);

   //Konstansok
   db $0F,$76,$C0           /// pcmpeqd mm0,mm0
   db $0F,$7F,$83,$00,$04,$00,$00/// movq [ebx+1024],mm0

   mov eax,$7F7F7F7F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$08,$04,$00,$00/// movq [ebx+1032],mm0

   mov ecx,SrcH_M

@MF33_1:

   push ecx
   mov ecx,SrcW_M

@MF33_2:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov edx,4

   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3


@MF33R:

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$33           /// pcmpeqb mm6,[ebx]
   db $0F,$6F,$03           /// movq mm0,[ebx]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$03           /// movq [ebx],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$08       /// pcmpeqb mm6,[ebx+8]
   db $0F,$6F,$43,$08       /// movq mm0,[ebx+8]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$10       /// pcmpeqb mm6,[ebx+16]
   db $0F,$6F,$43,$10       /// movq mm0,[ebx+16]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$18       /// pcmpeqb mm6,[ebx+24]
   db $0F,$6F,$43,$18       /// movq mm0,[ebx+24]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$20       /// pcmpeqb mm6,[ebx+32]
   db $0F,$6F,$43,$20       /// movq mm0,[ebx+32]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$28       /// pcmpeqb mm6,[ebx+40]
   db $0F,$6F,$43,$28       /// movq mm0,[ebx+40]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$30       /// pcmpeqb mm6,[ebx+48]
   db $0F,$6F,$43,$30       /// movq mm0,[ebx+48]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$38       /// pcmpeqb mm6,[ebx+56]
   db $0F,$6F,$43,$38       /// movq mm0,[ebx+56]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$40       /// pcmpeqb mm6,[ebx+64]
   db $0F,$6F,$43,$40       /// movq mm0,[ebx+64]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3

   dec edx
   jnz @MF33R

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R
   add edi,8

   dec ecx
   jnz @MF33_2

   sub esi,DispR
   sub edi,DispR

   //**** Maradék byte-ok kiszámolása (nem egész 8-ra jön ki -2 miatt)

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov edx,4

   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3

@MF33R2:

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$33           /// pcmpeqb mm6,[ebx]
   db $0F,$6F,$03           /// movq mm0,[ebx]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$03           /// movq [ebx],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$08       /// pcmpeqb mm6,[ebx+8]
   db $0F,$6F,$43,$08       /// movq mm0,[ebx+8]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$10       /// pcmpeqb mm6,[ebx+16]
   db $0F,$6F,$43,$10       /// movq mm0,[ebx+16]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$18       /// pcmpeqb mm6,[ebx+24]
   db $0F,$6F,$43,$18       /// movq mm0,[ebx+24]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$20       /// pcmpeqb mm6,[ebx+32]
   db $0F,$6F,$43,$20       /// movq mm0,[ebx+32]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$28       /// pcmpeqb mm6,[ebx+40]
   db $0F,$6F,$43,$28       /// movq mm0,[ebx+40]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$30       /// pcmpeqb mm6,[ebx+48]
   db $0F,$6F,$43,$30       /// movq mm0,[ebx+48]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$38       /// pcmpeqb mm6,[ebx+56]
   db $0F,$6F,$43,$38       /// movq mm0,[ebx+56]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$40       /// pcmpeqb mm6,[ebx+64]
   db $0F,$6F,$43,$40       /// movq mm0,[ebx+64]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3


   dec edx
   jnz @MF33R2

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R2
   add edi,10

   pop ecx
   dec ecx
   jnz @MF33_1

   //*** Másolás vissza
   mov edi,Src
   mov esi,Pointer(TempImage)
   mov ecx,Size
   shr ecx,5

   @MMX_CopyCycle:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
  FreeMem(TempImage);
end;

procedure MedianFilter3x3MMX1PlaneD(const Dest: pointer;
                                    const Src: pointer;
                                    const SrcW,SrcH: DWord);
var
  CacheMemory: PByte;
  Size,         
  Disp,
  DispR,
  SrcW_M,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(CacheMemory,4096);
  SrcW_M:=(SrcW-2) div 8;   // X irányú ciklus
  SrcW_R:=2*SrcW-8;          // esi eltolásának a helyreállítása 8 növeléssel együtt
  SrcW_R2:=2*SrcW-10;        // u.a. de a maradék byte-ok kiszámolásánál
  SrcH_M:=SrcH-2;           // Y irányú ciklus
  Disp:=SrcW+1;             // Elsõ pixel eltolása
  DispR:=8-(SrcW-(SrcW_M*8)-2);  // maradék byte-ok okozta kiesés kiszámolása
  Size:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Dest
   add edi,Disp
   mov ebx,Pointer(CacheMemory);

   //Konstansok
   db $0F,$76,$C0           /// pcmpeqd mm0,mm0
   db $0F,$7F,$83,$00,$04,$00,$00/// movq [ebx+1024],mm0

   mov eax,$7F7F7F7F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$08,$04,$00,$00/// movq [ebx+1032],mm0

   mov ecx,SrcH_M

@MF33_1:

   push ecx
   mov ecx,SrcW_M

@MF33_2:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov edx,4

   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3


@MF33R:

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$33           /// pcmpeqb mm6,[ebx]
   db $0F,$6F,$03           /// movq mm0,[ebx]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$03           /// movq [ebx],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$08       /// pcmpeqb mm6,[ebx+8]
   db $0F,$6F,$43,$08       /// movq mm0,[ebx+8]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$10       /// pcmpeqb mm6,[ebx+16]
   db $0F,$6F,$43,$10       /// movq mm0,[ebx+16]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$18       /// pcmpeqb mm6,[ebx+24]
   db $0F,$6F,$43,$18       /// movq mm0,[ebx+24]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$20       /// pcmpeqb mm6,[ebx+32]
   db $0F,$6F,$43,$20       /// movq mm0,[ebx+32]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$28       /// pcmpeqb mm6,[ebx+40]
   db $0F,$6F,$43,$28       /// movq mm0,[ebx+40]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$30       /// pcmpeqb mm6,[ebx+48]
   db $0F,$6F,$43,$30       /// movq mm0,[ebx+48]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$38       /// pcmpeqb mm6,[ebx+56]
   db $0F,$6F,$43,$38       /// movq mm0,[ebx+56]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$40       /// pcmpeqb mm6,[ebx+64]
   db $0F,$6F,$43,$40       /// movq mm0,[ebx+64]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3

   dec edx
   jnz @MF33R

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R
   add edi,8

   dec ecx
   jnz @MF33_2

   sub esi,DispR
   sub edi,DispR

   //**** Maradék byte-ok kiszámolása (nem egész 8-ra jön ki -2 miatt)

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov edx,4

   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3

@MF33R2:

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$33           /// pcmpeqb mm6,[ebx]
   db $0F,$6F,$03           /// movq mm0,[ebx]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$03           /// movq [ebx],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$08       /// pcmpeqb mm6,[ebx+8]
   db $0F,$6F,$43,$08       /// movq mm0,[ebx+8]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$10       /// pcmpeqb mm6,[ebx+16]
   db $0F,$6F,$43,$10       /// movq mm0,[ebx+16]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$18       /// pcmpeqb mm6,[ebx+24]
   db $0F,$6F,$43,$18       /// movq mm0,[ebx+24]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$20       /// pcmpeqb mm6,[ebx+32]
   db $0F,$6F,$43,$20       /// movq mm0,[ebx+32]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$28       /// pcmpeqb mm6,[ebx+40]
   db $0F,$6F,$43,$28       /// movq mm0,[ebx+40]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$30       /// pcmpeqb mm6,[ebx+48]
   db $0F,$6F,$43,$30       /// movq mm0,[ebx+48]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$38       /// pcmpeqb mm6,[ebx+56]
   db $0F,$6F,$43,$38       /// movq mm0,[ebx+56]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$73,$40       /// pcmpeqb mm6,[ebx+64]
   db $0F,$6F,$43,$40       /// movq mm0,[ebx+64]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3


   dec edx
   jnz @MF33R2

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R2
   add edi,10

   pop ecx
   dec ecx
   jnz @MF33_1

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure MinimumFilter3x3MMX1Plane(const Src: pointer;
                                    const SrcW,SrcH: DWord);
var
  CacheMemory,
  TempImage: PByte;
  Size,
  Disp,
  DispR,
  SrcW_M,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(TempImage,SrcW*SrcH);
  GetMem(CacheMemory,4096);
  SrcW_M:=(SrcW-2) div 8;   // X irányú ciklus
  SrcW_R:=2*SrcW-8;          // esi eltolásának a helyreállítása 8 növeléssel együtt
  SrcW_R2:=2*SrcW-10;        // u.a. de a maradék byte-ok kiszámolásánál
  SrcH_M:=SrcH-2;           // Y irányú ciklus
  Disp:=SrcW+1;             // Elsõ pixel eltolása
  DispR:=8-(SrcW-(SrcW_M*8)-2);  // maradék byte-ok okozta kiesés kiszámolása
  Size:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Pointer(TempImage)
   add edi,Disp
   mov ebx,Pointer(CacheMemory);

   //Konstansok
   db $0F,$76,$C0           /// pcmpeqd mm0,mm0
   db $0F,$7F,$83,$00,$04,$00,$00/// movq [ebx+1024],mm0

   mov eax,$7F7F7F7F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$08,$04,$00,$00/// movq [ebx+1032],mm0

   mov ecx,SrcH_M

@MF33_1:

   push ecx
   mov ecx,SrcW_M

@MF33_2:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0


   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R
   add edi,8

   dec ecx
   jnz @MF33_2

   sub esi,DispR
   sub edi,DispR

   //**** Maradék byte-ok kiszámolása (nem egész 8-ra jön ki -2 miatt)

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0


   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R2
   add edi,10

   pop ecx
   dec ecx
   jnz @MF33_1

   //*** Másolás vissza
   mov edi,Src
   mov esi,Pointer(TempImage)
   mov ecx,Size
   shr ecx,5

   @MMX_CopyCycle:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
  FreeMem(TempImage);
end;

procedure MaximumFilter3x3MMX1Plane(const Src: pointer;
                                    const SrcW,SrcH: DWord);
var
  CacheMemory,
  TempImage: PByte;
  Size,
  Disp,
  DispR,
  SrcW_M,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(TempImage,SrcW*SrcH);
  GetMem(CacheMemory,4096);
  SrcW_M:=(SrcW-2) div 8;   // X irányú ciklus
  SrcW_R:=2*SrcW-8;          // esi eltolásának a helyreállítása 8 növeléssel együtt
  SrcW_R2:=2*SrcW-10;        // u.a. de a maradék byte-ok kiszámolásánál
  SrcH_M:=SrcH-2;           // Y irányú ciklus
  Disp:=SrcW+1;             // Elsõ pixel eltolása
  DispR:=8-(SrcW-(SrcW_M*8)-2);  // maradék byte-ok okozta kiesés kiszámolása
  Size:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Pointer(TempImage)
   add edi,Disp
   mov ebx,Pointer(CacheMemory);

   //Konstansok
   db $0F,$76,$C0           /// pcmpeqd mm0,mm0
   db $0F,$7F,$83,$00,$04,$00,$00/// movq [ebx+1024],mm0

   mov eax,$7F7F7F7F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$83,$08,$04,$00,$00/// movq [ebx+1032],mm0

   mov ecx,SrcH_M

@MF33_1:

   push ecx
   mov ecx,SrcW_M

@MF33_2:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0


   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R
   add edi,8

   dec ecx
   jnz @MF33_2

   sub esi,DispR
   sub edi,DispR

   //**** Maradék byte-ok kiszámolása (nem egész 8-ra jön ki -2 miatt)

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0


   db $0F,$6F,$3B           /// movq mm7,[ebx]
   //*
   db $0F,$6F,$63,$08       /// movq mm4,[ebx+8]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$10       /// movq mm4,[ebx+16]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$18       /// movq mm4,[ebx+24]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$20       /// movq mm4,[ebx+32]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$28       /// movq mm4,[ebx+40]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$30       /// movq mm4,[ebx+48]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$38       /// movq mm4,[ebx+56]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3
   //*
   db $0F,$6F,$63,$40       /// movq mm4,[ebx+64]
   db $0F,$6F,$EF           /// movq mm5,mm7
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$D5,$01       /// psrlq mm5,1
   db $0F,$DB,$A3,$08,$04,$00,$00/// pand mm4,[ebx+1032]
   db $0F,$DB,$AB,$08,$04,$00,$00/// pand mm5,[ebx+1032]
   db $0F,$64,$EC           /// pcmpgtb mm5,mm4
   db $0F,$DB,$FD           /// pand mm7,mm5
   db $0F,$EF,$AB,$00,$04,$00,$00/// pxor mm5,[ebx+1024]
   db $0F,$DB,$DD           /// pand mm3,mm5
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R2
   add edi,10

   pop ecx
   dec ecx
   jnz @MF33_1

   //*** Másolás vissza
   mov edi,Src
   mov esi,Pointer(TempImage)
   mov ecx,Size
   shr ecx,5

   @MMX_CopyCycle:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
  FreeMem(TempImage);
end;

procedure RGB32toRGBPlanesMMX132(const Dest: pointer;
                                 const Src: pointer;
                                 const SrcW,SrcH: DWord);
var
  Size: Dword;
  Disp: DWord;
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  Size:=SrcW*SrcH div 8;   // (*4/32)
  Disp:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Dest
   mov ebx,Pointer(CacheMemory);

   mov eax,$00FF0000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$000000FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov edx,Disp
   mov eax,edx
   shl eax,1

   mov ecx,Size
@PLCONV:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DB,$33           /// pand mm6,[ebx]
   db $0F,$DB,$3B           /// pand mm7,[ebx]
   db $0F,$73,$D4,$10       /// psrlq mm4,16
   db $0F,$73,$D5,$10       /// psrlq mm5,16
   db $0F,$73,$D6,$10       /// psrlq mm6,16
   db $0F,$73,$D7,$10       /// psrlq mm7,16
   db $0F,$6B,$E5           /// packssdw mm4,mm5
   db $0F,$6B,$F7           /// packssdw mm6,mm7
   db $0F,$67,$E6           /// packuswb mm4,mm6
   db $0F,$E7,$27           /// movntq [edi],mm4       // R7R6R5R4R3R2R1R0

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$6B,$08       /// pand mm5,[ebx+8]
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]
   db $0F,$DB,$7B,$08       /// pand mm7,[ebx+8]
   db $0F,$73,$D4,$08       /// psrlq mm4,8
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$73,$D6,$08       /// psrlq mm6,8
   db $0F,$73,$D7,$08       /// psrlq mm7,8
   db $0F,$6B,$E5           /// packssdw mm4,mm5
   db $0F,$6B,$F7           /// packssdw mm6,mm7
   db $0F,$67,$E6           /// packuswb mm4,mm6
   db $0F,$E7,$24,$17       /// movntq [edi+edx],mm4   // G7G6G5G4G3G2G1G0

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$63,$10       /// pand mm4,[ebx+16]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]
   db $0F,$6B,$E5           /// packssdw mm4,mm5
   db $0F,$6B,$F7           /// packssdw mm6,mm7
   db $0F,$67,$E6           /// packuswb mm4,mm6
   db $0F,$E7,$24,$07       /// movntq [edi+eax],mm4   // B7B6B5B4B3B2B1B0

   add esi,32
   add edi,8

   dec ecx
   jnz @PLCONV

   db $0F,$77               /// emms

   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure RGBPlanestoRGB32MMX132(const Dest: pointer;
                                 const Src: pointer;
                                 const SrcW,SrcH: DWord);
var
  Size: Dword;
  Disp: DWord;
begin
  Size:=SrcW*SrcH div 8;   // (*4/32)
  Disp:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Dest

   mov edx,Disp
   mov eax,edx
   shl eax,1

   db $0F,$EF,$FF           /// pxor mm7,mm7

   mov ecx,Size
@PLCONV:

   db $0F,$6F,$06           /// movq mm0,[esi]       // R7R6R5R4R3R2R1R0
   db $0F,$6F,$0C,$16       /// movq mm1,[esi+edx]   // G7G6G5G4G3G2G1G0
   db $0F,$6F,$14,$06       /// movq mm2,[esi+eax]   // B7B6B5B4B3B2B1B0

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$1F           /// movntq [edi],mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$73,$D3,$10       /// psrlq mm3,16
   db $0F,$73,$D4,$10       /// psrlq mm4,16
   db $0F,$73,$D5,$10       /// psrlq mm5,16
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$73,$D3,$20       /// psrlq mm3,32
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$73,$D5,$20       /// psrlq mm5,32
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$10       /// movntq [edi+16],mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$73,$D3,$30       /// psrlq mm3,48
   db $0F,$73,$D4,$30       /// psrlq mm4,48
   db $0F,$73,$D5,$30       /// psrlq mm5,48
   db $0F,$60,$DF           /// punpcklbw mm3,mm7
   db $0F,$61,$DF           /// punpcklwd mm3,mm7
   db $0F,$73,$F3,$10       /// psllq mm3,16
   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$61,$E7           /// punpcklwd mm4,mm7
   db $0F,$73,$F4,$08       /// psllq mm4,8
   db $0F,$60,$EF           /// punpcklbw mm5,mm7
   db $0F,$61,$EF           /// punpcklwd mm5,mm7
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,8
   add edi,32

   dec ecx
   jnz @PLCONV

   db $0F,$77               /// emms

   popfd
   popad
  end;
end;


procedure RGB24toRGBPlanesMMX1(const Dest: Pointer;
                               const Src: Pointer;
                               const SrcW,SrcH: DWord);
var
  CacheMemory: PByte;
  Disp,
  SizeDiv24: Dword;
begin
  GetMem(CacheMemory,4096);
  SizeDiv24:=SrcW*SrcH div 8;
  Disp:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov ebx,Pointer(CacheMemory);

   mov edi,Dest
   mov esi,Src
   mov ecx,SizeDiv24

   mov eax,$000000FF
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov edx,Disp
   mov eax,Disp
   shl eax,1

@MMX_CopyCycle:

   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$46,$3C       /// prefetchtna [esi+60]

   db $0F,$EF,$ED           /// pxor mm5,mm5    // R planes
   db $0F,$EF,$F6           /// pxor mm6,mm6    // G planes
   db $0F,$EF,$FF           /// pxor mm7,mm7    // B planes

   db $0F,$6F,$06           /// movq mm0,[esi]

   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$DB,$4B,$10       /// pand mm1,[ebx+16]   // R
   db $0F,$DB,$53,$08       /// pand mm2,[ebx+8]    // G
   db $0F,$DB,$1B           /// pand mm3,[ebx]      // B
   db $0F,$73,$D1,$10       /// psrlq mm1,2*8
   db $0F,$73,$D2,$08       /// psrlq mm2,1*8
//   psrlq mm3,0
   db $0F,$EB,$E9           /// por mm5,mm1
   db $0F,$EB,$F2           /// por mm6,mm2
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$DB,$4B,$28       /// pand mm1,[ebx+40]   // R
   db $0F,$DB,$53,$20       /// pand mm2,[ebx+32]   // G
   db $0F,$DB,$5B,$18       /// pand mm3,[ebx+24]   // B
   db $0F,$73,$D1,$20       /// psrlq mm1,4*8
   db $0F,$73,$D2,$18       /// psrlq mm2,3*8
   db $0F,$73,$D3,$10       /// psrlq mm3,2*8
   db $0F,$EB,$E9           /// por mm5,mm1
   db $0F,$EB,$F2           /// por mm6,mm2
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$6F,$66,$08       /// movq mm4,[esi+8]

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$DB,$0B           /// pand mm1,[ebx]      // R
   db $0F,$DB,$53,$38       /// pand mm2,[ebx+56]   // G
   db $0F,$DB,$5B,$30       /// pand mm3,[ebx+48]   // B
   db $0F,$73,$F1,$10       /// psllq mm1,2*8
   db $0F,$73,$D2,$28       /// psrlq mm2,5*8
   db $0F,$73,$D3,$20       /// psrlq mm3,4*8
   db $0F,$EB,$E9           /// por mm5,mm1
   db $0F,$EB,$F2           /// por mm6,mm2
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$6F,$D4           /// movq mm2,mm4
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$DB,$4B,$18       /// pand mm1,[ebx+24]   // R
   db $0F,$DB,$53,$10       /// pand mm2,[ebx+16]   // G
   db $0F,$DB,$5B,$08       /// pand mm3,[ebx+8]    // B
//   psllq mm1,0
   db $0F,$73,$F2,$08       /// psllq mm2,8
   db $0F,$73,$F3,$10       /// psllq mm3,2*8
   db $0F,$EB,$E9           /// por mm5,mm1
   db $0F,$EB,$F2           /// por mm6,mm2
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$6F,$D4           /// movq mm2,mm4
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$DB,$4B,$30       /// pand mm1,[ebx+48]   // R
   db $0F,$DB,$53,$28       /// pand mm2,[ebx+40]   // G
   db $0F,$DB,$5B,$20       /// pand mm3,[ebx+32]   // B
   db $0F,$73,$D1,$10       /// psrlq mm1,2*8
   db $0F,$73,$D2,$08       /// psrlq mm2,8
//   psrlq mm3,0
   db $0F,$EB,$E9           /// por mm5,mm1
   db $0F,$EB,$F2           /// por mm6,mm2
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$6F,$46,$10       /// movq mm0,[esi+16]

   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$DC           /// movq mm3,mm4
   db $0F,$DB,$4B,$08       /// pand mm1,[ebx+8]    // R
   db $0F,$DB,$13           /// pand mm2,[ebx]      // G
   db $0F,$DB,$5B,$38       /// pand mm3,[ebx+56]   // B
   db $0F,$73,$F1,$20       /// psllq mm1,4*8
   db $0F,$73,$F2,$28       /// psllq mm2,5*8
   db $0F,$73,$D3,$10       /// psrlq mm3,2*8
   db $0F,$EB,$E9           /// por mm5,mm1
   db $0F,$EB,$F2           /// por mm6,mm2
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$DB,$4B,$20       /// pand mm1,[ebx+32]   // R
   db $0F,$DB,$53,$18       /// pand mm2,[ebx+24]   // G
   db $0F,$DB,$5B,$10       /// pand mm3,[ebx+16]   // B
   db $0F,$73,$F1,$18       /// psllq mm1,3*8
   db $0F,$73,$F2,$20       /// psllq mm2,4*8
   db $0F,$73,$F3,$28       /// psllq mm3,5*8
   db $0F,$EB,$E9           /// por mm5,mm1
   db $0F,$EB,$F2           /// por mm6,mm2
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$6F,$C8           /// movq mm1,mm0
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$DB,$4B,$38       /// pand mm1,[ebx+56]   // R
   db $0F,$DB,$53,$30       /// pand mm2,[ebx+48]   // G
   db $0F,$DB,$5B,$28       /// pand mm3,[ebx+40]   // B
//   psllq mm1,0
   db $0F,$73,$F2,$08       /// psllq mm2,8
   db $0F,$73,$F3,$10       /// psllq mm3,2*8
   db $0F,$EB,$E9           /// por mm5,mm1
   db $0F,$EB,$F2           /// por mm6,mm2
   db $0F,$EB,$FB           /// por mm7,mm3

   db $0F,$E7,$2F           /// movntq [edi],mm5
   db $0F,$E7,$34,$17       /// movntq [edi+edx],mm6
   db $0F,$E7,$3C,$07       /// movntq [edi+eax],mm7

   add esi,24
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure ORPlanesMMX132(const Dest: pointer; const Src: pointer; const Size: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src
   mov ecx,Size
   shr ecx,5

@MMX_CopyCycle:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]
   db $0F,$18,$47,$40       /// prefetchtna [edi+64]
   db $0F,$18,$47,$60       /// prefetchtna [edi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$6F,$27           /// movq mm4,[edi]
   db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
   db $0F,$6F,$77,$10       /// movq mm6,[edi+16]
   db $0F,$6F,$7F,$18       /// movq mm7,[edi+24]

   db $0F,$EB,$C4           /// por mm0,mm4
   db $0F,$EB,$CD           /// por mm1,mm5
   db $0F,$EB,$D6           /// por mm2,mm6
   db $0F,$EB,$DF           /// por mm3,mm7

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure XORPlanesMMX132(const Dest: pointer; const Src: pointer; const Size: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src
   mov ecx,Size
   shr ecx,5

@MMX_CopyCycle:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]
   db $0F,$18,$47,$40       /// prefetchtna [edi+64]
   db $0F,$18,$47,$60       /// prefetchtna [edi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$6F,$27           /// movq mm4,[edi]
   db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
   db $0F,$6F,$77,$10       /// movq mm6,[edi+16]
   db $0F,$6F,$7F,$18       /// movq mm7,[edi+24]

   db $0F,$EF,$C4           /// pxor mm0,mm4
   db $0F,$EF,$CD           /// pxor mm1,mm5
   db $0F,$EF,$D6           /// pxor mm2,mm6
   db $0F,$EF,$DF           /// pxor mm3,mm7

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure ANDPlanesMMX132(const Dest: pointer; const Src: pointer; const Size: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src
   mov ecx,Size
   shr ecx,5

@MMX_CopyCycle:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]
   db $0F,$18,$47,$40       /// prefetchtna [edi+64]
   db $0F,$18,$47,$60       /// prefetchtna [edi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$6F,$27           /// movq mm4,[edi]
   db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
   db $0F,$6F,$77,$10       /// movq mm6,[edi+16]
   db $0F,$6F,$7F,$18       /// movq mm7,[edi+24]

   db $0F,$DB,$C4           /// pand mm0,mm4
   db $0F,$DB,$CD           /// pand mm1,mm5
   db $0F,$DB,$D6           /// pand mm2,mm6
   db $0F,$DB,$DF           /// pand mm3,mm7

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

function GetModifiedWindowXWidth(const XW,YW: dword;
                                 const depth: dword): integer;
const
  BYTES = 16;
var
  XWDIV: dword;
begin
  XWDIV:=XW*(depth div 8) div BYTES;
  if XW*(depth div 8) mod BYTES<>0 then Inc(XWDIV);
  while ((XWDIV*BYTES) mod (depth div 8)<>0) do
   Inc(XWDIV);
  Result:=(XWDIV*BYTES) div (depth div 8);
end;

procedure CopyFromWindowMMX116(const Dest: pointer;
                               const Src: pointer;
                               const IMGXW: dword;
                               const X,Y: dword;
                               const XW,YW: dword;
                               const depth: dword);
var
  Disp: dword;
  Disp2: dword;
  XWDIV: dword;
begin
  Disp:=Y*IMGXW*(depth div 8)+X*(depth div 8);
  XWDIV:=GetModifiedWindowXWidth(XW,YW,depth)*(depth div 8) div 16;
  Disp2:=IMGXW*(depth div 8)-(XWDIV*16);
  asm
   pushad
   pushfd

   mov esi,Src
   add esi,Disp
   mov edi,Dest

   mov edx,YW
@LINE:
   mov ecx,XWDIV
@PIXELS:
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1

   add edi,16
   add esi,16

   dec ecx
   jnz @PIXELS

   add esi,Disp2

   dec edx
   jnz @LINE

   db $0F,$77               /// emms
   popfd
   popad
  end
end;

procedure CopyBackToWindowMMX116(const Dest: pointer;
                                 const Src: pointer;
                                 const IMGXW: dword;
                                 const X,Y: dword;
                                 const XW,YW: dword;
                                 const depth: dword);
var
  Disp: dword;
  Disp2: dword;
  XWDIV: dword;
begin
  Disp:=Y*IMGXW*(depth div 8)+X*(depth div 8);
  XWDIV:=GetModifiedWindowXWidth(XW,YW,depth)*(depth div 8) div 16;
  Disp2:=IMGXW*(depth div 8)-(XWDIV*16);
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Dest
   add edi,Disp

   mov edx,YW
@LINE:
   mov ecx,XWDIV
@PIXELS:
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1

   add esi,16
   add edi,16

   dec ecx
   jnz @PIXELS

   add edi,Disp2

   dec edx
   jnz @LINE

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure ORBackToWindowMMX116(const Dest: pointer;
                               const Src: pointer;
                               const IMGXW: dword;
                               const X,Y: dword;
                               const XW,YW: dword;
                               const depth: dword);
var
  Disp: dword;
  Disp2: dword;
  XWDIV: dword;
begin
  Disp:=Y*IMGXW*(depth div 8)+X*(depth div 8);
  XWDIV:=GetModifiedWindowXWidth(XW,YW,depth)*(depth div 8) div 16;
  Disp2:=IMGXW*(depth div 8)-(XWDIV*16);
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Dest
   add edi,Disp

   mov edx,YW
@LINE:
   mov ecx,XWDIV
@PIXELS:
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$17           /// movq mm2,[edi]
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]
   db $0F,$EB,$CB           /// por mm1,mm3
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1

   add esi,16
   add edi,16

   dec ecx
   jnz @PIXELS

   add edi,Disp2

   dec edx
   jnz @LINE

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure ORBackToWindowWithBlackFrameMMX116(const Dest: pointer;
                                             const Src: pointer;
                                             const IMGXW: dword;
                                             const X,Y: dword;
                                             const XW,YW: dword;
                                             const depth: dword);
var
  Disp: dword;
  Disp2: dword;
  XWDIV: dword;
begin
  Disp:=Y*IMGXW*(depth div 8)+X*(depth div 8);
  XWDIV:=GetModifiedWindowXWidth(XW,YW,depth)*(depth div 8) div 16;
  Disp2:=IMGXW*(depth div 8)-(XWDIV*16);
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Dest
   add edi,Disp

   db $0F,$EF,$C0           /// pxor mm0,mm0
   mov ecx,XWDIV
@BLACKPIXELS1:
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$47,$08       /// movntq [edi+8],mm0
   add esi,16
   add edi,16
   dec ecx
   jnz @BLACKPIXELS1
   add edi,Disp2

   mov eax,$00FFFFFF
   db $0F,$6E,$F8           /// movd mm7,eax
   db $0F,$73,$F7,$20       /// psllq mm7,32
   mov eax,$FFFFFFFF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$EB,$F8           /// por mm7,mm0
   //*
   mov eax,$FFFFFFFF
   db $0F,$6E,$F0           /// movd mm6,eax
   db $0F,$73,$F6,$20       /// psllq mm6,32
   mov eax,$FFFFFF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$EB,$F0           /// por mm6,mm0

   mov edx,YW
   sub edx,2
@LINE:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$DB,$C6           /// pand mm0,mm6
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$17           /// movq mm2,[edi]
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]
   db $0F,$EB,$CB           /// por mm1,mm3
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   add esi,16
   add edi,16

   mov ecx,XWDIV
   sub ecx,2
   jc @NOPIXE
   jz @NOPIX
@PIXELS:
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$17           /// movq mm2,[edi]
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]
   db $0F,$EB,$CB           /// por mm1,mm3
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1

   add esi,16
   add edi,16

   dec ecx
   jnz @PIXELS
   jmp @NOPIX

@NOPIXE:
   sub esi,16
   sub edi,16

@NOPIX:
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$DB,$CF           /// pand mm1,mm7
   db $0F,$6F,$17           /// movq mm2,[edi]
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]
   db $0F,$EB,$CB           /// por mm1,mm3
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   add esi,16
   add edi,16

   add edi,Disp2

   dec edx
   jnz @LINE

   db $0F,$EF,$C0           /// pxor mm0,mm0
   mov ecx,XWDIV
@BLACKPIXELS2:
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$47,$08       /// movntq [edi+8],mm0
   add esi,16
   add edi,16
   dec ecx
   jnz @BLACKPIXELS2

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure CutPlanesMMX132(const Src: pointer; const Size: DWord; const Level: byte);
begin
  asm
   pushad
   pushfd

   mov esi,Src

   mov al,Level
   shr al,1
   shl eax,8
   mov al,Level
   shr al,1
   shl eax,8
   mov al,Level
   shr al,1
   shl eax,8
   mov al,Level
   shr al,1
   db $0F,$6E,$F8           /// movd mm7,eax
   db $0F,$73,$F7,$20       /// psllq mm7,32
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$EB,$F8           /// por mm7,mm0

   mov eax,$7F7F7F7F
   db $0F,$6E,$F0           /// movd mm6,eax
   db $0F,$73,$F6,$20       /// psllq mm6,32
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$EB,$F0           /// por mm6,mm0

   mov ecx,Size
   shr ecx,5
@CopyCycle:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$73,$D0,$01       /// psrlq mm0,1
   db $0F,$DB,$C6           /// pand mm0,mm6
   db $0F,$64,$C7           /// pcmpgtb mm0,mm7
   db $0F,$73,$D1,$01       /// psrlq mm1,1
   db $0F,$DB,$CE           /// pand mm1,mm6
   db $0F,$64,$CF           /// pcmpgtb mm1,mm7
   db $0F,$73,$D2,$01       /// psrlq mm2,1
   db $0F,$DB,$D6           /// pand mm2,mm6
   db $0F,$64,$D7           /// pcmpgtb mm2,mm7
   db $0F,$73,$D3,$01       /// psrlq mm3,1
   db $0F,$DB,$DE           /// pand mm3,mm6
   db $0F,$64,$DF           /// pcmpgtb mm3,mm7

   db $0F,$E7,$06           /// movntq [esi],mm0
   db $0F,$E7,$4E,$08       /// movntq [esi+8],mm1
   db $0F,$E7,$56,$10       /// movntq [esi+16],mm2
   db $0F,$E7,$5E,$18       /// movntq [esi+24],mm3

   add esi,32

   dec ecx
   jnz @CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure SearchRectangleRGBMMX1(const SrcFull,SrcRect: pointer;
                                 const SrcfullW,SrcfullH: word;
                                 const SrcRectW,SrcRectH: word;
                                 const sx,sy,ex,ey: word;
                                 var fx,fy: word;
                                 var error: dword);
var
  x,y: word;
  Disp: dword;
  Disp2: dword;
  XWDIV: dword;
  perror: dword;
begin
  XWDIV:=GetModifiedWindowXWidth(SrcRectW,SrcRectH,32)*4 div 16;
  Disp2:=SrcfullW*4-(XWDIV*16);
  error:=$FFFFFFFF;
  for y:=sy to ey do
   for x:=sx to ex do
    begin
     Disp:=y*SrcfullW*4+x*4;
     asm
      pushad
      pushfd

      mov esi,SrcFull
      add esi,Disp
      mov edi,SrcRect

      db $0F,$EF,$D2           /// pxor mm2,mm2
      db $0F,$EF,$FF           /// pxor mm7,mm7

      mov dx,SrcRectH
@LINE:
      mov ecx,XWDIV
@PIXELS:
      db $0F,$18,$46,$20       /// prefetchtna [esi+32]
      db $0F,$18,$47,$20       /// prefetchtna [edi+32]
      db $0F,$6F,$06           /// movq mm0,[esi]
      db $0F,$6F,$66,$08       /// movq mm4,[esi+8]
      db $0F,$6F,$0F           /// movq mm1,[edi]
      db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
      db $0F,$6F,$F1           /// movq mm6,mm1
      db $0F,$64,$F0           /// pcmpgtb mm6,mm0
      db $0F,$F8,$C1           /// psubb mm0,mm1
      db $0F,$EF,$C6           /// pxor mm0,mm6
      db $0F,$6F,$D8           /// movq mm3,mm0
      db $0F,$68,$C2           /// punpckhbw mm0,mm2
      db $0F,$F5,$C0           /// pmaddwd mm0,mm0
      db $0F,$FE,$F8           /// paddd mm7,mm0
      db $0F,$60,$DA           /// punpcklbw mm3,mm2
      db $0F,$F5,$DB           /// pmaddwd mm3,mm3
      db $0F,$FE,$FB           /// paddd mm7,mm3

      db $0F,$6F,$F5           /// movq mm6,mm5
      db $0F,$64,$F4           /// pcmpgtb mm6,mm4
      db $0F,$F8,$E5           /// psubb mm4,mm5
      db $0F,$EF,$E6           /// pxor mm4,mm6
      db $0F,$6F,$DC           /// movq mm3,mm4
      db $0F,$68,$E2           /// punpckhbw mm4,mm2
      db $0F,$F5,$E4           /// pmaddwd mm4,mm4
      db $0F,$FE,$FC           /// paddd mm7,mm4
      db $0F,$60,$DA           /// punpcklbw mm3,mm2
      db $0F,$F5,$DB           /// pmaddwd mm3,mm3
      db $0F,$FE,$FB           /// paddd mm7,mm3

      add edi,16
      add esi,16

      dec ecx
      jnz @PIXELS

      add esi,Disp2

      dec dx
      jnz @LINE

      db $0F,$7E,$F8           /// movd eax,mm7
      db $0F,$73,$D7,$20       /// psrlq mm7,32
      db $0F,$7E,$FB           /// movd ebx,mm7
      add eax,ebx

      mov perror,eax

      db $0F,$77               /// emms
      popfd
      popad
     end;
     if perror<error then
      begin
       error:=perror;
       fx:=x;
       fy:=y;
      end;
    end;
end;

procedure SearchRectangleGrayScaleMMX1(const SrcFull,SrcRect: pointer;
                                       const SrcfullW,SrcfullH: word;
                                       const SrcRectW,SrcRectH: word;
                                       const sx,sy,ex,ey: word;
                                       var fx,fy: word;
                                       var error: dword);
var
  x,y: word;
  Disp: dword;
  Disp2: dword;
  XWDIV: dword;
  perror: dword;
begin
  XWDIV:=GetModifiedWindowXWidth(SrcRectW,SrcRectH,8) div 16;
  Disp2:=SrcfullW-(XWDIV*16);
  error:=$FFFFFFFF;
  for y:=sy to ey do
   for x:=sx to ex do
    begin
     Disp:=y*SrcfullW+x;
     asm
      pushad
      pushfd

      mov esi,SrcFull
      add esi,Disp
      mov edi,SrcRect

      db $0F,$EF,$D2           /// pxor mm2,mm2
      db $0F,$EF,$FF           /// pxor mm7,mm7

      mov dx,SrcRectH
@LINE:
      mov ecx,XWDIV
@PIXELS:
      db $0F,$18,$46,$20       /// prefetchtna [esi+32]
      db $0F,$18,$47,$20       /// prefetchtna [edi+32]
      db $0F,$6F,$06           /// movq mm0,[esi]
      db $0F,$6F,$66,$08       /// movq mm4,[esi+8]
      db $0F,$6F,$0F           /// movq mm1,[edi]
      db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
      db $0F,$6F,$F1           /// movq mm6,mm1
      db $0F,$64,$F0           /// pcmpgtb mm6,mm0
      db $0F,$F8,$C1           /// psubb mm0,mm1
      db $0F,$EF,$C6           /// pxor mm0,mm6
      db $0F,$6F,$D8           /// movq mm3,mm0
      db $0F,$68,$C2           /// punpckhbw mm0,mm2
      db $0F,$F5,$C0           /// pmaddwd mm0,mm0
      db $0F,$FE,$F8           /// paddd mm7,mm0
      db $0F,$60,$DA           /// punpcklbw mm3,mm2
      db $0F,$F5,$DB           /// pmaddwd mm3,mm3
      db $0F,$FE,$FB           /// paddd mm7,mm3

      db $0F,$6F,$F5           /// movq mm6,mm5
      db $0F,$64,$F4           /// pcmpgtb mm6,mm4
      db $0F,$F8,$E5           /// psubb mm4,mm5
      db $0F,$EF,$E6           /// pxor mm4,mm6
      db $0F,$6F,$DC           /// movq mm3,mm4
      db $0F,$68,$E2           /// punpckhbw mm4,mm2
      db $0F,$F5,$E4           /// pmaddwd mm4,mm4
      db $0F,$FE,$FC           /// paddd mm7,mm4
      db $0F,$60,$DA           /// punpcklbw mm3,mm2
      db $0F,$F5,$DB           /// pmaddwd mm3,mm3
      db $0F,$FE,$FB           /// paddd mm7,mm3

      add edi,16
      add esi,16

      dec ecx
      jnz @PIXELS

      add esi,Disp2

      dec dx
      jnz @LINE

      db $0F,$7E,$F8           /// movd eax,mm7
      db $0F,$73,$D7,$20       /// psrlq mm7,32
      db $0F,$7E,$FB           /// movd ebx,mm7
      add eax,ebx

      mov perror,eax

      db $0F,$77               /// emms
      popfd
      popad
     end;
     if perror<error then
      begin
       error:=perror;
       fx:=x;
       fy:=y;
      end;
    end;
end;

procedure SearchRectangleHSVMMX1(const SrcFull,SrcRect: pointer;
                                 const SrcfullW,SrcfullH: word;
                                 const SrcRectW,SrcRectH: word;
                                 const sx,sy,ex,ey: word;
                                 var fx,fy: word;
                                 var error: dword);
var
  x,y: word;
  Disp: dword;
  Disp2: dword;
  XWDIV: dword;
  perror: dword;
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad

   mov ebx,Pointer(CacheMemory)

   mov eax,$FF7FFFFF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C8           /// por mm1,mm0
   db $0F,$7F,$0B           /// movq [ebx],mm1

   mov eax,$007F0000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C8           /// por mm1,mm0
   db $0F,$7F,$4B,$08       /// movq [ebx+8],mm1

   db $0F,$77               /// emms
   popad
  end;
  XWDIV:=GetModifiedWindowXWidth(SrcRectW,SrcRectH,32)*4 div 16;
  Disp2:=SrcfullW*4-(XWDIV*16);
  error:=$FFFFFFFF;
  for y:=sy to ey do
   for x:=sx to ex do
    begin
     Disp:=y*SrcfullW*4+x*4;
     asm
      pushad
      pushfd

      mov esi,SrcFull
      add esi,Disp
      mov edi,SrcRect

      mov ebx,Pointer(CacheMemory)

      db $0F,$EF,$D2           /// pxor mm2,mm2
      db $0F,$EF,$FF           /// pxor mm7,mm7

      mov dx,SrcRectH
@LINE:
      mov ecx,XWDIV
@PIXELS:
      db $0F,$18,$46,$20       /// prefetchtna [esi+32]
      db $0F,$18,$47,$20       /// prefetchtna [edi+32]
      db $0F,$6F,$06           /// movq mm0,[esi]
      db $0F,$6F,$66,$08       /// movq mm4,[esi+8]
      db $0F,$6F,$0F           /// movq mm1,[edi]
      db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
      db $0F,$6F,$F1           /// movq mm6,mm1
      db $0F,$64,$F0           /// pcmpgtb mm6,mm0
      db $0F,$F8,$C1           /// psubb mm0,mm1
      db $0F,$EF,$C6           /// pxor mm0,mm6
      db $0F,$DB,$03           /// pand mm0,[ebx]       // 127 felett
      db $0F,$EF,$43,$08       /// pxor mm0,[ebx+8]     //
      db $0F,$6F,$D8           /// movq mm3,mm0
      db $0F,$68,$C2           /// punpckhbw mm0,mm2
      db $0F,$F5,$C0           /// pmaddwd mm0,mm0
      db $0F,$FE,$F8           /// paddd mm7,mm0
      db $0F,$60,$DA           /// punpcklbw mm3,mm2
      db $0F,$F5,$DB           /// pmaddwd mm3,mm3
      db $0F,$FE,$FB           /// paddd mm7,mm3

      db $0F,$6F,$F5           /// movq mm6,mm5
      db $0F,$64,$F4           /// pcmpgtb mm6,mm4
      db $0F,$F8,$E5           /// psubb mm4,mm5
      db $0F,$EF,$E6           /// pxor mm4,mm6
      db $0F,$DB,$23           /// pand mm4,[ebx]       // 127 felett
      db $0F,$EF,$63,$08       /// pxor mm4,[ebx+8]     //
      db $0F,$6F,$DC           /// movq mm3,mm4
      db $0F,$68,$E2           /// punpckhbw mm4,mm2
      db $0F,$F5,$E4           /// pmaddwd mm4,mm4
      db $0F,$FE,$FC           /// paddd mm7,mm4
      db $0F,$60,$DA           /// punpcklbw mm3,mm2
      db $0F,$F5,$DB           /// pmaddwd mm3,mm3
      db $0F,$FE,$FB           /// paddd mm7,mm3

      add edi,16
      add esi,16

      dec ecx
      jnz @PIXELS

      add esi,Disp2

      dec dx
      jnz @LINE

      db $0F,$7E,$F8           /// movd eax,mm7
      db $0F,$73,$D7,$20       /// psrlq mm7,32
      db $0F,$7E,$FB           /// movd ebx,mm7
      add eax,ebx

      mov perror,eax

      db $0F,$77               /// emms
      popfd
      popad
     end;
     if perror<error then
      begin
       error:=perror;
       fx:=x;
       fy:=y;
      end;
    end;
  FreeMem(CacheMemory);
end;

procedure BGR32toYUY2MMX1(const Dest: pointer; const Src: pointer; const SrcW,SrcH: Dword);
var
  PixelCount: dword;
begin
  PixelCount:=SrcW*SrcH;
  asm
   pushad
   pushfd

   db $0F,$18,$46,$10       /// prefetchtna [esi+16]

   mov eax,$00002646
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   mov eax,$4B230E98
   db $0F,$6E,$F8           /// movd mm7,eax
   db $0F,$EB,$C7           /// por mm0,mm7

   db $0F,$EF,$FF           /// pxor mm7,mm7

   mov edi,Dest
   mov esi,Src

   mov ecx,PixelCount
   shr ecx,1

@CONVERT:
   db $0F,$6F,$1E           /// movq mm3,[esi]
   db $0F,$6F,$E3           /// movq mm4,mm3

   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$F5,$E0           /// pmaddwd mm4,mm0
   db $0F,$7E,$E0           /// movd eax,mm4
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$7E,$E3           /// movd ebx,mm4
   add eax,ebx
   shr eax,15
   mov [edi],al

   db $0F,$7E,$DA           /// movd edx,mm3

   and dx,$00FF
   sub ax,dx
   mov bx,$FF82       // -126
   mul bx
   add ah,$7F
   mov [edi+3],ah

   mov al,[edi]
   shr edx,16
   and dx,$00FF
   xor ah,ah
   sub ax,dx
   mov bx,$FF3B       // -197
   mul bx
   add ah,$7F
   mov [edi+1],ah

   db $0F,$6F,$E3           /// movq mm4,mm3
   db $0F,$68,$E7           /// punpckhbw mm4,mm7
   db $0F,$F5,$E0           /// pmaddwd mm4,mm0
   db $0F,$7E,$E0           /// movd eax,mm4
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$7E,$E3           /// movd ebx,mm4
   add eax,ebx
   shr eax,15
   mov [edi+2],al

   add esi,8
   add edi,4

   dec ecx
   jnz @CONVERT

   popfd
   popad
   db $0F,$77               /// emms
  end;
end;

procedure RGB32toYUY2MMX1(const Dest: pointer; const Src: pointer; const SrcW,SrcH: Dword);
var
  PixelCount: dword;
begin
  PixelCount:=SrcW*SrcH;
  asm
   pushad
   pushfd

   db $0F,$18,$46,$10       /// prefetchtna [esi+16]

   mov eax,$00002646
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   mov eax,$4B230E98
   db $0F,$6E,$F8           /// movd mm7,eax
   db $0F,$EB,$C7           /// por mm0,mm7

   db $0F,$EF,$FF           /// pxor mm7,mm7

   mov edi,Dest
   mov esi,Src

   mov ecx,PixelCount
   shr ecx,1

@CONVERT:
   db $0F,$6F,$1E           /// movq mm3,[esi]
   db $0F,$6F,$E3           /// movq mm4,mm3

   db $0F,$60,$E7           /// punpcklbw mm4,mm7
   db $0F,$F5,$E0           /// pmaddwd mm4,mm0
   db $0F,$7E,$E0           /// movd eax,mm4
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$7E,$E3           /// movd ebx,mm4
   add eax,ebx
   shr eax,15
   mov [edi],al

   db $0F,$7E,$DA           /// movd edx,mm3

   and dx,$00FF
   sub ax,dx
   mov bx,$FF82       // -126
   mul bx
   add ah,$7F
   mov [edi+1],ah

   mov al,[edi]
   shr edx,16
   and dx,$00FF
   xor ah,ah
   sub ax,dx
   mov bx,$FF3B       // -197
   mul bx
   add ah,$7F
   mov [edi+3],ah

   db $0F,$6F,$E3           /// movq mm4,mm3
   db $0F,$68,$E7           /// punpckhbw mm4,mm7
   db $0F,$F5,$E0           /// pmaddwd mm4,mm0
   db $0F,$7E,$E0           /// movd eax,mm4
   db $0F,$73,$D4,$20       /// psrlq mm4,32
   db $0F,$7E,$E3           /// movd ebx,mm4
   add eax,ebx
   shr eax,15
   mov [edi+2],al

   add esi,8
   add edi,4

   dec ecx
   jnz @CONVERT

   popfd
   popad
   db $0F,$77               /// emms
  end;
end;

procedure InterlaceRGB32MMX1(const Dest: pointer; const Src: pointer; const SrcW,SrcH: Dword);
begin
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Dest

   mov eax,SrcW
   shl eax,2

   mov edx,eax
   sub edx,32

   mov ebx,SrcH

@MMX_CopyCycle:

   mov ecx,SrcW
   shr ecx,3

@MMX_CopyCycleLine:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add edi,eax

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3


   add esi,32
   sub edi,edx      // -eax+32 = -(eax-32)

   dec ecx
   jnz @MMX_CopyCycleLine

   add edi,eax

   dec ebx
   jnz @MMX_CopyCycle

   popfd
   popad
   db $0F,$77               /// emms
  end;
end;
//************************ MMX2

procedure CopyMemoryRGB565toRGB555_DeinterlaceOnly768x576MMX28(const Dest: Pointer;
                                                               const Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd

   mov edi,Dest
   mov esi,Src
   mov eax,Pointer(CacheMemory)

   mov ebx,$FFC0FFC0
   db $0F,$6E,$C3           /// movd mm0,ebx
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$CB           /// movd mm1,ebx
   db $0F,$EB,$C8           /// por mm1,mm0
   db $0F,$7F,$08           /// movq [eax],mm1

   mov ebx,$001F001F
   db $0F,$6E,$C3           /// movd mm0,ebx
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$CB           /// movd mm1,ebx
   db $0F,$EB,$C8           /// por mm1,mm0
   db $0F,$7F,$48,$08       /// movq [eax+8],mm1
   db $0F,$73,$F1,$05       /// psllq mm1,5
   db $0F,$7F,$48,$10       /// movq [eax+16],mm1
   db $0F,$73,$F1,$05       /// psllq mm1,5
   db $0F,$7F,$48,$18       /// movq [eax+24],mm1

   mov ecx,768*2/32

@MMX_CopyFirstLine:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$DB,$00           /// pand mm0,[eax]
   db $0F,$73,$D0,$01       /// psrlq mm0,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$C4           /// por mm0,mm4

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$DB,$08           /// pand mm1,[eax]
   db $0F,$73,$D1,$01       /// psrlq mm1,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$CC           /// por mm1,mm4

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$DB,$10           /// pand mm2,[eax]
   db $0F,$73,$D2,$01       /// psrlq mm2,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$D4           /// por mm2,mm4

   db $0F,$6F,$E3           /// movq mm4,mm3
   db $0F,$DB,$18           /// pand mm3,[eax]
   db $0F,$73,$D3,$01       /// psrlq mm3,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$DC           /// por mm3,mm4

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyFirstLine

   mov edi,Dest
   mov esi,Src

   mov ecx,(576/2)-1
   mov edx,(768*2)/8

   db $0F,$6F,$07           /// movq mm0,[edi]

@MMX_Line:

   mov ebx,edx

@MMX_CopyCycle:

   db $0F,$18,$47,$18       /// prefetchtna [edi+24]
   db $0F,$18,$86,$18,$06,$00,$00/// prefetchtna [esi+768*2+24]
   db $0F,$18,$86,$18,$0C,$00,$00/// prefetchtna [esi+768*4+24]
   db $0F,$18,$47,$20       /// prefetchtna [edi+32]
   db $0F,$18,$86,$20,$06,$00,$00/// prefetchtna [esi+768*2+32]
   db $0F,$18,$86,$20,$0C,$00,$00/// prefetchtna [esi+768*4+32]

   db $0F,$6F,$8E,$00,$06,$00,$00/// movq mm1,[esi+768*2]
   db $0F,$6F,$96,$00,$0C,$00,$00/// movq mm2,[esi+768*4]

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$DB,$08           /// pand mm1,[eax]
   db $0F,$73,$D1,$01       /// psrlq mm1,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$CC           /// por mm1,mm4

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$DB,$10           /// pand mm2,[eax]
   db $0F,$73,$D2,$01       /// psrlq mm2,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$D4           /// por mm2,mm4

   db $0F,$EF,$F6           /// pxor mm6,mm6
   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$58,$08       /// pand mm3,[eax+8]
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$DB,$68,$08       /// pand mm5,[eax+8]
   db $0F,$73,$F4,$01       /// psllq mm4,1
   db $0F,$F9,$E3           /// psubw mm4,mm3
   db $0F,$F9,$E5           /// psubw mm4,mm5
   db $0F,$E3,$DD           /// pavgw mm3,mm5
   db $0F,$73,$F3,$03       /// psllq mm3,3
   db $0F,$FD,$E3           /// paddw mm4,mm3
   db $0F,$73,$D4,$03       /// psrlq mm4,3
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$F4           /// por mm6,mm4

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$58,$10       /// pand mm3,[eax+16]
   db $0F,$DB,$60,$10       /// pand mm4,[eax+16]
   db $0F,$DB,$68,$10       /// pand mm5,[eax+16]
   db $0F,$73,$F4,$01       /// psllq mm4,1
   db $0F,$F9,$E3           /// psubw mm4,mm3
   db $0F,$F9,$E5           /// psubw mm4,mm5
   db $0F,$E3,$DD           /// pavgw mm3,mm5
   db $0F,$73,$F3,$03       /// psllq mm3,3
   db $0F,$FD,$E3           /// paddw mm4,mm3
   db $0F,$73,$D4,$03       /// psrlq mm4,3
   db $0F,$DB,$60,$10       /// pand mm4,[eax+16]
   db $0F,$EB,$F4           /// por mm6,mm4

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$DB,$40,$18       /// pand mm0,[eax+24]
   db $0F,$DB,$48,$18       /// pand mm1,[eax+24]
   db $0F,$DB,$50,$18       /// pand mm2,[eax+24]
   db $0F,$73,$D0,$03       /// psrlq mm0,3
   db $0F,$73,$D2,$03       /// psrlq mm2,3
   db $0F,$73,$D1,$02       /// psrlq mm1,2
   db $0F,$F9,$C8           /// psubw mm1,mm0
   db $0F,$F9,$CA           /// psubw mm1,mm2
   db $0F,$E3,$C2           /// pavgw mm0,mm2
   db $0F,$73,$F0,$03       /// psllq mm0,3
   db $0F,$FD,$C8           /// paddw mm1,mm0
   db $0F,$DB,$48,$18       /// pand mm1,[eax+24]
   db $0F,$EB,$F1           /// por mm6,mm1

   db $0F,$E7,$B7,$00,$06,$00,$00/// movntq [edi+768*2],mm6
   db $0F,$7F,$A7,$00,$0C,$00,$00/// movq [edi+768*4],mm4

   add esi,8
   add edi,8

   db $0F,$6F,$07           /// movq mm0,[edi]

   dec ebx
   jnz @MMX_CopyCycle

   add esi,768*2
   add edi,768*2

   dec ecx
   jnz @MMX_Line

   mov ecx,768*2/32

   add esi,768*2
   add edi,768*2

@MMX_CopyLastLine:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$DB,$00           /// pand mm0,[eax]
   db $0F,$73,$D0,$01       /// psrlq mm0,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$C4           /// por mm0,mm4

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$DB,$08           /// pand mm1,[eax]
   db $0F,$73,$D1,$01       /// psrlq mm1,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$CC           /// por mm1,mm4

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$DB,$10           /// pand mm2,[eax]
   db $0F,$73,$D2,$01       /// psrlq mm2,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$D4           /// por mm2,mm4

   db $0F,$6F,$E3           /// movq mm4,mm3
   db $0F,$DB,$18           /// pand mm3,[eax]
   db $0F,$73,$D3,$01       /// psrlq mm3,1
   db $0F,$DB,$60,$08       /// pand mm4,[eax+8]
   db $0F,$EB,$DC           /// por mm3,mm4

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyLastLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX216(const Dest: Pointer;
                                                              const Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov esi,Src
   mov edi,Dest

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$00F800F8
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov eax,$001F001F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$58       /// movq [ebx+88],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$60       /// movq [ebx+96],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$68       /// movq [ebx+104],mm0

   mov eax,$7C1F7C1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$70       /// movq [ebx+112],mm0

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyFirstLine:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$61,$C0           /// punpcklwd mm0,mm0
   db $0F,$61,$C9           /// punpcklwd mm1,mm1
   db $0F,$61,$D2           /// punpcklwd mm2,mm2
   db $0F,$69,$DB           /// punpckhwd mm3,mm3
   db $0F,$69,$E4           /// punpckhwd mm4,mm4
   db $0F,$69,$ED           /// punpckhwd mm5,mm5

   db $0F,$ED,$C6           /// paddsw mm0,mm6      // 0 B3 0 B2 0 B1 0 B0
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7      // 0 B7 0 B6 0 B5 0 B4
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$6F,$73,$10       /// movq mm6,[ebx+16]
   db $0F,$EF,$FF           /// pxor mm7,mm7
   db $0F,$EA,$C6           /// pminsw mm0,mm6
   db $0F,$EE,$C7           /// pmaxsw mm0,mm7
   db $0F,$EA,$CE           /// pminsw mm1,mm6
   db $0F,$EE,$CF           /// pmaxsw mm1,mm7
   db $0F,$EA,$D6           /// pminsw mm2,mm6
   db $0F,$EE,$D7           /// pmaxsw mm2,mm7
   db $0F,$EA,$DE           /// pminsw mm3,mm6
   db $0F,$EE,$DF           /// pmaxsw mm3,mm7
   db $0F,$EA,$E6           /// pminsw mm4,mm6
   db $0F,$EE,$E7           /// pmaxsw mm4,mm7
   db $0F,$EA,$EE           /// pminsw mm5,mm6
   db $0F,$EE,$EF           /// pmaxsw mm5,mm7

   db $0F,$DB,$43,$40       /// pand mm0,[ebx+64]
   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$4B,$40       /// pand mm1,[ebx+64]
   db $0F,$71,$F1,$07       /// psllw mm1,7
   db $0F,$DB,$53,$40       /// pand mm2,[ebx+64]
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$DB,$5B,$40       /// pand mm3,[ebx+64]
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$63,$40       /// pand mm4,[ebx+64]
   db $0F,$71,$F4,$07       /// psllw mm4,7
   db $0F,$DB,$6B,$40       /// pand mm5,[ebx+64]
   db $0F,$71,$F5,$02       /// psllw mm5,2

   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyFirstLine

   mov edx,574/2

@MMX_CopyLine:

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyCycle1:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$61,$C0           /// punpcklwd mm0,mm0
   db $0F,$61,$C9           /// punpcklwd mm1,mm1
   db $0F,$61,$D2           /// punpcklwd mm2,mm2
   db $0F,$69,$DB           /// punpckhwd mm3,mm3
   db $0F,$69,$E4           /// punpckhwd mm4,mm4
   db $0F,$69,$ED           /// punpckhwd mm5,mm5

   db $0F,$ED,$C6           /// paddsw mm0,mm6      // 0 B3 0 B2 0 B1 0 B0
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7      // 0 B7 0 B6 0 B5 0 B4
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$6F,$73,$10       /// movq mm6,[ebx+16]
   db $0F,$EF,$FF           /// pxor mm7,mm7
   db $0F,$EA,$C6           /// pminsw mm0,mm6
   db $0F,$EE,$C7           /// pmaxsw mm0,mm7
   db $0F,$EA,$CE           /// pminsw mm1,mm6
   db $0F,$EE,$CF           /// pmaxsw mm1,mm7
   db $0F,$EA,$D6           /// pminsw mm2,mm6
   db $0F,$EE,$D7           /// pmaxsw mm2,mm7
   db $0F,$EA,$DE           /// pminsw mm3,mm6
   db $0F,$EE,$DF           /// pmaxsw mm3,mm7
   db $0F,$EA,$E6           /// pminsw mm4,mm6
   db $0F,$EE,$E7           /// pmaxsw mm4,mm7
   db $0F,$EA,$EE           /// pminsw mm5,mm6
   db $0F,$EE,$EF           /// pmaxsw mm5,mm7

   db $0F,$DB,$43,$40       /// pand mm0,[ebx+64]
   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$4B,$40       /// pand mm1,[ebx+64]
   db $0F,$71,$F1,$07       /// psllw mm1,7
   db $0F,$DB,$53,$40       /// pand mm2,[ebx+64]
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$DB,$5B,$40       /// pand mm3,[ebx+64]
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$63,$40       /// pand mm4,[ebx+64]
   db $0F,$71,$F4,$07       /// psllw mm4,7
   db $0F,$DB,$6B,$40       /// pand mm5,[ebx+64]
   db $0F,$71,$F5,$02       /// psllw mm5,2

   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle1

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyCycle2:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$18,$87,$10,$FA,$FF,$FF/// prefetchtna [edi-768*2+16]
   db $0F,$18,$87,$10,$F4,$FF,$FF/// prefetchtna [edi-768*4+16]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$61,$C0           /// punpcklwd mm0,mm0
   db $0F,$61,$C9           /// punpcklwd mm1,mm1
   db $0F,$61,$D2           /// punpcklwd mm2,mm2
   db $0F,$69,$DB           /// punpckhwd mm3,mm3
   db $0F,$69,$E4           /// punpckhwd mm4,mm4
   db $0F,$69,$ED           /// punpckhwd mm5,mm5

   db $0F,$ED,$C6           /// paddsw mm0,mm6      // 0 B3 0 B2 0 B1 0 B0
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7      // 0 B7 0 B6 0 B5 0 B4
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$6F,$73,$10       /// movq mm6,[ebx+16]
   db $0F,$EF,$FF           /// pxor mm7,mm7
   db $0F,$EA,$C6           /// pminsw mm0,mm6
   db $0F,$EE,$C7           /// pmaxsw mm0,mm7
   db $0F,$EA,$CE           /// pminsw mm1,mm6
   db $0F,$EE,$CF           /// pmaxsw mm1,mm7
   db $0F,$EA,$D6           /// pminsw mm2,mm6
   db $0F,$EE,$D7           /// pmaxsw mm2,mm7
   db $0F,$EA,$DE           /// pminsw mm3,mm6
   db $0F,$EE,$DF           /// pmaxsw mm3,mm7
   db $0F,$EA,$E6           /// pminsw mm4,mm6
   db $0F,$EE,$E7           /// pmaxsw mm4,mm7
   db $0F,$EA,$EE           /// pminsw mm5,mm6
   db $0F,$EE,$EF           /// pmaxsw mm5,mm7

   db $0F,$DB,$43,$40       /// pand mm0,[ebx+64]
   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$4B,$40       /// pand mm1,[ebx+64]
   db $0F,$71,$F1,$07       /// psllw mm1,7
   db $0F,$DB,$53,$40       /// pand mm2,[ebx+64]
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$DB,$5B,$40       /// pand mm3,[ebx+64]
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$63,$40       /// pand mm4,[ebx+64]
   db $0F,$71,$F4,$07       /// psllw mm4,7
   db $0F,$DB,$6B,$40       /// pand mm5,[ebx+64]
   db $0F,$71,$F5,$02       /// psllw mm5,2

   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3
   db $0F,$6F,$FB           /// movq mm7,mm3

   db $0F,$6F,$8F,$00,$FA,$FF,$FF/// movq mm1,[edi-768*2]
   db $0F,$6F,$97,$00,$F4,$FF,$FF/// movq mm2,[edi-768*4]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$63,$70       /// pand mm4,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$6F,$F3           /// movq mm6,mm3
   db $0F,$E0,$F5           /// pavgb mm6,mm5
   db $0F,$71,$D4,$01       /// psrlw mm4,1
   db $0F,$E0,$F4           /// pavgb mm6,mm4
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]

   db $0F,$DB,$43,$60       /// pand mm0,[ebx+96]
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$DB,$53,$60       /// pand mm2,[ebx+96]
   db $0F,$73,$F1,$01       /// psllq mm1,1
   db $0F,$F9,$C8           /// psubw mm1,mm0
   db $0F,$F9,$CA           /// psubw mm1,mm2
   db $0F,$E3,$C2           /// pavgw mm0,mm2
   db $0F,$73,$F0,$03       /// psllq mm0,3
   db $0F,$FD,$C8           /// paddw mm1,mm0
   db $0F,$73,$D1,$03       /// psrlq mm1,3
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$EB,$F1           /// por mm6,mm1

   db $0F,$E7,$B7,$00,$FA,$FF,$FF/// movntq [edi-768*2],mm6

   db $0F,$6F,$C7           /// movq mm0,mm7
   db $0F,$6F,$8F,$08,$FA,$FF,$FF/// movq mm1,[edi-768*2+8]
   db $0F,$6F,$97,$08,$F4,$FF,$FF/// movq mm2,[edi-768*4+8]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$63,$70       /// pand mm4,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$6F,$F3           /// movq mm6,mm3
   db $0F,$E0,$F5           /// pavgb mm6,mm5
   db $0F,$71,$D4,$01       /// psrlw mm4,1
   db $0F,$E0,$F4           /// pavgb mm6,mm4
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]

   db $0F,$DB,$43,$60       /// pand mm0,[ebx+96]
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$DB,$53,$60       /// pand mm2,[ebx+96]
   db $0F,$73,$F1,$01       /// psllq mm1,1
   db $0F,$F9,$C8           /// psubw mm1,mm0
   db $0F,$F9,$CA           /// psubw mm1,mm2
   db $0F,$E3,$C2           /// pavgw mm0,mm2
   db $0F,$73,$F0,$03       /// psllq mm0,3
   db $0F,$FD,$C8           /// paddw mm1,mm0
   db $0F,$73,$D1,$03       /// psrlq mm1,3
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$EB,$F1           /// por mm6,mm1

   db $0F,$E7,$B7,$08,$FA,$FF,$FF/// movntq [edi-768*2+8],mm6

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle2

   dec edx
   jnz @MMX_CopyLine

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyLastLine:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$18,$87,$10,$FA,$FF,$FF/// prefetchtna [edi-768*2+16]
   db $0F,$18,$87,$10,$F4,$FF,$FF/// prefetchtna [edi-768*4+16]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$61,$C0           /// punpcklwd mm0,mm0
   db $0F,$61,$C9           /// punpcklwd mm1,mm1
   db $0F,$61,$D2           /// punpcklwd mm2,mm2
   db $0F,$69,$DB           /// punpckhwd mm3,mm3
   db $0F,$69,$E4           /// punpckhwd mm4,mm4
   db $0F,$69,$ED           /// punpckhwd mm5,mm5

   db $0F,$ED,$C6           /// paddsw mm0,mm6      // 0 B3 0 B2 0 B1 0 B0
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7      // 0 B7 0 B6 0 B5 0 B4
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$6F,$73,$10       /// movq mm6,[ebx+16]
   db $0F,$EF,$FF           /// pxor mm7,mm7
   db $0F,$EA,$C6           /// pminsw mm0,mm6
   db $0F,$EE,$C7           /// pmaxsw mm0,mm7
   db $0F,$EA,$CE           /// pminsw mm1,mm6
   db $0F,$EE,$CF           /// pmaxsw mm1,mm7
   db $0F,$EA,$D6           /// pminsw mm2,mm6
   db $0F,$EE,$D7           /// pmaxsw mm2,mm7
   db $0F,$EA,$DE           /// pminsw mm3,mm6
   db $0F,$EE,$DF           /// pmaxsw mm3,mm7
   db $0F,$EA,$E6           /// pminsw mm4,mm6
   db $0F,$EE,$E7           /// pmaxsw mm4,mm7
   db $0F,$EA,$EE           /// pminsw mm5,mm6
   db $0F,$EE,$EF           /// pmaxsw mm5,mm7

   db $0F,$DB,$43,$40       /// pand mm0,[ebx+64]
   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$4B,$40       /// pand mm1,[ebx+64]
   db $0F,$71,$F1,$07       /// psllw mm1,7
   db $0F,$DB,$53,$40       /// pand mm2,[ebx+64]
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$DB,$5B,$40       /// pand mm3,[ebx+64]
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$63,$40       /// pand mm4,[ebx+64]
   db $0F,$71,$F4,$07       /// psllw mm4,7
   db $0F,$DB,$6B,$40       /// pand mm5,[ebx+64]
   db $0F,$71,$F5,$02       /// psllw mm5,2

   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyLastLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB555MMX216(const Dest: Pointer;
                                       const Src: Pointer;
                                       const SrcW: DWord;
                                       const SrcH: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov edi,Dest

   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$00F800F8
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov edx,SrcH

@MMX_CopyLine:

   mov ecx,SrcW             // ecx=(SrcW*2)/16
   shr ecx,3

@MMX_CopyCycle:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$61,$C0           /// punpcklwd mm0,mm0
   db $0F,$61,$C9           /// punpcklwd mm1,mm1
   db $0F,$61,$D2           /// punpcklwd mm2,mm2
   db $0F,$69,$DB           /// punpckhwd mm3,mm3
   db $0F,$69,$E4           /// punpckhwd mm4,mm4
   db $0F,$69,$ED           /// punpckhwd mm5,mm5

   db $0F,$ED,$C6           /// paddsw mm0,mm6      // 0 B3 0 B2 0 B1 0 B0
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7      // 0 B7 0 B6 0 B5 0 B4
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$6F,$73,$10       /// movq mm6,[ebx+16]
   db $0F,$EF,$FF           /// pxor mm7,mm7
   db $0F,$EA,$C6           /// pminsw mm0,mm6
   db $0F,$EE,$C7           /// pmaxsw mm0,mm7
   db $0F,$EA,$CE           /// pminsw mm1,mm6
   db $0F,$EE,$CF           /// pmaxsw mm1,mm7
   db $0F,$EA,$D6           /// pminsw mm2,mm6
   db $0F,$EE,$D7           /// pmaxsw mm2,mm7
   db $0F,$EA,$DE           /// pminsw mm3,mm6
   db $0F,$EE,$DF           /// pmaxsw mm3,mm7
   db $0F,$EA,$E6           /// pminsw mm4,mm6
   db $0F,$EE,$E7           /// pmaxsw mm4,mm7
   db $0F,$EA,$EE           /// pminsw mm5,mm6
   db $0F,$EE,$EF           /// pmaxsw mm5,mm7

   db $0F,$DB,$43,$40       /// pand mm0,[ebx+64]
   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$4B,$40       /// pand mm1,[ebx+64]
   db $0F,$71,$F1,$07       /// psllw mm1,7
   db $0F,$DB,$53,$40       /// pand mm2,[ebx+64]
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$DB,$5B,$40       /// pand mm3,[ebx+64]
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$63,$40       /// pand mm4,[ebx+64]
   db $0F,$71,$F4,$07       /// psllw mm4,7
   db $0F,$DB,$6B,$40       /// pand mm5,[ebx+64]
   db $0F,$71,$F5,$02       /// psllw mm5,2

   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   dec edx
   jnz @MMX_CopyLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryRGB24toRGB555MMX224Interlaced_Ymirror(const Dest: Pointer;
                                                          const Src: Pointer;
                                                          const Width,
                                                                Height: DWord);
var
  CacheMemory: PByte;
  SrcWD,SrcWQ: dword;
begin
  GetMem(CacheMemory,4096);
  SrcWD:=2*Width;
  SrcWQ:=4*Width;
  asm
   pushad
   pushfd

   mov ebx,Pointer(CacheMemory);
   mov eax,$000000F8
   db $0F,$EF,$C0           /// pxor mm0,mm0
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
   db $0F,$73,$F0,$08       /// psllq mm0,8
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov edi,Dest
   mov esi,Src

   mov ecx,Height
   dec ecx
@DestAdd:
   add edi,SrcWQ
   loop @DestAdd

   mov ecx,Width
   shr ecx,3

@MMX_CopyFirstLine:

   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$46,$48       /// prefetchtna [esi+72]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$DB,$5B,$10       /// pand mm3,[ebx+16]
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$73,$D3,$09       /// psrlq mm3,8+1
   db $0F,$73,$D4,$06       /// psrlq mm4,8-2
   db $0F,$73,$D5,$03       /// psrlq mm5,3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$DB,$73,$18       /// pand mm6,[ebx+24]
   db $0F,$73,$D4,$11       /// psrlq mm4,2*8+1
   db $0F,$73,$D5,$0E       /// psrlq mm5,2*8-2
   db $0F,$73,$D6,$0B       /// psrlq mm6,8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$6B,$38       /// pand mm5,[ebx+56]
   db $0F,$DB,$73,$30       /// pand mm6,[ebx+48]
   db $0F,$73,$F4,$27       /// psllq mm4,5*8-1
   db $0F,$73,$D5,$16       /// psrlq mm5,3*8-2
   db $0F,$73,$D6,$13       /// psrlq mm6,2*8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6


   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]
   db $0F,$73,$F4,$1F       /// psllq mm4,4*8-1
   db $0F,$73,$F5,$22       /// psllq mm5,4*8+2
   db $0F,$73,$F6,$25       /// psllq mm6,5*8-3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   //*** Elso mmx reg. ok

   db $0F,$6F,$F9           /// movq mm7,mm1
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$DB,$7B,$30       /// pand mm7,[ebx+48]
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$73,$D7,$29       /// psrlq mm7,5*8+1
   db $0F,$73,$D4,$26       /// psrlq mm4,5*8-2
   db $0F,$73,$D5,$23       /// psrlq mm5,4*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DB,$73,$38       /// pand mm6,[ebx+56]
   db $0F,$73,$F4,$0F       /// psllq mm4,2*8-1
   db $0F,$73,$F5,$12       /// psllq mm5,2*8+2
   db $0F,$73,$D6,$2B       /// psrlq mm6,5*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$20       /// pand mm4,[ebx+32]
   db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$73,$F4,$07       /// psllq mm4,8-1
   db $0F,$73,$F5,$0A       /// psllq mm5,8+2
   db $0F,$73,$F6,$0D       /// psllq mm6,2*8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$38       /// pand mm4,[ebx+56]
   db $0F,$DB,$6B,$30       /// pand mm5,[ebx+48]
   db $0F,$DB,$73,$28       /// pand mm6,[ebx+40]
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$F5,$02       /// psllq mm5,2
   db $0F,$73,$F6,$05       /// psllq mm6,8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   mov eax,$001F001F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$58       /// movq [ebx+88],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$60       /// movq [ebx+96],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$68       /// movq [ebx+104],mm0

   mov eax,$7C1F7C1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$70       /// movq [ebx+112],mm0

   db $0F,$7F,$1F           /// movq [edi],mm3
   db $0F,$7F,$7F,$08       /// movq [edi+8],mm7

   add esi,24
   add edi,16

   dec ecx
   jnz @MMX_CopyFirstLine

   sub edi,SrcWQ
   sub edi,SrcWD

   mov edx,Height
   dec edx

@MMX_MainCycle:

   mov ecx,Width
   shr ecx,3

@MMX_CopyCycle1:

   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$46,$48       /// prefetchtna [esi+72]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$DB,$5B,$10       /// pand mm3,[ebx+16]
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$73,$D3,$09       /// psrlq mm3,8+1
   db $0F,$73,$D4,$06       /// psrlq mm4,8-2
   db $0F,$73,$D5,$03       /// psrlq mm5,3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$DB,$73,$18       /// pand mm6,[ebx+24]
   db $0F,$73,$D4,$11       /// psrlq mm4,2*8+1
   db $0F,$73,$D5,$0E       /// psrlq mm5,2*8-2
   db $0F,$73,$D6,$0B       /// psrlq mm6,8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E8           /// movq mm5,mm0
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$6B,$38       /// pand mm5,[ebx+56]
   db $0F,$DB,$73,$30       /// pand mm6,[ebx+48]
   db $0F,$73,$F4,$27       /// psllq mm4,5*8-1
   db $0F,$73,$D5,$16       /// psrlq mm5,3*8-2
   db $0F,$73,$D6,$13       /// psrlq mm6,2*8+3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6


   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$DB,$73,$08       /// pand mm6,[ebx+8]
   db $0F,$73,$F4,$1F       /// psllq mm4,4*8-1
   db $0F,$73,$F5,$22       /// psllq mm5,4*8+2
   db $0F,$73,$F6,$25       /// psllq mm6,5*8-3
   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$EB,$DE           /// por mm3,mm6

   //*** Elso mmx reg. ok

   db $0F,$6F,$F9           /// movq mm7,mm1
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$E9           /// movq mm5,mm1
   db $0F,$DB,$7B,$30       /// pand mm7,[ebx+48]
   db $0F,$DB,$63,$28       /// pand mm4,[ebx+40]
   db $0F,$DB,$6B,$20       /// pand mm5,[ebx+32]
   db $0F,$73,$D7,$29       /// psrlq mm7,5*8+1
   db $0F,$73,$D4,$26       /// psrlq mm4,5*8-2
   db $0F,$73,$D5,$23       /// psrlq mm5,4*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DB,$73,$38       /// pand mm6,[ebx+56]
   db $0F,$73,$F4,$0F       /// psllq mm4,2*8-1
   db $0F,$73,$F5,$12       /// psllq mm5,2*8+2
   db $0F,$73,$D6,$2B       /// psrlq mm6,5*8+3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$20       /// pand mm4,[ebx+32]
   db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]
   db $0F,$73,$F4,$07       /// psllq mm4,8-1
   db $0F,$73,$F5,$0A       /// psllq mm5,8+2
   db $0F,$73,$F6,$0D       /// psllq mm6,2*8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$6F,$E2           /// movq mm4,mm2
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F2           /// movq mm6,mm2
   db $0F,$DB,$63,$38       /// pand mm4,[ebx+56]
   db $0F,$DB,$6B,$30       /// pand mm5,[ebx+48]
   db $0F,$DB,$73,$28       /// pand mm6,[ebx+40]
   db $0F,$73,$D4,$01       /// psrlq mm4,1
   db $0F,$73,$F5,$02       /// psllq mm5,2
   db $0F,$73,$F6,$05       /// psllq mm6,8-3
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$EB,$FD           /// por mm7,mm5
   db $0F,$EB,$FE           /// por mm7,mm6

   db $0F,$7F,$1F           /// movq [edi],mm3
   db $0F,$7F,$7F,$08       /// movq [edi+8],mm7

   add edi,SrcWQ
   db $0F,$6F,$0F           /// movq mm1,[edi]
   db $0F,$6F,$57,$08       /// movq mm2,[edi+8]
   sub edi,SrcWD
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$C3           /// movq mm0,mm3
   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$DB,$63,$60       /// pand mm4,[ebx+96]
   db $0F,$DB,$6B,$60       /// pand mm5,[ebx+96]
   db $0F,$DB,$43,$60       /// pand mm0,[ebx+96]
   db $0F,$DB,$73,$60       /// pand mm6,[ebx+96]
   db $0F,$E3,$E0           /// pavgw mm4,mm0
   db $0F,$DB,$63,$60       /// pand mm4,[ebx+96]
   db $0F,$E3,$EE           /// pavgw mm5,mm6
   db $0F,$DB,$6B,$60       /// pand mm5,[ebx+96]
   db $0F,$DB,$4B,$70       /// pand mm1,[ebx+112]
   db $0F,$DB,$53,$70       /// pand mm2,[ebx+112]
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$7B,$70       /// pand mm7,[ebx+112]
   db $0F,$E0,$CB           /// pavgb mm1,mm3
   db $0F,$DB,$4B,$70       /// pand mm1,[ebx+112]
   db $0F,$E0,$D7           /// pavgb mm2,mm7
   db $0F,$DB,$53,$70       /// pand mm2,[ebx+112]
   db $0F,$EB,$CC           /// por mm1,mm4
   db $0F,$EB,$D5           /// por mm2,mm5
   db $0F,$E7,$0F           /// movntq [edi],mm1
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2
   sub edi,SrcWD

   add esi,24
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle1

   sub edi,SrcWQ
   sub edi,SrcWD

   dec edx
   jnz @MMX_MainCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB555MMX216Interlaced(const Dest: Pointer;
                                                 const Src: Pointer;
                                                 const SrcW: DWord;
                                                 const SrcH: DWord);
var
  CacheMemory: PByte;
  SrcWD: dword;
  SrcWQ: dword;
begin
  GetMem(CacheMemory,4096);
  SrcWD:=2*SrcW;
  SrcWQ:=4*SrcW;
  asm
   pushad
   pushfd
   mov edi,Dest

   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$00F800F8
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov eax,$001F001F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$58       /// movq [ebx+88],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$60       /// movq [ebx+96],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$68       /// movq [ebx+104],mm0

   mov eax,$7C1F7C1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$70       /// movq [ebx+112],mm0

   mov ecx,SrcW             // ecx=(SrcW*2)/16
   shr ecx,3

@MMX_CopyFirstLine:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$61,$C0           /// punpcklwd mm0,mm0
   db $0F,$61,$C9           /// punpcklwd mm1,mm1
   db $0F,$61,$D2           /// punpcklwd mm2,mm2
   db $0F,$69,$DB           /// punpckhwd mm3,mm3
   db $0F,$69,$E4           /// punpckhwd mm4,mm4
   db $0F,$69,$ED           /// punpckhwd mm5,mm5

   db $0F,$ED,$C6           /// paddsw mm0,mm6      // 0 B3 0 B2 0 B1 0 B0
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7      // 0 B7 0 B6 0 B5 0 B4
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$6F,$73,$10       /// movq mm6,[ebx+16]
   db $0F,$EF,$FF           /// pxor mm7,mm7
   db $0F,$EA,$C6           /// pminsw mm0,mm6
   db $0F,$EE,$C7           /// pmaxsw mm0,mm7
   db $0F,$EA,$CE           /// pminsw mm1,mm6
   db $0F,$EE,$CF           /// pmaxsw mm1,mm7
   db $0F,$EA,$D6           /// pminsw mm2,mm6
   db $0F,$EE,$D7           /// pmaxsw mm2,mm7
   db $0F,$EA,$DE           /// pminsw mm3,mm6
   db $0F,$EE,$DF           /// pmaxlsw mm3,mm7
   db $0F,$EA,$E6           /// pminsw mm4,mm6
   db $0F,$EE,$E7           /// pmaxsw mm4,mm7
   db $0F,$EA,$EE           /// pminsw mm5,mm6
   db $0F,$EE,$EF           /// pmaxsw mm5,mm7

   db $0F,$DB,$43,$40       /// pand mm0,[ebx+64]
   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$4B,$40       /// pand mm1,[ebx+64]
   db $0F,$71,$F1,$07       /// psllw mm1,7
   db $0F,$DB,$53,$40       /// pand mm2,[ebx+64]
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$DB,$5B,$40       /// pand mm3,[ebx+64]
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$63,$40       /// pand mm4,[ebx+64]
   db $0F,$71,$F4,$07       /// psllw mm4,7
   db $0F,$DB,$6B,$40       /// pand mm5,[ebx+64]
   db $0F,$71,$F5,$02       /// psllw mm5,2

   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyFirstLine

   add edi,SrcWD

   mov edx,SrcH
   dec edx

@MMX_CopyLine:

   mov ecx,SrcW             // ecx=(SrcW*2)/16
   shr ecx,3

@MMX_CopyCycle:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$61,$C0           /// punpcklwd mm0,mm0
   db $0F,$61,$C9           /// punpcklwd mm1,mm1
   db $0F,$61,$D2           /// punpcklwd mm2,mm2
   db $0F,$69,$DB           /// punpckhwd mm3,mm3
   db $0F,$69,$E4           /// punpckhwd mm4,mm4
   db $0F,$69,$ED           /// punpckhwd mm5,mm5

   db $0F,$ED,$C6           /// paddsw mm0,mm6      // 0 B3 0 B2 0 B1 0 B0
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7      // 0 B7 0 B6 0 B5 0 B4
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$6F,$73,$10       /// movq mm6,[ebx+16]
   db $0F,$EF,$FF           /// pxor mm7,mm7
   db $0F,$EA,$C6           /// pminsw mm0,mm6
   db $0F,$EE,$C7           /// pmaxsw mm0,mm7
   db $0F,$EA,$CE           /// pminsw mm1,mm6
   db $0F,$EE,$CF           /// pmaxsw mm1,mm7
   db $0F,$EA,$D6           /// pminsw mm2,mm6
   db $0F,$EE,$D7           /// pmaxsw mm2,mm7
   db $0F,$EA,$DE           /// pminsw mm3,mm6
   db $0F,$EE,$DF           /// pmaxsw mm3,mm7
   db $0F,$EA,$E6           /// pminsw mm4,mm6
   db $0F,$EE,$E7           /// pmaxsw mm4,mm7
   db $0F,$EA,$EE           /// pminsw mm5,mm6
   db $0F,$EE,$EF           /// pmaxsw mm5,mm7

   db $0F,$DB,$43,$40       /// pand mm0,[ebx+64]
   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$4B,$40       /// pand mm1,[ebx+64]
   db $0F,$71,$F1,$07       /// psllw mm1,7
   db $0F,$DB,$53,$40       /// pand mm2,[ebx+64]
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$DB,$5B,$40       /// pand mm3,[ebx+64]
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$63,$40       /// pand mm4,[ebx+64]
   db $0F,$71,$F4,$07       /// psllw mm4,7
   db $0F,$DB,$6B,$40       /// pand mm5,[ebx+64]
   db $0F,$71,$F5,$02       /// psllw mm5,2

   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   sub edi,SrcWQ
   db $0F,$6F,$0F           /// movq mm1,[edi]
   db $0F,$6F,$57,$08       /// movq mm2,[edi+8]
   add edi,SrcWD
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$63,$60       /// pand mm4,[ebx+96]
   db $0F,$DB,$6B,$60       /// pand mm5,[ebx+96]
   db $0F,$DB,$73,$60       /// pand mm6,[ebx+96]
   db $0F,$DB,$7B,$60       /// pand mm7,[ebx+96]
   db $0F,$E3,$E6           /// pavgw mm4,mm6
   db $0F,$E3,$EF           /// pavgw mm5,mm7
   db $0F,$DB,$63,$60       /// pand mm4,[ebx+96]
   db $0F,$DB,$6B,$60       /// pand mm5,[ebx+96]
   db $0F,$DB,$4B,$70       /// pand mm1,[ebx+112]
   db $0F,$DB,$53,$70       /// pand mm2,[ebx+112]
   db $0F,$DB,$43,$70       /// pand mm0,[ebx+112]
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$E0,$C8           /// pavgb mm1,mm0
   db $0F,$E0,$D3           /// pavgb mm2,mm3
   db $0F,$DB,$4B,$70       /// pand mm1,[ebx+112]
   db $0F,$DB,$53,$70       /// pand mm2,[ebx+112]
   db $0F,$EB,$CC           /// por mm1,mm4
   db $0F,$EB,$D5           /// por mm2,mm5
   db $0F,$E7,$0F           /// movntq [edi],mm1
   db $0F,$E7,$57,$08       /// movntq [edi+8],mm2
   add edi,SrcWD

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   add edi,SrcWD

   dec edx
   jnz @MMX_CopyLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB555_DeinterlaceOnly768x576MMX216_Ymirror(const Dest: Pointer;
                                                                      const Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov esi,Src
   mov edi,Dest
   mov ecx,576-1
@CALC_edi:
   add edi,768*2
   loop @CALC_edi

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$00F800F8
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov eax,$001F001F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$58       /// movq [ebx+88],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$60       /// movq [ebx+96],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$68       /// movq [ebx+104],mm0

   mov eax,$7C1F7C1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$70       /// movq [ebx+112],mm0

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyFirstLine:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$61,$C0           /// punpcklwd mm0,mm0
   db $0F,$61,$C9           /// punpcklwd mm1,mm1
   db $0F,$61,$D2           /// punpcklwd mm2,mm2
   db $0F,$69,$DB           /// punpckhwd mm3,mm3
   db $0F,$69,$E4           /// punpckhwd mm4,mm4
   db $0F,$69,$ED           /// punpckhwd mm5,mm5

   db $0F,$ED,$C6           /// paddsw mm0,mm6      // 0 B3 0 B2 0 B1 0 B0
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7      // 0 B7 0 B6 0 B5 0 B4
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$6F,$73,$10       /// movq mm6,[ebx+16]
   db $0F,$EF,$FF           /// pxor mm7,mm7
   db $0F,$EA,$C6           /// pminsw mm0,mm6
   db $0F,$EE,$C7           /// pmaxsw mm0,mm7
   db $0F,$EA,$CE           /// pminsw mm1,mm6
   db $0F,$EE,$CF           /// pmaxsw mm1,mm7
   db $0F,$EA,$D6           /// pminsw mm2,mm6
   db $0F,$EE,$D7           /// pmaxsw mm2,mm7
   db $0F,$EA,$DE           /// pminsw mm3,mm6
   db $0F,$EE,$DF           /// pmaxsw mm3,mm7
   db $0F,$EA,$E6           /// pminsw mm4,mm6
   db $0F,$EE,$E7           /// pmaxsw mm4,mm7
   db $0F,$EA,$EE           /// pminsw mm5,mm6
   db $0F,$EE,$EF           /// pmaxsw mm5,mm7

   db $0F,$DB,$43,$40       /// pand mm0,[ebx+64]
   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$4B,$40       /// pand mm1,[ebx+64]
   db $0F,$71,$F1,$07       /// psllw mm1,7
   db $0F,$DB,$53,$40       /// pand mm2,[ebx+64]
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$DB,$5B,$40       /// pand mm3,[ebx+64]
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$63,$40       /// pand mm4,[ebx+64]
   db $0F,$71,$F4,$07       /// psllw mm4,7
   db $0F,$DB,$6B,$40       /// pand mm5,[ebx+64]
   db $0F,$71,$F5,$02       /// psllw mm5,2

   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyFirstLine
   sub edi,768*4

   mov edx,574/2

@MMX_CopyLine:

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyCycle1:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$61,$C0           /// punpcklwd mm0,mm0
   db $0F,$61,$C9           /// punpcklwd mm1,mm1
   db $0F,$61,$D2           /// punpcklwd mm2,mm2
   db $0F,$69,$DB           /// punpckhwd mm3,mm3
   db $0F,$69,$E4           /// punpckhwd mm4,mm4
   db $0F,$69,$ED           /// punpckhwd mm5,mm5

   db $0F,$ED,$C6           /// paddsw mm0,mm6      // 0 B3 0 B2 0 B1 0 B0
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7      // 0 B7 0 B6 0 B5 0 B4
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$6F,$73,$10       /// movq mm6,[ebx+16]
   db $0F,$EF,$FF           /// pxor mm7,mm7
   db $0F,$EA,$C6           /// pminsw mm0,mm6
   db $0F,$EE,$C7           /// pmaxsw mm0,mm7
   db $0F,$EA,$CE           /// pminsw mm1,mm6
   db $0F,$EE,$CF           /// pmaxsw mm1,mm7
   db $0F,$EA,$D6           /// pminsw mm2,mm6
   db $0F,$EE,$D7           /// pmaxsw mm2,mm7
   db $0F,$EA,$DE           /// pminsw mm3,mm6
   db $0F,$EE,$DF           /// pmaxsw mm3,mm7
   db $0F,$EA,$E6           /// pminsw mm4,mm6
   db $0F,$EE,$E7           /// pmaxsw mm4,mm7
   db $0F,$EA,$EE           /// pminsw mm5,mm6
   db $0F,$EE,$EF           /// pmaxsw mm5,mm7

   db $0F,$DB,$43,$40       /// pand mm0,[ebx+64]
   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$4B,$40       /// pand mm1,[ebx+64]
   db $0F,$71,$F1,$07       /// psllw mm1,7
   db $0F,$DB,$53,$40       /// pand mm2,[ebx+64]
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$DB,$5B,$40       /// pand mm3,[ebx+64]
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$63,$40       /// pand mm4,[ebx+64]
   db $0F,$71,$F4,$07       /// psllw mm4,7
   db $0F,$DB,$6B,$40       /// pand mm5,[ebx+64]
   db $0F,$71,$F5,$02       /// psllw mm5,2

   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$7F,$07           /// movq [edi],mm0

   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$7F,$5F,$08       /// movq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle1
   sub edi,768*4

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyCycle2:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$18,$87,$10,$06,$00,$00/// prefetchtna [edi+768*2+16]
   db $0F,$18,$87,$10,$0C,$00,$00/// prefetchtna [edi+768*4+16]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$61,$C0           /// punpcklwd mm0,mm0
   db $0F,$61,$C9           /// punpcklwd mm1,mm1
   db $0F,$61,$D2           /// punpcklwd mm2,mm2
   db $0F,$69,$DB           /// punpckhwd mm3,mm3
   db $0F,$69,$E4           /// punpckhwd mm4,mm4
   db $0F,$69,$ED           /// punpckhwd mm5,mm5

   db $0F,$ED,$C6           /// paddsw mm0,mm6      // 0 B3 0 B2 0 B1 0 B0
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7      // 0 B7 0 B6 0 B5 0 B4
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$6F,$73,$10       /// movq mm6,[ebx+16]
   db $0F,$EF,$FF           /// pxor mm7,mm7
   db $0F,$EA,$C6           /// pminsw mm0,mm6
   db $0F,$EE,$C7           /// pmaxsw mm0,mm7
   db $0F,$EA,$CE           /// pminsw mm1,mm6
   db $0F,$EE,$CF           /// pmaxsw mm1,mm7
   db $0F,$EA,$D6           /// pminsw mm2,mm6
   db $0F,$EE,$D7           /// pmaxsw mm2,mm7
   db $0F,$EA,$DE           /// pminsw mm3,mm6
   db $0F,$EE,$DF           /// pmaxsw mm3,mm7
   db $0F,$EA,$E6           /// pminsw mm4,mm6
   db $0F,$EE,$E7           /// pmaxsw mm4,mm7
   db $0F,$EA,$EE           /// pminsw mm5,mm6
   db $0F,$EE,$EF           /// pmaxsw mm5,mm7

   db $0F,$DB,$43,$40       /// pand mm0,[ebx+64]
   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$4B,$40       /// pand mm1,[ebx+64]
   db $0F,$71,$F1,$07       /// psllw mm1,7
   db $0F,$DB,$53,$40       /// pand mm2,[ebx+64]
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$DB,$5B,$40       /// pand mm3,[ebx+64]
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$63,$40       /// pand mm4,[ebx+64]
   db $0F,$71,$F4,$07       /// psllw mm4,7
   db $0F,$DB,$6B,$40       /// pand mm5,[ebx+64]
   db $0F,$71,$F5,$02       /// psllw mm5,2

   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3
   db $0F,$6F,$FB           /// movq mm7,mm3

   db $0F,$6F,$8F,$00,$06,$00,$00/// movq mm1,[edi+768*2]
   db $0F,$6F,$97,$00,$0C,$00,$00/// movq mm2,[edi+768*4]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$63,$70       /// pand mm4,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$6F,$F3           /// movq mm6,mm3
   db $0F,$E0,$F5           /// pavgb mm6,mm5
   db $0F,$71,$D4,$01       /// psrlw mm4,1
   db $0F,$E0,$F4           /// pavgb mm6,mm4
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]

   db $0F,$DB,$43,$60       /// pand mm0,[ebx+96]
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$DB,$53,$60       /// pand mm2,[ebx+96]
   db $0F,$73,$F1,$01       /// psllq mm1,1
   db $0F,$F9,$C8           /// psubw mm1,mm0
   db $0F,$F9,$CA           /// psubw mm1,mm2
   db $0F,$E3,$C2           /// pavgw mm0,mm2
   db $0F,$73,$F0,$03       /// psllq mm0,3
   db $0F,$FD,$C8           /// paddw mm1,mm0
   db $0F,$73,$D1,$03       /// psrlq mm1,3
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$EB,$F1           /// por mm6,mm1

   db $0F,$E7,$B7,$00,$06,$00,$00/// movntq [edi+768*2],mm6

   db $0F,$6F,$C7           /// movq mm0,mm7
   db $0F,$6F,$8F,$08,$06,$00,$00/// movq mm1,[edi+768*2+8]
   db $0F,$6F,$97,$08,$0C,$00,$00/// movq mm2,[edi+768*4+8]

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$63,$70       /// pand mm4,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$6F,$F3           /// movq mm6,mm3
   db $0F,$E0,$F5           /// pavgb mm6,mm5
   db $0F,$71,$D4,$01       /// psrlw mm4,1
   db $0F,$E0,$F4           /// pavgb mm6,mm4
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$5B,$70       /// pand mm3,[ebx+112]
   db $0F,$DB,$6B,$70       /// pand mm5,[ebx+112]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5
   db $0F,$DB,$73,$70       /// pand mm6,[ebx+112]

   db $0F,$DB,$43,$60       /// pand mm0,[ebx+96]
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$DB,$53,$60       /// pand mm2,[ebx+96]
   db $0F,$73,$F1,$01       /// psllq mm1,1
   db $0F,$F9,$C8           /// psubw mm1,mm0
   db $0F,$F9,$CA           /// psubw mm1,mm2
   db $0F,$E3,$C2           /// pavgw mm0,mm2
   db $0F,$73,$F0,$03       /// psllq mm0,3
   db $0F,$FD,$C8           /// paddw mm1,mm0
   db $0F,$73,$D1,$03       /// psrlq mm1,3
   db $0F,$DB,$4B,$60       /// pand mm1,[ebx+96]
   db $0F,$EB,$F1           /// por mm6,mm1

   db $0F,$E7,$B7,$08,$06,$00,$00/// movntq [edi+768*2+8],mm6

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle2
   sub edi,768*4

   dec edx
   jnz @MMX_CopyLine

   mov ecx,(768*2)/16       // ecx=(SrcW*2)/16
@MMX_CopyLastLine:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$18,$87,$10,$06,$00,$00/// prefetchtna [edi+768*2+16]
   db $0F,$18,$87,$10,$0C,$00,$00/// prefetchtna [edi+768*4+16]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$61,$C0           /// punpcklwd mm0,mm0
   db $0F,$61,$C9           /// punpcklwd mm1,mm1
   db $0F,$61,$D2           /// punpcklwd mm2,mm2
   db $0F,$69,$DB           /// punpckhwd mm3,mm3
   db $0F,$69,$E4           /// punpckhwd mm4,mm4
   db $0F,$69,$ED           /// punpckhwd mm5,mm5

   db $0F,$ED,$C6           /// paddsw mm0,mm6      // 0 B3 0 B2 0 B1 0 B0
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7      // 0 B7 0 B6 0 B5 0 B4
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$6F,$73,$10       /// movq mm6,[ebx+16]
   db $0F,$EF,$FF           /// pxor mm7,mm7
   db $0F,$EA,$C6           /// pminsw mm0,mm6
   db $0F,$EE,$C7           /// pmaxsw mm0,mm7
   db $0F,$EA,$CE           /// pminsw mm1,mm6
   db $0F,$EE,$CF           /// pmaxsw mm1,mm7
   db $0F,$EA,$D6           /// pminsw mm2,mm6
   db $0F,$EE,$D7           /// pmaxsw mm2,mm7
   db $0F,$EA,$DE           /// pminsw mm3,mm6
   db $0F,$EE,$DF           /// pmaxsw mm3,mm7
   db $0F,$EA,$E6           /// pminsw mm4,mm6
   db $0F,$EE,$E7           /// pmaxsw mm4,mm7
   db $0F,$EA,$EE           /// pminsw mm5,mm6
   db $0F,$EE,$EF           /// pmaxsw mm5,mm7

   db $0F,$DB,$43,$40       /// pand mm0,[ebx+64]
   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$4B,$40       /// pand mm1,[ebx+64]
   db $0F,$71,$F1,$07       /// psllw mm1,7
   db $0F,$DB,$53,$40       /// pand mm2,[ebx+64]
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$DB,$5B,$40       /// pand mm3,[ebx+64]
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$63,$40       /// pand mm4,[ebx+64]
   db $0F,$71,$F4,$07       /// psllw mm4,7
   db $0F,$DB,$6B,$40       /// pand mm5,[ebx+64]
   db $0F,$71,$F5,$02       /// psllw mm5,2

   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyLastLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryYUY2toRGB555MMX216_Ymirror(const Dest: Pointer;
                                               const Src: Pointer;
                                               const SrcW: DWord;
                                               const SrcH: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov edi,Dest

   mov ecx,SrcH
   dec ecx
@CALC_edi:
   add edi,SrcW
   add edi,SrcW
   loop @CALC_edi

   mov esi,Src

   mov ebx,Pointer(CacheMemory);

   mov eax,$00800080
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

   mov eax,$00100010
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

   mov eax,$00FF00FF
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

   mov eax,$253F253F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

   mov eax,$F37DF37D
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

   mov eax,$40934093
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$28       /// movq [ebx+40],mm0

   mov eax,$33123312
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$30       /// movq [ebx+48],mm0

   mov eax,$E5FCE5FC
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$38       /// movq [ebx+56],mm0

   mov eax,$00F800F8
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$40       /// movq [ebx+64],mm0

   mov eax,$0000FF00
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$48       /// movq [ebx+72],mm0

   mov eax,$FF000000
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$43,$50       /// movq [ebx+80],mm0

   mov edx,SrcH

@MMX_CopyLine:

   mov ecx,SrcW             // ecx=(SrcW*2)/16
   shr ecx,3

@MMX_CopyCycle:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]

   db $0F,$6F,$0E           /// movq mm1,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]

   db $0F,$6F,$F1           /// movq mm6,mm1
   db $0F,$DB,$73,$10       /// pand mm6,[ebx+16]  // 0 Y3 0 Y2 0 Y1 0 Y0
   db $0F,$6F,$FB           /// movq mm7,mm3
   db $0F,$DB,$7B,$10       /// pand mm7,[ebx+16]  // 0 Y7 0 Y6 0 Y5 0 Y4

   db $0F,$D9,$73,$08       /// psubusw mm6,[ebx+8]
   db $0F,$D9,$7B,$08       /// psubusw mm7,[ebx+8]
   db $0F,$71,$F6,$03       /// psllw mm6,3
   db $0F,$71,$F7,$03       /// psllw mm7,3
   db $0F,$E5,$73,$18       /// pmulhw mm6,[ebx+24]
   db $0F,$E5,$7B,$18       /// pmulhw mm7,[ebx+24]

   db $0F,$6F,$C1           /// movq mm0,mm1
   db $0F,$DB,$43,$48       /// pand mm0,[ebx+72]
   db $0F,$73,$D0,$08       /// psrlq mm0,8
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$6B,$48       /// pand mm5,[ebx+72]
   db $0F,$73,$D5,$08       /// psrlq mm5,8
   db $0F,$6B,$C5           /// packssdw mm0,mm5   // 0 Cr3 0 Cr2 0 Cr1 0 Cr0

   db $0F,$DB,$4B,$50       /// pand mm1,[ebx+80]
   db $0F,$73,$D1,$18       /// psrlq mm1,24
   db $0F,$DB,$5B,$50       /// pand mm3,[ebx+80]
   db $0F,$73,$D3,$18       /// psrlq mm3,24
   db $0F,$6B,$CB           /// packssdw mm1,mm3   // 0 Cb3 0 Cb2 0 Cb1 0 Cb0

   db $0F,$E9,$03           /// psubsw mm0,[ebx]
   db $0F,$E9,$0B           /// psubsw mm1,[ebx]
   db $0F,$71,$F0,$03       /// psllw mm0,3
   db $0F,$71,$F1,$03       /// psllw mm1,3
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1
   db $0F,$E5,$53,$20       /// pmulhw mm2,[ebx+32]
   db $0F,$E5,$5B,$38       /// pmulhw mm3,[ebx+56]
   db $0F,$E5,$43,$28       /// pmulhw mm0,[ebx+40]
   db $0F,$E5,$4B,$30       /// pmulhw mm1,[ebx+48]
   db $0F,$ED,$D3           /// paddsw mm2,mm3

   db $0F,$6F,$D8           /// movq mm3,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$61,$C0           /// punpcklwd mm0,mm0
   db $0F,$61,$C9           /// punpcklwd mm1,mm1
   db $0F,$61,$D2           /// punpcklwd mm2,mm2
   db $0F,$69,$DB           /// punpckhwd mm3,mm3
   db $0F,$69,$E4           /// punpckhwd mm4,mm4
   db $0F,$69,$ED           /// punpckhwd mm5,mm5

   db $0F,$ED,$C6           /// paddsw mm0,mm6      // 0 B3 0 B2 0 B1 0 B0
   db $0F,$ED,$CE           /// paddsw mm1,mm6
   db $0F,$ED,$D6           /// paddsw mm2,mm6
   db $0F,$ED,$DF           /// paddsw mm3,mm7      // 0 B7 0 B6 0 B5 0 B4
   db $0F,$ED,$E7           /// paddsw mm4,mm7
   db $0F,$ED,$EF           /// paddsw mm5,mm7
   db $0F,$6F,$73,$10       /// movq mm6,[ebx+16]
   db $0F,$EF,$FF           /// pxor mm7,mm7
   db $0F,$EA,$C6           /// pminsw mm0,mm6
   db $0F,$EE,$C7           /// pmaxsw mm0,mm7
   db $0F,$EA,$CE           /// pminsw mm1,mm6
   db $0F,$EE,$CF           /// pmaxsw mm1,mm7
   db $0F,$EA,$D6           /// pminsw mm2,mm6
   db $0F,$EE,$D7           /// pmaxsw mm2,mm7
   db $0F,$EA,$DE           /// pminsw mm3,mm6
   db $0F,$EE,$DF           /// pmaxsw mm3,mm7
   db $0F,$EA,$E6           /// pminsw mm4,mm6
   db $0F,$EE,$E7           /// pmaxsw mm4,mm7
   db $0F,$EA,$EE           /// pminsw mm5,mm6
   db $0F,$EE,$EF           /// pmaxsw mm5,mm7

   db $0F,$DB,$43,$40       /// pand mm0,[ebx+64]
   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$4B,$40       /// pand mm1,[ebx+64]
   db $0F,$71,$F1,$07       /// psllw mm1,7
   db $0F,$DB,$53,$40       /// pand mm2,[ebx+64]
   db $0F,$71,$F2,$02       /// psllw mm2,2
   db $0F,$DB,$5B,$40       /// pand mm3,[ebx+64]
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$63,$40       /// pand mm4,[ebx+64]
   db $0F,$71,$F4,$07       /// psllw mm4,7
   db $0F,$DB,$6B,$40       /// pand mm5,[ebx+64]
   db $0F,$71,$F5,$02       /// psllw mm5,2

   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$EB,$C2           /// por mm0,mm2
   db $0F,$E7,$07           /// movntq [edi],mm0

   db $0F,$EB,$DC           /// por mm3,mm4
   db $0F,$EB,$DD           /// por mm3,mm5
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   sub edi,SrcW
   sub edi,SrcW
   sub edi,SrcW
   sub edi,SrcW

   dec edx
   jnz @MMX_CopyLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure YUY2DeinterlaceOnly768x576MMX216(const Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov esi,Src

   mov edx,(768*2)/16
   mov ecx,576/2-1

   mov ebx,Pointer(CacheMemory)

   mov eax,$1F1F1F1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0

@MMX_Line:

   mov eax,edx
@MMX_CopyCycle:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$86,$20,$06,$00,$00/// prefetchtna [esi+768*2+32]
   db $0F,$18,$86,$30,$06,$00,$00/// prefetchtna [esi+768*2+48]
   db $0F,$18,$86,$20,$0C,$00,$00/// prefetchtna [esi+768*4+32]
   db $0F,$18,$86,$30,$0C,$00,$00/// prefetchtna [esi+768*4+48]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]
   db $0F,$6F,$8E,$00,$06,$00,$00/// movq mm1,[esi+768*2]
   db $0F,$6F,$A6,$08,$06,$00,$00/// movq mm4,[esi+768*2+8]
   db $0F,$6F,$96,$00,$0C,$00,$00/// movq mm2,[esi+768*4]
   db $0F,$6F,$AE,$08,$0C,$00,$00/// movq mm5,[esi+768*4+8]

   db $0F,$EF,$FF           /// pxor mm7,mm7

   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$E0,$F2           /// pavgb mm6,mm2
   db $0F,$E0,$CF           /// pavgb mm1,mm7
   db $0F,$E0,$F1           /// pavgb mm6,mm1
   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$03           /// pand mm0,[ebx]
   db $0F,$71,$D2,$03       /// psrlw mm2,3
   db $0F,$DB,$13           /// pand mm2,[ebx]
   db $0F,$DC,$F0           /// paddusb mm6,mm0
   db $0F,$DC,$F2           /// paddusb mm6,mm2

   db $0F,$E7,$B6,$00,$06,$00,$00/// movntq [esi+768*2],mm6

   db $0F,$6F,$F3           /// movq mm6,mm3
   db $0F,$E0,$F5           /// pavgb mm6,mm5
   db $0F,$E0,$E7           /// pavgb mm4,mm7
   db $0F,$E0,$F4           /// pavgb mm6,mm4
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$1B           /// pand mm3,[ebx]
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5

   db $0F,$E7,$B6,$08,$06,$00,$00/// movntq [esi+768*2+8],mm6

   add esi,16

   dec eax
   jnz @MMX_CopyCycle

   add esi,768*2

   dec ecx
   jnz @MMX_Line

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure YUY2DeinterlaceOnly768x576_2MMX216(const Dest,Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov esi,Src
   mov edi,Dest

   mov edx,(768*2)/16
   mov ecx,576/2-1

   mov ebx,Pointer(CacheMemory)

   mov eax,$1F1F1F1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0


   mov eax,edx
   shr eax,1
@MMX_FirstLine:
   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32
   dec eax
   jnz @MMX_FirstLine

   mov esi,Src
   mov edi,Dest

@MMX_Line:

   mov eax,edx
@MMX_CopyCycle:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$86,$20,$06,$00,$00/// prefetchtna [esi+768*2+32]
   db $0F,$18,$86,$30,$06,$00,$00/// prefetchtna [esi+768*2+48]
   db $0F,$18,$86,$20,$0C,$00,$00/// prefetchtna [esi+768*4+32]
   db $0F,$18,$86,$30,$0C,$00,$00/// prefetchtna [esi+768*4+48]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]
   db $0F,$6F,$8E,$00,$06,$00,$00/// movq mm1,[esi+768*2]
   db $0F,$6F,$A6,$08,$06,$00,$00/// movq mm4,[esi+768*2+8]
   db $0F,$6F,$96,$00,$0C,$00,$00/// movq mm2,[esi+768*4]
   db $0F,$6F,$AE,$08,$0C,$00,$00/// movq mm5,[esi+768*4+8]

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3
   db $0F,$E7,$97,$00,$0C,$00,$00/// movntq [edi+768*4],mm2
   db $0F,$E7,$AF,$08,$0C,$00,$00/// movntq [edi+768*4+8],mm5

   db $0F,$EF,$FF           /// pxor mm7,mm7

   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$E0,$F2           /// pavgb mm6,mm2
   db $0F,$E0,$CF           /// pavgb mm1,mm7
   db $0F,$E0,$F1           /// pavgb mm6,mm1
   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$03           /// pand mm0,[ebx]
   db $0F,$71,$D2,$03       /// psrlw mm2,3
   db $0F,$DB,$13           /// pand mm2,[ebx]
   db $0F,$DC,$F0           /// paddusb mm6,mm0
   db $0F,$DC,$F2           /// paddusb mm6,mm2

   db $0F,$E7,$B7,$00,$06,$00,$00/// movntq [edi+768*2],mm6

   db $0F,$6F,$F3           /// movq mm6,mm3
   db $0F,$E0,$F5           /// pavgb mm6,mm5
   db $0F,$E0,$E7           /// pavgb mm4,mm7
   db $0F,$E0,$F4           /// pavgb mm6,mm4
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$1B           /// pand mm3,[ebx]
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5

   db $0F,$E7,$B7,$08,$06,$00,$00/// movntq [edi+768*2+8],mm6

   add esi,16
   add edi,16

   dec eax
   jnz @MMX_CopyCycle

   add esi,768*2
   add edi,768*2

   dec ecx
   jnz @MMX_Line

   mov eax,edx
   shr eax,1
@MMX_LastLine:
   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32
   dec eax
   jnz @MMX_LastLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure YUY2DeinterlaceOnly768x576_2MMX216_Ymirror(const Dest,Src: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov esi,Src
   mov edi,Dest
   mov ecx,576-1
@CALC_edi:
   add edi,768*2
   loop @CALC_edi

   mov edx,(768*2)/16

   mov ebx,Pointer(CacheMemory)

   mov eax,$1F1F1F1F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0


   mov eax,edx
   shr eax,1
@MMX_FirstLine:
   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32
   dec eax
   jnz @MMX_FirstLine

   mov esi,Src
   mov edi,Dest
   mov ecx,576-1
@CALC_edi2:
   add edi,768*2
   loop @CALC_edi2
   mov ecx,576/2-1

@MMX_Line:

   mov eax,edx
@MMX_CopyCycle:
   db $0F,$18,$46,$20       /// prefetchtna [esi+32]
   db $0F,$18,$46,$30       /// prefetchtna [esi+48]
   db $0F,$18,$86,$20,$06,$00,$00/// prefetchtna [esi+768*2+32]
   db $0F,$18,$86,$30,$06,$00,$00/// prefetchtna [esi+768*2+48]
   db $0F,$18,$86,$20,$0C,$00,$00/// prefetchtna [esi+768*4+32]
   db $0F,$18,$86,$30,$0C,$00,$00/// prefetchtna [esi+768*4+48]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$5E,$08       /// movq mm3,[esi+8]
   db $0F,$6F,$8E,$00,$06,$00,$00/// movq mm1,[esi+768*2]
   db $0F,$6F,$A6,$08,$06,$00,$00/// movq mm4,[esi+768*2+8]
   db $0F,$6F,$96,$00,$0C,$00,$00/// movq mm2,[esi+768*4]
   db $0F,$6F,$AE,$08,$0C,$00,$00/// movq mm5,[esi+768*4+8]

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$5F,$08       /// movntq [edi+8],mm3
   db $0F,$E7,$97,$00,$F4,$FF,$FF/// movntq [edi-768*4],mm2
   db $0F,$E7,$AF,$08,$F4,$FF,$FF/// movntq [edi-768*4+8],mm5

   db $0F,$EF,$FF           /// pxor mm7,mm7

   db $0F,$6F,$F0           /// movq mm6,mm0
   db $0F,$E0,$F2           /// pavgb mm6,mm2
   db $0F,$E0,$CF           /// pavgb mm1,mm7
   db $0F,$E0,$F1           /// pavgb mm6,mm1
   db $0F,$71,$D0,$03       /// psrlw mm0,3
   db $0F,$DB,$03           /// pand mm0,[ebx]
   db $0F,$71,$D2,$03       /// psrlw mm2,3
   db $0F,$DB,$13           /// pand mm2,[ebx]
   db $0F,$DC,$F0           /// paddusb mm6,mm0
   db $0F,$DC,$F2           /// paddusb mm6,mm2

   db $0F,$E7,$B7,$00,$FA,$FF,$FF/// movntq [edi-768*2],mm6

   db $0F,$6F,$F3           /// movq mm6,mm3
   db $0F,$E0,$F5           /// pavgb mm6,mm5
   db $0F,$E0,$E7           /// pavgb mm4,mm7
   db $0F,$E0,$F4           /// pavgb mm6,mm4
   db $0F,$71,$D3,$03       /// psrlw mm3,3
   db $0F,$DB,$1B           /// pand mm3,[ebx]
   db $0F,$71,$D5,$03       /// psrlw mm5,3
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$DC,$F3           /// paddusb mm6,mm3
   db $0F,$DC,$F5           /// paddusb mm6,mm5

   db $0F,$E7,$B7,$08,$FA,$FF,$FF/// movntq [edi-768*2+8],mm6

   add esi,16
   add edi,16

   dec eax
   jnz @MMX_CopyCycle

   add esi,768*2
   sub edi,768*2
   sub edi,768*2
   sub edi,768*2

   dec ecx
   jnz @MMX_Line

   mov eax,edx
   shr eax,1
@MMX_LastLine:
   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32
   dec eax
   jnz @MMX_LastLine

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure CopyMemoryAverageYUY2MMX232(const Dest: Pointer;
                                      const Src: Pointer;
                                      const Size: DWord);
begin
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src
   mov ecx,Size
   shr ecx,5

@MMX_CopyCycle:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]
   db $0F,$18,$47,$40       /// prefetchtna [edi+64]
   db $0F,$18,$47,$60       /// prefetchtna [edi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$6F,$27           /// movq mm4,[edi]
   db $0F,$6F,$6F,$08       /// movq mm5,[edi+8]
   db $0F,$6F,$77,$10       /// movq mm6,[edi+16]
   db $0F,$6F,$7F,$18       /// movq mm7,[edi+24]

   db $0F,$E0,$C4           /// pavgb mm0,mm4
   db $0F,$E0,$CD           /// pavgb mm1,mm5
   db $0F,$E0,$D6           /// pavgb mm2,mm6
   db $0F,$E0,$DF           /// pavgb mm3,mm7

   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
end;

procedure CopyMemoryAverageRGB555MMX216(const Dest: Pointer;
                                        const Src: Pointer;
                                        const Size: DWord);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  asm
   pushad
   pushfd
   mov edi,Dest
   mov esi,Src
   mov ecx,Size
   shr ecx,4

   mov ebx,Pointer(CacheMemory)

   mov eax,$001F001F
   db $0F,$6E,$C0           /// movd mm0,eax
   db $0F,$73,$F0,$20       /// psllq mm0,32
   db $0F,$EF,$C9           /// pxor mm1,mm1
   db $0F,$6E,$C8           /// movd mm1,eax
   db $0F,$EB,$C1           /// por mm0,mm1
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$73,$F0,$05       /// psllq mm0,5
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

@MMX_CopyCycle:

   db $0F,$18,$46,$32       /// prefetchtna [esi+$32]
   db $0F,$18,$46,$48       /// prefetchtna [esi+$48]
   db $0F,$18,$47,$32       /// prefetchtna [edi+$32]
   db $0F,$18,$47,$48       /// prefetchtna [edi+$48]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$17           /// movq mm2,[edi]
   db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]

   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$E3,$E5           /// pavgw mm4,mm5
   db $0F,$6F,$F4           /// movq mm6,mm4
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$6B,$08       /// pand mm5,[ebx+8]
   db $0F,$E3,$E5           /// pavgw mm4,mm5
   db $0F,$EB,$F4           /// por mm6,mm4
   db $0F,$6F,$E0           /// movq mm4,mm0
   db $0F,$6F,$EA           /// movq mm5,mm2
   db $0F,$DB,$63,$10       /// pand mm4,[ebx+16]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$E3,$E5           /// pavgw mm4,mm5
   db $0F,$EB,$F4           /// por mm6,mm4

   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$23           /// pand mm4,[ebx]
   db $0F,$DB,$2B           /// pand mm5,[ebx]
   db $0F,$E3,$E5           /// pavgw mm4,mm5
   db $0F,$6F,$FC           /// movq mm7,mm4
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$63,$08       /// pand mm4,[ebx+8]
   db $0F,$DB,$6B,$08       /// pand mm5,[ebx+8]
   db $0F,$E3,$E5           /// pavgw mm4,mm5
   db $0F,$EB,$FC           /// por mm7,mm4
   db $0F,$6F,$E1           /// movq mm4,mm1
   db $0F,$6F,$EB           /// movq mm5,mm3
   db $0F,$DB,$63,$10       /// pand mm4,[ebx+16]
   db $0F,$DB,$6B,$10       /// pand mm5,[ebx+16]
   db $0F,$E3,$E5           /// pavgw mm4,mm5
   db $0F,$EB,$FC           /// por mm7,mm4

   db $0F,$E7,$37           /// movntq [edi],mm6
   db $0F,$E7,$7F,$08       /// movntq [edi+8],mm7

   add esi,16
   add edi,16

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure VmdYUY2MMX2(const ref,new,mask: Pointer;
                      const Size: DWord;
                      const Noise: DWord;
                      const MeasureLight: boolean;
                      const VR: Pointer);
var
  CacheMemory: PByte;
begin
  GetMem(CacheMemory,4096);
  if mask=nil then
    begin
        asm
         pushad
         pushfd

         mov edi,ref
         mov esi,new
         mov ecx,Size
         shr ecx,4

         mov ebx,Pointer(CacheMemory)

         mov eax,$00FF00FF
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$03           /// movq [ebx],mm0

         mov eax,Noise
         mov edx,Noise
         and eax,$000000FF
         and edx,$000000FF
         shl edx,16
         or eax,edx
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$08       /// movq [ebx+8],mm0

         mov eax,$00010001
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

         mov eax,$00000000
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         mov eax,$000000FF
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

         db $0F,$EF,$C0           /// pxor mm0,mm0
         db $0F,$7F,$43,$20       /// movq [ebx+32],mm0

         db $0F,$7F,$43,$60       /// movq [ebx+96],mm0     // level

       @MMX_CopyCycle:

         db $0F,$18,$46,$20       /// prefetchtna [esi+32]
         db $0F,$18,$46,$30       /// prefetchtna [esi+48]
         db $0F,$18,$47,$20       /// prefetchtna [edi+32]
         db $0F,$18,$47,$30       /// prefetchtna [edi+48]

         db $0F,$6F,$06           /// movq mm0,[esi]
         db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
         db $0F,$6F,$17           /// movq mm2,[edi]
         db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]

       @MeasureLight:
         cmp MeasureLight,0
         je @MeasureEnd
         db $0F,$6F,$73,$60       /// movq mm6,[ebx+96]
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$10       /// psrlq mm4,16
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$20       /// psrlq mm4,32
         db $0F,$73,$D5,$20       /// psrlq mm5,32
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$30       /// psrlq mm4,48
         db $0F,$73,$D5,$30       /// psrlq mm5,48
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$7F,$73,$60       /// movq [ebx+96],mm6

       @MeasureEnd:
         db $0F,$DB,$03           /// pand mm0,[ebx]  // 0 Y0 0 Y1 0 Y2 0 Y3
         db $0F,$DB,$0B           /// pand mm1,[ebx]  // 0 Y4 0 Y5 0 Y6 0 Y7
         db $0F,$DB,$13           /// pand mm2,[ebx]
         db $0F,$DB,$1B           /// pand mm3,[ebx]

         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$EE,$E2           /// pmaxsw mm4,mm2  // signed, because 00xx is a word
         db $0F,$EE,$EB           /// pmaxsw mm5,mm3
         db $0F,$6F,$F2           /// movq mm6,mm2
         db $0F,$6F,$FB           /// movq mm7,mm3
         db $0F,$EA,$F0           /// pminsw mm6,mm0
         db $0F,$EA,$F9           /// pminsw mm7,mm1

         db $0F,$D9,$E6           /// psubusw mm4,mm6 // 0 diff0 0 diff1 0 diff2 0 diff3
         db $0F,$D9,$EF           /// psubusw mm5,mm7 // 0 diff4 0 diff5 0 diff6 0 diff7

         db $0F,$D9,$63,$08       /// psubusw mm4,[ebx+8] // mm4=0 if Noise>=mm4
         db $0F,$D9,$6B,$08       /// psubusw mm5,[ebx+8]

         db $0F,$EA,$63,$10       /// pminsw mm4,[ebx+16]
         db $0F,$EA,$6B,$10       /// pminsw mm5,[ebx+16]

         db $0F,$DD,$E5           /// paddusw mm4,mm5
         db $0F,$6F,$73,$20       /// movq mm6,[ebx+32]

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$7F,$73,$20       /// movq [ebx+32],mm6

         add esi,16
         add edi,16

         dec ecx
         jnz @MMX_CopyCycle

         db $0F,$6F,$43,$20       /// movq mm0,[ebx+32]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov edi,VR
         mov [edi],eax

         mov eax,$FFFFFFFF
         mov [edi+4],eax
         mov [edi+8],eax
         mov [edi+12],eax
         mov [edi+16],eax
         mov [edi+20],eax
         mov [edi+24],eax
         mov [edi+28],eax

         db $0F,$6F,$43,$60       /// movq mm0,[ebx+96]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+32],eax

         db $0F,$77               /// emms
         popfd
         popad
        end;
    end
   else // mask<>nil
    begin
        asm
         pushad
         pushfd

         mov edi,ref
         mov esi,new
         mov edx,mask
         mov ecx,Size
         shr ecx,4

         mov ebx,Pointer(CacheMemory)

         mov eax,$00FF00FF
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$03           /// movq [ebx],mm0

         push edx
         mov eax,Noise
         mov edx,Noise
         and eax,$000000FF
         and edx,$000000FF
         shl edx,16
         or eax,edx
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
         pop edx

         mov eax,$00010001
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$10       /// movq [ebx+16],mm0

         mov eax,$00000000
         db $0F,$6E,$C0           /// movd mm0,eax
         db $0F,$73,$F0,$20       /// psllq mm0,32
         db $0F,$EF,$C9           /// pxor mm1,mm1
         mov eax,$000000FF
         db $0F,$6E,$C8           /// movd mm1,eax
         db $0F,$EB,$C1           /// por mm0,mm1
         db $0F,$7F,$43,$18       /// movq [ebx+24],mm0

         db $0F,$EF,$C0           /// pxor mm0,mm0
         db $0F,$7F,$43,$20       /// movq [ebx+32],mm0
         db $0F,$7F,$43,$28       /// movq [ebx+40],mm0
         db $0F,$7F,$43,$30       /// movq [ebx+48],mm0
         db $0F,$7F,$43,$38       /// movq [ebx+56],mm0
         db $0F,$7F,$43,$40       /// movq [ebx+64],mm0
         db $0F,$7F,$43,$48       /// movq [ebx+72],mm0
         db $0F,$7F,$43,$50       /// movq [ebx+80],mm0
         db $0F,$7F,$43,$58       /// movq [ebx+88],mm0

         db $0F,$7F,$43,$60       /// movq [ebx+96],mm0     // level

       @MMX_CopyCycle:

         db $0F,$18,$46,$20       /// prefetchtna [esi+32]
         db $0F,$18,$46,$30       /// prefetchtna [esi+48]
         db $0F,$18,$47,$20       /// prefetchtna [edi+32]
         db $0F,$18,$47,$30       /// prefetchtna [edi+48]
         db $0F,$18,$42,$20       /// prefetchtna [edx+32]
         db $0F,$18,$42,$30       /// prefetchtna [edx+48]

         db $0F,$6F,$06           /// movq mm0,[esi]
         db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
         db $0F,$6F,$17           /// movq mm2,[edi]
         db $0F,$6F,$5F,$08       /// movq mm3,[edi+8]

       @MeasureLight:
         cmp MeasureLight,0
         je @MeasureEnd
         db $0F,$6F,$73,$60       /// movq mm6,[ebx+96]
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$10       /// psrlq mm4,16
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$20       /// psrlq mm4,32
         db $0F,$73,$D5,$20       /// psrlq mm5,32
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$73,$D4,$30       /// psrlq mm4,48
         db $0F,$73,$D5,$30       /// psrlq mm5,48
         db $0F,$DB,$63,$18       /// pand mm4,[ebx+24]
         db $0F,$DB,$6B,$18       /// pand mm5,[ebx+24]
         db $0F,$FE,$E5           /// paddd mm4,mm5
         db $0F,$FE,$F4           /// paddd mm6,mm4
         db $0F,$7F,$73,$60       /// movq [ebx+96],mm6

       @MeasureEnd:
         db $0F,$6F,$32           /// movq mm6,[edx]
         db $0F,$7E,$F0           /// movd eax,mm6
         cmp eax,$00
         jne @Check
         db $0F,$73,$D6,$20       /// psrlq mm6,32
         db $0F,$7E,$F0           /// movd eax,mm6
         cmp eax,$00
         jne @Check
         db $0F,$6F,$72,$08       /// movq mm6,[edx+8]
         db $0F,$7E,$F0           /// movd eax,mm6
         cmp eax,$00
         jne @Check
         db $0F,$73,$D6,$20       /// psrlq mm6,32
         db $0F,$7E,$F0           /// movd eax,mm6
         cmp eax,$00
         je @CheckEnd

       @Check:
         db $0F,$DB,$03           /// pand mm0,[ebx]  // 0 Y0 0 Y1 0 Y2 0 Y3
         db $0F,$DB,$0B           /// pand mm1,[ebx]  // 0 Y4 0 Y5 0 Y6 0 Y7
         db $0F,$DB,$13           /// pand mm2,[ebx]
         db $0F,$DB,$1B           /// pand mm3,[ebx]

         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1
         db $0F,$EE,$E2           /// pmaxsw mm4,mm2  // signed, because 00xx is a word
         db $0F,$EE,$EB           /// pmaxsw mm5,mm3
         db $0F,$6F,$F2           /// movq mm6,mm2
         db $0F,$6F,$FB           /// movq mm7,mm3
         db $0F,$EA,$F0           /// pminsw mm6,mm0
         db $0F,$EA,$F9           /// pminsw mm7,mm1

         db $0F,$D9,$E6           /// psubusw mm4,mm6 // 0 diff0 0 diff1 0 diff2 0 diff3
         db $0F,$D9,$EF           /// psubusw mm5,mm7 // 0 diff4 0 diff5 0 diff6 0 diff7

         db $0F,$D9,$63,$08       /// psubusw mm4,[ebx+8] // mm4=0 if Noise>=mm4
         db $0F,$D9,$6B,$08       /// psubusw mm5,[ebx+8]

         db $0F,$EA,$63,$10       /// pminsw mm4,[ebx+16]
         db $0F,$EA,$6B,$10       /// pminsw mm5,[ebx+16]

         db $0F,$6F,$C4           /// movq mm0,mm4
         db $0F,$6F,$CD           /// movq mm1,mm5

         db $0F,$6F,$12           /// movq mm2,[edx]
         db $0F,$6F,$5A,$08       /// movq mm3,[edx+8]

         db $0F,$6F,$7B,$18       /// movq mm7,[ebx+24]

         push ecx
         mov ecx,8
         mov eax,32

       @Mask_NS:

         db $0F,$6F,$E0           /// movq mm4,mm0
         db $0F,$6F,$E9           /// movq mm5,mm1

         db $0F,$DB,$E2           /// pand mm4,mm2
         db $0F,$DB,$EB           /// pand mm5,mm3

         db $0F,$71,$D2,$01       /// psrlw mm2,1
         db $0F,$71,$D3,$01       /// psrlw mm3,1

         db $0F,$DD,$E5           /// paddusw mm4,mm5
         db $0F,$6F,$34,$03       /// movq mm6,[ebx+eax]

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$DB,$EF           /// pand mm5,mm7
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$EF           /// pand mm5,mm7
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$EF           /// pand mm5,mm7
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$6F,$EC           /// movq mm5,mm4
         db $0F,$73,$D5,$10       /// psrlq mm5,16
         db $0F,$DB,$EF           /// pand mm5,mm7
         db $0F,$FE,$F5           /// paddd mm6,mm5

         db $0F,$7F,$34,$03       /// movq [ebx+eax],mm6

         add eax,8
         dec ecx
         jnz @Mask_NS

         pop ecx

       @CheckEnd:
         add esi,16
         add edi,16
         add edx,16

         dec ecx
         jnz @MMX_CopyCycle

         mov edi,VR

         db $0F,$6F,$43,$20       /// movq mm0,[ebx+32]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi],eax
         db $0F,$6F,$43,$28       /// movq mm0,[ebx+40]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+4],eax
         db $0F,$6F,$43,$30       /// movq mm0,[ebx+48]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+8],eax
         db $0F,$6F,$43,$38       /// movq mm0,[ebx+56]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+12],eax
         db $0F,$6F,$43,$40       /// movq mm0,[ebx+64]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+16],eax
         db $0F,$6F,$43,$48       /// movq mm0,[ebx+72]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+20],eax
         db $0F,$6F,$43,$50       /// movq mm0,[ebx+80]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+24],eax
         db $0F,$6F,$43,$58       /// movq mm0,[ebx+88]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+28],eax

         db $0F,$6F,$43,$60       /// movq mm0,[ebx+96]
         db $0F,$7E,$C0           /// movd eax,mm0
         mov [edi+32],eax

         db $0F,$77               /// emms
         popfd
         popad
        end;
    end;
  FreeMem(CacheMemory);
end;

procedure MedianFilter3x3MMX2Plane(const Src: pointer;
                                   const SrcW,SrcH: DWord);
var
  CacheMemory,
  TempImage: PByte;
  Size,
  Disp,
  DispR,
  SrcW_M,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(TempImage,SrcW*SrcH);
  GetMem(CacheMemory,4096);
  SrcW_M:=(SrcW-2) div 8;   // X irányú ciklus
  SrcW_R:=2*SrcW-8;          // esi eltolásának a helyreállítása 8 növeléssel együtt
  SrcW_R2:=2*SrcW-10;        // u.a. de a maradék byte-ok kiszámolásánál
  SrcH_M:=SrcH-2;           // Y irányú ciklus
  Disp:=SrcW+1;             // Elsõ pixel eltolása
  DispR:=8-(SrcW-(SrcW_M*8)-2);  // maradék byte-ok okozta kiesés kiszámolása
  Size:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Pointer(TempImage)
   add edi,Disp
   mov ebx,Pointer(CacheMemory);

   mov ecx,SrcH_M

@MF33_1:

   push ecx
   mov ecx,SrcW_M

@MF33_2:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$4E,$01       /// movq mm1,[esi+1]
   db $0F,$7F,$4B,$08       /// movq [ebx+8],mm1
   db $0F,$6F,$56,$02       /// movq mm2,[esi+2]
   db $0F,$7F,$53,$10       /// movq [ebx+16],mm2
   add esi,SrcW
   db $0F,$6F,$16           /// movq mm2,[esi]
   db $0F,$6F,$5E,$01       /// movq mm3,[esi+1]
   db $0F,$6F,$66,$02       /// movq mm4,[esi+2]
   add esi,SrcW
   db $0F,$6F,$2E           /// movq mm5,[esi]
   db $0F,$6F,$76,$01       /// movq mm6,[esi+1]
   db $0F,$6F,$7E,$02       /// movq mm7,[esi+2]


   db $0F,$DA,$C1           /// pminub mm0,mm1           // mm0,mm1 már be van töltve
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$7F,$4B,$08       /// movq [ebx+8],mm1

   db $0F,$6F,$4B,$10       /// movq mm1,[ebx+16]
   db $0F,$DA,$C1           /// pminub mm0,mm1
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$7F,$4B,$10       /// movq [ebx+16],mm1

   db $0F,$6F,$CA           /// movq mm1,mm2
   db $0F,$DA,$C2           /// pminub mm0,mm2
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$D1           /// movq mm2,mm1

   db $0F,$6F,$CB           /// movq mm1,mm3
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$D9           /// movq mm3,mm1

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$E1           /// movq mm4,mm1

   db $0F,$6F,$CD           /// movq mm1,mm5
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$E9           /// movq mm5,mm1

   db $0F,$6F,$CE           /// movq mm1,mm6
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$F1           /// movq mm6,mm1

   db $0F,$6F,$CF           /// movq mm1,mm7
   db $0F,$DA,$C7           /// pminub mm0,mm7
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   //movq [ebx],mm0    //legkisebb
   db $0F,$6F,$F9           /// movq mm7,mm1
   //******* 1. legkisebb megvan
   db $0F,$6F,$43,$08       /// movq mm0,[ebx+8]

   db $0F,$6F,$4B,$10       /// movq mm1,[ebx+16]
   db $0F,$DA,$C1           /// pminub mm0,mm1
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$7F,$4B,$10       /// movq [ebx+16],mm1

   db $0F,$6F,$CA           /// movq mm1,mm2
   db $0F,$DA,$C2           /// pminub mm0,mm2
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$D1           /// movq mm2,mm1

   db $0F,$6F,$CB           /// movq mm1,mm3
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$D9           /// movq mm3,mm1

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$E1           /// movq mm4,mm1

   db $0F,$6F,$CD           /// movq mm1,mm5
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$E9           /// movq mm5,mm1

   db $0F,$6F,$CE           /// movq mm1,mm6
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$F1           /// movq mm6,mm1

   db $0F,$6F,$CF           /// movq mm1,mm7
   db $0F,$DA,$C7           /// pminub mm0,mm7
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   //movq [ebx+8],mm0    //legkisebb
   db $0F,$6F,$F9           /// movq mm7,mm1
   //******* 2. legkisebb megvan
   db $0F,$6F,$43,$10       /// movq mm0,[ebx+16]

   db $0F,$6F,$CA           /// movq mm1,mm2
   db $0F,$DA,$C2           /// pminub mm0,mm2
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$D1           /// movq mm2,mm1

   db $0F,$6F,$CB           /// movq mm1,mm3
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$D9           /// movq mm3,mm1

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$E1           /// movq mm4,mm1

   db $0F,$6F,$CD           /// movq mm1,mm5
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$E9           /// movq mm5,mm1

   db $0F,$6F,$CE           /// movq mm1,mm6
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$F1           /// movq mm6,mm1

   db $0F,$6F,$CF           /// movq mm1,mm7
   db $0F,$DA,$C7           /// pminub mm0,mm7
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   //movq [ebx+16],mm0    //legkisebb
   db $0F,$6F,$F9           /// movq mm7,mm1
   //******* 3. legkisebb megvan
   db $0F,$6F,$C2           /// movq mm0,mm2

   db $0F,$6F,$CB           /// movq mm1,mm3
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1

   db $0F,$6F,$CD           /// movq mm1,mm5
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$E9           /// movq mm5,mm1

   db $0F,$6F,$CE           /// movq mm1,mm6
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$F1           /// movq mm6,mm1

   db $0F,$6F,$CF           /// movq mm1,mm7
   db $0F,$DA,$C7           /// pminub mm0,mm7
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   //movq mm2,mm0    //legkisebb
   db $0F,$6F,$F9           /// movq mm7,mm1
   //******* 4. legkisebb megvan
   db $0F,$DA,$DC           /// pminub mm3,mm4
   db $0F,$DA,$DD           /// pminub mm3,mm5
   db $0F,$DA,$DE           /// pminub mm3,mm6
   db $0F,$DA,$DF           /// pminub mm3,mm7
   //******* 5. legkisebb megvan

   db $0F,$E7,$1F           /// movntq [edi],mm3

   sub esi,SrcW_R
   add edi,8

   dec ecx
   jnz @MF33_2

   sub esi,DispR
   sub edi,DispR

   //**** Maradék byte-ok kiszámolása (nem egész 8-ra jön ki -2 miatt)

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$4E,$01       /// movq mm1,[esi+1]
   db $0F,$7F,$4B,$08       /// movq [ebx+8],mm1
   db $0F,$6F,$56,$02       /// movq mm2,[esi+2]
   db $0F,$7F,$53,$10       /// movq [ebx+16],mm2
   add esi,SrcW
   db $0F,$6F,$16           /// movq mm2,[esi]
   db $0F,$6F,$5E,$01       /// movq mm3,[esi+1]
   db $0F,$6F,$66,$02       /// movq mm4,[esi+2]
   add esi,SrcW
   db $0F,$6F,$2E           /// movq mm5,[esi]
   db $0F,$6F,$76,$01       /// movq mm6,[esi+1]
   db $0F,$6F,$7E,$02       /// movq mm7,[esi+2]

   db $0F,$DA,$C1           /// pminub mm0,mm1           // mm0,mm1 már be van töltve
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$7F,$4B,$08       /// movq [ebx+8],mm1

   db $0F,$6F,$4B,$10       /// movq mm1,[ebx+16]
   db $0F,$DA,$C1           /// pminub mm0,mm1
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$7F,$4B,$10       /// movq [ebx+16],mm1

   db $0F,$6F,$CA           /// movq mm1,mm2
   db $0F,$DA,$C2           /// pminub mm0,mm2
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$D1           /// movq mm2,mm1

   db $0F,$6F,$CB           /// movq mm1,mm3
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$D9           /// movq mm3,mm1

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$E1           /// movq mm4,mm1

   db $0F,$6F,$CD           /// movq mm1,mm5
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$E9           /// movq mm5,mm1

   db $0F,$6F,$CE           /// movq mm1,mm6
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$F1           /// movq mm6,mm1

   db $0F,$6F,$CF           /// movq mm1,mm7
   db $0F,$DA,$C7           /// pminub mm0,mm7
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   //movq [ebx],mm0    //legkisebb
   db $0F,$6F,$F9           /// movq mm7,mm1
   //******* 1. legkisebb megvan
   db $0F,$6F,$43,$08       /// movq mm0,[ebx+8]

   db $0F,$6F,$4B,$10       /// movq mm1,[ebx+16]
   db $0F,$DA,$C1           /// pminub mm0,mm1
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$7F,$4B,$10       /// movq [ebx+16],mm1

   db $0F,$6F,$CA           /// movq mm1,mm2
   db $0F,$DA,$C2           /// pminub mm0,mm2
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$D1           /// movq mm2,mm1

   db $0F,$6F,$CB           /// movq mm1,mm3
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$D9           /// movq mm3,mm1

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$E1           /// movq mm4,mm1

   db $0F,$6F,$CD           /// movq mm1,mm5
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$E9           /// movq mm5,mm1

   db $0F,$6F,$CE           /// movq mm1,mm6
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$F1           /// movq mm6,mm1

   db $0F,$6F,$CF           /// movq mm1,mm7
   db $0F,$DA,$C7           /// pminub mm0,mm7
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   //movq [ebx+8],mm0    //legkisebb
   db $0F,$6F,$F9           /// movq mm7,mm1
   //******* 2. legkisebb megvan
   db $0F,$6F,$43,$10       /// movq mm0,[ebx+16]

   db $0F,$6F,$CA           /// movq mm1,mm2
   db $0F,$DA,$C2           /// pminub mm0,mm2
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$D1           /// movq mm2,mm1

   db $0F,$6F,$CB           /// movq mm1,mm3
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$D9           /// movq mm3,mm1

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$E1           /// movq mm4,mm1

   db $0F,$6F,$CD           /// movq mm1,mm5
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$E9           /// movq mm5,mm1

   db $0F,$6F,$CE           /// movq mm1,mm6
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$F1           /// movq mm6,mm1

   db $0F,$6F,$CF           /// movq mm1,mm7
   db $0F,$DA,$C7           /// pminub mm0,mm7
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   //movq [ebx+16],mm0    //legkisebb
   db $0F,$6F,$F9           /// movq mm7,mm1
   //******* 3. legkisebb megvan
   db $0F,$6F,$C2           /// movq mm0,mm2

   db $0F,$6F,$CB           /// movq mm1,mm3
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1

   db $0F,$6F,$CD           /// movq mm1,mm5
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$E9           /// movq mm5,mm1

   db $0F,$6F,$CE           /// movq mm1,mm6
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$F1           /// movq mm6,mm1

   db $0F,$6F,$CF           /// movq mm1,mm7
   db $0F,$DA,$C7           /// pminub mm0,mm7
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   //movq mm2,mm0    //legkisebb
   db $0F,$6F,$F9           /// movq mm7,mm1
   //******* 4. legkisebb megvan
   db $0F,$DA,$DC           /// pminub mm3,mm4
   db $0F,$DA,$DD           /// pminub mm3,mm5
   db $0F,$DA,$DE           /// pminub mm3,mm6
   db $0F,$DA,$DF           /// pminub mm3,mm7
   //******* 5. legkisebb megvan

   db $0F,$E7,$1F           /// movntq [edi],mm3

   sub esi,SrcW_R2
   add edi,10

   pop ecx
   dec ecx
   jnz @MF33_1

   //*** Másolás vissza
   mov edi,Src
   mov esi,Pointer(TempImage)
   mov ecx,Size
   shr ecx,5

   @MMX_CopyCycle:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle


   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
  FreeMem(TempImage);
end;

procedure MedianFilter3x3MMX2PlaneD(const Dest: pointer;
                                    const Src: pointer;
                                    const SrcW,SrcH: DWord);
var
  CacheMemory: PByte;
  Size,
  Disp,
  DispR,
  SrcW_M,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(CacheMemory,4096);
  SrcW_M:=(SrcW-2) div 8;   // X irányú ciklus
  SrcW_R:=2*SrcW-8;          // esi eltolásának a helyreállítása 8 növeléssel együtt
  SrcW_R2:=2*SrcW-10;        // u.a. de a maradék byte-ok kiszámolásánál
  SrcH_M:=SrcH-2;           // Y irányú ciklus
  Disp:=SrcW+1;             // Elsõ pixel eltolása
  DispR:=8-(SrcW-(SrcW_M*8)-2);  // maradék byte-ok okozta kiesés kiszámolása
  Size:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Dest
   add edi,Disp
   mov ebx,Pointer(CacheMemory);

   mov ecx,SrcH_M

@MF33_1:

   push ecx
   mov ecx,SrcW_M

@MF33_2:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$4E,$01       /// movq mm1,[esi+1]
   db $0F,$7F,$4B,$08       /// movq [ebx+8],mm1
   db $0F,$6F,$56,$02       /// movq mm2,[esi+2]
   db $0F,$7F,$53,$10       /// movq [ebx+16],mm2
   add esi,SrcW
   db $0F,$6F,$16           /// movq mm2,[esi]
   db $0F,$6F,$5E,$01       /// movq mm3,[esi+1]
   db $0F,$6F,$66,$02       /// movq mm4,[esi+2]
   add esi,SrcW
   db $0F,$6F,$2E           /// movq mm5,[esi]
   db $0F,$6F,$76,$01       /// movq mm6,[esi+1]
   db $0F,$6F,$7E,$02       /// movq mm7,[esi+2]


   db $0F,$DA,$C1           /// pminub mm0,mm1           // mm0,mm1 már be van töltve
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$7F,$4B,$08       /// movq [ebx+8],mm1

   db $0F,$6F,$4B,$10       /// movq mm1,[ebx+16]
   db $0F,$DA,$C1           /// pminub mm0,mm1
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$7F,$4B,$10       /// movq [ebx+16],mm1

   db $0F,$6F,$CA           /// movq mm1,mm2
   db $0F,$DA,$C2           /// pminub mm0,mm2
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$D1           /// movq mm2,mm1

   db $0F,$6F,$CB           /// movq mm1,mm3
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$D9           /// movq mm3,mm1

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$E1           /// movq mm4,mm1

   db $0F,$6F,$CD           /// movq mm1,mm5
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$E9           /// movq mm5,mm1

   db $0F,$6F,$CE           /// movq mm1,mm6
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$F1           /// movq mm6,mm1

   db $0F,$6F,$CF           /// movq mm1,mm7
   db $0F,$DA,$C7           /// pminub mm0,mm7
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   //movq [ebx],mm0    //legkisebb
   db $0F,$6F,$F9           /// movq mm7,mm1
   //******* 1. legkisebb megvan
   db $0F,$6F,$43,$08       /// movq mm0,[ebx+8]

   db $0F,$6F,$4B,$10       /// movq mm1,[ebx+16]
   db $0F,$DA,$C1           /// pminub mm0,mm1
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$7F,$4B,$10       /// movq [ebx+16],mm1

   db $0F,$6F,$CA           /// movq mm1,mm2
   db $0F,$DA,$C2           /// pminub mm0,mm2
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$D1           /// movq mm2,mm1

   db $0F,$6F,$CB           /// movq mm1,mm3
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$D9           /// movq mm3,mm1

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$E1           /// movq mm4,mm1

   db $0F,$6F,$CD           /// movq mm1,mm5
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$E9           /// movq mm5,mm1

   db $0F,$6F,$CE           /// movq mm1,mm6
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$F1           /// movq mm6,mm1

   db $0F,$6F,$CF           /// movq mm1,mm7
   db $0F,$DA,$C7           /// pminub mm0,mm7
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   //movq [ebx+8],mm0    //legkisebb
   db $0F,$6F,$F9           /// movq mm7,mm1
   //******* 2. legkisebb megvan
   db $0F,$6F,$43,$10       /// movq mm0,[ebx+16]

   db $0F,$6F,$CA           /// movq mm1,mm2
   db $0F,$DA,$C2           /// pminub mm0,mm2
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$D1           /// movq mm2,mm1

   db $0F,$6F,$CB           /// movq mm1,mm3
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$D9           /// movq mm3,mm1

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$E1           /// movq mm4,mm1

   db $0F,$6F,$CD           /// movq mm1,mm5
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$E9           /// movq mm5,mm1

   db $0F,$6F,$CE           /// movq mm1,mm6
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$F1           /// movq mm6,mm1

   db $0F,$6F,$CF           /// movq mm1,mm7
   db $0F,$DA,$C7           /// pminub mm0,mm7
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   //movq [ebx+16],mm0    //legkisebb
   db $0F,$6F,$F9           /// movq mm7,mm1
   //******* 3. legkisebb megvan
   db $0F,$6F,$C2           /// movq mm0,mm2

   db $0F,$6F,$CB           /// movq mm1,mm3
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1

   db $0F,$6F,$CD           /// movq mm1,mm5
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$E9           /// movq mm5,mm1

   db $0F,$6F,$CE           /// movq mm1,mm6
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$F1           /// movq mm6,mm1

   db $0F,$6F,$CF           /// movq mm1,mm7
   db $0F,$DA,$C7           /// pminub mm0,mm7
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   //movq mm2,mm0    //legkisebb
   db $0F,$6F,$F9           /// movq mm7,mm1
   //******* 4. legkisebb megvan
   db $0F,$DA,$DC           /// pminub mm3,mm4
   db $0F,$DA,$DD           /// pminub mm3,mm5
   db $0F,$DA,$DE           /// pminub mm3,mm6
   db $0F,$DA,$DF           /// pminub mm3,mm7
   //******* 5. legkisebb megvan

   db $0F,$E7,$1F           /// movntq [edi],mm3

   sub esi,SrcW_R
   add edi,8

   dec ecx
   jnz @MF33_2

   sub esi,DispR
   sub edi,DispR

   //**** Maradék byte-ok kiszámolása (nem egész 8-ra jön ki -2 miatt)

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$4E,$01       /// movq mm1,[esi+1]
   db $0F,$7F,$4B,$08       /// movq [ebx+8],mm1
   db $0F,$6F,$56,$02       /// movq mm2,[esi+2]
   db $0F,$7F,$53,$10       /// movq [ebx+16],mm2
   add esi,SrcW
   db $0F,$6F,$16           /// movq mm2,[esi]
   db $0F,$6F,$5E,$01       /// movq mm3,[esi+1]
   db $0F,$6F,$66,$02       /// movq mm4,[esi+2]
   add esi,SrcW
   db $0F,$6F,$2E           /// movq mm5,[esi]
   db $0F,$6F,$76,$01       /// movq mm6,[esi+1]
   db $0F,$6F,$7E,$02       /// movq mm7,[esi+2]

   db $0F,$DA,$C1           /// pminub mm0,mm1           // mm0,mm1 már be van töltve
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$7F,$4B,$08       /// movq [ebx+8],mm1

   db $0F,$6F,$4B,$10       /// movq mm1,[ebx+16]
   db $0F,$DA,$C1           /// pminub mm0,mm1
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$7F,$4B,$10       /// movq [ebx+16],mm1

   db $0F,$6F,$CA           /// movq mm1,mm2
   db $0F,$DA,$C2           /// pminub mm0,mm2
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$D1           /// movq mm2,mm1

   db $0F,$6F,$CB           /// movq mm1,mm3
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$D9           /// movq mm3,mm1

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$E1           /// movq mm4,mm1

   db $0F,$6F,$CD           /// movq mm1,mm5
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$E9           /// movq mm5,mm1

   db $0F,$6F,$CE           /// movq mm1,mm6
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$F1           /// movq mm6,mm1

   db $0F,$6F,$CF           /// movq mm1,mm7
   db $0F,$DA,$C7           /// pminub mm0,mm7
   db $0F,$DE,$0B           /// pmaxub mm1,[ebx]
   //movq [ebx],mm0    //legkisebb
   db $0F,$6F,$F9           /// movq mm7,mm1
   //******* 1. legkisebb megvan
   db $0F,$6F,$43,$08       /// movq mm0,[ebx+8]

   db $0F,$6F,$4B,$10       /// movq mm1,[ebx+16]
   db $0F,$DA,$C1           /// pminub mm0,mm1
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$7F,$4B,$10       /// movq [ebx+16],mm1

   db $0F,$6F,$CA           /// movq mm1,mm2
   db $0F,$DA,$C2           /// pminub mm0,mm2
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$D1           /// movq mm2,mm1

   db $0F,$6F,$CB           /// movq mm1,mm3
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$D9           /// movq mm3,mm1

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$E1           /// movq mm4,mm1

   db $0F,$6F,$CD           /// movq mm1,mm5
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$E9           /// movq mm5,mm1

   db $0F,$6F,$CE           /// movq mm1,mm6
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   db $0F,$7F,$43,$08       /// movq [ebx+8],mm0
   db $0F,$6F,$F1           /// movq mm6,mm1

   db $0F,$6F,$CF           /// movq mm1,mm7
   db $0F,$DA,$C7           /// pminub mm0,mm7
   db $0F,$DE,$4B,$08       /// pmaxub mm1,[ebx+8]
   //movq [ebx+8],mm0    //legkisebb
   db $0F,$6F,$F9           /// movq mm7,mm1
   //******* 2. legkisebb megvan
   db $0F,$6F,$43,$10       /// movq mm0,[ebx+16]

   db $0F,$6F,$CA           /// movq mm1,mm2
   db $0F,$DA,$C2           /// pminub mm0,mm2
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$D1           /// movq mm2,mm1

   db $0F,$6F,$CB           /// movq mm1,mm3
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$D9           /// movq mm3,mm1

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$E1           /// movq mm4,mm1

   db $0F,$6F,$CD           /// movq mm1,mm5
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$E9           /// movq mm5,mm1

   db $0F,$6F,$CE           /// movq mm1,mm6
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   db $0F,$7F,$43,$10       /// movq [ebx+16],mm0
   db $0F,$6F,$F1           /// movq mm6,mm1

   db $0F,$6F,$CF           /// movq mm1,mm7
   db $0F,$DA,$C7           /// pminub mm0,mm7
   db $0F,$DE,$4B,$10       /// pmaxub mm1,[ebx+16]
   //movq [ebx+16],mm0    //legkisebb
   db $0F,$6F,$F9           /// movq mm7,mm1
   //******* 3. legkisebb megvan
   db $0F,$6F,$C2           /// movq mm0,mm2

   db $0F,$6F,$CB           /// movq mm1,mm3
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$D9           /// movq mm3,mm1

   db $0F,$6F,$CC           /// movq mm1,mm4
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$E1           /// movq mm4,mm1

   db $0F,$6F,$CD           /// movq mm1,mm5
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$E9           /// movq mm5,mm1

   db $0F,$6F,$CE           /// movq mm1,mm6
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   db $0F,$6F,$D0           /// movq mm2,mm0
   db $0F,$6F,$F1           /// movq mm6,mm1

   db $0F,$6F,$CF           /// movq mm1,mm7
   db $0F,$DA,$C7           /// pminub mm0,mm7
   db $0F,$DE,$CA           /// pmaxub mm1,mm2
   //movq mm2,mm0    //legkisebb
   db $0F,$6F,$F9           /// movq mm7,mm1
   //******* 4. legkisebb megvan
   db $0F,$DA,$DC           /// pminub mm3,mm4
   db $0F,$DA,$DD           /// pminub mm3,mm5
   db $0F,$DA,$DE           /// pminub mm3,mm6
   db $0F,$DA,$DF           /// pminub mm3,mm7
   //******* 5. legkisebb megvan

   db $0F,$E7,$1F           /// movntq [edi],mm3

   sub esi,SrcW_R2
   add edi,10

   pop ecx
   dec ecx
   jnz @MF33_1

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
end;

procedure MinimumFilter3x3MMX2Plane(const Src: pointer;
                                    const SrcW,SrcH: DWord);
var
  CacheMemory,
  TempImage: PByte;
  Size,
  Disp,
  DispR,
  SrcW_M,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(TempImage,SrcW*SrcH);
  GetMem(CacheMemory,4096);
  SrcW_M:=(SrcW-2) div 8;   // X irányú ciklus
  SrcW_R:=2*SrcW-8;          // esi eltolásának a helyreállítása 8 növeléssel együtt
  SrcW_R2:=2*SrcW-10;        // u.a. de a maradék byte-ok kiszámolásánál
  SrcH_M:=SrcH-2;           // Y irányú ciklus
  Disp:=SrcW+1;             // Elsõ pixel eltolása
  DispR:=8-(SrcW-(SrcW_M*8)-2);  // maradék byte-ok okozta kiesés kiszámolása
  Size:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Pointer(TempImage)
   add edi,Disp
   mov ebx,Pointer(CacheMemory);

   mov ecx,SrcH_M

@MF33_1:

   push ecx
   mov ecx,SrcW_M

@MF33_2:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$4E,$01       /// movq mm1,[esi+1]
   db $0F,$7F,$4B,$08       /// movq [ebx+8],mm1
   db $0F,$6F,$56,$02       /// movq mm2,[esi+2]
   db $0F,$7F,$53,$10       /// movq [ebx+16],mm2
   add esi,SrcW
   db $0F,$6F,$16           /// movq mm2,[esi]
   db $0F,$6F,$5E,$01       /// movq mm3,[esi+1]
   db $0F,$6F,$66,$02       /// movq mm4,[esi+2]
   add esi,SrcW
   db $0F,$6F,$2E           /// movq mm5,[esi]
   db $0F,$6F,$76,$01       /// movq mm6,[esi+1]
   db $0F,$6F,$7E,$02       /// movq mm7,[esi+2]

   db $0F,$DA,$C1           /// pminub mm0,mm1           // mm0,mm1 már be van töltve
   db $0F,$DA,$43,$10       /// pminub mm0,[ebx+16]
   db $0F,$DA,$C2           /// pminub mm0,mm2
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DA,$C7           /// pminub mm0,mm7

   db $0F,$E7,$07           /// movntq [edi],mm0

   sub esi,SrcW_R
   add edi,8

   dec ecx
   jnz @MF33_2

   sub esi,DispR
   sub edi,DispR

   //**** Maradék byte-ok kiszámolása (nem egész 8-ra jön ki -2 miatt)

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$4E,$01       /// movq mm1,[esi+1]
   db $0F,$7F,$4B,$08       /// movq [ebx+8],mm1
   db $0F,$6F,$56,$02       /// movq mm2,[esi+2]
   db $0F,$7F,$53,$10       /// movq [ebx+16],mm2
   add esi,SrcW
   db $0F,$6F,$16           /// movq mm2,[esi]
   db $0F,$6F,$5E,$01       /// movq mm3,[esi+1]
   db $0F,$6F,$66,$02       /// movq mm4,[esi+2]
   add esi,SrcW
   db $0F,$6F,$2E           /// movq mm5,[esi]
   db $0F,$6F,$76,$01       /// movq mm6,[esi+1]
   db $0F,$6F,$7E,$02       /// movq mm7,[esi+2]

   db $0F,$DA,$C1           /// pminub mm0,mm1           // mm0,mm1 már be van töltve
   db $0F,$DA,$43,$10       /// pminub mm0,[ebx+16]
   db $0F,$DA,$C2           /// pminub mm0,mm2
   db $0F,$DA,$C3           /// pminub mm0,mm3
   db $0F,$DA,$C4           /// pminub mm0,mm4
   db $0F,$DA,$C5           /// pminub mm0,mm5
   db $0F,$DA,$C6           /// pminub mm0,mm6
   db $0F,$DA,$C7           /// pminub mm0,mm7

   db $0F,$E7,$07           /// movntq [edi],mm0

   sub esi,SrcW_R2
   add edi,10

   pop ecx
   dec ecx
   jnz @MF33_1

   //*** Másolás vissza
   mov edi,Src
   mov esi,Pointer(TempImage)
   mov ecx,Size
   shr ecx,5

   @MMX_CopyCycle:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle


   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
  FreeMem(TempImage);
end;

procedure MaximumFilter3x3MMX2Plane(const Src: pointer;
                                    const SrcW,SrcH: DWord);
var
  CacheMemory,
  TempImage: PByte;
  Size,
  Disp,
  DispR,
  SrcW_M,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(TempImage,SrcW*SrcH);
  GetMem(CacheMemory,4096);
  SrcW_M:=(SrcW-2) div 8;   // X irányú ciklus
  SrcW_R:=2*SrcW-8;          // esi eltolásának a helyreállítása 8 növeléssel együtt
  SrcW_R2:=2*SrcW-10;        // u.a. de a maradék byte-ok kiszámolásánál
  SrcH_M:=SrcH-2;           // Y irányú ciklus
  Disp:=SrcW+1;             // Elsõ pixel eltolása
  DispR:=8-(SrcW-(SrcW_M*8)-2);  // maradék byte-ok okozta kiesés kiszámolása
  Size:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Pointer(TempImage)
   add edi,Disp
   mov ebx,Pointer(CacheMemory);

   mov ecx,SrcH_M

@MF33_1:

   push ecx
   mov ecx,SrcW_M

@MF33_2:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$4E,$01       /// movq mm1,[esi+1]
   db $0F,$7F,$4B,$08       /// movq [ebx+8],mm1
   db $0F,$6F,$56,$02       /// movq mm2,[esi+2]
   db $0F,$7F,$53,$10       /// movq [ebx+16],mm2
   add esi,SrcW
   db $0F,$6F,$16           /// movq mm2,[esi]
   db $0F,$6F,$5E,$01       /// movq mm3,[esi+1]
   db $0F,$6F,$66,$02       /// movq mm4,[esi+2]
   add esi,SrcW
   db $0F,$6F,$2E           /// movq mm5,[esi]
   db $0F,$6F,$76,$01       /// movq mm6,[esi+1]
   db $0F,$6F,$7E,$02       /// movq mm7,[esi+2]

   db $0F,$DE,$C1           /// pmaxub mm0,mm1           // mm0,mm1 már be van töltve
   db $0F,$DE,$43,$10       /// pmaxub mm0,[ebx+16]
   db $0F,$DE,$C2           /// pmaxub mm0,mm2
   db $0F,$DE,$C3           /// pmaxub mm0,mm3
   db $0F,$DE,$C4           /// pmaxub mm0,mm4
   db $0F,$DE,$C5           /// pmaxub mm0,mm5
   db $0F,$DE,$C6           /// pmaxub mm0,mm6
   db $0F,$DE,$C7           /// pmaxub mm0,mm7

   db $0F,$E7,$07           /// movntq [edi],mm0

   sub esi,SrcW_R
   add edi,8

   dec ecx
   jnz @MF33_2

   sub esi,DispR
   sub edi,DispR

   //**** Maradék byte-ok kiszámolása (nem egész 8-ra jön ki -2 miatt)

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$03           /// movq [ebx],mm0
   db $0F,$6F,$4E,$01       /// movq mm1,[esi+1]
   db $0F,$7F,$4B,$08       /// movq [ebx+8],mm1
   db $0F,$6F,$56,$02       /// movq mm2,[esi+2]
   db $0F,$7F,$53,$10       /// movq [ebx+16],mm2
   add esi,SrcW
   db $0F,$6F,$16           /// movq mm2,[esi]
   db $0F,$6F,$5E,$01       /// movq mm3,[esi+1]
   db $0F,$6F,$66,$02       /// movq mm4,[esi+2]
   add esi,SrcW
   db $0F,$6F,$2E           /// movq mm5,[esi]
   db $0F,$6F,$76,$01       /// movq mm6,[esi+1]
   db $0F,$6F,$7E,$02       /// movq mm7,[esi+2]

   db $0F,$DE,$C1           /// pmaxub mm0,mm1           // mm0,mm1 már be van töltve
   db $0F,$DE,$43,$10       /// pmaxub mm0,[ebx+16]
   db $0F,$DE,$C2           /// pmaxub mm0,mm2
   db $0F,$DE,$C3           /// pmaxub mm0,mm3
   db $0F,$DE,$C4           /// pmaxub mm0,mm4
   db $0F,$DE,$C5           /// pmaxub mm0,mm5
   db $0F,$DE,$C6           /// pmaxub mm0,mm6
   db $0F,$DE,$C7           /// pmaxub mm0,mm7

   db $0F,$E7,$07           /// movntq [edi],mm0

   sub esi,SrcW_R2
   add edi,10

   pop ecx
   dec ecx
   jnz @MF33_1

   //*** Másolás vissza
   mov edi,Src
   mov esi,Pointer(TempImage)
   mov ecx,Size
   shr ecx,5

   @MMX_CopyCycle:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle


   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
  FreeMem(TempImage);
end;

procedure MedianFilter5x5MMX2Plane(const Src: pointer;
                                   const SrcW,SrcH: DWord);
var
  CacheMemory,
  TempImage: PByte;
  Size,
  Disp,
  DispR,
  SrcW_M,
  SrcW_R,
  SrcW_R2,
  SrcH_M: dword;
begin
  GetMem(TempImage,SrcW*SrcH);
  GetMem(CacheMemory,4096);
  SrcW_M:=(SrcW-4) div 8;   // X irányú ciklus
  SrcW_R:=4*SrcW-8;          // esi eltolásának a helyreállítása 8 növeléssel együtt
  SrcW_R2:=4*SrcW-12;        // u.a. de a maradék byte-ok kiszámolásánál
  SrcH_M:=SrcH-4;           // Y irányú ciklus
  Disp:=2*SrcW+2;           // Elsõ pixel eltolása
  DispR:=8-(SrcW-(SrcW_M*8)-4);  // maradék byte-ok okozta kiesés kiszámolása
  Size:=SrcW*SrcH;
  asm
   pushad
   pushfd

   mov esi,Src
   mov edi,Pointer(TempImage)
   add edi,Disp
   mov ebx,Pointer(CacheMemory);
   sub ebx,256

   mov ecx,SrcH_M

@MF55_1:

   push ecx
   mov ecx,SrcW_M

@MF55_2:

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$83,$00,$01,$00,$00/// movq [ebx+256],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$83,$08,$01,$00,$00/// movq [ebx+256+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$83,$10,$01,$00,$00/// movq [ebx+256+16],mm0
   db $0F,$6F,$46,$03       /// movq mm0,[esi+3]
   db $0F,$7F,$83,$18,$01,$00,$00/// movq [ebx+256+24],mm0
   db $0F,$6F,$46,$04       /// movq mm0,[esi+4]
   db $0F,$7F,$83,$20,$01,$00,$00/// movq [ebx+256+32],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$83,$28,$01,$00,$00/// movq [ebx+256+40],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$83,$30,$01,$00,$00/// movq [ebx+256+48],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$83,$38,$01,$00,$00/// movq [ebx+256+56],mm0
   db $0F,$6F,$46,$03       /// movq mm0,[esi+3]
   db $0F,$7F,$83,$40,$01,$00,$00/// movq [ebx+256+64],mm0
   db $0F,$6F,$46,$04       /// movq mm0,[esi+4]
   db $0F,$7F,$83,$48,$01,$00,$00/// movq [ebx+256+72],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$83,$50,$01,$00,$00/// movq [ebx+256+80],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$83,$58,$01,$00,$00/// movq [ebx+256+88],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$83,$60,$01,$00,$00/// movq [ebx+256+96],mm0
   db $0F,$6F,$46,$03       /// movq mm0,[esi+3]
   db $0F,$7F,$83,$68,$01,$00,$00/// movq [ebx+256+104],mm0
   db $0F,$6F,$46,$04       /// movq mm0,[esi+4]
   db $0F,$7F,$83,$70,$01,$00,$00/// movq [ebx+256+112],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$83,$78,$01,$00,$00/// movq [ebx+256+120],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$83,$80,$01,$00,$00/// movq [ebx+256+128],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$83,$88,$01,$00,$00/// movq [ebx+256+136],mm0
   db $0F,$6F,$46,$03       /// movq mm0,[esi+3]
   db $0F,$7F,$83,$90,$01,$00,$00/// movq [ebx+256+144],mm0
   db $0F,$6F,$46,$04       /// movq mm0,[esi+4]
   db $0F,$7F,$83,$98,$01,$00,$00/// movq [ebx+256+152],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$83,$A0,$01,$00,$00/// movq [ebx+256+160],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$83,$A8,$01,$00,$00/// movq [ebx+256+168],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$83,$B0,$01,$00,$00/// movq [ebx+256+176],mm0
   db $0F,$6F,$46,$03       /// movq mm0,[esi+3]
   db $0F,$7F,$83,$B8,$01,$00,$00/// movq [ebx+256+184],mm0
   db $0F,$6F,$46,$04       /// movq mm0,[esi+4]
   db $0F,$7F,$83,$C0,$01,$00,$00/// movq [ebx+256+192],mm0

   mov edx,12

   db $0F,$6F,$BB,$00,$01,$00,$00/// movq mm7,[ebx+256]
   db $0F,$DA,$BB,$08,$01,$00,$00/// pminub mm7,[ebx+256+8]
   db $0F,$DA,$BB,$10,$01,$00,$00/// pminub mm7,[ebx+256+16]
   db $0F,$DA,$BB,$18,$01,$00,$00/// pminub mm7,[ebx+256+24]
   db $0F,$DA,$BB,$20,$01,$00,$00/// pminub mm7,[ebx+256+32]
   db $0F,$DA,$BB,$28,$01,$00,$00/// pminub mm7,[ebx+256+40]
   db $0F,$DA,$BB,$30,$01,$00,$00/// pminub mm7,[ebx+256+48]
   db $0F,$DA,$BB,$38,$01,$00,$00/// pminub mm7,[ebx+256+56]
   db $0F,$DA,$BB,$40,$01,$00,$00/// pminub mm7,[ebx+256+64]
   db $0F,$DA,$BB,$48,$01,$00,$00/// pminub mm7,[ebx+256+72]
   db $0F,$DA,$BB,$50,$01,$00,$00/// pminub mm7,[ebx+256+80]
   db $0F,$DA,$BB,$58,$01,$00,$00/// pminub mm7,[ebx+256+88]
   db $0F,$DA,$BB,$60,$01,$00,$00/// pminub mm7,[ebx+256+96]
   db $0F,$DA,$BB,$68,$01,$00,$00/// pminub mm7,[ebx+256+104]
   db $0F,$DA,$BB,$70,$01,$00,$00/// pminub mm7,[ebx+256+112]
   db $0F,$DA,$BB,$78,$01,$00,$00/// pminub mm7,[ebx+256+120]
   db $0F,$DA,$BB,$80,$01,$00,$00/// pminub mm7,[ebx+256+128]
   db $0F,$DA,$BB,$88,$01,$00,$00/// pminub mm7,[ebx+256+136]
   db $0F,$DA,$BB,$90,$01,$00,$00/// pminub mm7,[ebx+256+144]
   db $0F,$DA,$BB,$98,$01,$00,$00/// pminub mm7,[ebx+256+152]
   db $0F,$DA,$BB,$A0,$01,$00,$00/// pminub mm7,[ebx+256+160]
   db $0F,$DA,$BB,$A8,$01,$00,$00/// pminub mm7,[ebx+256+168]
   db $0F,$DA,$BB,$B0,$01,$00,$00/// pminub mm7,[ebx+256+176]
   db $0F,$DA,$BB,$B8,$01,$00,$00/// pminub mm7,[ebx+256+184]
   db $0F,$DA,$BB,$C0,$01,$00,$00/// pminub mm7,[ebx+256+192]

@MF55R:

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$00,$01,$00,$00/// pcmpeqb mm6,[ebx+256]
   db $0F,$6F,$83,$00,$01,$00,$00/// movq mm0,[ebx+256]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$00,$01,$00,$00/// movq [ebx+256],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$08,$01,$00,$00/// pcmpeqb mm6,[ebx+256+8]
   db $0F,$6F,$83,$08,$01,$00,$00/// movq mm0,[ebx+256+8]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$08,$01,$00,$00/// movq [ebx+256+8],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$10,$01,$00,$00/// pcmpeqb mm6,[ebx+256+16]
   db $0F,$6F,$83,$10,$01,$00,$00/// movq mm0,[ebx+256+16]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$10,$01,$00,$00/// movq [ebx+256+16],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$18,$01,$00,$00/// pcmpeqb mm6,[ebx+256+24]
   db $0F,$6F,$83,$18,$01,$00,$00/// movq mm0,[ebx+256+24]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$18,$01,$00,$00/// movq [ebx+256+24],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$20,$01,$00,$00/// pcmpeqb mm6,[ebx+256+32]
   db $0F,$6F,$83,$20,$01,$00,$00/// movq mm0,[ebx+256+32]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$20,$01,$00,$00/// movq [ebx+256+32],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$28,$01,$00,$00/// pcmpeqb mm6,[ebx+256+40]
   db $0F,$6F,$83,$28,$01,$00,$00/// movq mm0,[ebx+256+40]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$28,$01,$00,$00/// movq [ebx+256+40],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$30,$01,$00,$00/// pcmpeqb mm6,[ebx+256+48]
   db $0F,$6F,$83,$30,$01,$00,$00/// movq mm0,[ebx+256+48]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$30,$01,$00,$00/// movq [ebx+256+48],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$38,$01,$00,$00/// pcmpeqb mm6,[ebx+256+56]
   db $0F,$6F,$83,$38,$01,$00,$00/// movq mm0,[ebx+256+56]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$38,$01,$00,$00/// movq [ebx+256+56],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$40,$01,$00,$00/// pcmpeqb mm6,[ebx+256+64]
   db $0F,$6F,$83,$40,$01,$00,$00/// movq mm0,[ebx+256+64]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$40,$01,$00,$00/// movq [ebx+256+64],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$48,$01,$00,$00/// pcmpeqb mm6,[ebx+256+72]
   db $0F,$6F,$83,$48,$01,$00,$00/// movq mm0,[ebx+256+72]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$48,$01,$00,$00/// movq [ebx+256+72],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$50,$01,$00,$00/// pcmpeqb mm6,[ebx+256+80]
   db $0F,$6F,$83,$50,$01,$00,$00/// movq mm0,[ebx+256+80]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$50,$01,$00,$00/// movq [ebx+256+80],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$58,$01,$00,$00/// pcmpeqb mm6,[ebx+256+88]
   db $0F,$6F,$83,$58,$01,$00,$00/// movq mm0,[ebx+256+88]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$58,$01,$00,$00/// movq [ebx+256+88],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$60,$01,$00,$00/// pcmpeqb mm6,[ebx+256+96]
   db $0F,$6F,$83,$60,$01,$00,$00/// movq mm0,[ebx+256+96]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$60,$01,$00,$00/// movq [ebx+256+96],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$68,$01,$00,$00/// pcmpeqb mm6,[ebx+256+104]
   db $0F,$6F,$83,$68,$01,$00,$00/// movq mm0,[ebx+256+104]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$68,$01,$00,$00/// movq [ebx+256+104],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$70,$01,$00,$00/// pcmpeqb mm6,[ebx+256+112]
   db $0F,$6F,$83,$70,$01,$00,$00/// movq mm0,[ebx+256+112]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$70,$01,$00,$00/// movq [ebx+256+112],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$78,$01,$00,$00/// pcmpeqb mm6,[ebx+256+120]
   db $0F,$6F,$83,$78,$01,$00,$00/// movq mm0,[ebx+256+120]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$78,$01,$00,$00/// movq [ebx+256+120],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$80,$01,$00,$00/// pcmpeqb mm6,[ebx+256+128]
   db $0F,$6F,$83,$80,$01,$00,$00/// movq mm0,[ebx+256+128]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$80,$01,$00,$00/// movq [ebx+256+128],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$88,$01,$00,$00/// pcmpeqb mm6,[ebx+256+136]
   db $0F,$6F,$83,$88,$01,$00,$00/// movq mm0,[ebx+256+136]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$88,$01,$00,$00/// movq [ebx+256+136],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$90,$01,$00,$00/// pcmpeqb mm6,[ebx+256+144]
   db $0F,$6F,$83,$90,$01,$00,$00/// movq mm0,[ebx+256+144]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$90,$01,$00,$00/// movq [ebx+256+144],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$98,$01,$00,$00/// pcmpeqb mm6,[ebx+256+152]
   db $0F,$6F,$83,$98,$01,$00,$00/// movq mm0,[ebx+256+152]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$98,$01,$00,$00/// movq [ebx+256+152],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$A0,$01,$00,$00/// pcmpeqb mm6,[ebx+256+160]
   db $0F,$6F,$83,$A0,$01,$00,$00/// movq mm0,[ebx+256+160]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$A0,$01,$00,$00/// movq [ebx+256+160],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$A8,$01,$00,$00/// pcmpeqb mm6,[ebx+256+168]
   db $0F,$6F,$83,$A8,$01,$00,$00/// movq mm0,[ebx+256+168]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$A8,$01,$00,$00/// movq [ebx+256+168],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$B0,$01,$00,$00/// pcmpeqb mm6,[ebx+256+176]
   db $0F,$6F,$83,$B0,$01,$00,$00/// movq mm0,[ebx+256+176]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$B0,$01,$00,$00/// movq [ebx+256+176],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$B8,$01,$00,$00/// pcmpeqb mm6,[ebx+256+184]
   db $0F,$6F,$83,$B8,$01,$00,$00/// movq mm0,[ebx+256+184]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$B8,$01,$00,$00/// movq [ebx+256+184],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$C0,$01,$00,$00/// pcmpeqb mm6,[ebx+256+192]
   db $0F,$6F,$83,$C0,$01,$00,$00/// movq mm0,[ebx+256+192]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$C0,$01,$00,$00/// movq [ebx+256+192],mm0

   db $0F,$6F,$BB,$00,$01,$00,$00/// movq mm7,[ebx+256]
   db $0F,$DA,$BB,$08,$01,$00,$00/// pminub mm7,[ebx+256+8]
   db $0F,$DA,$BB,$10,$01,$00,$00/// pminub mm7,[ebx+256+16]
   db $0F,$DA,$BB,$18,$01,$00,$00/// pminub mm7,[ebx+256+24]
   db $0F,$DA,$BB,$20,$01,$00,$00/// pminub mm7,[ebx+256+32]
   db $0F,$DA,$BB,$28,$01,$00,$00/// pminub mm7,[ebx+256+40]
   db $0F,$DA,$BB,$30,$01,$00,$00/// pminub mm7,[ebx+256+48]
   db $0F,$DA,$BB,$38,$01,$00,$00/// pminub mm7,[ebx+256+56]
   db $0F,$DA,$BB,$40,$01,$00,$00/// pminub mm7,[ebx+256+64]
   db $0F,$DA,$BB,$48,$01,$00,$00/// pminub mm7,[ebx+256+72]
   db $0F,$DA,$BB,$50,$01,$00,$00/// pminub mm7,[ebx+256+80]
   db $0F,$DA,$BB,$58,$01,$00,$00/// pminub mm7,[ebx+256+88]
   db $0F,$DA,$BB,$60,$01,$00,$00/// pminub mm7,[ebx+256+96]
   db $0F,$DA,$BB,$68,$01,$00,$00/// pminub mm7,[ebx+256+104]
   db $0F,$DA,$BB,$70,$01,$00,$00/// pminub mm7,[ebx+256+112]
   db $0F,$DA,$BB,$78,$01,$00,$00/// pminub mm7,[ebx+256+120]
   db $0F,$DA,$BB,$80,$01,$00,$00/// pminub mm7,[ebx+256+128]
   db $0F,$DA,$BB,$88,$01,$00,$00/// pminub mm7,[ebx+256+136]
   db $0F,$DA,$BB,$90,$01,$00,$00/// pminub mm7,[ebx+256+144]
   db $0F,$DA,$BB,$98,$01,$00,$00/// pminub mm7,[ebx+256+152]
   db $0F,$DA,$BB,$A0,$01,$00,$00/// pminub mm7,[ebx+256+160]
   db $0F,$DA,$BB,$A8,$01,$00,$00/// pminub mm7,[ebx+256+168]
   db $0F,$DA,$BB,$B0,$01,$00,$00/// pminub mm7,[ebx+256+176]
   db $0F,$DA,$BB,$B8,$01,$00,$00/// pminub mm7,[ebx+256+184]
   db $0F,$DA,$BB,$C0,$01,$00,$00/// pminub mm7,[ebx+256+192]

   dec edx
   jnz @MF55R

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R
   add edi,8

   dec ecx
   jnz @MF55_2

   sub esi,DispR
   sub edi,DispR

   //**** Maradék byte-ok kiszámolása (nem egész 8-ra jön ki -2 miatt)

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$83,$00,$01,$00,$00/// movq [ebx+256],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$83,$08,$01,$00,$00/// movq [ebx+256+8],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$83,$10,$01,$00,$00/// movq [ebx+256+16],mm0
   db $0F,$6F,$46,$03       /// movq mm0,[esi+3]
   db $0F,$7F,$83,$18,$01,$00,$00/// movq [ebx+256+24],mm0
   db $0F,$6F,$46,$04       /// movq mm0,[esi+4]
   db $0F,$7F,$83,$20,$01,$00,$00/// movq [ebx+256+32],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$83,$28,$01,$00,$00/// movq [ebx+256+40],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$83,$30,$01,$00,$00/// movq [ebx+256+48],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$83,$38,$01,$00,$00/// movq [ebx+256+56],mm0
   db $0F,$6F,$46,$03       /// movq mm0,[esi+3]
   db $0F,$7F,$83,$40,$01,$00,$00/// movq [ebx+256+64],mm0
   db $0F,$6F,$46,$04       /// movq mm0,[esi+4]
   db $0F,$7F,$83,$48,$01,$00,$00/// movq [ebx+256+72],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$83,$50,$01,$00,$00/// movq [ebx+256+80],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$83,$58,$01,$00,$00/// movq [ebx+256+88],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$83,$60,$01,$00,$00/// movq [ebx+256+96],mm0
   db $0F,$6F,$46,$03       /// movq mm0,[esi+3]
   db $0F,$7F,$83,$68,$01,$00,$00/// movq [ebx+256+104],mm0
   db $0F,$6F,$46,$04       /// movq mm0,[esi+4]
   db $0F,$7F,$83,$70,$01,$00,$00/// movq [ebx+256+112],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$83,$78,$01,$00,$00/// movq [ebx+256+120],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$83,$80,$01,$00,$00/// movq [ebx+256+128],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$83,$88,$01,$00,$00/// movq [ebx+256+136],mm0
   db $0F,$6F,$46,$03       /// movq mm0,[esi+3]
   db $0F,$7F,$83,$90,$01,$00,$00/// movq [ebx+256+144],mm0
   db $0F,$6F,$46,$04       /// movq mm0,[esi+4]
   db $0F,$7F,$83,$98,$01,$00,$00/// movq [ebx+256+152],mm0
   add esi,SrcW
   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$7F,$83,$A0,$01,$00,$00/// movq [ebx+256+160],mm0
   db $0F,$6F,$46,$01       /// movq mm0,[esi+1]
   db $0F,$7F,$83,$A8,$01,$00,$00/// movq [ebx+256+168],mm0
   db $0F,$6F,$46,$02       /// movq mm0,[esi+2]
   db $0F,$7F,$83,$B0,$01,$00,$00/// movq [ebx+256+176],mm0
   db $0F,$6F,$46,$03       /// movq mm0,[esi+3]
   db $0F,$7F,$83,$B8,$01,$00,$00/// movq [ebx+256+184],mm0
   db $0F,$6F,$46,$04       /// movq mm0,[esi+4]
   db $0F,$7F,$83,$C0,$01,$00,$00/// movq [ebx+256+192],mm0

   mov edx,12

   db $0F,$6F,$BB,$00,$01,$00,$00/// movq mm7,[ebx+256]
   db $0F,$DA,$BB,$08,$01,$00,$00/// pminub mm7,[ebx+256+8]
   db $0F,$DA,$BB,$10,$01,$00,$00/// pminub mm7,[ebx+256+16]
   db $0F,$DA,$BB,$18,$01,$00,$00/// pminub mm7,[ebx+256+24]
   db $0F,$DA,$BB,$20,$01,$00,$00/// pminub mm7,[ebx+256+32]
   db $0F,$DA,$BB,$28,$01,$00,$00/// pminub mm7,[ebx+256+40]
   db $0F,$DA,$BB,$30,$01,$00,$00/// pminub mm7,[ebx+256+48]
   db $0F,$DA,$BB,$38,$01,$00,$00/// pminub mm7,[ebx+256+56]
   db $0F,$DA,$BB,$40,$01,$00,$00/// pminub mm7,[ebx+256+64]
   db $0F,$DA,$BB,$48,$01,$00,$00/// pminub mm7,[ebx+256+72]
   db $0F,$DA,$BB,$50,$01,$00,$00/// pminub mm7,[ebx+256+80]
   db $0F,$DA,$BB,$58,$01,$00,$00/// pminub mm7,[ebx+256+88]
   db $0F,$DA,$BB,$60,$01,$00,$00/// pminub mm7,[ebx+256+96]
   db $0F,$DA,$BB,$68,$01,$00,$00/// pminub mm7,[ebx+256+104]
   db $0F,$DA,$BB,$70,$01,$00,$00/// pminub mm7,[ebx+256+112]
   db $0F,$DA,$BB,$78,$01,$00,$00/// pminub mm7,[ebx+256+120]
   db $0F,$DA,$BB,$80,$01,$00,$00/// pminub mm7,[ebx+256+128]
   db $0F,$DA,$BB,$88,$01,$00,$00/// pminub mm7,[ebx+256+136]
   db $0F,$DA,$BB,$90,$01,$00,$00/// pminub mm7,[ebx+256+144]
   db $0F,$DA,$BB,$98,$01,$00,$00/// pminub mm7,[ebx+256+152]
   db $0F,$DA,$BB,$A0,$01,$00,$00/// pminub mm7,[ebx+256+160]
   db $0F,$DA,$BB,$A8,$01,$00,$00/// pminub mm7,[ebx+256+168]
   db $0F,$DA,$BB,$B0,$01,$00,$00/// pminub mm7,[ebx+256+176]
   db $0F,$DA,$BB,$B8,$01,$00,$00/// pminub mm7,[ebx+256+184]
   db $0F,$DA,$BB,$C0,$01,$00,$00/// pminub mm7,[ebx+256+192]

@MF55R2:

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$00,$01,$00,$00/// pcmpeqb mm6,[ebx+256]
   db $0F,$6F,$83,$00,$01,$00,$00/// movq mm0,[ebx+256]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$00,$01,$00,$00/// movq [ebx+256],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$08,$01,$00,$00/// pcmpeqb mm6,[ebx+256+8]
   db $0F,$6F,$83,$08,$01,$00,$00/// movq mm0,[ebx+256+8]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$08,$01,$00,$00/// movq [ebx+256+8],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$10,$01,$00,$00/// pcmpeqb mm6,[ebx+256+16]
   db $0F,$6F,$83,$10,$01,$00,$00/// movq mm0,[ebx+256+16]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$10,$01,$00,$00/// movq [ebx+256+16],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$18,$01,$00,$00/// pcmpeqb mm6,[ebx+256+24]
   db $0F,$6F,$83,$18,$01,$00,$00/// movq mm0,[ebx+256+24]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$18,$01,$00,$00/// movq [ebx+256+24],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$20,$01,$00,$00/// pcmpeqb mm6,[ebx+256+32]
   db $0F,$6F,$83,$20,$01,$00,$00/// movq mm0,[ebx+256+32]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$20,$01,$00,$00/// movq [ebx+256+32],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$28,$01,$00,$00/// pcmpeqb mm6,[ebx+256+40]
   db $0F,$6F,$83,$28,$01,$00,$00/// movq mm0,[ebx+256+40]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$28,$01,$00,$00/// movq [ebx+256+40],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$30,$01,$00,$00/// pcmpeqb mm6,[ebx+256+48]
   db $0F,$6F,$83,$30,$01,$00,$00/// movq mm0,[ebx+256+48]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$30,$01,$00,$00/// movq [ebx+256+48],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$38,$01,$00,$00/// pcmpeqb mm6,[ebx+256+56]
   db $0F,$6F,$83,$38,$01,$00,$00/// movq mm0,[ebx+256+56]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$38,$01,$00,$00/// movq [ebx+256+56],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$40,$01,$00,$00/// pcmpeqb mm6,[ebx+256+64]
   db $0F,$6F,$83,$40,$01,$00,$00/// movq mm0,[ebx+256+64]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$40,$01,$00,$00/// movq [ebx+256+64],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$48,$01,$00,$00/// pcmpeqb mm6,[ebx+256+72]
   db $0F,$6F,$83,$48,$01,$00,$00/// movq mm0,[ebx+256+72]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$48,$01,$00,$00/// movq [ebx+256+72],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$50,$01,$00,$00/// pcmpeqb mm6,[ebx+256+80]
   db $0F,$6F,$83,$50,$01,$00,$00/// movq mm0,[ebx+256+80]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$50,$01,$00,$00/// movq [ebx+256+80],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$58,$01,$00,$00/// pcmpeqb mm6,[ebx+256+88]
   db $0F,$6F,$83,$58,$01,$00,$00/// movq mm0,[ebx+256+88]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$58,$01,$00,$00/// movq [ebx+256+88],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$60,$01,$00,$00/// pcmpeqb mm6,[ebx+256+96]
   db $0F,$6F,$83,$60,$01,$00,$00/// movq mm0,[ebx+256+96]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$60,$01,$00,$00/// movq [ebx+256+96],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$68,$01,$00,$00/// pcmpeqb mm6,[ebx+256+104]
   db $0F,$6F,$83,$68,$01,$00,$00/// movq mm0,[ebx+256+104]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$68,$01,$00,$00/// movq [ebx+256+104],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$70,$01,$00,$00/// pcmpeqb mm6,[ebx+256+112]
   db $0F,$6F,$83,$70,$01,$00,$00/// movq mm0,[ebx+256+112]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$70,$01,$00,$00/// movq [ebx+256+112],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$78,$01,$00,$00/// pcmpeqb mm6,[ebx+256+120]
   db $0F,$6F,$83,$78,$01,$00,$00/// movq mm0,[ebx+256+120]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$78,$01,$00,$00/// movq [ebx+256+120],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$80,$01,$00,$00/// pcmpeqb mm6,[ebx+256+128]
   db $0F,$6F,$83,$80,$01,$00,$00/// movq mm0,[ebx+256+128]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$80,$01,$00,$00/// movq [ebx+256+128],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$88,$01,$00,$00/// pcmpeqb mm6,[ebx+256+136]
   db $0F,$6F,$83,$88,$01,$00,$00/// movq mm0,[ebx+256+136]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$88,$01,$00,$00/// movq [ebx+256+136],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$90,$01,$00,$00/// pcmpeqb mm6,[ebx+256+144]
   db $0F,$6F,$83,$90,$01,$00,$00/// movq mm0,[ebx+256+144]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$90,$01,$00,$00/// movq [ebx+256+144],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$98,$01,$00,$00/// pcmpeqb mm6,[ebx+256+152]
   db $0F,$6F,$83,$98,$01,$00,$00/// movq mm0,[ebx+256+152]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$98,$01,$00,$00/// movq [ebx+256+152],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$A0,$01,$00,$00/// pcmpeqb mm6,[ebx+256+160]
   db $0F,$6F,$83,$A0,$01,$00,$00/// movq mm0,[ebx+256+160]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$A0,$01,$00,$00/// movq [ebx+256+160],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$A8,$01,$00,$00/// pcmpeqb mm6,[ebx+256+168]
   db $0F,$6F,$83,$A8,$01,$00,$00/// movq mm0,[ebx+256+168]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$A8,$01,$00,$00/// movq [ebx+256+168],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$B0,$01,$00,$00/// pcmpeqb mm6,[ebx+256+176]
   db $0F,$6F,$83,$B0,$01,$00,$00/// movq mm0,[ebx+256+176]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$B0,$01,$00,$00/// movq [ebx+256+176],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$B8,$01,$00,$00/// pcmpeqb mm6,[ebx+256+184]
   db $0F,$6F,$83,$B8,$01,$00,$00/// movq mm0,[ebx+256+184]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$B8,$01,$00,$00/// movq [ebx+256+184],mm0

   db $0F,$6F,$F7           /// movq mm6,mm7
   db $0F,$74,$B3,$C0,$01,$00,$00/// pcmpeqb mm6,[ebx+256+192]
   db $0F,$6F,$83,$C0,$01,$00,$00/// movq mm0,[ebx+256+192]
   db $0F,$EB,$C6           /// por mm0,mm6
   db $0F,$EB,$FE           /// por mm7,mm6
   db $0F,$7F,$83,$C0,$01,$00,$00/// movq [ebx+256+192],mm0

   db $0F,$6F,$BB,$00,$01,$00,$00/// movq mm7,[ebx+256]
   db $0F,$DA,$BB,$08,$01,$00,$00/// pminub mm7,[ebx+256+8]
   db $0F,$DA,$BB,$10,$01,$00,$00/// pminub mm7,[ebx+256+16]
   db $0F,$DA,$BB,$18,$01,$00,$00/// pminub mm7,[ebx+256+24]
   db $0F,$DA,$BB,$20,$01,$00,$00/// pminub mm7,[ebx+256+32]
   db $0F,$DA,$BB,$28,$01,$00,$00/// pminub mm7,[ebx+256+40]
   db $0F,$DA,$BB,$30,$01,$00,$00/// pminub mm7,[ebx+256+48]
   db $0F,$DA,$BB,$38,$01,$00,$00/// pminub mm7,[ebx+256+56]
   db $0F,$DA,$BB,$40,$01,$00,$00/// pminub mm7,[ebx+256+64]
   db $0F,$DA,$BB,$48,$01,$00,$00/// pminub mm7,[ebx+256+72]
   db $0F,$DA,$BB,$50,$01,$00,$00/// pminub mm7,[ebx+256+80]
   db $0F,$DA,$BB,$58,$01,$00,$00/// pminub mm7,[ebx+256+88]
   db $0F,$DA,$BB,$60,$01,$00,$00/// pminub mm7,[ebx+256+96]
   db $0F,$DA,$BB,$68,$01,$00,$00/// pminub mm7,[ebx+256+104]
   db $0F,$DA,$BB,$70,$01,$00,$00/// pminub mm7,[ebx+256+112]
   db $0F,$DA,$BB,$78,$01,$00,$00/// pminub mm7,[ebx+256+120]
   db $0F,$DA,$BB,$80,$01,$00,$00/// pminub mm7,[ebx+256+128]
   db $0F,$DA,$BB,$88,$01,$00,$00/// pminub mm7,[ebx+256+136]
   db $0F,$DA,$BB,$90,$01,$00,$00/// pminub mm7,[ebx+256+144]
   db $0F,$DA,$BB,$98,$01,$00,$00/// pminub mm7,[ebx+256+152]
   db $0F,$DA,$BB,$A0,$01,$00,$00/// pminub mm7,[ebx+256+160]
   db $0F,$DA,$BB,$A8,$01,$00,$00/// pminub mm7,[ebx+256+168]
   db $0F,$DA,$BB,$B0,$01,$00,$00/// pminub mm7,[ebx+256+176]
   db $0F,$DA,$BB,$B8,$01,$00,$00/// pminub mm7,[ebx+256+184]
   db $0F,$DA,$BB,$C0,$01,$00,$00/// pminub mm7,[ebx+256+192]

   dec edx
   jnz @MF55R2

   db $0F,$E7,$3F           /// movntq [edi],mm7

   sub esi,SrcW_R2
   add edi,12

   pop ecx
   dec ecx
   jnz @MF55_1

   //*** Másolás vissza
   mov edi,Src
   mov esi,Pointer(TempImage)
   mov ecx,Size
   shr ecx,5

   @MMX_CopyCycle:

   db $0F,$18,$46,$40       /// prefetchtna [esi+64]
   db $0F,$18,$46,$60       /// prefetchtna [esi+96]

   db $0F,$6F,$06           /// movq mm0,[esi]
   db $0F,$6F,$4E,$08       /// movq mm1,[esi+8]
   db $0F,$6F,$56,$10       /// movq mm2,[esi+16]
   db $0F,$6F,$5E,$18       /// movq mm3,[esi+24]
   db $0F,$E7,$07           /// movntq [edi],mm0
   db $0F,$E7,$4F,$08       /// movntq [edi+8],mm1
   db $0F,$E7,$57,$10       /// movntq [edi+16],mm2
   db $0F,$E7,$5F,$18       /// movntq [edi+24],mm3

   add esi,32
   add edi,32

   dec ecx
   jnz @MMX_CopyCycle

   db $0F,$77               /// emms
   popfd
   popad
  end;
  FreeMem(CacheMemory);
  FreeMem(TempImage);
end;

// src - 32 bites rgb, dest - 8 bites grayscale
procedure CopyMemoryRGB32toRGB8GrayScale(dest, src : pointer; pixels : integer);
const r : array [0..255] of byte = (
          $00,$00,$01,$01,$01,$02,$02,$02,$02,$03,$03,$03,$04,$04,$04,$04,$05,$05,$05,$06,$06,$06,$07,$07,$07,$08,$08,$08,$08,$09,$09,$09,
          $0A,$0A,$0A,$0A,$0B,$0B,$0B,$0C,$0C,$0C,$0D,$0D,$0D,$0E,$0E,$0E,$0E,$0F,$0F,$0F,$10,$10,$10,$10,$11,$11,$11,$12,$12,$12,$13,$13,
          $13,$14,$14,$14,$14,$15,$15,$15,$16,$16,$16,$16,$17,$17,$17,$18,$18,$18,$19,$19,$19,$1A,$1A,$1A,$1A,$1B,$1B,$1B,$1C,$1C,$1C,$1D,
          $1D,$1D,$1D,$1E,$1E,$1E,$1F,$1F,$1F,$20,$20,$20,$20,$21,$21,$21,$22,$22,$22,$22,$23,$23,$23,$24,$24,$24,$25,$25,$25,$26,$26,$26,
          $26,$27,$27,$27,$28,$28,$28,$28,$29,$29,$29,$2A,$2A,$2A,$2B,$2B,$2B,$2C,$2C,$2C,$2C,$2D,$2D,$2D,$2E,$2E,$2E,$2E,$2F,$2F,$2F,$30,
          $30,$30,$31,$31,$31,$32,$32,$32,$32,$33,$33,$33,$34,$34,$34,$35,$35,$35,$35,$36,$36,$36,$37,$37,$37,$38,$38,$38,$38,$39,$39,$39,
          $3A,$3A,$3A,$3B,$3B,$3B,$3B,$3C,$3C,$3C,$3D,$3D,$3D,$3E,$3E,$3E,$3E,$3F,$3F,$3F,$40,$40,$40,$40,$41,$41,$41,$42,$42,$42,$43,$43,
          $43,$44,$44,$44,$44,$45,$45,$45,$46,$46,$46,$46,$47,$47,$47,$48,$48,$48,$49,$49,$49,$4A,$4A,$4A,$4A,$4B,$4B,$4B,$4C,$4C,$4C,$4C);

const g : array [0..255] of byte = (
          $00,$01,$01,$02,$02,$03,$03,$04,$05,$05,$06,$06,$07,$08,$08,$09,$09,$0A,$0A,$0B,$0C,$0C,$0D,$0D,$0E,$0E,$0F,$10,$10,$11,$11,$12,
          $13,$13,$14,$14,$15,$15,$16,$17,$17,$18,$18,$19,$1A,$1A,$1B,$1B,$1C,$1C,$1D,$1E,$1E,$1F,$1F,$20,$20,$21,$22,$22,$23,$23,$24,$25,
          $25,$26,$26,$27,$27,$28,$29,$29,$2A,$2A,$2B,$2C,$2C,$2D,$2D,$2E,$2E,$2F,$30,$30,$31,$31,$32,$32,$33,$34,$34,$35,$35,$36,$37,$37,
          $38,$38,$39,$39,$3A,$3B,$3B,$3C,$3C,$3D,$3D,$3E,$3F,$3F,$40,$40,$41,$42,$42,$43,$43,$44,$44,$45,$46,$46,$47,$47,$48,$48,$49,$4A,
          $4A,$4B,$4B,$4C,$4D,$4D,$4E,$4E,$4F,$4F,$50,$51,$51,$52,$52,$53,$54,$54,$55,$55,$56,$56,$57,$58,$58,$59,$59,$5A,$5A,$5B,$5C,$5C,
          $5D,$5D,$5E,$5F,$5F,$60,$60,$61,$61,$62,$63,$63,$64,$64,$65,$66,$66,$67,$67,$68,$68,$69,$6A,$6A,$6B,$6B,$6C,$6C,$6D,$6E,$6E,$6F,
          $6F,$70,$71,$71,$72,$72,$73,$73,$74,$75,$75,$76,$76,$77,$77,$78,$79,$79,$7A,$7A,$7B,$7C,$7C,$7D,$7D,$7E,$7E,$7F,$80,$80,$81,$81,
          $82,$82,$83,$84,$84,$85,$85,$86,$87,$87,$88,$88,$89,$89,$8A,$8B,$8B,$8C,$8C,$8D,$8E,$8E,$8F,$8F,$90,$90,$91,$92,$92,$93,$93,$94);

const b : array [0..255] of byte = (
          $00,$00,$00,$00,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$02,$02,$02,$02,$02,$02,$02,$02,$02,$03,$03,$03,$03,$03,$03,$03,$03,$03,
          $04,$04,$04,$04,$04,$04,$04,$04,$04,$05,$05,$05,$05,$05,$05,$05,$05,$05,$06,$06,$06,$06,$06,$06,$06,$06,$06,$06,$07,$07,$07,$07,
          $07,$07,$07,$07,$07,$08,$08,$08,$08,$08,$08,$08,$08,$08,$09,$09,$09,$09,$09,$09,$09,$09,$09,$0A,$0A,$0A,$0A,$0A,$0A,$0A,$0A,$0A,
          $0B,$0B,$0B,$0B,$0B,$0B,$0B,$0B,$0B,$0C,$0C,$0C,$0C,$0C,$0C,$0C,$0C,$0C,$0D,$0D,$0D,$0D,$0D,$0D,$0D,$0D,$0D,$0E,$0E,$0E,$0E,$0E,
          $0E,$0E,$0E,$0E,$0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F,$0F,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$11,$11,$11,$11,$11,$11,$11,$11,$11,
          $12,$12,$12,$12,$12,$12,$12,$12,$12,$13,$13,$13,$13,$13,$13,$13,$13,$13,$14,$14,$14,$14,$14,$14,$14,$14,$14,$15,$15,$15,$15,$15,
          $15,$15,$15,$15,$16,$16,$16,$16,$16,$16,$16,$16,$16,$17,$17,$17,$17,$17,$17,$17,$17,$17,$18,$18,$18,$18,$18,$18,$18,$18,$18,$19,
          $19,$19,$19,$19,$19,$19,$19,$19,$1A,$1A,$1A,$1A,$1A,$1A,$1A,$1A,$1A,$1B,$1B,$1B,$1B,$1B,$1B,$1B,$1B,$1B,$1C,$1C,$1C,$1C,$1C,$1C);
begin
   asm   pushad
         mov    esi,[src]
         mov    edi,[dest]
         xor    eax,eax
         mov    ecx,[pixels]
   @1:   lodsb
         mov    bl,byte ptr g[eax]
         lodsb
         add    bl,byte ptr b[eax]
         lodsb
         add    bl,byte ptr r[eax]
         inc    esi
         mov    byte ptr [edi],bl
         inc    edi
         loop   @1
         popad
   end;
end;

initialization

  SetMMX(2);

end.
